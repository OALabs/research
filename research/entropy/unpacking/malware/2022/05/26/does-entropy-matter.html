<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Does Entropy Matter? A Pseudoscientific Study!</h1><p class="page-description">How useful is entropy for identifying packed samples?</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-05-26T00:00:00-05:00" itemprop="datePublished">
        May 26, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      11 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#research">research</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#entropy">entropy</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#unpacking">unpacking</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#malware">malware</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2022-05-26-does-entropy-matter.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#Overview">Overview </a>
<ul>
<li class="toc-entry toc-h2"><a href="#References">References </a></li>
<li class="toc-entry toc-h2"><a href="#Our-Problem">Our Problem </a></li>
<li class="toc-entry toc-h2"><a href="#Our-Study">Our Study </a></li>
<li class="toc-entry toc-h2"><a href="#Tools">Tools </a></li>
<li class="toc-entry toc-h2"><a href="#First-Test-of-All-Methods">First Test of All Methods </a></li>
<li class="toc-entry toc-h2"><a href="#Conclusions">Conclusions </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Entropy-May-Not-Be-Useful-for-.NET">Entropy May Not Be Useful for .NET </a></li>
<li class="toc-entry toc-h3"><a href="#Bintropy-Has-A-Poor-Packed-Detection-Rate-with-Default-Values">Bintropy Has A Poor Packed Detection Rate with Default Values </a></li>
<li class="toc-entry toc-h3"><a href="#General-Conclusions">General Conclusions </a></li>
</ul>
</li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-05-26-does-entropy-matter.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h1>
<p>Entroy is obviously useful and tells us information about the binary. However, can we use entropy <strong>alone</strong> to determine if a sample is packed or not. Let's define the parameters for our study.</p>
<ul>
<li>Without looking at the binary in IDA (or your RE tool of choice) can you use entropy to determine if the sample is packed?</li>
<li>We are defining "packed" as a file that contains an encrypted, or compressed payload, where our analysis goals are to analyze the payload and not the packer.</li>
<li>Are there specific data in the binary that can be tested for entopy that will give use a better answer than testing the full binary? For example, looking at the entropy of sections, or of resources.</li>
</ul>
<h2 id="References">
<a class="anchor" href="#References" aria-hidden="true"><span class="octicon octicon-link"></span></a>References<a class="anchor-link" href="#References"> </a>
</h2>
<ul>
<li><a href="https://arxiv.org/pdf/1405.2061.pdf">Understanding Shannon's Entropy metric for Information</a></li>
<li><a href="https://umbrella.cisco.com/blog/using-entropy-to-spot-the-malware-hiding-in-plain-sight">Using entropy to spot the malware hiding in plain sight</a></li>
<li><a href="https://github.com/merces/entropy">merces/entropy (github)</a></li>
<li><a href="https://github.com/mattifestation/PowerShellArsenal/blob/master/Misc/Get-Entropy.ps1">PowerShellArsenal/Misc/Get-Entropy.ps1</a></li>
<li><a href="https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.120.9861&amp;rep=rep1&amp;type=pdf">Using Entropy Analysis to Find Encrypted and Packed Malware (bintropy)</a></li>
<li><a href="https://github.com/dhondta/bintropy">bintropy (github)</a></li>
<li><a href="https://www.mdpi.com/1099-4300/19/3/125/htm">Packer Detection for Multi-Layer Executables Using Entropy Analysis</a></li>
<li><a href="https://sci-hub.hkvisa.net/10.1109/malware.2010.5665789">Generic unpacking using entropy analysis</a></li>
</ul>
<h2 id="Our-Problem">
<a class="anchor" href="#Our-Problem" aria-hidden="true"><span class="octicon octicon-link"></span></a>Our Problem<a class="anchor-link" href="#Our-Problem"> </a>
</h2>
<p>Based on entropy can we make a decision about whether or not to open a sample in IDA by looking at entropy alone. If we cannot make this decision we will have to open the binary in IDA so why bother looking at entropy at all?</p>
<h2 id="Our-Study">
<a class="anchor" href="#Our-Study" aria-hidden="true"><span class="octicon octicon-link"></span></a>Our Study<a class="anchor-link" href="#Our-Study"> </a>
</h2>
<p>For our study we are going to collect a set of known packed, and unpacked (payload) samples to use as our ground truth. We will then run differnt types of entropy calculation on the binaries and look for a common cutoff where we could made a decision that the samples are packed/unpacked. If the cutoff is such that we cannot classify all samples within an error margin of <strong>ERROR-RATE-TBD</strong> then we can conclude that entropy will not consistantly answer our problem statement.</p>
<h2 id="Tools">
<a class="anchor" href="#Tools" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tools<a class="anchor-link" href="#Tools"> </a>
</h2>
<p>We are going to use <code>bintropy</code> and the standard section entropy calculation from <code>pefile</code> as our two tools.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pefile</span>
<span class="kn">import</span> <span class="nn">bintropy</span>

<span class="k">def</span> <span class="nf">pe_test</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">all_sections</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1">#</span>
    <span class="c1"># We will test the entropy of the non-executable sections</span>
    <span class="c1"># and return the largest entropy value</span>
    <span class="c1">#</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="o">.</span><span class="n">PE</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">entropy_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pe</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">all_sections</span><span class="p">:</span>
            <span class="n">entropy_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get_entropy</span><span class="p">())</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">IMAGE_SCN_CNT_CODE</span><span class="p">:</span>
            <span class="n">entropy_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get_entropy</span><span class="p">())</span>
            
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entropy_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">entropy_list</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_dotnet</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="o">.</span><span class="n">PE</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">isDotNet</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">OPTIONAL_HEADER</span><span class="o">.</span><span class="n">DATA_DIRECTORY</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">isDotNet</span><span class="o">.</span><span class="n">VirtualAddress</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">isDotNet</span><span class="o">.</span><span class="n">Size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
        

<span class="k">def</span> <span class="nf">bintropy_test</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">get_average</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">h_e</span><span class="p">,</span> <span class="n">av_e</span> <span class="o">=</span> <span class="n">bintropy</span><span class="o">.</span><span class="n">bintropy</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">decide</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">get_average</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">av_e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">h_e</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">UNPACKED_DIR</span> <span class="o">=</span> <span class="s1">'/tmp/unpacked'</span>
<span class="n">PACKED_DIR</span> <span class="o">=</span> <span class="s1">'/tmp/packed'</span>

<span class="n">file_path</span> <span class="o">=</span> <span class="s1">'/tmp/packed/ff5ac0eb80d90c6a2a46a4133fc8d90cd165b8b2bac1cbaa8fadd35b186bd5c8.bin'</span>

<span class="c1">#</span>
<span class="c1"># threshold avg packed 6.677</span>
<span class="c1"># threshold highest packed 7.199</span>
<span class="c1">#</span>


<span class="c1"># test all sections</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">testing all sections"</span><span class="p">)</span>
<span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="o">.</span><span class="n">PE</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pe</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" is code: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">IMAGE_SCN_CNT_CODE</span><span class="si">}</span><span class="s2"> -- </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">get_entropy</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


        
<span class="c1"># test the pe method only data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">test highest entropy from data sections"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pe_test</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">all_sections</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># test the pe method all sections</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">test highest entropy from all sections"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pe_test</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">all_sections</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>


<span class="c1"># test bintropy average</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">test bintropy average"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bintropy_test</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">get_average</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>


<span class="c1"># test bintropy average</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">test bintropy highest"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bintropy_test</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">get_average</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
testing all sections
 is code: True -- 7.6981527898958
 is code: False -- 5.395082466102808
 is code: False -- 2.3168484674576013
 is code: False -- 0.020393135236084953
 is code: False -- 4.823677517350269

test highest entropy from data sections
5.395082466102808

test highest entropy from all sections
7.6981527898958

test bintropy average
6.267216812715635

test bintropy highest
7.796875
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="First-Test-of-All-Methods">
<a class="anchor" href="#First-Test-of-All-Methods" aria-hidden="true"><span class="octicon octicon-link"></span></a>First Test of All Methods<a class="anchor-link" href="#First-Test-of-All-Methods"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">rich.console</span> <span class="kn">import</span> <span class="n">Console</span>
<span class="kn">from</span> <span class="nn">rich.table</span> <span class="kn">import</span> <span class="n">Table</span>



<span class="c1"># assign directory</span>
<span class="n">directory</span> <span class="o">=</span> <span class="n">PACKED_DIR</span>
 
<span class="c1"># iterate over files in</span>
<span class="c1"># that directory</span>


<span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Packed Samples"</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"file"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">".NET"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"pe data"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"pe all"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"pe all</span><span class="se">\n</span><span class="s2">packed @ 7"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"bin ave"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"bin all"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"bin all</span><span class="se">\n</span><span class="s2">packed @ 7"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"bin t/f"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="c1"># checking if it is a file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">f</span>
        <span class="n">pe_data</span> <span class="o">=</span>  <span class="n">pe_test</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">all_sections</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">pe_all</span> <span class="o">=</span> <span class="n">pe_test</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">all_sections</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">bin_ave</span> <span class="o">=</span> <span class="n">bintropy_test</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">get_average</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">bin_all</span> <span class="o">=</span> <span class="n">bintropy_test</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">get_average</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">bin_tf</span> <span class="o">=</span> <span class="n">bintropy</span><span class="o">.</span><span class="n">bintropy</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">dotnet</span> <span class="o">=</span> <span class="n">is_dotnet</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">filename</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">dotnet</span><span class="p">),</span> 
                      <span class="nb">str</span><span class="p">(</span><span class="n">pe_data</span><span class="p">)[:</span><span class="mi">4</span><span class="p">],</span> 
                      <span class="nb">str</span><span class="p">(</span><span class="n">pe_all</span><span class="p">)[:</span><span class="mi">4</span><span class="p">],</span> 
                      <span class="nb">str</span><span class="p">(</span><span class="kc">True</span> <span class="k">if</span> <span class="n">pe_all</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="k">else</span> <span class="kc">False</span><span class="p">),</span> 
                      <span class="nb">str</span><span class="p">(</span><span class="n">bin_ave</span><span class="p">)[:</span><span class="mi">4</span><span class="p">],</span> 
                      <span class="nb">str</span><span class="p">(</span><span class="n">bin_all</span><span class="p">)[:</span><span class="mi">4</span><span class="p">],</span>
                      <span class="nb">str</span><span class="p">(</span><span class="kc">True</span> <span class="k">if</span> <span class="n">bin_all</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="k">else</span> <span class="kc">False</span><span class="p">),</span>
                      <span class="nb">str</span><span class="p">(</span><span class="n">bin_tf</span><span class="p">))</span>
        

<span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span>
<span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-style: italic">                                       Packed Samples                                        </span>
┏━━━━━━━━┳━━━━━━━┳━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━┓
┃<span style="font-weight: bold">        </span>┃<span style="font-weight: bold">       </span>┃<span style="font-weight: bold">         </span>┃<span style="font-weight: bold">        </span>┃<span style="font-weight: bold">   pe all   </span>┃<span style="font-weight: bold">         </span>┃<span style="font-weight: bold">         </span>┃<span style="font-weight: bold">  bin all   </span>┃<span style="font-weight: bold">         </span>┃
┃<span style="font-weight: bold">  file  </span>┃<span style="font-weight: bold"> .NET  </span>┃<span style="font-weight: bold"> pe data </span>┃<span style="font-weight: bold"> pe all </span>┃<span style="font-weight: bold"> packed @ 7 </span>┃<span style="font-weight: bold"> bin ave </span>┃<span style="font-weight: bold"> bin all </span>┃<span style="font-weight: bold"> packed @ 7 </span>┃<span style="font-weight: bold"> bin t/f </span>┃
┡━━━━━━━━╇━━━━━━━╇━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━┩
│ 5b39d  │ True  │  3.46   │  7.85  │    True    │  6.82   │  7.31   │    True    │  True   │
│ 2d83e  │ False │  7.98   │  7.98  │    True    │  6.87   │  7.34   │    True    │  True   │
│ 54fa2  │ False │  2.85   │  7.95  │    True    │  6.86   │  7.28   │    True    │  True   │
│ eca1c  │ False │  7.89   │  7.89  │    True    │  6.07   │  7.30   │    True    │  False  │
│ 8cb98  │ False │   0.0   │  7.99  │    True    │  6.86   │  7.31   │    True    │  True   │
│ f2354  │ True  │  4.22   │  7.81  │    True    │  6.77   │  7.29   │    True    │  True   │
│ b9aba  │ False │  7.17   │  7.17  │    True    │  6.14   │  7.01   │    True    │  False  │
│ d5c2e  │ True  │  2.65   │  7.85  │    True    │  6.28   │  7.31   │    True    │  False  │
│ 3493e  │ True  │  3.70   │  6.21  │   False    │  3.92   │  7.27   │    True    │  False  │
│ 23b04  │ False │  5.93   │  6.55  │   False    │  5.36   │  6.91   │   False    │  False  │
│ 080f1  │ False │  5.52   │  7.46  │    True    │  5.89   │  7.79   │    True    │  False  │
│ a7084  │ True  │  4.10   │  7.86  │    True    │  6.84   │  7.31   │    True    │  True   │
│ 60d89  │ False │  5.25   │  7.77  │    True    │  5.71   │  7.32   │    True    │  False  │
│ 35196  │ False │  7.25   │  7.25  │    True    │  5.44   │  7.38   │    True    │  False  │
│ ff5ac  │ False │  5.39   │  7.69  │    True    │  6.26   │  7.79   │    True    │  False  │
│ 3664a  │ True  │  4.51   │  4.51  │   False    │  4.20   │  5.32   │   False    │  False  │
│ 0d333  │ False │  7.99   │  7.99  │    True    │  6.50   │  7.45   │    True    │  False  │
│ 35196  │ False │  7.25   │  7.25  │    True    │  5.44   │  7.38   │    True    │  False  │
│ 31323  │ False │    0    │  7.99  │    True    │  7.13   │  7.32   │    True    │  True   │
│ 44824  │ False │  7.74   │  7.74  │    True    │  5.80   │  7.79   │    True    │  False  │
│ 3d4f0  │ True  │  6.51   │  7.86  │    True    │  6.79   │  7.30   │    True    │  True   │
│ b707d  │ False │   0.0   │  6.45  │   False    │  5.37   │  7.42   │    True    │  False  │
│ 6966f  │ False │  7.12   │  7.12  │    True    │  5.41   │  7.36   │    True    │  False  │
│ 5139a  │ True  │  2.39   │  7.87  │    True    │  6.82   │  7.35   │    True    │  True   │
│ 6e6e5  │ True  │  7.71   │  7.94  │    True    │  6.83   │  7.33   │    True    │  True   │
│ 0e4f3  │ False │  7.80   │  7.80  │    True    │  6.01   │  7.79   │    True    │  False  │
└────────┴───────┴─────────┴────────┴────────────┴─────────┴─────────┴────────────┴─────────┘
</pre>

</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">rich.console</span> <span class="kn">import</span> <span class="n">Console</span>
<span class="kn">from</span> <span class="nn">rich.table</span> <span class="kn">import</span> <span class="n">Table</span>



<span class="c1"># assign directory</span>
<span class="n">directory</span> <span class="o">=</span> <span class="n">UNPACKED_DIR</span>
 
<span class="c1"># iterate over files in</span>
<span class="c1"># that directory</span>


<span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Unpacked Samples"</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"file"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">".NET"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"pe data"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"pe all"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"pe all</span><span class="se">\n</span><span class="s2">packed @ 7"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"bin ave"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"bin all"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"bin all</span><span class="se">\n</span><span class="s2">packed @ 7"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"bin t/f"</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="c1"># checking if it is a file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">f</span>
        <span class="n">pe_data</span> <span class="o">=</span>  <span class="n">pe_test</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">all_sections</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">pe_all</span> <span class="o">=</span> <span class="n">pe_test</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">all_sections</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">bin_ave</span> <span class="o">=</span> <span class="n">bintropy_test</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">get_average</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">bin_all</span> <span class="o">=</span> <span class="n">bintropy_test</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">get_average</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">bin_tf</span> <span class="o">=</span> <span class="n">bintropy</span><span class="o">.</span><span class="n">bintropy</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">dotnet</span> <span class="o">=</span> <span class="n">is_dotnet</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">filename</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">dotnet</span><span class="p">),</span> 
                      <span class="nb">str</span><span class="p">(</span><span class="n">pe_data</span><span class="p">)[:</span><span class="mi">4</span><span class="p">],</span> 
                      <span class="nb">str</span><span class="p">(</span><span class="n">pe_all</span><span class="p">)[:</span><span class="mi">4</span><span class="p">],</span> 
                      <span class="nb">str</span><span class="p">(</span><span class="kc">True</span> <span class="k">if</span> <span class="n">pe_all</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span> <span class="p">,</span> 
                      <span class="nb">str</span><span class="p">(</span><span class="n">bin_ave</span><span class="p">)[:</span><span class="mi">4</span><span class="p">],</span> 
                      <span class="nb">str</span><span class="p">(</span><span class="n">bin_all</span><span class="p">)[:</span><span class="mi">4</span><span class="p">],</span>
                      <span class="nb">str</span><span class="p">(</span><span class="kc">True</span> <span class="k">if</span> <span class="n">bin_all</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span> <span class="p">,</span>
                      <span class="nb">str</span><span class="p">(</span><span class="n">bin_tf</span><span class="p">))</span>
        

<span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span>
<span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-style: italic">                                      Unpacked Samples                                       </span>
┏━━━━━━━━┳━━━━━━━┳━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━┓
┃<span style="font-weight: bold">        </span>┃<span style="font-weight: bold">       </span>┃<span style="font-weight: bold">         </span>┃<span style="font-weight: bold">        </span>┃<span style="font-weight: bold">   pe all   </span>┃<span style="font-weight: bold">         </span>┃<span style="font-weight: bold">         </span>┃<span style="font-weight: bold">  bin all   </span>┃<span style="font-weight: bold">         </span>┃
┃<span style="font-weight: bold">  file  </span>┃<span style="font-weight: bold"> .NET  </span>┃<span style="font-weight: bold"> pe data </span>┃<span style="font-weight: bold"> pe all </span>┃<span style="font-weight: bold"> packed @ 7 </span>┃<span style="font-weight: bold"> bin ave </span>┃<span style="font-weight: bold"> bin all </span>┃<span style="font-weight: bold"> packed @ 7 </span>┃<span style="font-weight: bold"> bin t/f </span>┃
┡━━━━━━━━╇━━━━━━━╇━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━┩
│ cf5f9  │ True  │  3.51   │  5.65  │   False    │  4.51   │  5.37   │   False    │  False  │
│ 1b88e  │ False │    0    │  7.40  │    True    │  6.15   │  7.31   │    True    │  False  │
│ 2333c  │ False │  6.69   │  6.69  │   False    │  5.28   │  6.34   │   False    │  False  │
│ 7b277  │ True  │  0.00   │  1.81  │   False    │  6.04   │  7.30   │    True    │  False  │
│ 2b3d3  │ False │  5.04   │  6.18  │   False    │  5.06   │  6.15   │   False    │  False  │
│ 967bd  │ False │  7.87   │  7.87  │    True    │  5.65   │  7.32   │    True    │  False  │
│ 931a0  │ False │  7.87   │  7.87  │    True    │  5.65   │  7.32   │    True    │  False  │
│ 72f63  │ False │  4.65   │  6.59  │   False    │  5.55   │  7.11   │    True    │  False  │
│ ee75b  │ False │  6.59   │  6.62  │   False    │  5.43   │  7.79   │    True    │  False  │
│ 65be9  │ False │  3.69   │  5.20  │   False    │  4.73   │  5.22   │   False    │  False  │
│ 0f001  │ False │  6.52   │  6.70  │   False    │  5.26   │  7.79   │    True    │  False  │
│ dc305  │ False │  1.26   │  5.73  │   False    │  5.58   │  7.07   │    True    │  False  │
│ 82c44  │ False │    0    │  7.55  │    True    │  5.02   │  7.32   │    True    │  False  │
│ 1d69f  │ False │  4.41   │  6.58  │   False    │  5.52   │  6.98   │   False    │  False  │
│ 75bae  │ False │  6.45   │  6.45  │   False    │  5.12   │  7.27   │    True    │  False  │
│ e8ad8  │ False │    0    │  7.27  │    True    │  6.03   │  7.32   │    True    │  False  │
│ 6057d  │ False │  5.05   │  5.99  │   False    │  5.07   │  5.86   │   False    │  False  │
│ ed6eb  │ True  │  7.99   │  7.99  │    True    │  5.98   │  7.31   │    True    │  False  │
│ 967bd  │ False │  7.87   │  7.87  │    True    │  5.65   │  7.32   │    True    │  False  │
│ 443bb  │ False │  6.58   │  6.58  │   False    │  4.43   │  7.71   │    True    │  False  │
│ 4076a  │ True  │  4.88   │  5.52  │   False    │  4.22   │  5.65   │   False    │  False  │
│ f1c92  │ False │  7.52   │  7.52  │    True    │  5.69   │  7.30   │    True    │  False  │
│ 0a5cd  │ False │  6.65   │  6.65  │   False    │  5.40   │  7.79   │    True    │  False  │
│ 0ffc3  │ False │    0    │  7.41  │    True    │  6.15   │  7.32   │    True    │  False  │
│ 31a4d  │ False │  6.60   │  6.60  │   False    │  4.42   │  7.49   │    True    │  False  │
└────────┴───────┴─────────┴────────┴────────────┴─────────┴─────────┴────────────┴─────────┘
</pre>

</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Conclusions">
<a class="anchor" href="#Conclusions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusions<a class="anchor-link" href="#Conclusions"> </a>
</h2>
<h3 id="Entropy-May-Not-Be-Useful-for-.NET">
<a class="anchor" href="#Entropy-May-Not-Be-Useful-for-.NET" aria-hidden="true"><span class="octicon octicon-link"></span></a>Entropy May Not Be Useful for .NET<a class="anchor-link" href="#Entropy-May-Not-Be-Useful-for-.NET"> </a>
</h3>
<p>For <strong>.NET</strong> in atleast one sample <code>3664a0db89a9f1a8bf439d8117943d3e042abe488a761dc6c8e18b90d6081298</code> which was packed had an entropy in the <code>4</code> range but when unpacked <code>2333c19020f6e928198cea31c05dd685055991c921f3a1cd32ad9817b6c704e6</code> the entropy was in the <code>6</code> range. From this we can conclude that entropy may have no relation to the packed status of a .NET binary.</p>
<h3 id="Bintropy-Has-A-Poor-Packed-Detection-Rate-with-Default-Values">
<a class="anchor" href="#Bintropy-Has-A-Poor-Packed-Detection-Rate-with-Default-Values" aria-hidden="true"><span class="octicon octicon-link"></span></a>Bintropy Has A Poor Packed Detection Rate with Default Values<a class="anchor-link" href="#Bintropy-Has-A-Poor-Packed-Detection-Rate-with-Default-Values"> </a>
</h3>
<p>For detecting packed samples using the default threashold the failure rate was <code>16/26</code>, however there were no unpacked false positives. One conclusion we can draw from this is that the tool can the relied on when it detects a packed sample (ie, the sample is probably packed) but it cannot be relied on for a decision, as it has a high false negative rate. This could be used as a filter, but not as a decision metric.</p>
<h3 id="General-Conclusions">
<a class="anchor" href="#General-Conclusions" aria-hidden="true"><span class="octicon octicon-link"></span></a>General Conclusions<a class="anchor-link" href="#General-Conclusions"> </a>
</h3>
<p>The results from our small "pseudoscientific" study do not match the results from the two academic papers refernced in our overview (99% and 97% accuracy). In our study we had a high fidelity when detecting packed sample (ie. if it was detected as packed it was in fact packed) however, we also have very high false negative rates (ie. if it was detected as not-packed there was an over 50% chance that it was actually packed). From this we can draw two conclusions, obviously the first, this was not a scientific study (more data needed) and the second, we cannot use entropy alone for packer identification, it must be combined with other metrics.</p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/research/entropy/unpacking/malware/2022/05/26/does-entropy-matter.html" hidden></a>
</article>
