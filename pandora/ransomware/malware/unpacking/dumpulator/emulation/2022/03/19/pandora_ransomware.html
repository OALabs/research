<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Pandora Ransomware | OALABS Research</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Pandora Ransomware" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Analysis of Pandora ransomware including some fun unpacking" />
<meta property="og:description" content="Analysis of Pandora ransomware including some fun unpacking" />
<link rel="canonical" href="https://research.openanalysis.net/pandora/ransomware/malware/unpacking/dumpulator/emulation/2022/03/19/pandora_ransomware.html" />
<meta property="og:url" content="https://research.openanalysis.net/pandora/ransomware/malware/unpacking/dumpulator/emulation/2022/03/19/pandora_ransomware.html" />
<meta property="og:site_name" content="OALABS Research" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-03-19T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Pandora Ransomware" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-19T00:00:00-05:00","datePublished":"2022-03-19T00:00:00-05:00","description":"Analysis of Pandora ransomware including some fun unpacking","headline":"Pandora Ransomware","mainEntityOfPage":{"@type":"WebPage","@id":"https://research.openanalysis.net/pandora/ransomware/malware/unpacking/dumpulator/emulation/2022/03/19/pandora_ransomware.html"},"url":"https://research.openanalysis.net/pandora/ransomware/malware/unpacking/dumpulator/emulation/2022/03/19/pandora_ransomware.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://research.openanalysis.net/feed.xml" title="OALABS Research" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">OALABS Research</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Pandora Ransomware</h1><p class="page-description">Analysis of Pandora ransomware including some fun unpacking</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-03-19T00:00:00-05:00" itemprop="datePublished">
        Mar 19, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      14 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#pandora">pandora</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#ransomware">ransomware</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#malware">malware</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#unpacking">unpacking</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#dumpulator">dumpulator</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#emulation">emulation</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2022-03-19-pandora_ransomware.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a></li>
<li class="toc-entry toc-h2"><a href="#Stage-1-Unpacking">Stage 1 Unpacking </a></li>
<li class="toc-entry toc-h2"><a href="#Payload-Obfuscation">Payload Obfuscation </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Control-Flow-Obfuscation">Control Flow Obfuscation </a></li>
<li class="toc-entry toc-h3"><a href="#Deobfuscation-Steps">Deobfuscation Steps </a></li>
<li class="toc-entry toc-h3"><a href="#IDA-Produce-Basic-Block-Table">IDA Produce Basic Block Table </a></li>
<li class="toc-entry toc-h3"><a href="#Emulate-Basic-Blocks">Emulate Basic Blocks </a></li>
<li class="toc-entry toc-h3"><a href="#IDA-Patch-Basic-Blocks">IDA Patch Basic Blocks </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-03-19-pandora_ransomware.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>
</p>
<center>
    <div class="jekyll-twitter-plugin"><p>There was a 'Not Found' error fetching URL: 'https://twitter.com/kienbigmummy/status/1504750051956240384/photo/1'</p></div>
</center>


</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p>Sample: <code>5b56c5d86347e164c6e571c86dbf5b1535eae6b979fede6ed66b01e79ea33b7b</code></p>
<p>Sample is x64 and is on <a href="https://malshare.com/sample.php?action=detail&amp;hash=5b56c5d86347e164c6e571c86dbf5b1535eae6b979fede6ed66b01e79ea33b7b">malshare</a>.</p>
<p>Unpacked sample <a href="https://malshare.com/sample.php?action=detail&amp;hash=2619862c382d3e375f13f3859c6ab44db1a4bce905b4a617df2390fbf36902e7">2619862c382d3e375f13f3859c6ab44db1a4bce905b4a617df2390fbf36902e7</a></p>
<p><strong>References</strong></p>
<ul>
<li>f0wl blog <a href="https://dissectingmalwa.re/blog/pandora/">Pandora Ransomware</a>
</li>
<li><a href="https://synthesis.to/2021/03/03/flattening_detection.html">Control Flow Flattening</a></li>
<li><a href="%5Dhttps://blog.quarkslab.com/deobfuscation-recovering-an-ollvm-protected-program.html">Deobfuscation - Recovering an ollvm</a></li>
<li><a href="https://github.com/eset/stadeo">stadeo deobfuscation tool</a></li>
<li><a href="https://eshard.com/posts/D810-a-journey-into-control-flow-unflattening">Control Flow Unflattening</a></li>
</ul>
<h2 id="Stage-1-Unpacking">
<a class="anchor" href="#Stage-1-Unpacking" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stage 1 Unpacking<a class="anchor-link" href="#Stage-1-Unpacking"> </a>
</h2>
<p>Stage1 is just a modified UPX. We can unpack it with the following steps.</p>
<ul>
<li>removed X permissions from the first PE section memory</li>
<li>run till exception</li>
<li>excpetion EIP is OEP for PE </li>
<li>dump and reconstruct imports with Scylla</li>
</ul>
<h2 id="Payload-Obfuscation">
<a class="anchor" href="#Payload-Obfuscation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Payload Obfuscation<a class="anchor-link" href="#Payload-Obfuscation"> </a>
</h2>
<p>The ransomware has both obfuscated strings and control flow obfuscation. The obfuscated strings can be deobfuscated directly with an emulator call to the deobfuscation function. The cf obfuscation requires special attention.</p>
<h3 id="Control-Flow-Obfuscation">
<a class="anchor" href="#Control-Flow-Obfuscation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Control Flow Obfuscation<a class="anchor-link" href="#Control-Flow-Obfuscation"> </a>
</h3>
<p>Many function in the binary have been obfuscated using two layers of obfuscation. First control flow flattening (CFF) has been applied to convert the original code basic blocks into a state machine and force all flow through a dispatcher. For each state the dispatcher determines the control flow. Then a second layer of obfuscation has been applied to the basic blocks that make up the dispatcher. The dispatcher bbs are seperated with conditional jmp statements that require a lookup in a hard coded jmp table. This hard coded jmp table may be an attempt to frustrate symbolic execution (a traditional tool for CFF deobfuscation.) The flow is discribed below.</p>
<ul>
<li>basic blocks (bb) that contain the actual payload code are accessed via a state machine - each bb has a state </li>
<li>the dispatcher for the state machine uses the bb state as a key which is used to calculate jumps between it's own (dispatcher) basic blocks</li>
<li>the (dispatcher) bb uses a compare with the key/state to generate a conditional lookup in a hard coded jump table</li>
<li>the jump table contains an obfuscated address of the next bb, either another dispatcher bb or the original code bb</li>
</ul>
<h3 id="Deobfuscation-Steps">
<a class="anchor" href="#Deobfuscation-Steps" aria-hidden="true"><span class="octicon octicon-link"></span></a>Deobfuscation Steps<a class="anchor-link" href="#Deobfuscation-Steps"> </a>
</h3>
<p>Our approach is to seperate the dispatcher bb from the payload bb. For each dispatcher bb the code is emulated with all conditions to generate the conditional jump addresses. The bb is then replaced with a simple compare and conditional jmp. Emulation is done with <a href="https://github.com/mrexodia/dumpulator">Dumpulator</a>.</p>
<p>Once the dispatcher has been deobfuscated we should be able to see the control flow for the payload bb and futher simplify the dispatcher using more traditional tools, possibly removing it completely.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>r14 = FFFFFFFFAE6529F8

00007FF6C4B068E3   | 3D E1A53B17           | cmp eax,173BA5E1                                      | not part of cf
00007FF6C4B068E8   | BA D8000000           | mov edx,D8                                            | rdx = 0xd8
00007FF6C4B068ED   | BD 20010000           | mov ebp,120                                           | rbp = 0x120
00007FF6C4B068F2   | 48:0F4CD5             | cmovl rdx,rbp                                         | 
00007FF6C4B068F6   | 48:8B1411             | mov rdx,qword ptr ds:[rcx+rdx]  | table:00007FF6C4B69640 + rdx = rdx=00007FF7164B42E9
00007FF6C4B068FA   | 4C:01F2               | add rdx,r14                     |rdx=00007FF7164B42E9 + r14
00007FF6C4B068FD   | FFE2                  | jmp rdx                         | rdx = 00007FF6C4B06CE1</code></pre>
<p>if the jump is relative it's for a code bb</p>
<p>if the jump is reg then it's a cf bb</p>
<p>if there is a ret this is the end</p>
<p>start = 0x00007FF6C4B067F0 
last_jmp = 0x00007FF6C4B0706C
end = 0x00007FF6C4B070D0</p>
<p>build a table of bb the start is next head after jmp, end is jmp
emulate
patch the jmp for each table entry</p>
<h3 id="IDA-Produce-Basic-Block-Table">
<a class="anchor" href="#IDA-Produce-Basic-Block-Table" aria-hidden="true"><span class="octicon octicon-link"></span></a>IDA Produce Basic Block Table<a class="anchor-link" href="#IDA-Produce-Basic-Block-Table"> </a>
</h3>
<p>There are two dispatcher bb formats, one that uses <code>cmovl</code>, <code>cmovz</code>, and one that uses <code>setl</code> and <code>setz</code>. We need to match both patterns and determine the type of condition for our jmp statement, and the eax cmp value. For each bb record the following information so it can be used in our emulator.</p>
<ul>
<li>bb start</li>
<li>bb end</li>
<li>add cmov instruction </li>
<li>type of cmov instruction (l,z)</li>
<li>eax cmp value</li>
<li>jmp register</li>
</ul>
<p>Results: (bb_start, bb_end, eax_value, jmp_condition,jmp_condition_address, jmp_register)</p>
<div class="highlight"><pre><span></span><span class="c1"># Basic blocks for dispatcher</span>
<span class="n">bb_table</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># List of addresses of original code basic blocks</span>
<span class="n">bb_orig_table</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ptr</span> <span class="o">=</span> <span class="mh">0x00007FF6C4B067C8</span>
<span class="n">end</span> <span class="o">=</span> <span class="mh">0x00007FF6C4B070D0</span> 
<span class="n">bb_start</span> <span class="o">=</span> <span class="n">ptr</span>
<span class="k">while</span> <span class="n">ptr</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'jmp'</span><span class="p">:</span> 
        <span class="n">op_type</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">op_type</span> <span class="o">==</span> <span class="n">o_reg</span><span class="p">:</span>
            <span class="c1"># This is a cf bb save it</span>
            <span class="n">reg_name</span> <span class="o">=</span> <span class="n">print_operand</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Get eax value</span>
            <span class="n">first_instruction</span> <span class="o">=</span> <span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">bb_start</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">first_instruction</span> <span class="o">==</span> <span class="s1">'cmp'</span><span class="p">:</span>
                <span class="n">eax_cmp_value</span> <span class="o">=</span> <span class="n">get_operand_value</span><span class="p">(</span><span class="n">bb_start</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Find cmov instruction</span>
                <span class="n">bb_ptr</span> <span class="o">=</span> <span class="n">bb_start</span>
                <span class="n">jmp_condition</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">jmp_condition_address</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">while</span> <span class="n">bb_ptr</span> <span class="o">&lt;</span> <span class="n">ptr</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">'cmovl'</span> <span class="o">==</span> <span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">bb_ptr</span><span class="p">):</span>
                        <span class="n">jmp_condition</span> <span class="o">=</span> <span class="s1">'cmovl'</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">'cmovz'</span> <span class="o">==</span> <span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">bb_ptr</span><span class="p">):</span>
                        <span class="n">jmp_condition</span> <span class="o">=</span> <span class="s1">'cmovz'</span>
                        <span class="k">break</span>
                    <span class="n">bb_ptr</span>  <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">bb_ptr</span><span class="p">)</span>
                <span class="n">jmp_condition_address</span> <span class="o">=</span> <span class="n">bb_ptr</span>
                <span class="c1"># Check results of cmov find</span>
                <span class="k">if</span> <span class="n">jmp_condition</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># This bb doesn't match our pattern skip it</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"BB at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> doesn't contain cmovl or cmovz, skip it"</span><span class="p">)</span>
                    <span class="n">ptr</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="n">is_code</span><span class="p">(</span><span class="n">ida_bytes</span><span class="o">.</span><span class="n">get_full_flags</span><span class="p">(</span><span class="n">ptr</span><span class="p">)):</span>
                        <span class="n">ptr</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
                    <span class="n">bb_start</span> <span class="o">=</span> <span class="n">ptr</span>
                    <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">first_instruction</span> <span class="o">==</span> <span class="s1">'xor'</span><span class="p">:</span>
                <span class="c1"># assume next instruction is the cmp, we should check</span>
                <span class="n">ptr_cmp</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">bb_start</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">"cmp"</span> <span class="o">!=</span> <span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ptr_cmp</span><span class="p">):</span>
                    <span class="c1"># This bb doesn't match our pattern skip it</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"BB at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> doesn't contain have cmp after xor, skip it"</span><span class="p">)</span>
                    <span class="n">ptr</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="n">is_code</span><span class="p">(</span><span class="n">ida_bytes</span><span class="o">.</span><span class="n">get_full_flags</span><span class="p">(</span><span class="n">ptr</span><span class="p">)):</span>
                        <span class="n">ptr</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
                    <span class="n">bb_start</span> <span class="o">=</span> <span class="n">ptr</span>
                    <span class="k">continue</span>
                <span class="n">eax_cmp_value</span> <span class="o">=</span> <span class="n">get_operand_value</span><span class="p">(</span><span class="n">ptr_cmp</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Find cmov instruction</span>
                <span class="n">bb_ptr</span> <span class="o">=</span> <span class="n">bb_start</span>
                <span class="n">jmp_condition</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">jmp_condition_address</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">while</span> <span class="n">bb_ptr</span> <span class="o">&lt;</span> <span class="n">ptr</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">'setl'</span> <span class="o">==</span> <span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">bb_ptr</span><span class="p">):</span>
                        <span class="n">jmp_condition</span> <span class="o">=</span> <span class="s1">'setl'</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">'setz'</span> <span class="o">==</span> <span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">bb_ptr</span><span class="p">):</span>
                        <span class="n">jmp_condition</span> <span class="o">=</span> <span class="s1">'setz'</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">'setnz'</span> <span class="o">==</span> <span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">bb_ptr</span><span class="p">):</span>
                        <span class="n">jmp_condition</span> <span class="o">=</span> <span class="s1">'setnz'</span>
                        <span class="k">break</span>
                    <span class="n">bb_ptr</span>  <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">bb_ptr</span><span class="p">)</span>
                <span class="n">jmp_condition_address</span> <span class="o">=</span> <span class="n">bb_ptr</span>
                <span class="c1"># Check results of cmov find</span>
                <span class="k">if</span> <span class="n">jmp_condition</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># This bb doesn't match our pattern skip it</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"BB at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> doesn't contain setl or setz, skip it"</span><span class="p">)</span>
                    <span class="n">ptr</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="n">is_code</span><span class="p">(</span><span class="n">ida_bytes</span><span class="o">.</span><span class="n">get_full_flags</span><span class="p">(</span><span class="n">ptr</span><span class="p">)):</span>
                        <span class="n">ptr</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
                    <span class="n">bb_start</span> <span class="o">=</span> <span class="n">ptr</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This bb doesn't match our pattern skip it</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"BB at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> doesn't match pattern, skip it"</span><span class="p">)</span>
                <span class="n">ptr</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">is_code</span><span class="p">(</span><span class="n">ida_bytes</span><span class="o">.</span><span class="n">get_full_flags</span><span class="p">(</span><span class="n">ptr</span><span class="p">)):</span>
                    <span class="n">ptr</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
                <span class="n">bb_start</span> <span class="o">=</span> <span class="n">ptr</span>
                <span class="k">continue</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Dispatcher bb </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">bb_table</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bb_start</span><span class="p">,</span><span class="n">ptr</span><span class="p">,</span><span class="n">eax_cmp_value</span><span class="p">,</span><span class="n">jmp_condition</span><span class="p">,</span><span class="n">jmp_condition_address</span><span class="p">,</span><span class="n">reg_name</span><span class="p">))</span>
            <span class="n">ptr</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">is_code</span><span class="p">(</span><span class="n">ida_bytes</span><span class="o">.</span><span class="n">get_full_flags</span><span class="p">(</span><span class="n">ptr</span><span class="p">)):</span>
                <span class="n">ptr</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
            <span class="n">bb_start</span> <span class="o">=</span> <span class="n">ptr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is code bb don't save it</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Original code bb </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">bb_orig_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bb_start</span><span class="p">)</span>
            <span class="n">ptr</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">is_code</span><span class="p">(</span><span class="n">ida_bytes</span><span class="o">.</span><span class="n">get_full_flags</span><span class="p">(</span><span class="n">ptr</span><span class="p">)):</span>
                <span class="n">ptr</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
            <span class="n">bb_start</span> <span class="o">=</span> <span class="n">ptr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Emulate-Basic-Blocks">
<a class="anchor" href="#Emulate-Basic-Blocks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Emulate Basic Blocks<a class="anchor-link" href="#Emulate-Basic-Blocks"> </a>
</h3>
<p>For each dispatcher bb emulate the block both satisfying the condition and not satisfying it to produce both the jmp address for the conditional jmp and the jmp address for the unconditional jmp.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">DUMP_FILE</span> <span class="o">=</span> <span class="s1">'/tmp/pandora.dmp'</span>

<span class="kn">from</span> <span class="nn">dumpulator</span> <span class="kn">import</span> <span class="n">Dumpulator</span>
<span class="n">dp</span> <span class="o">=</span> <span class="n">Dumpulator</span><span class="p">(</span><span class="n">DUMP_FILE</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># temp_addr = dp.allocate(256)</span>
<span class="c1"># dp.call(0x140001000, [temp_addr, 0x140017000])</span>
<span class="c1"># decrypted = dp.read_str(temp_addr)</span>
<span class="c1"># print(f"decrypted: '{decrypted}'")</span>

<span class="c1"># # Obfuscation key for table values</span>
<span class="c1"># dp.regs.r14 = 0xFFFFFFFFAE6529F8</span>
<span class="c1"># # Pointer to the jmp table </span>
<span class="c1"># dp.regs.rcx = 0x00007FF6C4B69640</span>
<span class="c1"># dp.start(0x00007FF6C4B068E8,end=0x00007FF6C4B068FD)</span>
<span class="n">dp</span> <span class="o">=</span> <span class="n">Dumpulator</span><span class="p">(</span><span class="n">DUMP_FILE</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#(bb_start, bb_end, eax_value, jmp_condition,jmp_condition_address, jmp_register)</span>
<span class="c1">#bb_table = [(0x7ff6c4b067f0, 0x7ff6c4b06817, 0x10bc6c78, 'cmovl', 0x7ff6c4b067fa, 'rdx'), (0x7ff6c4b06819, 0x7ff6c4b0682e, 0xffffffffc30bae2e, 'cmovl', 0x7ff6c4b06823, 'rdx'), (0x7ff6c4b06830, 0x7ff6c4b06845, 0xffffffffa2992627, 'cmovl', 0x7ff6c4b0683a, 'rdx'), (0x7ff6c4b06847, 0x7ff6c4b06861, 0xffffffffa22a16af, 'cmovl', 0x7ff6c4b06856, 'rdx'), (0x7ff6c4b06863, 0x7ff6c4b0687d, 0xffffffff8cbc0434, 'cmovz', 0x7ff6c4b06872, 'rcx'), (0x7ff6c4b068b0, 0x7ff6c4b068c5, 0x6c249751, 'cmovl', 0x7ff6c4b068ba, 'rdx'), (0x7ff6c4b068c7, 0x7ff6c4b068e1, 0x3b2b8a1e, 'cmovl', 0x7ff6c4b068d6, 'rdx'), (0x7ff6c4b068e3, 0x7ff6c4b068fd, 0x173ba5e1, 'cmovl', 0x7ff6c4b068f2, 'rdx'), (0x7ff6c4b068ff, 0x7ff6c4b06918, 0x10bc6c78, 'setz', 0x7ff6c4b06906, 'rcx'), (0x7ff6c4b069b0, 0x7ff6c4b069ca, 0xffffffffd43fb344, 'cmovl', 0x7ff6c4b069bf, 'rdx'), (0x7ff6c4b069cc, 0x7ff6c4b069e6, 0xffffffffcef7092e, 'cmovl', 0x7ff6c4b069db, 'rdx'), (0x7ff6c4b069e8, 0x7ff6c4b06a02, 0xffffffffc30bae2e, 'cmovz', 0x7ff6c4b069f7, 'rcx'), (0x7ff6c4b06a30, 0x7ff6c4b06a4a, 0x7d71a1e3, 'cmovl', 0x7ff6c4b06a3f, 'rdx'), (0x7ff6c4b06a4c, 0x7ff6c4b06a66, 0x7a980236, 'cmovl', 0x7ff6c4b06a5b, 'rdx'), (0x7ff6c4b06a68, 0x7ff6c4b06a82, 0x6c249751, 'cmovz', 0x7ff6c4b06a77, 'rcx'), (0x7ff6c4b06a99, 0x7ff6c4b06ab3, 0xffffffffc094d6c9, 'cmovl', 0x7ff6c4b06aa8, 'rdx'), (0x7ff6c4b06ab5, 0x7ff6c4b06acf, 0xffffffffa2992627, 'cmovz', 0x7ff6c4b06ac4, 'rcx'), (0x7ff6c4b06b09, 0x7ff6c4b06b1e, 0x3cd69d30, 'setl', 0x7ff6c4b06b10, 'rdx'), (0x7ff6c4b06b20, 0x7ff6c4b06b39, 0x3b2b8a1e, 'setnz', 0x7ff6c4b06b27, 'rcx'), (0x7ff6c4b06b63, 0x7ff6c4b06b7d, 0xffffffffecce8ff1, 'cmovl', 0x7ff6c4b06b72, 'rdx'), (0x7ff6c4b06b7f, 0x7ff6c4b06b99, 0xffffffffd43fb344, 'cmovz', 0x7ff6c4b06b8e, 'rcx'), (0x7ff6c4b06bbb, 0x7ff6c4b06bd5, 0x7d9d86f3, 'cmovl', 0x7ff6c4b06bca, 'rdx'), (0x7ff6c4b06bd7, 0x7ff6c4b06bf1, 0x7d71a1e3, 'cmovz', 0x7ff6c4b06be6, 'rcx'), (0x7ff6c4b06c45, 0x7ff6c4b06c5f, 0xffffffffa22a16af, 'cmovz', 0x7ff6c4b06c54, 'rcx'), (0x7ff6c4b06ce1, 0x7ff6c4b06cfb, 0x173ba5e1, 'cmovz', 0x7ff6c4b06cf0, 'rcx'), (0x7ff6c4b06e83, 0x7ff6c4b06e9d, 0xffffffffcef7092e, 'cmovz', 0x7ff6c4b06e92, 'rcx'), (0x7ff6c4b06edc, 0x7ff6c4b06ef6, 0x7a980236, 'cmovz', 0x7ff6c4b06eeb, 'rcx'), (0x7ff6c4b06f3d, 0x7ff6c4b06f56, 0xffffffffc094d6c9, 'setz', 0x7ff6c4b06f44, 'rcx'), (0x7ff6c4b07008, 0x7ff6c4b07022, 0x3cd69d30, 'cmovz', 0x7ff6c4b07017, 'rcx'), (0x7ff6c4b07052, 0x7ff6c4b0706c, 0xffffffffecce8ff1, 'cmovz', 0x7ff6c4b07061, 'rcx')]</span>
<span class="c1"># Above is the old table that was missing one bb because we started our search too late</span>
<span class="n">bb_table</span> <span class="o">=</span> <span class="p">[(</span><span class="mh">0x7ff6c4b067c8</span><span class="p">,</span> <span class="mh">0x7ff6c4b067e2</span><span class="p">,</span> <span class="mh">0x7d9d86f3</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b067d7</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b067f0</span><span class="p">,</span> <span class="mh">0x7ff6c4b06817</span><span class="p">,</span> <span class="mh">0x10bc6c78</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mh">0x7ff6c4b067fa</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06819</span><span class="p">,</span> <span class="mh">0x7ff6c4b0682e</span><span class="p">,</span> <span class="mh">0xffffffffc30bae2e</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06823</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06830</span><span class="p">,</span> <span class="mh">0x7ff6c4b06845</span><span class="p">,</span> <span class="mh">0xffffffffa2992627</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mh">0x7ff6c4b0683a</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06847</span><span class="p">,</span> <span class="mh">0x7ff6c4b06861</span><span class="p">,</span> <span class="mh">0xffffffffa22a16af</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06856</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06863</span><span class="p">,</span> <span class="mh">0x7ff6c4b0687d</span><span class="p">,</span> <span class="mh">0xffffffff8cbc0434</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06872</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b068b0</span><span class="p">,</span> <span class="mh">0x7ff6c4b068c5</span><span class="p">,</span> <span class="mh">0x6c249751</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mh">0x7ff6c4b068ba</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b068c7</span><span class="p">,</span> <span class="mh">0x7ff6c4b068e1</span><span class="p">,</span> <span class="mh">0x3b2b8a1e</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mh">0x7ff6c4b068d6</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b068e3</span><span class="p">,</span> <span class="mh">0x7ff6c4b068fd</span><span class="p">,</span> <span class="mh">0x173ba5e1</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mh">0x7ff6c4b068f2</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b068ff</span><span class="p">,</span> <span class="mh">0x7ff6c4b06918</span><span class="p">,</span> <span class="mh">0x10bc6c78</span><span class="p">,</span> <span class="s1">'setz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06906</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b069b0</span><span class="p">,</span> <span class="mh">0x7ff6c4b069ca</span><span class="p">,</span> <span class="mh">0xffffffffd43fb344</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mh">0x7ff6c4b069bf</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b069cc</span><span class="p">,</span> <span class="mh">0x7ff6c4b069e6</span><span class="p">,</span> <span class="mh">0xffffffffcef7092e</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mh">0x7ff6c4b069db</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b069e8</span><span class="p">,</span> <span class="mh">0x7ff6c4b06a02</span><span class="p">,</span> <span class="mh">0xffffffffc30bae2e</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b069f7</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06a30</span><span class="p">,</span> <span class="mh">0x7ff6c4b06a4a</span><span class="p">,</span> <span class="mh">0x7d71a1e3</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06a3f</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06a4c</span><span class="p">,</span> <span class="mh">0x7ff6c4b06a66</span><span class="p">,</span> <span class="mh">0x7a980236</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06a5b</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06a68</span><span class="p">,</span> <span class="mh">0x7ff6c4b06a82</span><span class="p">,</span> <span class="mh">0x6c249751</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06a77</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06a99</span><span class="p">,</span> <span class="mh">0x7ff6c4b06ab3</span><span class="p">,</span> <span class="mh">0xffffffffc094d6c9</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06aa8</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06ab5</span><span class="p">,</span> <span class="mh">0x7ff6c4b06acf</span><span class="p">,</span> <span class="mh">0xffffffffa2992627</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06ac4</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06b09</span><span class="p">,</span> <span class="mh">0x7ff6c4b06b1e</span><span class="p">,</span> <span class="mh">0x3cd69d30</span><span class="p">,</span> <span class="s1">'setl'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06b10</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06b20</span><span class="p">,</span> <span class="mh">0x7ff6c4b06b39</span><span class="p">,</span> <span class="mh">0x3b2b8a1e</span><span class="p">,</span> <span class="s1">'setnz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06b27</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06b63</span><span class="p">,</span> <span class="mh">0x7ff6c4b06b7d</span><span class="p">,</span> <span class="mh">0xffffffffecce8ff1</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06b72</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06b7f</span><span class="p">,</span> <span class="mh">0x7ff6c4b06b99</span><span class="p">,</span> <span class="mh">0xffffffffd43fb344</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06b8e</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06bbb</span><span class="p">,</span> <span class="mh">0x7ff6c4b06bd5</span><span class="p">,</span> <span class="mh">0x7d9d86f3</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06bca</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06bd7</span><span class="p">,</span> <span class="mh">0x7ff6c4b06bf1</span><span class="p">,</span> <span class="mh">0x7d71a1e3</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06be6</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06c45</span><span class="p">,</span> <span class="mh">0x7ff6c4b06c5f</span><span class="p">,</span> <span class="mh">0xffffffffa22a16af</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06c54</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06ce1</span><span class="p">,</span> <span class="mh">0x7ff6c4b06cfb</span><span class="p">,</span> <span class="mh">0x173ba5e1</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06cf0</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06e83</span><span class="p">,</span> <span class="mh">0x7ff6c4b06e9d</span><span class="p">,</span> <span class="mh">0xffffffffcef7092e</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06e92</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06edc</span><span class="p">,</span> <span class="mh">0x7ff6c4b06ef6</span><span class="p">,</span> <span class="mh">0x7a980236</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06eeb</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b06f3d</span><span class="p">,</span> <span class="mh">0x7ff6c4b06f56</span><span class="p">,</span> <span class="mh">0xffffffffc094d6c9</span><span class="p">,</span> <span class="s1">'setz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b06f44</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b07008</span><span class="p">,</span> <span class="mh">0x7ff6c4b07022</span><span class="p">,</span> <span class="mh">0x3cd69d30</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b07017</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">),</span> <span class="p">(</span><span class="mh">0x7ff6c4b07052</span><span class="p">,</span> <span class="mh">0x7ff6c4b0706c</span><span class="p">,</span> <span class="mh">0xffffffffecce8ff1</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mh">0x7ff6c4b07061</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">)]</span>
<span class="n">bb_jmp_table</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">emulate_bb</span><span class="p">(</span><span class="n">bb_start</span><span class="p">,</span> <span class="n">bb_end</span><span class="p">,</span> <span class="n">eax_value</span><span class="p">,</span> <span class="n">jmp_reg</span><span class="p">):</span>
    <span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">eflags</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">r15</span> <span class="o">=</span> <span class="mh">0x190</span>
    <span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">r14</span> <span class="o">=</span> <span class="mh">0x0FFFFFFFFAE6529F8</span>
    <span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">r13</span> <span class="o">=</span> <span class="mh">0x10</span>
    <span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">r12</span> <span class="o">=</span> <span class="mh">0x1B0</span>
    <span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">rcx</span> <span class="o">=</span> <span class="mh">0x00007FF6C4B69640</span>
    <span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">rax</span> <span class="o">=</span> <span class="n">eax_value</span>
    <span class="n">dp</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">bb_start</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="n">bb_end</span><span class="p">)</span>
    <span class="n">jmp_reg_value</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">jmp_reg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jmp_reg_value</span>
    
    

<span class="c1">## We need to calculate two jmp addresses conditional on the eax compare</span>
<span class="c1">## based on these we can replace the control bb with conditional jmps based on the compare</span>
<span class="c1"># def get_jmp(start_ea, end_ea, reg_name, jmp_cond):</span>
<span class="c1">#     dp.regs.r15 = 0x190</span>
<span class="c1">#     dp.regs.r14 = 0x0FFFFFFFFAE6529F8</span>
<span class="c1">#     dp.regs.r13 = 0x10</span>
<span class="c1">#     dp.regs.r12 = 0x1B0</span>
<span class="c1">#     dp.regs.rcx = 0x00007FF6C4B69640</span>
<span class="c1">#     if jmp_cond:</span>
        
<span class="c1">#     else:</span>
        
<span class="c1">#     dp.start(start_ea,end=end_ea)</span>
<span class="c1">#     print(hex(dp.regs.__getattr__(reg_name)))</span>


<span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">bb_table</span><span class="p">:</span>
    <span class="n">bb_start</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bb_end</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">eax_value</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">jmp_condition</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">jmp_condition_address</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">jmp_register</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="c1"># One emulation to satisfy conditon and one without</span>
    <span class="k">if</span> <span class="n">jmp_condition</span> <span class="o">==</span> <span class="s1">'cmovl'</span> <span class="ow">or</span> <span class="n">jmp_condition</span> <span class="o">==</span> <span class="s1">'setl'</span><span class="p">:</span>
        <span class="n">jmp_addr_satisfied</span> <span class="o">=</span> <span class="n">emulate_bb</span><span class="p">(</span><span class="n">bb_start</span><span class="p">,</span> <span class="n">bb_end</span><span class="p">,</span> <span class="n">eax_value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jmp_register</span><span class="p">)</span>
        <span class="n">jmp_addr_unsatisfied</span> <span class="o">=</span> <span class="n">emulate_bb</span><span class="p">(</span><span class="n">bb_start</span><span class="p">,</span> <span class="n">bb_end</span><span class="p">,</span> <span class="n">eax_value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jmp_register</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">jmp_condition</span> <span class="o">==</span> <span class="s1">'cmovz'</span> <span class="ow">or</span> <span class="n">jmp_condition</span> <span class="o">==</span> <span class="s1">'setz'</span><span class="p">:</span>
        <span class="n">jmp_addr_satisfied</span> <span class="o">=</span> <span class="n">emulate_bb</span><span class="p">(</span><span class="n">bb_start</span><span class="p">,</span> <span class="n">bb_end</span><span class="p">,</span> <span class="n">eax_value</span><span class="p">,</span> <span class="n">jmp_register</span><span class="p">)</span>
        <span class="n">jmp_addr_unsatisfied</span> <span class="o">=</span> <span class="n">emulate_bb</span><span class="p">(</span><span class="n">bb_start</span><span class="p">,</span> <span class="n">bb_end</span><span class="p">,</span> <span class="n">eax_value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jmp_register</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">jmp_condition</span> <span class="o">==</span> <span class="s1">'setnz'</span><span class="p">:</span>
        <span class="n">jmp_addr_satisfied</span> <span class="o">=</span> <span class="n">emulate_bb</span><span class="p">(</span><span class="n">bb_start</span><span class="p">,</span> <span class="n">bb_end</span><span class="p">,</span> <span class="n">eax_value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jmp_register</span><span class="p">)</span>
        <span class="n">jmp_addr_unsatisfied</span> <span class="o">=</span> <span class="n">emulate_bb</span><span class="p">(</span><span class="n">bb_start</span><span class="p">,</span> <span class="n">bb_end</span><span class="p">,</span> <span class="n">eax_value</span><span class="p">,</span> <span class="n">jmp_register</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"BB </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">bb_end</span><span class="p">)</span><span class="si">}</span><span class="s2"> - jmp_addr_satisfied: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">jmp_addr_satisfied</span><span class="p">)</span><span class="si">}</span><span class="s2"> - jmp_addr_unsatisfied: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">jmp_addr_unsatisfied</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">bb_jmp_table</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bb_start</span><span class="p">,</span><span class="n">bb_end</span><span class="p">,</span><span class="n">eax_value</span><span class="p">,</span><span class="n">jmp_condition</span><span class="p">,</span><span class="n">jmp_condition_address</span><span class="p">,</span><span class="n">jmp_register</span><span class="p">,</span><span class="n">jmp_addr_satisfied</span><span class="p">,</span><span class="n">jmp_addr_unsatisfied</span><span class="p">))</span>


<span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">bb_jmp_table</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>BB 0x7ff6c4b067c8:0x7ff6c4b067e2 - jmp_addr_satisfied: 0x7ff6c4b070d1 - jmp_addr_unsatisfied: 0x7ff6c4b067f0
BB 0x7ff6c4b067f0:0x7ff6c4b06817 - jmp_addr_satisfied: 0x7ff6c4b06819 - jmp_addr_unsatisfied: 0x7ff6c4b068b0
BB 0x7ff6c4b06819:0x7ff6c4b0682e - jmp_addr_satisfied: 0x7ff6c4b06830 - jmp_addr_unsatisfied: 0x7ff6c4b069b0
BB 0x7ff6c4b06830:0x7ff6c4b06845 - jmp_addr_satisfied: 0x7ff6c4b06847 - jmp_addr_unsatisfied: 0x7ff6c4b06a99
BB 0x7ff6c4b06847:0x7ff6c4b06861 - jmp_addr_satisfied: 0x7ff6c4b06863 - jmp_addr_unsatisfied: 0x7ff6c4b06c45
BB 0x7ff6c4b06863:0x7ff6c4b0687d - jmp_addr_satisfied: 0x7ff6c4b0687f - jmp_addr_unsatisfied: 0x7ff6c4b067f0
BB 0x7ff6c4b068b0:0x7ff6c4b068c5 - jmp_addr_satisfied: 0x7ff6c4b068c7 - jmp_addr_unsatisfied: 0x7ff6c4b06a30
BB 0x7ff6c4b068c7:0x7ff6c4b068e1 - jmp_addr_satisfied: 0x7ff6c4b068e3 - jmp_addr_unsatisfied: 0x7ff6c4b06b09
BB 0x7ff6c4b068e3:0x7ff6c4b068fd - jmp_addr_satisfied: 0x7ff6c4b068ff - jmp_addr_unsatisfied: 0x7ff6c4b06ce1
BB 0x7ff6c4b068ff:0x7ff6c4b06918 - jmp_addr_satisfied: 0x7ff6c4b0691a - jmp_addr_unsatisfied: 0x7ff6c4b067f0
BB 0x7ff6c4b069b0:0x7ff6c4b069ca - jmp_addr_satisfied: 0x7ff6c4b069cc - jmp_addr_unsatisfied: 0x7ff6c4b06b63
BB 0x7ff6c4b069cc:0x7ff6c4b069e6 - jmp_addr_satisfied: 0x7ff6c4b069e8 - jmp_addr_unsatisfied: 0x7ff6c4b06e83
BB 0x7ff6c4b069e8:0x7ff6c4b06a02 - jmp_addr_satisfied: 0x7ff6c4b06a04 - jmp_addr_unsatisfied: 0x7ff6c4b067f0
BB 0x7ff6c4b06a30:0x7ff6c4b06a4a - jmp_addr_satisfied: 0x7ff6c4b06a4c - jmp_addr_unsatisfied: 0x7ff6c4b06bbb
BB 0x7ff6c4b06a4c:0x7ff6c4b06a66 - jmp_addr_satisfied: 0x7ff6c4b06a68 - jmp_addr_unsatisfied: 0x7ff6c4b06edc
BB 0x7ff6c4b06a68:0x7ff6c4b06a82 - jmp_addr_satisfied: 0x7ff6c4b06a84 - jmp_addr_unsatisfied: 0x7ff6c4b067f0
BB 0x7ff6c4b06a99:0x7ff6c4b06ab3 - jmp_addr_satisfied: 0x7ff6c4b06ab5 - jmp_addr_unsatisfied: 0x7ff6c4b06f3d
BB 0x7ff6c4b06ab5:0x7ff6c4b06acf - jmp_addr_satisfied: 0x7ff6c4b06ad1 - jmp_addr_unsatisfied: 0x7ff6c4b067f0
BB 0x7ff6c4b06b09:0x7ff6c4b06b1e - jmp_addr_satisfied: 0x7ff6c4b06b20 - jmp_addr_unsatisfied: 0x7ff6c4b07008
BB 0x7ff6c4b06b20:0x7ff6c4b06b39 - jmp_addr_satisfied: 0x7ff6c4b067f0 - jmp_addr_unsatisfied: 0x7ff6c4b06b3b
BB 0x7ff6c4b06b63:0x7ff6c4b06b7d - jmp_addr_satisfied: 0x7ff6c4b06b7f - jmp_addr_unsatisfied: 0x7ff6c4b07052
BB 0x7ff6c4b06b7f:0x7ff6c4b06b99 - jmp_addr_satisfied: 0x7ff6c4b06b9b - jmp_addr_unsatisfied: 0x7ff6c4b067f0
BB 0x7ff6c4b06bbb:0x7ff6c4b06bd5 - jmp_addr_satisfied: 0x7ff6c4b06bd7 - jmp_addr_unsatisfied: 0x7ff6c4b067c8
BB 0x7ff6c4b06bd7:0x7ff6c4b06bf1 - jmp_addr_satisfied: 0x7ff6c4b06bf3 - jmp_addr_unsatisfied: 0x7ff6c4b067f0
BB 0x7ff6c4b06c45:0x7ff6c4b06c5f - jmp_addr_satisfied: 0x7ff6c4b06c61 - jmp_addr_unsatisfied: 0x7ff6c4b067f0
BB 0x7ff6c4b06ce1:0x7ff6c4b06cfb - jmp_addr_satisfied: 0x7ff6c4b06cfd - jmp_addr_unsatisfied: 0x7ff6c4b067f0
BB 0x7ff6c4b06e83:0x7ff6c4b06e9d - jmp_addr_satisfied: 0x7ff6c4b06e9f - jmp_addr_unsatisfied: 0x7ff6c4b067f0
BB 0x7ff6c4b06edc:0x7ff6c4b06ef6 - jmp_addr_satisfied: 0x7ff6c4b06ef8 - jmp_addr_unsatisfied: 0x7ff6c4b067f0
BB 0x7ff6c4b06f3d:0x7ff6c4b06f56 - jmp_addr_satisfied: 0x7ff6c4b06f58 - jmp_addr_unsatisfied: 0x7ff6c4b067f0
BB 0x7ff6c4b07008:0x7ff6c4b07022 - jmp_addr_satisfied: 0x7ff6c4b07024 - jmp_addr_unsatisfied: 0x7ff6c4b067f0
BB 0x7ff6c4b07052:0x7ff6c4b0706c - jmp_addr_satisfied: 0x7ff6c4b0706e - jmp_addr_unsatisfied: 0x7ff6c4b067f0
(140697838577608, 140697838577634, 2107475699, 'cmovz', 140697838577623, 'rcx', 140697838579921, 140697838577648)
(140697838577648, 140697838577687, 280783992, 'cmovl', 140697838577658, 'rdx', 140697838577689, 140697838577840)
(140697838577689, 140697838577710, 18446744072686906926, 'cmovl', 140697838577699, 'rdx', 140697838577712, 140697838578096)
(140697838577712, 140697838577733, 18446744072142530087, 'cmovl', 140697838577722, 'rdx', 140697838577735, 140697838578329)
(140697838577735, 140697838577761, 18446744072135251631, 'cmovl', 140697838577750, 'rdx', 140697838577763, 140697838578757)
(140697838577763, 140697838577789, 18446744071775716404, 'cmovz', 140697838577778, 'rcx', 140697838577791, 140697838577648)
(140697838577840, 140697838577861, 1814337361, 'cmovl', 140697838577850, 'rdx', 140697838577863, 140697838578224)
(140697838577863, 140697838577889, 992709150, 'cmovl', 140697838577878, 'rdx', 140697838577891, 140697838578441)
(140697838577891, 140697838577917, 389785057, 'cmovl', 140697838577906, 'rdx', 140697838577919, 140697838578913)
(140697838577919, 140697838577944, 280783992, 'setz', 140697838577926, 'rcx', 140697838577946, 140697838577648)
(140697838578096, 140697838578122, 18446744072975528772, 'cmovl', 140697838578111, 'rdx', 140697838578124, 140697838578531)
(140697838578124, 140697838578150, 18446744072886880558, 'cmovl', 140697838578139, 'rdx', 140697838578152, 140697838579331)
(140697838578152, 140697838578178, 18446744072686906926, 'cmovz', 140697838578167, 'rcx', 140697838578180, 140697838577648)
(140697838578224, 140697838578250, 2104599011, 'cmovl', 140697838578239, 'rdx', 140697838578252, 140697838578619)
(140697838578252, 140697838578278, 2056782390, 'cmovl', 140697838578267, 'rdx', 140697838578280, 140697838579420)
(140697838578280, 140697838578306, 1814337361, 'cmovz', 140697838578295, 'rcx', 140697838578308, 140697838577648)
(140697838578329, 140697838578355, 18446744072645564105, 'cmovl', 140697838578344, 'rdx', 140697838578357, 140697838579517)
(140697838578357, 140697838578383, 18446744072142530087, 'cmovz', 140697838578372, 'rcx', 140697838578385, 140697838577648)
(140697838578441, 140697838578462, 1020697904, 'setl', 140697838578448, 'rdx', 140697838578464, 140697838579720)
(140697838578464, 140697838578489, 992709150, 'setnz', 140697838578471, 'rcx', 140697838577648, 140697838578491)
(140697838578531, 140697838578557, 18446744073387544561, 'cmovl', 140697838578546, 'rdx', 140697838578559, 140697838579794)
(140697838578559, 140697838578585, 18446744072975528772, 'cmovz', 140697838578574, 'rcx', 140697838578587, 140697838577648)
(140697838578619, 140697838578645, 2107475699, 'cmovl', 140697838578634, 'rdx', 140697838578647, 140697838577608)
(140697838578647, 140697838578673, 2104599011, 'cmovz', 140697838578662, 'rcx', 140697838578675, 140697838577648)
(140697838578757, 140697838578783, 18446744072135251631, 'cmovz', 140697838578772, 'rcx', 140697838578785, 140697838577648)
(140697838578913, 140697838578939, 389785057, 'cmovz', 140697838578928, 'rcx', 140697838578941, 140697838577648)
(140697838579331, 140697838579357, 18446744072886880558, 'cmovz', 140697838579346, 'rcx', 140697838579359, 140697838577648)
(140697838579420, 140697838579446, 2056782390, 'cmovz', 140697838579435, 'rcx', 140697838579448, 140697838577648)
(140697838579517, 140697838579542, 18446744072645564105, 'setz', 140697838579524, 'rcx', 140697838579544, 140697838577648)
(140697838579720, 140697838579746, 1020697904, 'cmovz', 140697838579735, 'rcx', 140697838579748, 140697838577648)
(140697838579794, 140697838579820, 18446744073387544561, 'cmovz', 140697838579809, 'rcx', 140697838579822, 140697838577648)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="IDA-Patch-Basic-Blocks">
<a class="anchor" href="#IDA-Patch-Basic-Blocks" aria-hidden="true"><span class="octicon octicon-link"></span></a>IDA Patch Basic Blocks<a class="anchor-link" href="#IDA-Patch-Basic-Blocks"> </a>
</h3>
<p>Copy the output table from our emulator and use it to patch out each bb with a conditional jmp and an unconditional jmp based on the emulation results.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">struct</span> 

<span class="n">bb_jmp_table</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">140697838577608</span><span class="p">,</span> <span class="mi">140697838577634</span><span class="p">,</span> <span class="mi">2107475699</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mi">140697838577623</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838579921</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838577648</span><span class="p">,</span> <span class="mi">140697838577687</span><span class="p">,</span> <span class="mi">280783992</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mi">140697838577658</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">,</span> <span class="mi">140697838577689</span><span class="p">,</span> <span class="mi">140697838577840</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838577689</span><span class="p">,</span> <span class="mi">140697838577710</span><span class="p">,</span> <span class="mi">18446744072686906926</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mi">140697838577699</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">,</span> <span class="mi">140697838577712</span><span class="p">,</span> <span class="mi">140697838578096</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838577712</span><span class="p">,</span> <span class="mi">140697838577733</span><span class="p">,</span> <span class="mi">18446744072142530087</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mi">140697838577722</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">,</span> <span class="mi">140697838577735</span><span class="p">,</span> <span class="mi">140697838578329</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838577735</span><span class="p">,</span> <span class="mi">140697838577761</span><span class="p">,</span> <span class="mi">18446744072135251631</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mi">140697838577750</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">,</span> <span class="mi">140697838577763</span><span class="p">,</span> <span class="mi">140697838578757</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838577763</span><span class="p">,</span> <span class="mi">140697838577789</span><span class="p">,</span> <span class="mi">18446744071775716404</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mi">140697838577778</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838577791</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838577840</span><span class="p">,</span> <span class="mi">140697838577861</span><span class="p">,</span> <span class="mi">1814337361</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mi">140697838577850</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">,</span> <span class="mi">140697838577863</span><span class="p">,</span> <span class="mi">140697838578224</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838577863</span><span class="p">,</span> <span class="mi">140697838577889</span><span class="p">,</span> <span class="mi">992709150</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mi">140697838577878</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">,</span> <span class="mi">140697838577891</span><span class="p">,</span> <span class="mi">140697838578441</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838577891</span><span class="p">,</span> <span class="mi">140697838577917</span><span class="p">,</span> <span class="mi">389785057</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mi">140697838577906</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">,</span> <span class="mi">140697838577919</span><span class="p">,</span> <span class="mi">140697838578913</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838577919</span><span class="p">,</span> <span class="mi">140697838577944</span><span class="p">,</span> <span class="mi">280783992</span><span class="p">,</span> <span class="s1">'setz'</span><span class="p">,</span> <span class="mi">140697838577926</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838577946</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578096</span><span class="p">,</span> <span class="mi">140697838578122</span><span class="p">,</span> <span class="mi">18446744072975528772</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mi">140697838578111</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">,</span> <span class="mi">140697838578124</span><span class="p">,</span> <span class="mi">140697838578531</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578124</span><span class="p">,</span> <span class="mi">140697838578150</span><span class="p">,</span> <span class="mi">18446744072886880558</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mi">140697838578139</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">,</span> <span class="mi">140697838578152</span><span class="p">,</span> <span class="mi">140697838579331</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578152</span><span class="p">,</span> <span class="mi">140697838578178</span><span class="p">,</span> <span class="mi">18446744072686906926</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mi">140697838578167</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838578180</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578224</span><span class="p">,</span> <span class="mi">140697838578250</span><span class="p">,</span> <span class="mi">2104599011</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mi">140697838578239</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">,</span> <span class="mi">140697838578252</span><span class="p">,</span> <span class="mi">140697838578619</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578252</span><span class="p">,</span> <span class="mi">140697838578278</span><span class="p">,</span> <span class="mi">2056782390</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mi">140697838578267</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">,</span> <span class="mi">140697838578280</span><span class="p">,</span> <span class="mi">140697838579420</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578280</span><span class="p">,</span> <span class="mi">140697838578306</span><span class="p">,</span> <span class="mi">1814337361</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mi">140697838578295</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838578308</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578329</span><span class="p">,</span> <span class="mi">140697838578355</span><span class="p">,</span> <span class="mi">18446744072645564105</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mi">140697838578344</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">,</span> <span class="mi">140697838578357</span><span class="p">,</span> <span class="mi">140697838579517</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578357</span><span class="p">,</span> <span class="mi">140697838578383</span><span class="p">,</span> <span class="mi">18446744072142530087</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mi">140697838578372</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838578385</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578441</span><span class="p">,</span> <span class="mi">140697838578462</span><span class="p">,</span> <span class="mi">1020697904</span><span class="p">,</span> <span class="s1">'setl'</span><span class="p">,</span> <span class="mi">140697838578448</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">,</span> <span class="mi">140697838578464</span><span class="p">,</span> <span class="mi">140697838579720</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578464</span><span class="p">,</span> <span class="mi">140697838578489</span><span class="p">,</span> <span class="mi">992709150</span><span class="p">,</span> <span class="s1">'setnz'</span><span class="p">,</span> <span class="mi">140697838578471</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">,</span> <span class="mi">140697838578491</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578531</span><span class="p">,</span> <span class="mi">140697838578557</span><span class="p">,</span> <span class="mi">18446744073387544561</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mi">140697838578546</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">,</span> <span class="mi">140697838578559</span><span class="p">,</span> <span class="mi">140697838579794</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578559</span><span class="p">,</span> <span class="mi">140697838578585</span><span class="p">,</span> <span class="mi">18446744072975528772</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mi">140697838578574</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838578587</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578619</span><span class="p">,</span> <span class="mi">140697838578645</span><span class="p">,</span> <span class="mi">2107475699</span><span class="p">,</span> <span class="s1">'cmovl'</span><span class="p">,</span> <span class="mi">140697838578634</span><span class="p">,</span> <span class="s1">'rdx'</span><span class="p">,</span> <span class="mi">140697838578647</span><span class="p">,</span> <span class="mi">140697838577608</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578647</span><span class="p">,</span> <span class="mi">140697838578673</span><span class="p">,</span> <span class="mi">2104599011</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mi">140697838578662</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838578675</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578757</span><span class="p">,</span> <span class="mi">140697838578783</span><span class="p">,</span> <span class="mi">18446744072135251631</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mi">140697838578772</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838578785</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838578913</span><span class="p">,</span> <span class="mi">140697838578939</span><span class="p">,</span> <span class="mi">389785057</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mi">140697838578928</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838578941</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838579331</span><span class="p">,</span> <span class="mi">140697838579357</span><span class="p">,</span> <span class="mi">18446744072886880558</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mi">140697838579346</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838579359</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838579420</span><span class="p">,</span> <span class="mi">140697838579446</span><span class="p">,</span> <span class="mi">2056782390</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mi">140697838579435</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838579448</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838579517</span><span class="p">,</span> <span class="mi">140697838579542</span><span class="p">,</span> <span class="mi">18446744072645564105</span><span class="p">,</span> <span class="s1">'setz'</span><span class="p">,</span> <span class="mi">140697838579524</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838579544</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838579720</span><span class="p">,</span> <span class="mi">140697838579746</span><span class="p">,</span> <span class="mi">1020697904</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mi">140697838579735</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838579748</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">),</span>
<span class="p">(</span><span class="mi">140697838579794</span><span class="p">,</span> <span class="mi">140697838579820</span><span class="p">,</span> <span class="mi">18446744073387544561</span><span class="p">,</span> <span class="s1">'cmovz'</span><span class="p">,</span> <span class="mi">140697838579809</span><span class="p">,</span> <span class="s1">'rcx'</span><span class="p">,</span> <span class="mi">140697838579822</span><span class="p">,</span> <span class="mi">140697838577648</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">bb_jmp_table</span><span class="p">:</span>
    <span class="n">bb_start</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bb_end</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">eax_value</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">jmp_condition</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">jmp_condition_address</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">jmp_register</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">jmp_addr_satisfied</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">jmp_addr_unsatisfied</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>

    <span class="n">patch_jmp_cond_start</span> <span class="o">=</span> <span class="n">jmp_condition_address</span>
    <span class="n">jmp_rel_statisfied</span> <span class="o">=</span>  <span class="n">jmp_addr_satisfied</span> <span class="o">-</span> <span class="p">(</span><span class="n">patch_jmp_cond_start</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">patch_jmp_start</span> <span class="o">=</span> <span class="n">patch_jmp_cond_start</span> <span class="o">+</span> <span class="mi">6</span>
    <span class="n">jmp_rel</span> <span class="o">=</span>  <span class="n">jmp_addr_unsatisfied</span> <span class="o">-</span> <span class="p">(</span><span class="n">patch_jmp_start</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">jmp_condition</span> <span class="o">==</span> <span class="s1">'cmovl'</span> <span class="ow">or</span> <span class="n">jmp_condition</span> <span class="o">==</span> <span class="s1">'setl'</span><span class="p">:</span>
        <span class="c1"># jl</span>
        <span class="n">patch_jmp_condition</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x0f\x8c</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel_statisfied</span><span class="p">)</span>
        <span class="n">patch_jmp</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\xe9</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">jmp_condition</span> <span class="o">==</span> <span class="s1">'cmovz'</span> <span class="ow">or</span> <span class="n">jmp_condition</span> <span class="o">==</span> <span class="s1">'setz'</span><span class="p">:</span>
        <span class="c1"># jz</span>
        <span class="n">patch_jmp_condition</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x0f\x84</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel_statisfied</span><span class="p">)</span>
        <span class="n">patch_jmp</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\xe9</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">jmp_condition</span> <span class="o">==</span> <span class="s1">'setnz'</span><span class="p">:</span>
        <span class="c1"># jnz</span>
        <span class="n">patch_jmp_condition</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x0f\x85</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel_statisfied</span><span class="p">)</span>
        <span class="n">patch_jmp</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\xe9</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel</span><span class="p">)</span>

    <span class="c1"># calculat nops for end of patch</span>
    <span class="n">total_bytes</span> <span class="o">=</span> <span class="n">bb_end</span> <span class="o">-</span> <span class="n">jmp_condition_address</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">nop_count</span> <span class="o">=</span> <span class="n">total_bytes</span> <span class="o">-</span> <span class="mi">11</span>

    <span class="c1"># 11 bytes for the patch + nops to fill space</span>
    <span class="n">patch_bytes</span> <span class="o">=</span> <span class="n">patch_jmp_condition</span> <span class="o">+</span> <span class="n">patch_jmp</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x90</span><span class="s1">'</span><span class="o">*</span> <span class="n">nop_count</span>

    <span class="c1"># patch the bytes</span>
    <span class="n">patch_ptr</span> <span class="o">=</span> <span class="n">jmp_condition_address</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">patch_bytes</span><span class="p">:</span>
        <span class="n">patch_byte</span><span class="p">(</span><span class="n">patch_ptr</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">patch_ptr</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/pandora/ransomware/malware/unpacking/dumpulator/emulation/2022/03/19/pandora_ransomware.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
