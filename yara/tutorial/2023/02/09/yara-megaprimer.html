<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Yara Megaprimer</h1><p class="page-description">What is Yara and how is it used</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2023-02-09T00:00:00-06:00" itemprop="datePublished">
        Feb 9, 2023
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#yara">yara</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#tutorial">tutorial</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2023-02-09-yara-megaprimer.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Rule-Syntax-Overview">Rule Syntax Overview </a></li>
<li class="toc-entry toc-h3"><a href="#There-Be-Dragons!">There Be Dragons! </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Using-Yara">Using Yara </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Rules-for-Identifying-Malware-(Threat-Intel)">Rules for Identifying Malware (Threat Intel) </a></li>
<li class="toc-entry toc-h3"><a href="#Rules-Used-Like-AV-Signatures">Rules Used Like AV Signatures </a></li>
<li class="toc-entry toc-h3"><a href="#Rules-Used-Exclusively-For-Hunting">Rules Used Exclusively For Hunting </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Testing">Testing </a></li>
<li class="toc-entry toc-h2"><a href="#Questions">Questions </a></li>
<li class="toc-entry toc-h2"><a href="#Custom-Yara-Engines">Custom Yara Engines </a></li>
<li class="toc-entry toc-h2"><a href="#Some-Fun-Hunting-PDB-Paths">Some Fun Hunting PDB Paths </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2023-02-09-yara-megaprimer.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p>Yara rule is basically just a set of rules used to match some features in a file (binary). The Yara <a href="https://github.com/virustotal/yara">scanning tool</a> can then take these rules and scan a set of files, identifying files that match the rule.</p>
<p>According to <a href="https://en.wikipedia.org/wiki/YARA">wikipedia</a></p>
<blockquote>
<p>It provides a rule-based approach to create descriptions of malware families based on textual or binary patterns. A description is essentially a YARA rule name, where these rules consist of sets of strings and a boolean expression.</p>
</blockquote>
<h3 id="Rule-Syntax-Overview">
<a class="anchor" href="#Rule-Syntax-Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rule Syntax Overview<a class="anchor-link" href="#Rule-Syntax-Overview"> </a>
</h3>
<p>An example rule from the <a href="https://github.com/virustotal/yara">Yara GitHub</a> shows us that there are three main components to a rule; the <code>meta</code> section, the <code>strings</code> section, and the <code>condition</code>. ```
rule silent_banker : banker
{
    meta:
        description = "This is just an example"
        threat_level = 3
        in_the_wild = true</p>

<pre><code>strings:
    $a = {6A 40 68 00 30 00 00 6A 14 8D 91}
    $b = {8D 4D B0 2B C1 83 C0 27 99 6A 4E 59 F7 F9}
    $c = "UVODFRYSIHLNWPEJXQZAKCBGMT"

condition:
    $a or $b or $c
</code></pre>
<p>}
```</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="There-Be-Dragons!">
<a class="anchor" href="#There-Be-Dragons!" aria-hidden="true"><span class="octicon octicon-link"></span></a>There Be Dragons!<a class="anchor-link" href="#There-Be-Dragons!"> </a>
</h3>
<p><img src="https://i.imgur.com/6NumPKX.png" alt=""></p>
<blockquote>
<p><a href="https://twitter.com/nunohaien/status/1480821031656898560">https://twitter.com/nunohaien/status/1480821031656898560</a></p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Using-Yara">
<a class="anchor" href="#Using-Yara" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using Yara<a class="anchor-link" href="#Using-Yara"> </a>
</h2>
<h3 id="Rules-for-Identifying-Malware-(Threat-Intel)">
<a class="anchor" href="#Rules-for-Identifying-Malware-(Threat-Intel)" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rules for Identifying Malware (Threat Intel)<a class="anchor-link" href="#Rules-for-Identifying-Malware-(Threat-Intel)"> </a>
</h3>
<ul>
<li>Used to share intel about malware families </li>
<li>Usually tuned for unpacked malware (the actual malware code, not the packer)</li>
<li>Needs a low false positive (FP) rate or it could end up being "bad intel"</li>
<li>Usually used to automatically identify and classify malware samples (ex. malware tracker)</li>
</ul>
<p>A good example of these "intel" rules is the public Yara repository <a href="https://malpedia.caad.fkie.fraunhofer.de/">Malpedia</a></p>
<h3 id="Rules-Used-Like-AV-Signatures">
<a class="anchor" href="#Rules-Used-Like-AV-Signatures" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rules Used Like AV Signatures<a class="anchor-link" href="#Rules-Used-Like-AV-Signatures"> </a>
</h3>
<ul>
<li>Used to identify packed malware, and early-stage malware delivery chain artifacts (maldocs, packers, malicious js, etc.)</li>
<li>Doesn't need to identify a specific malware family, just needs to identify "badness" or "evil"</li>
<li>Usually used either in-line or for asyncronous enterprise scanning to detect malware</li>
<li>FP rate needs to be low (SOC goes brrrrrrr)</li>
</ul>
<p>A good example of these "AV" rules is the open source <a href="https://github.com/Neo23x0/Loki">"loki" scanner</a> with the <a href="https://github.com/Neo23x0/signature-base">signature-base ruleset</a> from <a href="https://twitter.com/cyb3rops">Florian Roth</a> and its commercial counterpart THOR.</p>
<h3 id="Rules-Used-Exclusively-For-Hunting">
<a class="anchor" href="#Rules-Used-Exclusively-For-Hunting" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rules Used Exclusively For Hunting<a class="anchor-link" href="#Rules-Used-Exclusively-For-Hunting"> </a>
</h3>
<ul>
<li>Used like a "loose" version of a AV signature, used for finding the needle in the haystack</li>
<li>Good for identifying unknowns </li>
<li>Usually used for "hunting" either within an enterpise or in a malware repository</li>
<li>Can have a high FP rate</li>
</ul>
<p>A good example of these are the "feels bad" rules from <a href="https://github.com/100DaysofYARA/">100 Days of Yara</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Testing">
<a class="anchor" href="#Testing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Testing<a class="anchor-link" href="#Testing"> </a>
</h2>
<ul>
<li>
<p>Packer detection
<a href="https://malwarology.substack.com/p/malicious-packer-pkr_ce1a">pkr_ce1a</a></p>
</li>
<li>
<p>Detects "bad"
<a href="https://pastebin.com/Yq0SRAN9">some_packer</a></p>
</li>
<li>
<p>.NET packer
<a href="https://github.com/dr4k0nia/yara-rules/blob/main/dotnet/msil_suspicious_use_of_strreverse.yar">msil_suspicious_use_of_strreverse.yar</a></p>
</li>
<li>
<p>lol PDB paths</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="n">import</span> <span class="s">"pe"</span>

<span class="n">rule</span> <span class="n">lol_pdb</span> <span class="p">{</span>
    <span class="nl">meta</span><span class="p">:</span>
        <span class="n">author</span> <span class="o">=</span> <span class="s">"BitsOfBinary"</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s">"Detects files that identify themselves as malware"</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="s">"https://bitsofbinary.github.io/yara/2023/01/04/100daysofyara-day-4.html"</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s">"1.0"</span>
        <span class="n">date</span> <span class="o">=</span> <span class="s">"2023-01-04"</span>
        <span class="n">DaysofYARA</span> <span class="o">=</span> <span class="s">"4/100"</span>

    <span class="nl">condition</span><span class="p">:</span>
        <span class="n">pe</span><span class="p">.</span><span class="n">pdb_path</span> <span class="n">icontains</span> <span class="s">"locker"</span> <span class="n">or</span>
        <span class="n">pe</span><span class="p">.</span><span class="n">pdb_path</span> <span class="n">icontains</span> <span class="s">"stealer"</span> <span class="n">or</span> 
        <span class="n">pe</span><span class="p">.</span><span class="n">pdb_path</span> <span class="n">icontains</span> <span class="s">"crypter"</span> <span class="n">or</span>
        <span class="n">pe</span><span class="p">.</span><span class="n">pdb_path</span> <span class="n">icontains</span> <span class="s">"ransomware"</span> <span class="n">or</span>
        <span class="n">pe</span><span class="p">.</span><span class="n">pdb_path</span> <span class="n">icontains</span> <span class="s">"keylogger"</span> <span class="n">or</span>  
        <span class="n">pe</span><span class="p">.</span><span class="n">pdb_path</span> <span class="n">icontains</span> <span class="s">"exploit"</span> 

<span class="p">}</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Questions">
<a class="anchor" href="#Questions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Questions<a class="anchor-link" href="#Questions"> </a>
</h2>
<p>Why would we need to define a string with zerors before and after such as the following: "\x00Fluffy\x00"</p>
<ul>
<li>this defines the surrounding bytes for a string, instead of just matching the string with no context... in this particular case it's very inefficient since the null bytes don't add much context and will infact slow down the matching buy adding some generic bytes to the string, a fullword keyword and a string would be a better choice</li>
</ul>
<p>Advanced regex yara rules examples.</p>
<ul>
<li>no</li>
</ul>
<p>Create yara rule for .NET using IL where the instructions may change between compiled samples and thus wildcarding is required.</p>
<ul>
<li>Maybe Drakonia's rule? TBD...</li>
</ul>
<p>How to utilise fuzzy hashing (SSDEEP, SDHASH, mvHASH-B) and fuzzy rules.</p>
<ul>
<li>in addition to the basic string pattern matching Yara supports some advanced features such as <a href="https://yara.readthedocs.io/en/stable/modules/hash.html">hash calculation</a> using the hash module but this doesn't support fuzzy hashing... generally hash matching is very brittel and sort of defeats the purpose of yara but it can be useful in some contexts... for fuzzy hashing I'm not sure if this is available outside of a custom module?</li>
</ul>
<p>When should we write a yara rule vs when to write a <a href="https://capev2.readthedocs.io/en/latest/customization/signatures.html">CAPE rule</a></p>
<ul>
<li>if you want the rule to be useable outside of CAPE then Yara is the best, one of the main advantages of Yara is its portablilty (you can share them! and they just work!)</li>
<li>if you are only running your rule on CAPE and you want some more advanced custom features you may be enticed to use a CAPE specific rule</li>
</ul>
<p>What are the advantages of YARA-L 2.0 vs the normal yara, and what use cases of YARA-L 2.0 rules to use?</p>
<ul>
<li>we can probably ignore this unless it catches on widely, all of these "custom" yara versions that are not portable are not worth investigating unless you are using the platform they are designed for</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Custom-Yara-Engines">
<a class="anchor" href="#Custom-Yara-Engines" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom Yara Engines<a class="anchor-link" href="#Custom-Yara-Engines"> </a>
</h2>
<p>Avast experimented with compiled yara rules using their <a href="https://github.com/avast/yarang">YaraNG</a> engine. Appearently with some decent improvemenst (35%) as detailed in their blog <a href="https://engineering.avast.io/yarang-reinventing-the-yara-scanner/">YaraNG: Reinventing the YARA Scanner</a>. They have have a <a href="https://github.com/avast/yls">yara linter</a>.</p>
<p>There is also a project underway to re-write the Yara engine in rust <a href="https://github.com/VirusTotal/yara-x/">yara-x</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Some-Fun-Hunting-PDB-Paths">
<a class="anchor" href="#Some-Fun-Hunting-PDB-Paths" aria-hidden="true"><span class="octicon octicon-link"></span></a>Some Fun Hunting PDB Paths<a class="anchor-link" href="#Some-Fun-Hunting-PDB-Paths"> </a>
</h2>
<ul>
<li><code>D:\Mktmp\Amadey\StealerDLL\x64\Release\STEALERDLL.pdb</code></li>
<li><code>o:\Programmieren\Codesoft Releases\_NEW BETATEST\Codesoft PW Stealer\v0.35_older\abcdef Version\release\Codesoft-PW_Stealer_Server.pdb</code></li>
<li><code>C:\Users\Ledzz\Desktop\LedzzsHUBBBGOLD\LedzzsHUBBBGOLD\Nitro-Ransomware-master\NitroRansomware\obj\Debug\NitroRansomware.pdb</code></li>
<li><code>c:\slam_ransomware_builder\ConsoleApp2\ConsoleApp2\obj\Debug\ConsoleApp2.pdb</code></li>
<li><code>d:\ronin\PROJEKTY\Keylogger\src\Keylogger_v0.05\Release\Keylogger.pdb</code></li>
<li><code>C:\Users\user\Desktop\ExploitKITS\C#\Windows\Trojans\CyberRAT\Client\obj\Debug\Client.pdb</code></li>
<li><code>c:\Users\User\Desktop\5.2\Decrypter\decrypter\obj\Debug\Chaos ransomware decrypter.pdb</code></li>
<li><code>C:\Users\ygzat\source\repos\Crypter Test2\Crypter\Crypter\obj\Debug\Crypter.pdb</code></li>
<li><code>D:\scm\Italy\Ransomware\lkh\FileDecrytptor2\Build\Win32\Release\FileCrytptor.pdb</code></li>
<li><code>D:\Mktmp\Amadey\StealerDLL\x64\Release\STEALERDLL.pdb</code></li>
</ul>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/yara/tutorial/2023/02/09/yara-megaprimer.html" hidden></a>
</article>
