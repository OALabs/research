<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Lumma Stealer Obfuscation | OALABS Research</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Lumma Stealer Obfuscation" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Taking a look at obfuscation in the latest version of lumma" />
<meta property="og:description" content="Taking a look at obfuscation in the latest version of lumma" />
<link rel="canonical" href="https://research.openanalysis.net/lumma/obfuscation/cff/ida/2024/04/07/lumma-cff.html" />
<meta property="og:url" content="https://research.openanalysis.net/lumma/obfuscation/cff/ida/2024/04/07/lumma-cff.html" />
<meta property="og:site_name" content="OALABS Research" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-04-07T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Lumma Stealer Obfuscation" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-04-07T00:00:00-05:00","datePublished":"2024-04-07T00:00:00-05:00","description":"Taking a look at obfuscation in the latest version of lumma","headline":"Lumma Stealer Obfuscation","mainEntityOfPage":{"@type":"WebPage","@id":"https://research.openanalysis.net/lumma/obfuscation/cff/ida/2024/04/07/lumma-cff.html"},"url":"https://research.openanalysis.net/lumma/obfuscation/cff/ida/2024/04/07/lumma-cff.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://research.openanalysis.net/feed.xml" title="OALABS Research" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">OALABS Research</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Lumma Stealer Obfuscation</h1><p class="page-description">Taking a look at obfuscation in the latest version of lumma</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2024-04-07T00:00:00-05:00" itemprop="datePublished">
        Apr 7, 2024
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      1 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#lumma">lumma</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#obfuscation">obfuscation</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#cff">cff</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#ida">ida</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2024-04-07-lumma-cff.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a></li>
<li class="toc-entry toc-h2"><a href="#Sample">Sample </a></li>
<li class="toc-entry toc-h2"><a href="#Analysis">Analysis </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Algorithm">Algorithm </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2024-04-07-lumma-cff.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p><a href="https://telegra.ph/LummaC2---universal-stealer-a-malware-for-professionals-07-27">Lumma</a> has been around for a <a href="https://www.esentire.com/blog/the-case-of-lummac2-v4-0">while</a> initially starting out with plaintext strings and simple to reverse code, but as they continue to evolve they added some <a href="https://outpost24.com/blog/lummac2-anti-sandbox-technique-trigonometry-human-detection/#h-control-flow-flattening">control flow flattening</a> (CFF) and string encryption. With the latest build more obfuscation has been added which introduces opaque predicates to the CFF. We are going to attempt to use IDA scripting to remove this obfuscation.</p>
<h2 id="Sample">
<a class="anchor" href="#Sample" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sample<a class="anchor-link" href="#Sample"> </a>
</h2>
<p><code>18a065b740da441c636bce23fd72fc0f68e935956131973f15bf4918e317bf03</code> [<a href="https://www.unpac.me/results/41d8f31a-3b36-4b77-8b7c-a2d7a81a7034#/">UnpacMe</a>]</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Analysis">
<a class="anchor" href="#Analysis" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analysis<a class="anchor-link" href="#Analysis"> </a>
</h2>
<p>The opaque predicates are setup using a jump table with encrypted addresses, for direct jumps the address is simply moved into a register, decrypted, then jumped to. For conditional jumps the jump table is used like an index to locate the correct address, which is then decrypted and jumped to.</p>

<pre><code>00433500      mov     eax, dword_4426C0
00433505      mov     ecx, 439EAE97h
0043350A      xor     ecx, dword_4426C8
00433510      add     eax, ecx
00433512      inc     eax
00433513      jmp     eax

0043351C      mov     eax, dword_442714
00433521      mov     ecx, 0DEA4552Dh
00433526      xor     ecx, dword_442718
0043352C      add     eax, ecx
0043352E      inc     eax
0043352F      nop
00433530      jmp     eax

00433399      movzx   eax, al
0043339C      mov     eax, dword_4426D4[eax*4]
004333A3      mov     ecx, 42CEBA5h
004333A8      xor     ecx, dword_4426DC
004333AE      add     eax, ecx
004333B0      inc     eax
004333B1      jmp     eax

00433312      test    eax, eax
00433314      setz    cl
00433317      mov     ecx, dword_4426A0[ecx*4]
0043331E      mov     edx, 0AD7AC4AAh
00433323      xor     edx, dword_4426A8
00433329      add     ecx, edx
0043332B      inc     ecx
0043332C      jmp     ecx</code></pre>
<h3 id="Algorithm">
<a class="anchor" href="#Algorithm" aria-hidden="true"><span class="octicon octicon-link"></span></a>Algorithm<a class="anchor-link" href="#Algorithm"> </a>
</h3>
<ul>
<li>Linear disassembly </li>
<li>Track memory moves to regs from jump table memory locations <code>.data</code>
</li>
<li>Reset memory tracking for control flow operations JMP,CALL,RET</li>
<li>When we have a JMP to a register use tracked memory location as emulation start and emulate jump address</li>
<li>For conditional jumps emulated both values for the index reg for the jump table (0,1) </li>
<li>Patch jumps, for condition test the index register and patch conditional jump</li>
</ul>
<p><strong>TO BE CONTINUED....</strong></p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/lumma/obfuscation/cff/ida/2024/04/07/lumma-cff.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
