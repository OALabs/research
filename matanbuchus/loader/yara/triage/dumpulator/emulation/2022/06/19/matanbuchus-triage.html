<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Matanbuchus Triage Notes</h1><p class="page-description">Matanbuchus loader triage and yara rule</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-06-19T00:00:00-05:00" itemprop="datePublished">
        Jun 19, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      19 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#Matanbuchus">Matanbuchus</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#loader">loader</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#yara">yara</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#triage">triage</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#dumpulator">dumpulator</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#emulation">emulation</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2022-06-19-matanbuchus-triage.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a>
<ul>
<li class="toc-entry toc-h3"><a href="#References">References </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Analysis">Analysis </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Yara-Rule">Yara Rule </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Yara-Rule-Revised">Yara Rule Revised </a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#String-Decryption">String Decryption </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Simple-Decryption">Simple Decryption </a></li>
<li class="toc-entry toc-h4"><a href="#Complex-Decryption">Complex Decryption </a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#Dumpulator-Notes">Dumpulator Notes </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Dumpulator-Patching-Out-Functions">Dumpulator Patching Out Functions </a></li>
<li class="toc-entry toc-h4"><a href="#Dumpulator-Implementing-Syscalls-to-Load-DLL">Dumpulator Implementing Syscalls to Load DLL </a></li>
<li class="toc-entry toc-h4"><a href="#Finding-Encrypted-Stack-Strings">Finding Encrypted Stack Strings </a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Revising-Our-Config-Extractor">Revising Our Config Extractor </a>
<ul>
<li class="toc-entry toc-h3"><a href="#New-Config-Extractor---Static-String-Decryption-Notes">New Config Extractor - Static String Decryption Notes </a></li>
<li class="toc-entry toc-h3"><a href="#Final-Config-Decryptor">Final Config Decryptor </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Test-All-Samples">Test All Samples </a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#Sample-Using-ADV-String-Obfuscation">Sample Using ADV String Obfuscation </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Different-Sample-From-Same-Family">Different Sample From Same Family </a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Taking-a-Closer-Look-At-Obfuscated-Samples">Taking a Closer Look At Obfuscated Samples </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Fixing-our-Yara-Rule-to-Match-the-Stack-Based-String-Encryption-Payload-(as-well-as-loaders)">Fixing our Yara Rule to Match the Stack Based String Encryption Payload (as well as loaders) </a></li>
<li class="toc-entry toc-h3"><a href="#Let's-Take-a-Look-At-the-Obfusacated-Strings">Let&#39;s Take a Look At the Obfusacated Strings </a></li>
<li class="toc-entry toc-h3"><a href="#String-Decryption-Recap">String Decryption Recap </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Complex-Third-String-Decryption-Method">Complex Third String Decryption Method </a></li>
</ul>
</li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-06-19-matanbuchus-triage.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://cdn.discordapp.com/attachments/885652495421030431/988186871660183612/a_horse.png" alt=""></p>
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p>Matanbuchus is a malware downloader that has been observed as the final loading stage in multiple phishing campaigns. There are two components, a Matanbuchus loader intented to load the Matanbuchus downloader. Once the downloader is executed it makes an HTTP request to the C2 with some victim info, and downloads the final payload.</p>
<p>According to <a href="https://twitter.com/DCSO_CyTec">DCSO CyTec</a>...</p>
<blockquote>
<p>Matanbuchus is the name given to a Malware-as-a-Service sold on Russian-speaking cybercriminal forums. Starting at a rental price of $2,500, the malware consists of an obfuscated two-stage loader which has been deployed in conjunction with Qakbot and Cobalt Strike payloads.</p>
</blockquote>
<p><img src="https://isc.sans.edu/diaryimages/images/2022-06-17-ISC-diary-image-00a.jpg" alt=""></p>
<h3 id="References">
<a class="anchor" href="#References" aria-hidden="true"><span class="octicon octicon-link"></span></a>References<a class="anchor-link" href="#References"> </a>
</h3>
<ul>
<li><a href="https://isc.sans.edu/forums/diary/Malspam+pushes+Matanbuchus+malware+leads+to+Cobalt+Strike/28752/">Malspam pushes Matanbuchus malware, leads to Cobalt Strike</a></li>
<li><a href="https://www.unpac.me/results/7166936d-dcd6-40ed-9d15-0151953e46ff#/">Not Packed (UnpacMe)</a></li>
<li><a href="https://malshare.com/sample.php?action=detail&amp;hash=f8cc2cf36e193774f13c9c5f23ab777496dcd7ca588f4f73b45a7a5ffa96145e">f8cc2cf36e193774f13c9c5f23ab777496dcd7ca588f4f73b45a7a5ffa96145e</a></li>
<li><a href="https://unit42.paloaltonetworks.com/matanbuchus-malware-as-a-service/">Matanbuchus: Malware-as-a-Service with Demonic Intentions</a></li>
<li><a href="https://medium.com/@DCSO_CyTec/a-deal-with-the-devil-analysis-of-a-recent-matanbuchus-sample-3ce991951d6a">A deal with the devil: Analysis of a recent Matanbuchus sample</a></li>
<li><a href="https://www.0ffset.net/reverse-engineering/matanbuchus-loader-analysis/">MATANBUCHUS: Another Loader As A Service Malware</a></li>
<li><a href="https://winbindex.m417z.com/?file=ntdll.dll">List of known versions of Windows DLLs</a></li>
<li><a href="https://riskmitigation.ch/yara-scan/">Free Yara Scan Service</a></li>
<li><a href="https://github.com/larsborn/MalwareBazaarClient">MalwareBazaar Client</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Analysis">
<a class="anchor" href="#Analysis" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analysis<a class="anchor-link" href="#Analysis"> </a>
</h2>
<ul>
<li>The DLL has an export called <code>HackCheck</code> that uses OutputDebugStringA to print <code>start dll HackCheck</code> </li>
<li>The sample uses API hashing with FNV1a hash algo to resolve API calls</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Yara-Rule">
<a class="anchor" href="#Yara-Rule" aria-hidden="true"><span class="octicon octicon-link"></span></a>Yara Rule<a class="anchor-link" href="#Yara-Rule"> </a>
</h3>
<p>This yara rule is very brittle and needs lots of testing/refining</p>

<pre><code>
rule matanbuchus {
    meta:
        description = "Identifies matanbuchus"

   strings:
       // recursive fnv1 hash
       // 69 C2 93 01 00 01                       imul    eax, edx, 1000193h
       // 50                                      push    eax
       // B9 01 00 00 00                          mov     ecx, 1
       // C1 E1 00                                shl     ecx, 0
       $x1 = { 69 c2 93 01 00 01 50 b9 01 00 00 00 c1 e1 00 }

      //  string decryption    
      //  0F BE 1C 01                             movsx   ebx, byte ptr [ecx+eax]
      //  33 DE                                   xor     ebx, esi
      //  6A 00                                   push    0
      //  6A 01                                   push    1
        $x2 = { 0f be 1c 01 33 de 6a 00 6a 01 }


   condition:
       all of ($x*)
}</code></pre>
<h4 id="Yara-Rule-Revised">
<a class="anchor" href="#Yara-Rule-Revised" aria-hidden="true"><span class="octicon octicon-link"></span></a>Yara Rule Revised<a class="anchor-link" href="#Yara-Rule-Revised"> </a>
</h4>
<pre><code>rule matanbuchus {
    meta:
        description = "Identifies matanbuchus"

   strings:
       // fnv1 hash
       // 69 C2 93 01 00 01                       imul    eax, edx, 1000193h
       // 
       // 69 C0 93 01 00 01                       imul    eax, 1000193h
       $x1 = { 69 ?? 93 01 00 01 }

      //pe loader
      $x2 = { B8 4D 5A 00 00 }
      $x3 = { 81 38 50 45 00 00 }

      //InternetCloseHandle
      $x5 = { 66 E9 DD 4D }

      //InternetOpenUrlA
      $x6 = { BC 8B CF F4 }

      //InternetCheckConnectionA
      $x7 = { 3F 82 58 52 }

      //InternetReadFile
      $x8 = { 66 E9 DD 4D }

   condition:
       all of ($x*)
}</code></pre>
<h3 id="String-Decryption">
<a class="anchor" href="#String-Decryption" aria-hidden="true"><span class="octicon octicon-link"></span></a>String Decryption<a class="anchor-link" href="#String-Decryption"> </a>
</h3>
<h4 id="Simple-Decryption">
<a class="anchor" href="#Simple-Decryption" aria-hidden="true"><span class="octicon octicon-link"></span></a>Simple Decryption<a class="anchor-link" href="#Simple-Decryption"> </a>
</h4>
<p>Some strings are built as stack strings then copied into a buffer and returned from a function. The returned buffer is then decrypted directly using a simple XOR decryption routine where the first byte is the key.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">struct</span>

<span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'jl8|tt8Py{s[p}{s'</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="mh">0x796C6B18</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">data</span>
<span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>b'start dll HackCheck'</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">unhex</span><span class="p">(</span><span class="n">hex_string</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">binascii</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">hex_string</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">hex_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">hex_string</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">tohex</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">binascii</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Complex-Decryption">
<a class="anchor" href="#Complex-Decryption" aria-hidden="true"><span class="octicon octicon-link"></span></a>Complex Decryption<a class="anchor-link" href="#Complex-Decryption"> </a>
</h4>
<p>Other strings are also build from stack strings in a function and returned in a buffer, but these strings are decrypted with a second function call to a decryption function. To handle these more complex strings, we will use <a href="https://github.com/mrexodia/dumpulator">dumpulator</a></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">dumpulator</span> <span class="kn">import</span> <span class="n">Dumpulator</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pefile</span>

<span class="n">file_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/mat.bin'</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="o">.</span><span class="n">PE</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">file_data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dp</span> <span class="o">=</span> <span class="n">Dumpulator</span><span class="p">(</span><span class="s2">"/tmp/mat.dmp"</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fn_get_string</span> <span class="o">=</span> <span class="mh">0x708641C0</span>
<span class="n">ss_start</span> <span class="o">=</span> <span class="mh">0x708631B2</span>
<span class="n">ss_end</span> <span class="o">=</span> <span class="mh">0x708632AA</span> 

<span class="n">dp</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">ss_start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">ss_end</span><span class="p">)</span>

<span class="n">ss</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">)</span>




<span class="n">ss</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">ss</span><span class="p">)[:</span><span class="mh">0x3e</span><span class="p">]</span>

<span class="n">buff</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mh">0x3e</span><span class="p">)</span>
<span class="n">dp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span>
<span class="n">fn_dec_str</span> <span class="o">=</span> <span class="mh">0x7086F3D0</span> 

<span class="n">dp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">fn_dec_str</span><span class="p">,</span> <span class="p">[</span><span class="n">buff</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x7ebbfa3</span><span class="p">,</span> <span class="mh">0x1010101</span><span class="p">])</span>
<span class="n">dp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="mh">0x3e</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Failed to read module data
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>bytearray(b'https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/auth.aspx\x00')</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Dumpulator-Notes">
<a class="anchor" href="#Dumpulator-Notes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dumpulator Notes<a class="anchor-link" href="#Dumpulator-Notes"> </a>
</h3>
<p>The DLL uses thread safe functions that require a call into <code>EnterCriticalSection</code> and <code>LeaveCriticalSection</code>. Because our dump was taken before the DLL was initialized the critical section object was not initialized and this causes Dumpulator to crash.</p>
<p>First we tried just calling the initialization function in the DLL to setup this object (also tried calling the wrapper functions for <code>InitializeCriticalSectionEx</code>) but these all led to crashes (we could implement some syscalls and try again but we are lazy!</p>
<p>Our solution is to just patch out the <code>EnterCriticalSection</code> and <code>LeaveCriticalSection</code> calls in the loaded <code>ntdll</code> using a simple return 0.</p>

<pre><code>33 C0     xor eax,eax
C2 04 00  ret 4</code></pre>
<h4 id="Dumpulator-Patching-Out-Functions">
<a class="anchor" href="#Dumpulator-Patching-Out-Functions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dumpulator Patching Out Functions<a class="anchor-link" href="#Dumpulator-Patching-Out-Functions"> </a>
</h4>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dp</span> <span class="o">=</span> <span class="n">Dumpulator</span><span class="p">(</span><span class="s2">"/tmp/mat.dmp"</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ntdll_start</span> <span class="o">=</span> <span class="mh">0x77a10000</span>


<span class="n">patch_bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x33\xC0\xC2\x04\x00</span><span class="s1">'</span>

<span class="n">ptr_RtlLeaveCriticalSection</span> <span class="o">=</span> <span class="mh">0x77A5FFF0</span>
<span class="n">ptr_RtlEnterCriticalSection</span> <span class="o">=</span> <span class="mh">0x77A5FDF0</span>

<span class="n">get_str_fn</span> <span class="o">=</span> <span class="mh">0x70861000</span>

<span class="c1">#tohex(dp.read(ntdll_init_crit_sec,10))</span>

<span class="n">dp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ptr_RtlLeaveCriticalSection</span><span class="p">,</span> <span class="n">patch_bytes</span><span class="p">)</span>
<span class="n">dp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ptr_RtlEnterCriticalSection</span><span class="p">,</span> <span class="n">patch_bytes</span><span class="p">)</span>



<span class="n">dp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">get_str_fn</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Failed to read module data
unmapped read from 8[4], cip = 77a6693a
error: Invalid memory read (UC_ERR_READ_UNMAPPED), cip = 77a6693a
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>134217727</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Dumpulator-Implementing-Syscalls-to-Load-DLL">
<a class="anchor" href="#Dumpulator-Implementing-Syscalls-to-Load-DLL" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dumpulator Implementing Syscalls to Load DLL<a class="anchor-link" href="#Dumpulator-Implementing-Syscalls-to-Load-DLL"> </a>
</h4>
<p>Our patching method sort of worked but there is other initializations stuff that was causing more crashes. We are going to try and just implement the syscalls that we need to actually emulate the full DLL load routine and see if that works better.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">dumpulator</span> <span class="kn">import</span> <span class="n">Dumpulator</span><span class="p">,</span> <span class="n">syscall</span>
<span class="kn">from</span> <span class="nn">dumpulator.native</span> <span class="kn">import</span> <span class="o">*</span>

<span class="nd">@syscall</span>
<span class="k">def</span> <span class="nf">ZwQueryVolumeInformationFile</span><span class="p">(</span><span class="n">dp</span><span class="p">:</span> <span class="n">Dumpulator</span><span class="p">,</span>
                                 <span class="n">FileHandle</span><span class="p">:</span> <span class="n">HANDLE</span><span class="p">,</span>
                                 <span class="n">IoStatusBlock</span><span class="p">:</span> <span class="n">P</span><span class="p">(</span><span class="n">IO_STATUS_BLOCK</span><span class="p">),</span>
                                 <span class="n">FsInformation</span><span class="p">:</span> <span class="n">PVOID</span><span class="p">,</span>
                                 <span class="n">Length</span><span class="p">:</span> <span class="n">ULONG</span><span class="p">,</span>
                                 <span class="n">FsInformationClass</span><span class="p">:</span> <span class="n">FSINFOCLASS</span>
                                 <span class="p">):</span>
    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span>



<span class="n">dp</span> <span class="o">=</span> <span class="n">Dumpulator</span><span class="p">(</span><span class="s2">"/tmp/mat2.dmp"</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">dll_base_addr</span> <span class="o">=</span> <span class="mh">0x71950000</span>

<span class="n">dp</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">eip</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">dp</span><span class="o">.</span><span class="n">read_ptr</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">esp</span><span class="p">))</span>


<span class="n">get_str_fn</span> <span class="o">=</span> <span class="mh">0x71951000</span>
<span class="n">dp</span><span class="o">.</span><span class="n">read_str</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">get_str_fn</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Failed to read module data
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/auth.aspx'</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Finding-Encrypted-Stack-Strings">
<a class="anchor" href="#Finding-Encrypted-Stack-Strings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Finding Encrypted Stack Strings<a class="anchor-link" href="#Finding-Encrypted-Stack-Strings"> </a>
</h4>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">egg</span> <span class="o">=</span> <span class="sa">rb</span><span class="s1">'(\xC6\x45..)</span><span class="si">{4}</span><span class="s1">'</span>

<span class="n">egg</span> <span class="o">=</span> <span class="sa">rb</span><span class="s1">'\x55\x8b\xec\x83\xec\x08\x33\xc0\x88\x45\xff'</span>

<span class="n">stack_string_offsets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">egg</span><span class="p">,</span> <span class="n">file_data</span><span class="p">):</span>
    <span class="n">fn_offset</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">fn_addr</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_rva_from_offset</span><span class="p">(</span><span class="n">fn_offset</span><span class="p">)</span> <span class="o">+</span> <span class="n">dll_base_addr</span>
    <span class="n">tmp_str</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">read_str</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">fn_addr</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tmp_str</span><span class="p">)</span>

    
    
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/auth.aspx
https://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/auth.aspx
DllRegisterServer
http://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/home.aspx
http://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx
https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Revising-Our-Config-Extractor">
<a class="anchor" href="#Revising-Our-Config-Extractor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Revising Our Config Extractor<a class="anchor-link" href="#Revising-Our-Config-Extractor"> </a>
</h2>
<p>Now that we have a base config extractor we need to test this across multiple samples/versions of the malware to make sure it is robust enough.</p>
<p>Our initial sample was <code>f8cc2cf36e193774f13c9c5f23ab777496dcd7ca588f4f73b45a7a5ffa96145e</code>.</p>
<p>We have collected the following samples to triage:</p>
<ul>
<li><code>b9b399dbb5d901c16d97b7c30cc182736cd83a7c53313194a1798d61f9c7501e</code></li>
<li>
<code>c41f7b7ec0909d5c21107ddebc2fe84dbc137f701b42943c1a5e69f5d50e05ab</code> </li>
<li>
<code>b4e7710488c2b7aaa71688b8bd546410af07a215c2e835e8dfbe24887186bd4f</code> </li>
<li>
<code>60f030597c75f9df0f7a494cb5432b600d41775cfe5cf13006c1448fa3a68d8d</code> </li>
<li>
<code>58a673023bbc7f2726e3b7ac917a43d9306692dc87b638ee21b98705a3262ccd</code> </li>
<li>
<code>4b87f95c4477fc66c58b8e16a74f9c47217913cb4a78dc69f27a364a099acd90</code> </li>
<li><code>4eb85a5532b98cbc4a6db1697cf46b9e2b7e28e89d6bbfc137b36c0736cd80e2</code></li>
</ul>
<p>More samples from Rattle (these work with our existing tools)</p>
<ul>
<li><code>67a9e8599ab71865a97e75dae9be438c24d015a93e6a12fb5b450ec558528290</code></li>
<li><code>075c904c5e18cd49f7d48f0fd1fc67d0921d51c7effb9233a3c92fbfa4f218ed</code></li>
<li><code>60f030597c75f9df0f7a494cb5432b600d41775cfe5cf13006c1448fa3a68d8d</code></li>
</ul>
<p>These samples don't work with our first version of the config extractor:</p>
<ul>
<li><code>e58b9bbb7bcdf3e901453b7b9c9e514fed1e53565e3280353dccc77cde26a98e.bin</code></li>
<li><code>b9b399dbb5d901c16d97b7c30cc182736cd83a7c53313194a1798d61f9c7501e.bin</code></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="New-Config-Extractor---Static-String-Decryption-Notes">
<a class="anchor" href="#New-Config-Extractor---Static-String-Decryption-Notes" aria-hidden="true"><span class="octicon octicon-link"></span></a>New Config Extractor - Static String Decryption Notes<a class="anchor-link" href="#New-Config-Extractor---Static-String-Decryption-Notes"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">unhex</span><span class="p">(</span><span class="n">hex_string</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">binascii</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">hex_string</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">hex_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">hex_string</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">tohex</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">binascii</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">pefile</span>

<span class="n">FILE_PATH</span> <span class="o">=</span> <span class="s1">'/tmp/samples/e58b9bbb7bcdf3e901453b7b9c9e514fed1e53565e3280353dccc77cde26a98e.bin'</span>
<span class="n">FILE_PATH</span> <span class="o">=</span> <span class="s1">'/tmp/samples/orig.bin'</span>
<span class="n">FILE_PATH</span> <span class="o">=</span> <span class="s1">'/tmp/samples/bd_rony.bin'</span>
<span class="n">file_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">FILE_PATH</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>



<span class="k">def</span> <span class="nf">xor_decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="k">len</span>(key)])
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_ascii</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">B</span><span class="s2">"^[\s!-~]+</span><span class="se">\0</span><span class="s2">*$"</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">rb</span><span class="s1">'[\f\v\t]'</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="n">stack_strings</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">#string_egg = rb'(\xC6\x45..){2,}'</span>

<span class="n">string_egg</span> <span class="o">=</span> <span class="sa">rb</span><span class="s1">'(?P&lt;a&gt;(?:\xC6\x85.</span><span class="si">{5}</span><span class="s1">){0,})(?P&lt;b&gt;(?:\xC6\x45..){1,})'</span>   

<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">string_egg</span><span class="p">,</span> <span class="n">file_data</span><span class="p">):</span>
    <span class="n">match_data</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1">#stack_strings.append({"data":match_data.replace(b'\xC6\x45',b'')[1::2], "match":match_data})</span>
    <span class="n">stack_strings</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"data"</span><span class="p">:</span><span class="n">m</span><span class="p">[</span><span class="s1">'a'</span><span class="p">][</span><span class="mi">6</span><span class="p">::</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="s1">'b'</span><span class="p">][</span><span class="mi">3</span><span class="p">::</span><span class="mi">4</span><span class="p">],</span> <span class="s2">"match"</span><span class="p">:</span><span class="n">match_data</span><span class="p">})</span>

    


<span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">key_byte_len_egg</span> <span class="o">=</span> <span class="sa">rb</span><span class="s1">'\x68(....)\x68(....)\x6a\x00\x6a(.)'</span>

<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">key_byte_len_egg</span><span class="p">,</span> <span class="n">file_data</span><span class="p">):</span>
     <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">{</span><span class="s1">'key'</span><span class="p">:</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s1">'length'</span><span class="p">:</span><span class="nb">ord</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))})</span>
        
        
<span class="n">key_dw_len_egg</span> <span class="o">=</span> <span class="sa">rb</span><span class="s1">'\x68(....)\x68(....)\x6a\x00\x68(....)'</span>

<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">key_dw_len_egg</span><span class="p">,</span> <span class="n">file_data</span><span class="p">):</span>
     <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">{</span><span class="s1">'key'</span><span class="p">:</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s1">'length'</span><span class="p">:</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))[</span><span class="mi">0</span><span class="p">]})</span>      

        
<span class="k">for</span> <span class="n">sj</span> <span class="ow">in</span> <span class="n">stack_strings</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">sj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'data'</span><span class="p">)</span>
    <span class="n">str_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">str_len</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="c1">#print(f"\n\n{str_len}")</span>
    <span class="n">flag_found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1">#print('\n')</span>
    <span class="c1">#print(f'{tohex(sj.get("match"))}')</span>
    <span class="n">tmp_strings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'length'</span><span class="p">)</span> <span class="o">==</span> <span class="n">str_len</span><span class="p">:</span>
            <span class="c1">#print(f"found key: {tohex(k.get('key'))}")</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">xor_decrypt</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'key'</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">is_ascii</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">filter</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
                <span class="n">tmp_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="n">flag_found</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">flag_found</span><span class="p">:</span>
        <span class="n">tmp_xoe_dec</span> <span class="o">=</span> <span class="n">xor_decrypt</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
        <span class="k">if</span> <span class="n">is_ascii</span><span class="p">(</span><span class="n">tmp_xoe_dec</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">filter</span><span class="p">(</span><span class="n">tmp_xoe_dec</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">tmp_xoe_dec</span><span class="p">)</span>
            
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#print(f"\n{tmp_strings}")</span>
        <span class="n">spec_char_egg</span> <span class="o">=</span> <span class="sa">rb</span><span class="s1">'[^A-Za-z0-9\s\./</span><span class="se">\\</span><span class="s1">\%]</span><span class="si">{1}</span><span class="s1">'</span>
        <span class="n">best_match</span> <span class="o">=</span>  <span class="nb">min</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">spec_char_egg</span><span class="p">,</span> <span class="n">s</span><span class="p">)),</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tmp_strings</span> <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">best_match</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>b'Content-Length: \x00'
b'C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe \x00'
b'collectiontelemetrysystem.com\x00'
b'DllRegisterServer\x00'
b'097f5m\x00'
b'Running dll in memory #3 (DllInstall(Unstall))\x00'
b'runas\x00'
b'.exe\x00'
b'timeout /t 3 &amp;&amp; move /Y \x00'
b'Running dll in memory #3 (DllInstall(Install))\x00'
b'.exe\x00'
b'.exe\x00'
b'TiC7\x00'
b'.nls\x00'
b'Run PS in memory\x00'
b'Admin\x00'
b'%LOCALAPPDATA%\\\x00'
b'DllInstall\x00'
b'cmd.exe /c \x00'
b'collectiontelemetrysystem.com\x00'
b'Not in domain\x00'
b'regsvr32.exe \x00'
b'%PROCESSOR_REVISION%\\\x00'
b'%APPDATA%\\\x00'
b'41.4.0\x00'
b'8QN04\x00'
b'64 Bit\x00'
b'8S2x\x00'
b'Starting the exe with parameters\x00'
b'C:\\Windows\\System32\\cmd.exe /c \x00'
b'cmd.exe /c \x00'
b'High start exe\x00'
b'Running exe\x00'
b'User-Agent: \x00'
b'%PROCESSOR_REVISION%\\\x00'
b'Content-Type: application/x-www-form-urlencoded\x00'
b'%APPDATA%\\\x00'
b'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\x00'
b'\\explorer.exe\x00'
b'MemLoadDllMain || MemLoadExe\x00'
b'Run CMD in memory\x00'
b'3CEk\x00'
b'3m7x\x00'
b'.nls\x00'
b'%APPDATA%\\\x00'
b'NCST \x00'
b'BCha\x00'
b"/c ECHO 'You must restart the program to resolve a critical error!' &amp;&amp; start \x00"
b'7eriel\x00'
b'%APPDATA%\\\x00'
b'.nls\x00'
b'%PROCESSOR_REVISION%\\\x00'
b"\\'z{VIS\rA6\rb\x00"
b'%LOCALAPPDATA%\\\x00'
b'IsWow64Process\x00'
b'rundll32.exe \x00'
b'%PROCESSOR_REVISION%\\\x00'
b'kernel32\x00'
b'%PROCESSOR_REVISION%\\\x00'
b'.nls\x00'
b'User\x00'
b'%PROCESSOR_REVISION%\\\x00'
b'.nls\x00'
b'\r\n\r\n\x00'
b'\rXOGONSEzBER%\x00'
b'%PROCESSOR_REVISION%\\\x00'
b'\nost: \x00'
b'MemLoadShellCode\x00'
b'Q6X6\x00'
b'timeout /t 3 &amp;&amp; del \x00'
b'cmd.exe\x00'
b'%02X-%02X-%02X-%02X-%02X-%02X\x00'
b'Running dll in memory #2 (DllRegisterServer)\x00'
b'Crypt update &amp; Bots upgrade\x00'
b'timeout /t 3 &amp;&amp; del \x00'
b'3fe11\x00'
b'%PROCESSOR_ARCHITECTURE%\x00'
b'%PROCESSOR_ARCHITECTURE%\x00'
b'NSeyDX\x00'
b'%APPDATA%\\\x00'
b'4nes\x00'
b'jpofxs\x00'
b'Not in domain\x00'
b'DllInstall\x00'
b' &amp;&amp; rd /s /q \x00'
b' &amp;&amp; regsvr32.exe -e "\x00'
b'32 Bit\x00'
b'%USERDOMAIN%\x00'
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Final-Config-Decryptor">
<a class="anchor" href="#Final-Config-Decryptor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Final Config Decryptor<a class="anchor-link" href="#Final-Config-Decryptor"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">pefile</span>


<span class="k">def</span> <span class="nf">xor_decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="k">len</span>(key)])
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_ascii</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">B</span><span class="s2">"^[\s!-~]+</span><span class="se">\0</span><span class="s2">*$"</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">get_strings</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="n">file_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">stack_strings</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#string_egg = rb'(\xC6\x45..){2,}'</span>

    <span class="n">string_egg</span> <span class="o">=</span> <span class="sa">rb</span><span class="s1">'(?P&lt;a&gt;(?:\xC6\x85.</span><span class="si">{5}</span><span class="s1">){0,})(?P&lt;b&gt;(?:\xC6\x45..){3,})'</span>   

    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">string_egg</span><span class="p">,</span> <span class="n">file_data</span><span class="p">):</span>
        <span class="n">match_data</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#stack_strings.append({"data":match_data.replace(b'\xC6\x45',b'')[1::2], "match":match_data})</span>
        <span class="n">stack_strings</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"data"</span><span class="p">:</span><span class="n">m</span><span class="p">[</span><span class="s1">'a'</span><span class="p">][</span><span class="mi">6</span><span class="p">::</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="s1">'b'</span><span class="p">][</span><span class="mi">3</span><span class="p">::</span><span class="mi">4</span><span class="p">],</span> <span class="s2">"match"</span><span class="p">:</span><span class="n">match_data</span><span class="p">})</span>

    <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">key_byte_len_egg</span> <span class="o">=</span> <span class="sa">rb</span><span class="s1">'\x68(....)\x68(....)\x6a\x00\x6a(.)'</span>

    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">key_byte_len_egg</span><span class="p">,</span> <span class="n">file_data</span><span class="p">):</span>
         <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">{</span><span class="s1">'key'</span><span class="p">:</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s1">'length'</span><span class="p">:</span><span class="nb">ord</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))})</span>


    <span class="n">key_dw_len_egg</span> <span class="o">=</span> <span class="sa">rb</span><span class="s1">'\x68(....)\x68(....)\x6a\x00\x68(....)'</span>

    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">key_dw_len_egg</span><span class="p">,</span> <span class="n">file_data</span><span class="p">):</span>
         <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">{</span><span class="s1">'key'</span><span class="p">:</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s1">'length'</span><span class="p">:</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))[</span><span class="mi">0</span><span class="p">]})</span>      

    <span class="n">out_strings</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">sj</span> <span class="ow">in</span> <span class="n">stack_strings</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">sj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'data'</span><span class="p">)</span>
        <span class="n">str_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">flag_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">tmp_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'length'</span><span class="p">)</span> <span class="o">==</span> <span class="n">str_len</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">xor_decrypt</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'key'</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">is_ascii</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
                    <span class="n">tmp_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">xor_decrypt</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
            <span class="k">if</span> <span class="n">is_ascii</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
                <span class="n">out_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">out_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_out</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is a hack</span>
            <span class="c1"># We have strings that will give valid ascii for multiple keys</span>
            <span class="c1"># So far these have only been dll names</span>
            <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">tmp_out</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">out</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">'dll'</span><span class="p">:</span>
                    <span class="n">out_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                    <span class="k">break</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">out_strings</span><span class="p">))</span>
            
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Test-All-Samples">
<a class="anchor" href="#Test-All-Samples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Test All Samples<a class="anchor-link" href="#Test-All-Samples"> </a>
</h4>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">get_strings</span><span class="p">(</span><span class="n">FILE_PATH</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">'/tmp/samples'</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".bin"</span><span class="p">):</span> 
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'/tmp/samples'</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">get_strings</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
        
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
/tmp/samples/55d329a13da236bec15c4c67686b809a2fbf5f6c9625b62d900ac22a7b729ba9.bin
[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\x00', b'rundll32.exe\x00', b'9npSEGB3kg9suo3Yit\x00', b'kernel32.dll', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/index.php\x00', b'Shlwapi.dll\x00', b'WS2_32.dll\x00', b'DllRegisterServer\x00', b'loaddll32.exe\x00', b'Shell32.dll\x00', b'Wininet.dll\x00', b'USER32.dll\x00', b'GetProcAddress', b'LoadLibraryA', b'IPHLPAPI.DLL\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\x00', b'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\x00', b'VirtualFree', b'regsvr32.exe\x00', b'%PROCESSOR_LEVEL%']

/tmp/samples/4b87f95c4477fc66c58b8e16a74f9c47217913cb4a78dc69f27a364a099acd90.bin
[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\x00', b'rundll32.exe\x00', b'9npSEGB3kg9suo3Yit\x00', b'kernel32.dll', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/index.php\x00', b'Shlwapi.dll\x00', b'WS2_32.dll\x00', b'DllRegisterServer\x00', b'loaddll32.exe\x00', b'Shell32.dll\x00', b'Wininet.dll\x00', b'USER32.dll\x00', b'GetProcAddress', b'LoadLibraryA', b'IPHLPAPI.DLL\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\x00', b'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\x00', b'VirtualFree', b'regsvr32.exe\x00', b'%PROCESSOR_LEVEL%']

/tmp/samples/0bdf1060b85ad55e73393eb0b59c1d226e091da4f4dcce65dacba5e9a1fd76a7.bin
[b'VirtualAlloc', b'start dll HackCheck', b'http://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/home.aspx\x00', b'https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/auth.aspx\x00', b'rundll32.exe\x00', b'kernel32.dll', b'Shlwapi.dll\x00', b'WS2_32.dll\x00', b'DllRegisterServer\x00', b'loaddll32.exe\x00', b'Shell32.dll\x00', b'Wininet.dll\x00', b'USER32.dll\x00', b'GetProcAddress', b'Netapi32.dll\x00', b'LoadLibraryA', b'http://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx\x00', b'Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 10.0; Win64; x64; Trident/8.0; .NET4.0C; .NET4.0E; .NET CLR 2.0.50727; .NET CLR 3.0.30729; .NET CLR 3.5.30729; Microsoft Outlook 16.0.5197; ms-office; MSOffice 16)\x00', b'IPHLPAPI.DLL\x00', b'Wkscli.dll\x00', b'https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx\x00', b'VirtualFree', b'https://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/auth.aspx\x00', b'%PROCESSOR_LEVEL%']

/tmp/samples/3cae2ce9b2d7040292f1661af63dc28e778027c46f78d8be3b1d43f4b6c2b046.bin
[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\x00', b'rundll32.exe\x00', b'9npSEGB3kg9suo3Yit\x00', b'kernel32.dll', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/index.php\x00', b'Shlwapi.dll\x00', b'WS2_32.dll\x00', b'DllRegisterServer\x00', b'loaddll32.exe\x00', b'Shell32.dll\x00', b'Wininet.dll\x00', b'USER32.dll\x00', b'GetProcAddress', b'LoadLibraryA', b'IPHLPAPI.DLL\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\x00', b'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\x00', b'VirtualFree', b'regsvr32.exe\x00', b'%PROCESSOR_LEVEL%']

/tmp/samples/b4e7710488c2b7aaa71688b8bd546410af07a215c2e835e8dfbe24887186bd4f.bin
[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\x00', b'rundll32.exe\x00', b'9npSEGB3kg9suo3Yit\x00', b'kernel32.dll', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/index.php\x00', b'Shlwapi.dll\x00', b'WS2_32.dll\x00', b'DllRegisterServer\x00', b'loaddll32.exe\x00', b'Shell32.dll\x00', b'Wininet.dll\x00', b'USER32.dll\x00', b'GetProcAddress', b'LoadLibraryA', b'IPHLPAPI.DLL\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\x00', b'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\x00', b'VirtualFree', b'regsvr32.exe\x00', b'%PROCESSOR_LEVEL%']

/tmp/samples/orig.bin
[b'VirtualAlloc', b'start dll HackCheck', b'http://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/home.aspx\x00', b'https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/auth.aspx\x00', b'rundll32.exe\x00', b'kernel32.dll', b'Shlwapi.dll\x00', b'WS2_32.dll\x00', b'DllRegisterServer\x00', b'loaddll32.exe\x00', b'Shell32.dll\x00', b'Wininet.dll\x00', b'USER32.dll\x00', b'GetProcAddress', b'Netapi32.dll\x00', b'LoadLibraryA', b'http://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx\x00', b'Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 10.0; Win64; x64; Trident/8.0; .NET4.0C; .NET4.0E; .NET CLR 2.0.50727; .NET CLR 3.0.30729; .NET CLR 3.5.30729; Microsoft Outlook 16.0.5197; ms-office; MSOffice 16)\x00', b'IPHLPAPI.DLL\x00', b'Wkscli.dll\x00', b'https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx\x00', b'VirtualFree', b'https://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/auth.aspx\x00', b'%PROCESSOR_LEVEL%']

/tmp/samples/2f36c571f20b2b2c2058d4db574a6d53b148450356bf529d72aefc19505c912e.bin
[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\x00', b'rundll32.exe\x00', b'9npSEGB3kg9suo3Yit\x00', b'kernel32.dll', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/index.php\x00', b'Shlwapi.dll\x00', b'WS2_32.dll\x00', b'DllRegisterServer\x00', b'loaddll32.exe\x00', b'Shell32.dll\x00', b'Wininet.dll\x00', b'USER32.dll\x00', b'GetProcAddress', b'LoadLibraryA', b'IPHLPAPI.DLL\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\x00', b'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\x00', b'VirtualFree', b'regsvr32.exe\x00', b'%PROCESSOR_LEVEL%']

/tmp/samples/4eb85a5532b98cbc4a6db1697cf46b9e2b7e28e89d6bbfc137b36c0736cd80e2.bin
[b'rundll32.exe\x00', b'ztCYGAuJ\x00', b'Shlwapi.dll\x00', b'WS2_32.dll\x00', b'https://windowsdriverupdate.at/V.asp\x00', b'DllRegisterServer\x00', b'Microsoft Office/16.0 (Windows NT 10.0; Microsoft Outlook 16.0.13127; Pro)\x00', b'Shell32.dll\x00', b'Wininet.dll\x00', b'USER32.dll\x00', b'https://windowsdriverupdate.at/ZBEr.asp\x00', b'Dll Uinstall\x00', b'%PROCESSOR_LEVEL%\x00', b'https://driverwindowsupdate.at/V.asp\x00', b'UnregisterServer\x00', b'IPHLPAPI.DLL\x00', b'%PROCESSOR_REVISION%\\\x00', b'regsvr32.exe\x00', b'"C:\\Windows\\system32\\schtasks.exe" /Create /SC MINUTE /MO 1 /TN \x00']

/tmp/samples/10d5483faf9a4e0fbc17556164f47f7014650797b7d501289b269515a0853b64.bin
[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\x00', b'rundll32.exe\x00', b'9npSEGB3kg9suo3Yit\x00', b'kernel32.dll', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/index.php\x00', b'Shlwapi.dll\x00', b'WS2_32.dll\x00', b'DllRegisterServer\x00', b'loaddll32.exe\x00', b'Shell32.dll\x00', b'Wininet.dll\x00', b'USER32.dll\x00', b'GetProcAddress', b'LoadLibraryA', b'IPHLPAPI.DLL\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\x00', b'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\x00', b'VirtualFree', b'regsvr32.exe\x00', b'%PROCESSOR_LEVEL%']

/tmp/samples/58a673023bbc7f2726e3b7ac917a43d9306692dc87b638ee21b98705a3262ccd.bin
[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\x00', b'rundll32.exe\x00', b'9npSEGB3kg9suo3Yit\x00', b'kernel32.dll', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/index.php\x00', b'Shlwapi.dll\x00', b'WS2_32.dll\x00', b'DllRegisterServer\x00', b'loaddll32.exe\x00', b'Shell32.dll\x00', b'Wininet.dll\x00', b'USER32.dll\x00', b'GetProcAddress', b'LoadLibraryA', b'IPHLPAPI.DLL\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\x00', b'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\x00', b'VirtualFree', b'regsvr32.exe\x00', b'%PROCESSOR_LEVEL%']

/tmp/samples/b9b399dbb5d901c16d97b7c30cc182736cd83a7c53313194a1798d61f9c7501e.bin
[]

/tmp/samples/fa6500946210334d397d612d5ee9b11456316e25672bc60c1267bbdb002af9c7.bin
[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\x00', b'rundll32.exe\x00', b'9npSEGB3kg9suo3Yit\x00', b'kernel32.dll', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/index.php\x00', b'Shlwapi.dll\x00', b'WS2_32.dll\x00', b'DllRegisterServer\x00', b'loaddll32.exe\x00', b'Shell32.dll\x00', b'Wininet.dll\x00', b'USER32.dll\x00', b'GetProcAddress', b'LoadLibraryA', b'IPHLPAPI.DLL\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\x00', b'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\x00', b'VirtualFree', b'regsvr32.exe\x00', b'%PROCESSOR_LEVEL%']

/tmp/samples/60f030597c75f9df0f7a494cb5432b600d41775cfe5cf13006c1448fa3a68d8d.bin
[b'VirtualAlloc', b'start dll HackCheck', b'http://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/home.aspx\x00', b'https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/auth.aspx\x00', b'rundll32.exe\x00', b'kernel32.dll', b'Shlwapi.dll\x00', b'WS2_32.dll\x00', b'DllRegisterServer\x00', b'loaddll32.exe\x00', b'Shell32.dll\x00', b'Wininet.dll\x00', b'USER32.dll\x00', b'GetProcAddress', b'Netapi32.dll\x00', b'LoadLibraryA', b'http://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx\x00', b'Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 10.0; Win64; x64; Trident/8.0; .NET4.0C; .NET4.0E; .NET CLR 2.0.50727; .NET CLR 3.0.30729; .NET CLR 3.5.30729; Microsoft Outlook 16.0.5197; ms-office; MSOffice 16)\x00', b'IPHLPAPI.DLL\x00', b'Wkscli.dll\x00', b'https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx\x00', b'VirtualFree', b'https://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/auth.aspx\x00', b'%PROCESSOR_LEVEL%']

/tmp/samples/e58b9bbb7bcdf3e901453b7b9c9e514fed1e53565e3280353dccc77cde26a98e.bin
[b'C:\\Windows\\System32\\schtasks.exe\x00', b'rundll32.exe\x00', b' /TR "%windir%\\system32\\regsvr32.exe -e \x00', b'%ProgramData%\\\x00', b'Shlwapi.dll\x00', b'WS2_32.dll\x00', b'DllRegisterServer\x00', b'%PROGRAMFILES%\\Opera\\Opera.exe\x00', b'Shell32.dll\x00', b'Wininet.dll\x00', b'USER32.dll\x00', b'Dll Uinstall\x00', b'%COMPUTERNAME%\x00', b'https://manageintel.com/RKyiihqXQiyE/xukYadevoVow/BhJM.xml\x00', b'UnregisterServer\x00', b'IPHLPAPI.DLL\x00', b'https://manageintel.com/RKyiihqXQiyE/xukYadevoVow/QXms.xml\x00', b'.ocx\x00', b'regsvr32.exe\x00', b'%PROCESSOR_LEVEL%\\\x00', b'%PROCESSOR_REVISION%\x00']

/tmp/samples/a3c896e23c86e47bcb77096e743010546cd7699e0189344d11b9c642b89deef1.bin
[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\x00', b'rundll32.exe\x00', b'9npSEGB3kg9suo3Yit\x00', b'kernel32.dll', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/index.php\x00', b'Shlwapi.dll\x00', b'WS2_32.dll\x00', b'DllRegisterServer\x00', b'loaddll32.exe\x00', b'Shell32.dll\x00', b'Wininet.dll\x00', b'USER32.dll\x00', b'GetProcAddress', b'LoadLibraryA', b'IPHLPAPI.DLL\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\x00', b'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\x00', b'VirtualFree', b'regsvr32.exe\x00', b'%PROCESSOR_LEVEL%']

/tmp/samples/f27821dddb17b6c8d59fb2ada1e90eac8d561476e5af3a6be064177683b0eee9.bin
[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\x00', b'rundll32.exe\x00', b'9npSEGB3kg9suo3Yit\x00', b'kernel32.dll', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/index.php\x00', b'Shlwapi.dll\x00', b'WS2_32.dll\x00', b'DllRegisterServer\x00', b'loaddll32.exe\x00', b'Shell32.dll\x00', b'Wininet.dll\x00', b'USER32.dll\x00', b'GetProcAddress', b'LoadLibraryA', b'IPHLPAPI.DLL\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\x00', b'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\x00', b'VirtualFree', b'regsvr32.exe\x00', b'%PROCESSOR_LEVEL%']
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Sample-Using-ADV-String-Obfuscation">
<a class="anchor" href="#Sample-Using-ADV-String-Obfuscation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sample Using ADV String Obfuscation<a class="anchor-link" href="#Sample-Using-ADV-String-Obfuscation"> </a>
</h3>
<p>A newer sample uses some type of ADV string obfuscation <code>b9b399dbb5d901c16d97b7c30cc182736cd83a7c53313194a1798d61f9c7501e</code>. We can probably use our old dumpulator tricks for  this.</p>
<p>The start of the <code>.text</code> section contains a vtable with all of the string decryption functions.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">dumpulator</span> <span class="kn">import</span> <span class="n">Dumpulator</span><span class="p">,</span> <span class="n">syscall</span>
<span class="kn">from</span> <span class="nn">dumpulator.native</span> <span class="kn">import</span> <span class="o">*</span>

<span class="nd">@syscall</span>
<span class="k">def</span> <span class="nf">ZwQueryVolumeInformationFile</span><span class="p">(</span><span class="n">dp</span><span class="p">:</span> <span class="n">Dumpulator</span><span class="p">,</span>
                                 <span class="n">FileHandle</span><span class="p">:</span> <span class="n">HANDLE</span><span class="p">,</span>
                                 <span class="n">IoStatusBlock</span><span class="p">:</span> <span class="n">P</span><span class="p">(</span><span class="n">IO_STATUS_BLOCK</span><span class="p">),</span>
                                 <span class="n">FsInformation</span><span class="p">:</span> <span class="n">PVOID</span><span class="p">,</span>
                                 <span class="n">Length</span><span class="p">:</span> <span class="n">ULONG</span><span class="p">,</span>
                                 <span class="n">FsInformationClass</span><span class="p">:</span> <span class="n">FSINFOCLASS</span>
                                 <span class="p">):</span>
    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span>



<span class="n">dp</span> <span class="o">=</span> <span class="n">Dumpulator</span><span class="p">(</span><span class="s2">"/tmp/b9b.dmp"</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">dp</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">eip</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">dp</span><span class="o">.</span><span class="n">read_ptr</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">esp</span><span class="p">))</span>

<span class="n">functs</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x74040976</span><span class="p">,</span><span class="mh">0x740409A4</span><span class="p">,</span><span class="mh">0x740409BA</span><span class="p">,</span><span class="mh">0x74040998</span><span class="p">,</span><span class="mh">0x7404098C</span><span class="p">,</span><span class="mh">0x7403F910</span><span class="p">,</span><span class="mh">0x7403F91C</span><span class="p">,</span><span class="mh">0x7403F967</span><span class="p">,</span><span class="mh">0x7403F9B2</span><span class="p">,</span><span class="mh">0x7403F9FD</span><span class="p">,</span><span class="mh">0x7403FA48</span><span class="p">,</span><span class="mh">0x7403FA93</span><span class="p">,</span><span class="mh">0x7403FADE</span><span class="p">,</span><span class="mh">0x7403FB44</span><span class="p">,</span><span class="mh">0x7403FBAE</span><span class="p">,</span><span class="mh">0x7403FC20</span><span class="p">,</span><span class="mh">0x7403FC98</span><span class="p">,</span><span class="mh">0x7403FD06</span><span class="p">,</span><span class="mh">0x7403FD74</span><span class="p">,</span><span class="mh">0x7403FDDD</span><span class="p">,</span><span class="mh">0x7403FE43</span><span class="p">,</span><span class="mh">0x7403FEBF</span><span class="p">,</span><span class="mh">0x7403FF46</span><span class="p">,</span><span class="mh">0x7403FFD5</span><span class="p">,</span><span class="mh">0x74040065</span><span class="p">,</span><span class="mh">0x740400DC</span><span class="p">,</span><span class="mh">0x74040146</span><span class="p">,</span><span class="mh">0x740401A2</span><span class="p">,</span><span class="mh">0x740401FE</span><span class="p">,</span><span class="mh">0x7404025A</span><span class="p">,</span><span class="mh">0x740402B6</span><span class="p">,</span><span class="mh">0x74040312</span><span class="p">,</span><span class="mh">0x74040378</span><span class="p">,</span><span class="mh">0x740403D4</span><span class="p">,</span><span class="mh">0x74040438</span><span class="p">,</span><span class="mh">0x7404048B</span><span class="p">,</span><span class="mh">0x740404DE</span><span class="p">,</span><span class="mh">0x74040542</span><span class="p">,</span><span class="mh">0x7404059E</span><span class="p">,</span><span class="mh">0x740405F1</span><span class="p">,</span><span class="mh">0x74040644</span><span class="p">,</span><span class="mh">0x740406A0</span><span class="p">,</span><span class="mh">0x74040706</span><span class="p">,</span><span class="mh">0x7404074F</span><span class="p">,</span><span class="mh">0x740407AB</span><span class="p">,</span><span class="mh">0x74040807</span><span class="p">,</span><span class="mh">0x7404085A</span><span class="p">,</span><span class="mh">0x740408B6</span><span class="p">,</span><span class="mh">0x7404091A</span><span class="p">]</span>

<span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">functs</span><span class="p">:</span>
    <span class="n">dp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">fn</span><span class="p">,[])</span>


<span class="n">str_tbl_start</span> <span class="o">=</span> <span class="mh">0x7407FDB4</span>
<span class="n">str_tbl_end</span> <span class="o">=</span> <span class="mh">0x7407FE7C</span>

<span class="n">str_tbl_start</span> <span class="o">=</span> <span class="mh">0x7407E000</span>
<span class="n">str_tbl_end</span> <span class="o">=</span> <span class="mh">0x74080224</span>

<span class="k">for</span> <span class="n">ptr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">str_tbl_start</span><span class="p">,</span><span class="n">str_tbl_end</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">read_str</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">read_ptr</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">continue</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Failed to read module data
C:\Users\IEUser\Desktop\DLLLoader32_82D6.exe
"C:\Users\IEUser\Desktop\DLLLoader32_82D6.exe"
e03ed
Uninstall
3fe11
Running exe
Starting the exe with parameters
Run CMD in memory
Run PS in memory
Running dll in memory #3 (DllInstall(Unstall))
Running dll in memory #3 (DllInstall(Install))
Regsvr32 &amp; Execute
MemLoadDllMain || MemLoadExe
zNETjp
5deb9c
Run EXE with admin rights
TAMfm
RunDll32 &amp; Execute
Crypt update &amp; Bots upgrade
Running dll in memory #2 (DllRegisterServer)
tbesqn
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Different-Sample-From-Same-Family">
<a class="anchor" href="#Different-Sample-From-Same-Family" aria-hidden="true"><span class="octicon octicon-link"></span></a>Different Sample From Same Family<a class="anchor-link" href="#Different-Sample-From-Same-Family"> </a>
</h4>
<p>This is clearly a different sample based on the decrypted strings, but it seems to be part of the matanbuchus family... maybe this is a payload instead of a loader? The sample matches analysis from this blog: <a href="https://r136a1.info/2022/05/25/introduction-of-a-pe-file-extractor-for-various-situations/">Introduction of a PE file extractor for various situations</a>&gt;</p>
<p>We need to figure out why these samples are so different...</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Taking-a-Closer-Look-At-Obfuscated-Samples">
<a class="anchor" href="#Taking-a-Closer-Look-At-Obfuscated-Samples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Taking a Closer Look At Obfuscated Samples<a class="anchor-link" href="#Taking-a-Closer-Look-At-Obfuscated-Samples"> </a>
</h2>
<p>Obfuscated sample</p>
<ul>
<li>
<code>b9b399dbb5d901c16d97b7c30cc182736cd83a7c53313194a1798d61f9c7501e</code> - does match yara (2021-11-12 11:47:44 UTC)</li>
</ul>
<p>Rony</p>
<ul>
<li>
<code>bd68ecd681b844232f050c21c1ea914590351ef64e889d8ef37ea63bd9e2a2ec</code> - doesn't match yara (2022-06-14 10:30:32 UTC)</li>
</ul>
<p>These samples appear to be the same (they are likely the "payload" portion of Matanbuchus) but the earlier sample uses obfuscated string encryption, while the newer sample uses the simpler stack based string encryption.</p>
<h3 id="Fixing-our-Yara-Rule-to-Match-the-Stack-Based-String-Encryption-Payload-(as-well-as-loaders)">
<a class="anchor" href="#Fixing-our-Yara-Rule-to-Match-the-Stack-Based-String-Encryption-Payload-(as-well-as-loaders)" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fixing our Yara Rule to Match the Stack Based String Encryption Payload (as well as loaders)<a class="anchor-link" href="#Fixing-our-Yara-Rule-to-Match-the-Stack-Based-String-Encryption-Payload-(as-well-as-loaders)"> </a>
</h3>
<p>This was a simple fix! The payload does not contain the murmur hash code, once we removed that the yara rule matched all samples.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Let's-Take-a-Look-At-the-Obfusacated-Strings">
<a class="anchor" href="#Let's-Take-a-Look-At-the-Obfusacated-Strings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Let's Take a Look At the Obfusacated Strings<a class="anchor-link" href="#Let's-Take-a-Look-At-the-Obfusacated-Strings"> </a>
</h3>
<p>We know that the one sample we have that is a "payload" will likely have some of the same strings as the obfuscated sample so let's pull these our first as a reference.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>b'Content-Length: \x00'
b'C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe \x00'
b'collectiontelemetrysystem.com\x00'
b'DllRegisterServer\x00'
b'097f5m\x00'
b'Running dll in memory #3 (DllInstall(Unstall))\x00'
b'runas\x00'
b'.exe\x00'
b'timeout /t 3 &amp;&amp; move /Y \x00'
b'Running dll in memory #3 (DllInstall(Install))\x00'
b'.exe\x00'
b'.exe\x00'
b'TiC7\x00'
b'.nls\x00'
b'Run PS in memory\x00'
b'Admin\x00'
b'%LOCALAPPDATA%\\\x00'
b'DllInstall\x00'
b'cmd.exe /c \x00'
b'collectiontelemetrysystem.com\x00'
b'Not in domain\x00'
b'regsvr32.exe \x00'
b'%PROCESSOR_REVISION%\\\x00'
b'%APPDATA%\\\x00'
b'41.4.0\x00'
b'8QN04\x00'
b'64 Bit\x00'
b'8S2x\x00'
b'Starting the exe with parameters\x00'
b'C:\\Windows\\System32\\cmd.exe /c \x00'
b'cmd.exe /c \x00'
b'High start exe\x00'
b'Running exe\x00'
b'User-Agent: \x00'
b'%PROCESSOR_REVISION%\\\x00'
b'Content-Type: application/x-www-form-urlencoded\x00'
b'%APPDATA%\\\x00'
b'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\x00'
b'\\explorer.exe\x00'
b'MemLoadDllMain || MemLoadExe\x00'
b'Run CMD in memory\x00'
b'3CEk\x00'
b'3m7x\x00'
b'.nls\x00'
b'%APPDATA%\\\x00'
b'NCST \x00'
b'BCha\x00'
b"/c ECHO 'You must restart the program to resolve a critical error!' &amp;&amp; start \x00"
b'7eriel\x00'
b'%APPDATA%\\\x00'
b'.nls\x00'
b'%PROCESSOR_REVISION%\\\x00'
b"\\'z{VIS\rA6\rb\x00"
b'%LOCALAPPDATA%\\\x00'
b'IsWow64Process\x00'
b'rundll32.exe \x00'
b'%PROCESSOR_REVISION%\\\x00'
b'kernel32\x00'
b'%PROCESSOR_REVISION%\\\x00'
b'.nls\x00'
b'User\x00'
b'%PROCESSOR_REVISION%\\\x00'
b'.nls\x00'
b'\r\n\r\n\x00'
b'\rXOGONSEzBER%\x00'
b'%PROCESSOR_REVISION%\\\x00'
b'\nost: \x00'
b'MemLoadShellCode\x00'
b'Q6X6\x00'
b'timeout /t 3 &amp;&amp; del \x00'
b'cmd.exe\x00'
b'%02X-%02X-%02X-%02X-%02X-%02X\x00'
b'Running dll in memory #2 (DllRegisterServer)\x00'
b'Crypt update &amp; Bots upgrade\x00'
b'timeout /t 3 &amp;&amp; del \x00'
b'3fe11\x00'
b'%PROCESSOR_ARCHITECTURE%\x00'
b'%PROCESSOR_ARCHITECTURE%\x00'
b'NSeyDX\x00'
b'%APPDATA%\\\x00'
b'4nes\x00'
b'jpofxs\x00'
b'Not in domain\x00'
b'DllInstall\x00'
b' &amp;&amp; rd /s /q \x00'
b' &amp;&amp; regsvr32.exe -e "\x00'
b'32 Bit\x00'
b'%USERDOMAIN%\x00'</code></pre>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">dumpulator</span> <span class="kn">import</span> <span class="n">Dumpulator</span><span class="p">,</span> <span class="n">syscall</span>
<span class="kn">from</span> <span class="nn">dumpulator.native</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pefile</span>


<span class="nd">@syscall</span>
<span class="k">def</span> <span class="nf">ZwQueryVolumeInformationFile</span><span class="p">(</span><span class="n">dp</span><span class="p">:</span> <span class="n">Dumpulator</span><span class="p">,</span>
                                 <span class="n">FileHandle</span><span class="p">:</span> <span class="n">HANDLE</span><span class="p">,</span>
                                 <span class="n">IoStatusBlock</span><span class="p">:</span> <span class="n">P</span><span class="p">(</span><span class="n">IO_STATUS_BLOCK</span><span class="p">),</span>
                                 <span class="n">FsInformation</span><span class="p">:</span> <span class="n">PVOID</span><span class="p">,</span>
                                 <span class="n">Length</span><span class="p">:</span> <span class="n">ULONG</span><span class="p">,</span>
                                 <span class="n">FsInformationClass</span><span class="p">:</span> <span class="n">FSINFOCLASS</span>
                                 <span class="p">):</span>
    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span>



<span class="n">dp</span> <span class="o">=</span> <span class="n">Dumpulator</span><span class="p">(</span><span class="s2">"/tmp/b9b.dmp"</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">dp</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">eip</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">dp</span><span class="o">.</span><span class="n">read_ptr</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">esp</span><span class="p">))</span>

<span class="n">functs</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x74040976</span><span class="p">,</span><span class="mh">0x740409A4</span><span class="p">,</span><span class="mh">0x740409BA</span><span class="p">,</span><span class="mh">0x74040998</span><span class="p">,</span><span class="mh">0x7404098C</span><span class="p">,</span><span class="mh">0x7403F910</span><span class="p">,</span><span class="mh">0x7403F91C</span><span class="p">,</span><span class="mh">0x7403F967</span><span class="p">,</span><span class="mh">0x7403F9B2</span><span class="p">,</span><span class="mh">0x7403F9FD</span><span class="p">,</span><span class="mh">0x7403FA48</span><span class="p">,</span><span class="mh">0x7403FA93</span><span class="p">,</span><span class="mh">0x7403FADE</span><span class="p">,</span><span class="mh">0x7403FB44</span><span class="p">,</span><span class="mh">0x7403FBAE</span><span class="p">,</span><span class="mh">0x7403FC20</span><span class="p">,</span><span class="mh">0x7403FC98</span><span class="p">,</span><span class="mh">0x7403FD06</span><span class="p">,</span><span class="mh">0x7403FD74</span><span class="p">,</span><span class="mh">0x7403FDDD</span><span class="p">,</span><span class="mh">0x7403FE43</span><span class="p">,</span><span class="mh">0x7403FEBF</span><span class="p">,</span><span class="mh">0x7403FF46</span><span class="p">,</span><span class="mh">0x7403FFD5</span><span class="p">,</span><span class="mh">0x74040065</span><span class="p">,</span><span class="mh">0x740400DC</span><span class="p">,</span><span class="mh">0x74040146</span><span class="p">,</span><span class="mh">0x740401A2</span><span class="p">,</span><span class="mh">0x740401FE</span><span class="p">,</span><span class="mh">0x7404025A</span><span class="p">,</span><span class="mh">0x740402B6</span><span class="p">,</span><span class="mh">0x74040312</span><span class="p">,</span><span class="mh">0x74040378</span><span class="p">,</span><span class="mh">0x740403D4</span><span class="p">,</span><span class="mh">0x74040438</span><span class="p">,</span><span class="mh">0x7404048B</span><span class="p">,</span><span class="mh">0x740404DE</span><span class="p">,</span><span class="mh">0x74040542</span><span class="p">,</span><span class="mh">0x7404059E</span><span class="p">,</span><span class="mh">0x740405F1</span><span class="p">,</span><span class="mh">0x74040644</span><span class="p">,</span><span class="mh">0x740406A0</span><span class="p">,</span><span class="mh">0x74040706</span><span class="p">,</span><span class="mh">0x7404074F</span><span class="p">,</span><span class="mh">0x740407AB</span><span class="p">,</span><span class="mh">0x74040807</span><span class="p">,</span><span class="mh">0x7404085A</span><span class="p">,</span><span class="mh">0x740408B6</span><span class="p">,</span><span class="mh">0x7404091A</span><span class="p">]</span>

<span class="n">functs</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x7403FC98</span><span class="p">]</span>

<span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">functs</span><span class="p">:</span>
    <span class="n">dp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">fn</span><span class="p">,[])</span>


<span class="n">data_start</span> <span class="o">=</span> <span class="mh">0x7407E000</span>
<span class="n">data_end</span> <span class="o">=</span> <span class="mh">0x74080228</span>

<span class="k">for</span> <span class="n">ptr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data_start</span><span class="p">,</span><span class="n">data_end</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">read_str</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">read_ptr</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">continue</span>
        
        
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n\n\n</span><span class="s2"> ===</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> 

<span class="nb">print</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">read_str</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">read_ptr</span><span class="p">(</span><span class="mh">0x7407FDFC</span> <span class="p">)))</span>

        
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Failed to read module data
C:\Users\IEUser\Desktop\DLLLoader32_82D6.exe
"C:\Users\IEUser\Desktop\DLLLoader32_82D6.exe"
Q6X6
zkC7
rJqU
e03ed
3CEk
Uninstall
3fe11
Running exe
au5o
Starting the exe with parameters
3m7x
Run CMD in memory
Run PS in memory
Running dll in memory #3 (DllInstall(Unstall))
Running dll in memory #3 (DllInstall(Install))
Regsvr32 &amp; Execute
MemLoadDllMain || MemLoadExe
b2tb
hszA
zNETjp
5deb9c
DS2x
Run EXE with admin rights
TAMfm
RunDll32 &amp; Execute
wgjv
Crypt update &amp; Bots upgrade
f1da
nX8y
Running dll in memory #2 (DllRegisterServer)
tbesqn



 ===

Running exe
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">FILE_PATH</span> <span class="o">=</span> <span class="s1">'/tmp/samples/b9b399dbb5d901c16d97b7c30cc182736cd83a7c53313194a1798d61f9c7501e.bin'</span>
<span class="n">file_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">FILE_PATH</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>



<span class="k">def</span> <span class="nf">xor_decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="k">len</span>(key)])
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_ascii</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">B</span><span class="s2">"^[\s!-~]+</span><span class="se">\0</span><span class="s2">*$"</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>




<span class="c1"># .text:74049A7D C6 45 B8 0D                             mov     byte ptr [ebp-48h], 13</span>
<span class="c1"># .text:74049A81 C7 45 E0 6E 60 69 23                    mov     dword ptr [ebp-20h], 2369606Eh</span>
<span class="c1"># .text:74049A88 C7 45 E4 68 75 68 2D                    mov     dword ptr [ebp-1Ch], 2D687568h</span>
<span class="c1"># .text:74049A8F C7 45 E8 22 6E 2D 00                    mov     dword ptr [ebp-18h], 2D6E22h</span>
<span class="c1"># .text:74049A96 C7 45 EC DA 4E 1E 00                    mov     dword ptr [ebp-14h], 1E4EDAh</span>

<span class="n">test_data</span> <span class="o">=</span> <span class="n">unhex</span><span class="p">(</span><span class="s1">'895db4c645b80dc745e06e606923c745e46875682dc745e8226e2d00c745ecda4e1e0052'</span><span class="p">)</span>

<span class="n">stack_strings</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">string_egg</span> <span class="o">=</span> <span class="sa">rb</span><span class="s1">'(?P&lt;a&gt;(?:\xC6\x45..)</span><span class="si">{1}</span><span class="s1">)(?P&lt;b&gt;(?:\xC7\x45.....){2,})'</span>   


<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">string_egg</span><span class="p">,</span> <span class="n">file_data</span><span class="p">):</span>
    <span class="n">match_data</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1">#print(tohex(match_data))</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">'a'</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">raw_data</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">'b'</span><span class="p">]</span>
    <span class="n">str_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">''</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="p">),</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">str_data</span> <span class="o">+=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">7</span><span class="p">][</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">xor_decrypt</span><span class="p">(</span><span class="n">str_data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">key</span><span class="p">])))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>b'Shell32.dllR'
b'Matanbuc'
b' HTTP/1.'
b'User-Agent: '
b'DllInsta'
b'DllInsta'
b'cmd.exe /c \x05\xdfK\x1b\x05'
b' &amp;&amp; rd /s /q'
b'cmd.exe /c \r\xd7C\x13\r'
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># .text:7404406B C7 45 AC 71 5D 48 5D                    mov     dword ptr [ebp-54h], 5D485D71h</span>
<span class="c1"># .text:74044072 C7 45 B0 52 5E 49 5F                    mov     dword ptr [ebp-50h], 5F495E52h</span>
<span class="c1"># .text:74044079 C7 45 B4 54 49 4F 0A                    mov     dword ptr [ebp-4Ch], 0A4F4954h</span>
<span class="c1"># .text:74044080 66 C7 45 B8 0A 0A                       mov     word ptr [ebp-48h], 0A0Ah</span>
    
    
    
<span class="c1"># .text:74048CF5 C6 45 B8 31                             mov     byte ptr [ebp-48h], 31h ; '1'</span>
<span class="c1"># .text:74048CF9 C7 45 E0 75 5D 5D 78                    mov     dword ptr [ebp-20h], 785D5D75h</span>
<span class="c1"># .text:74048D00 C7 45 E4 5F 42 45 50                    mov     dword ptr [ebp-1Ch], 5045425Fh</span>
<span class="c1"># .text:74048D07 66 C7 45 E8 5D 5D                       mov     word ptr [ebp-18h], 5D5Dh</span>
<span class="c1"># .text:74048D0D 88 5D EA                                mov     [ebp-16h], bl</span>
<span class="c1"># .text:74048D10 C7 45 EC DA 4E 1E 00                    mov     dword ptr [ebp-14h], 1E4EDAh</span>



<span class="c1"># .text:740454A9 30 14 08                                xor     [eax+ecx], dl</span>
<span class="c1"># .text:740454AC 41                                      inc     ecx</span>
<span class="c1"># .text:740454AD 83 F9 1D                                cmp     ecx, 1Dh</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-cyan-fg">  File </span><span class="ansi-green-fg">"&lt;ipython-input-82-89ec58536910&gt;"</span><span class="ansi-cyan-fg">, line </span><span class="ansi-green-fg">18</span>
<span class="ansi-red-fg">    80 b0 d8 ff 07 74 a8 40 83 f8 06</span>
       ^
<span class="ansi-red-fg">SyntaxError</span><span class="ansi-red-fg">:</span> invalid syntax
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">dumpulator</span> <span class="kn">import</span> <span class="n">Dumpulator</span><span class="p">,</span> <span class="n">syscall</span>
<span class="kn">from</span> <span class="nn">dumpulator.native</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pefile</span>


<span class="nd">@syscall</span>
<span class="k">def</span> <span class="nf">ZwQueryVolumeInformationFile</span><span class="p">(</span><span class="n">dp</span><span class="p">:</span> <span class="n">Dumpulator</span><span class="p">,</span>
                                 <span class="n">FileHandle</span><span class="p">:</span> <span class="n">HANDLE</span><span class="p">,</span>
                                 <span class="n">IoStatusBlock</span><span class="p">:</span> <span class="n">P</span><span class="p">(</span><span class="n">IO_STATUS_BLOCK</span><span class="p">),</span>
                                 <span class="n">FsInformation</span><span class="p">:</span> <span class="n">PVOID</span><span class="p">,</span>
                                 <span class="n">Length</span><span class="p">:</span> <span class="n">ULONG</span><span class="p">,</span>
                                 <span class="n">FsInformationClass</span><span class="p">:</span> <span class="n">FSINFOCLASS</span>
                                 <span class="p">):</span>
    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span>



<span class="n">dp</span> <span class="o">=</span> <span class="n">Dumpulator</span><span class="p">(</span><span class="s2">"/tmp/b9b.dmp"</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">dp</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">eip</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">dp</span><span class="o">.</span><span class="n">read_ptr</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">esp</span><span class="p">))</span>



<span class="n">start_addr</span> <span class="o">=</span> <span class="mh">0x74044390</span>  
<span class="n">end_addr</span> <span class="o">=</span> <span class="mh">0x740443C1</span>  

<span class="n">dp</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">start_addr</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_addr</span><span class="p">)</span>

<span class="n">dp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">ebx</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Failed to read module data
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>bytearray(b'193.56.146.60\\')</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="String-Decryption-Recap">
<a class="anchor" href="#String-Decryption-Recap" aria-hidden="true"><span class="octicon octicon-link"></span></a>String Decryption Recap<a class="anchor-link" href="#String-Decryption-Recap"> </a>
</h3>
<p>With these older samples, there are 3 different string decryption methods used</p>
<ul>
<li>Stack strings build with DWORDs that are decrypted using a single byte XOR, the byte is the first byte pushed onto the stack string (this is the same method used for small strings in the new samples)</li>
<li>Global strings that are generated using constructors which have some light obfuscation. To deal with these we simply emulate all of the constructors and scrape the global strings from the <code>.data</code> section of the PE.</li>
<li>The third and most complex method relies on two calls to functions used to build the encrypted string and then a simple single-byte XOR to decrypt the string. </li>
</ul>
<h4 id="Complex-Third-String-Decryption-Method">
<a class="anchor" href="#Complex-Third-String-Decryption-Method" aria-hidden="true"><span class="octicon octicon-link"></span></a>Complex Third String Decryption Method<a class="anchor-link" href="#Complex-Third-String-Decryption-Method"> </a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>c6 45 c4 53 57 6a 08

740458C7

.text:740436A5 BE DA 4E 1E 00                          mov     esi, 1E4EDAh
.text:740436AA 89 9D 28 FF FF FF                       mov     [ebp+var_D8], ebx
.text:740436B0 89 9D 2C FF FF FF                       mov     [ebp+var_D4], ebx

BE DA ?? ?? ?? 89 ?? ?? ?? ?? ?? 89

.text:740480FF 89 5D B0                                mov     [ebp-50h], ebx
.text:74048102 8B D3                                   mov     edx, ebx
.text:74048104 89 5D B4                                mov     [ebp-4Ch], ebx
.text:74048107 89 5D B8                                mov     [ebp-48h], ebx
.text:7404810A C6 45 BC 1A                             mov     byte ptr [ebp-44h], 1Ah

89 ?? ?? 8b ?? 89 ?? ?? 89 ?? ?? c6 45

.text:740431A2 72 F7                                   jb      short loc_7404319B
.text:740431A4 88 59 0C                                mov     [ecx+12], bl

.text:740438E2 72 F7                                   jb      short loc_740438DB
.text:740438E4 88 59 0B                                mov     [ecx+0Bh], bl</code></pre>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">dumpulator</span> <span class="kn">import</span> <span class="n">Dumpulator</span><span class="p">,</span> <span class="n">syscall</span>
<span class="kn">from</span> <span class="nn">dumpulator.native</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pefile</span>




<span class="nd">@syscall</span>
<span class="k">def</span> <span class="nf">ZwQueryVolumeInformationFile</span><span class="p">(</span><span class="n">dp</span><span class="p">:</span> <span class="n">Dumpulator</span><span class="p">,</span>
                                 <span class="n">FileHandle</span><span class="p">:</span> <span class="n">HANDLE</span><span class="p">,</span>
                                 <span class="n">IoStatusBlock</span><span class="p">:</span> <span class="n">P</span><span class="p">(</span><span class="n">IO_STATUS_BLOCK</span><span class="p">),</span>
                                 <span class="n">FsInformation</span><span class="p">:</span> <span class="n">PVOID</span><span class="p">,</span>
                                 <span class="n">Length</span><span class="p">:</span> <span class="n">ULONG</span><span class="p">,</span>
                                 <span class="n">FsInformationClass</span><span class="p">:</span> <span class="n">FSINFOCLASS</span>
                                 <span class="p">):</span>
    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span>


<span class="k">def</span> <span class="nf">emulate</span><span class="p">(</span><span class="n">start_addr</span><span class="p">,</span> <span class="n">end_addr</span><span class="p">,</span> <span class="n">ret_reg</span><span class="p">,</span> <span class="n">str_len</span><span class="p">):</span>
    <span class="n">dp</span> <span class="o">=</span> <span class="n">Dumpulator</span><span class="p">(</span><span class="s2">"/tmp/b9b.dmp"</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dp</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">eip</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">dp</span><span class="o">.</span><span class="n">read_ptr</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">esp</span><span class="p">))</span>
    <span class="n">dp</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">start_addr</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_addr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">ret_reg</span><span class="p">),</span> <span class="n">str_len</span><span class="p">)</span>


<span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="o">.</span><span class="n">PE</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">file_data</span><span class="p">)</span>

<span class="n">em_egg</span> <span class="o">=</span> <span class="sa">rb</span><span class="s1">'\xBE\xDA...\x89.....\x89.+?(?=\x72\xf7\x88)'</span>


<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">em_egg</span><span class="p">,</span> <span class="n">file_data</span><span class="p">):</span>
    <span class="n">start_offset</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">end_offset</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">start_addr</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_rva_from_offset</span><span class="p">(</span><span class="n">start_offset</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x74030000</span>
    <span class="n">end_addr</span> <span class="o">=</span>  <span class="n">pe</span><span class="o">.</span><span class="n">get_rva_from_offset</span><span class="p">(</span><span class="n">end_offset</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x74030000</span>
    <span class="n">str_len</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">end_offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">file_data</span><span class="p">[</span><span class="n">end_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x5f</span><span class="p">:</span>
        <span class="n">reg_name</span> <span class="o">=</span> <span class="s1">'edi'</span>
    <span class="k">elif</span> <span class="n">file_data</span><span class="p">[</span><span class="n">end_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x59</span><span class="p">:</span>
        <span class="n">reg_name</span> <span class="o">=</span> <span class="s1">'ecx'</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Testing: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">start_addr</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">emulate</span><span class="p">(</span><span class="n">start_addr</span><span class="p">,</span> <span class="n">end_addr</span><span class="p">,</span> <span class="n">reg_name</span><span class="p">,</span> <span class="n">str_len</span> <span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"fail"</span><span class="p">)</span>
        <span class="k">continue</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Testing: 0x74042f48
Failed to read module data
bytearray(b'IPHLPAPI.DLL')
Testing: 0x740430ce
Failed to read module data
bytearray(b'IPHLPAPI.DLL')
Testing: 0x740436a5
Failed to read module data
bytearray(b'\xfb\xcc\xf5\xfc\xd5i\xd2\t\xf7nz')
Testing: 0x74043814
Failed to read module data
bytearray(b'\x98\xe7\xe1\x13-\x0fo\xc0hUY')
Testing: 0x74043991
Failed to read module data
fail
</pre>
</div>
</div>

</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/matanbuchus/loader/yara/triage/dumpulator/emulation/2022/06/19/matanbuchus-triage.html" hidden></a>
</article>
