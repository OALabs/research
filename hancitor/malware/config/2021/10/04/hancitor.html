<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Hancitor | OALABS Research</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Hancitor" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Hancitor static config extractor" />
<meta property="og:description" content="Hancitor static config extractor" />
<link rel="canonical" href="https://research.openanalysis.net/hancitor/malware/config/2021/10/04/hancitor.html" />
<meta property="og:url" content="https://research.openanalysis.net/hancitor/malware/config/2021/10/04/hancitor.html" />
<meta property="og:site_name" content="OALABS Research" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-10-04T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Hancitor" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-10-04T00:00:00-05:00","datePublished":"2021-10-04T00:00:00-05:00","description":"Hancitor static config extractor","headline":"Hancitor","mainEntityOfPage":{"@type":"WebPage","@id":"https://research.openanalysis.net/hancitor/malware/config/2021/10/04/hancitor.html"},"url":"https://research.openanalysis.net/hancitor/malware/config/2021/10/04/hancitor.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://research.openanalysis.net/feed.xml" title="OALABS Research" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">OALABS Research</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Hancitor</h1><p class="page-description">Hancitor static config extractor</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-10-04T00:00:00-05:00" itemprop="datePublished">
        Oct 4, 2021
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#hancitor">hancitor</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#malware">malware</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#config">config</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2021-10-04-hancitor.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a></li>
<li class="toc-entry toc-h2"><a href="#Malware-Sample">Malware Sample </a></li>
<li class="toc-entry toc-h2"><a href="#References">References </a></li>
<li class="toc-entry toc-h2"><a href="#Setup-Imports">Setup Imports </a></li>
<li class="toc-entry toc-h2"><a href="#Load-The-Malware">Load The Malware </a></li>
<li class="toc-entry toc-h2"><a href="#Use-A-Regular-Expression-to-Locate-The-Decryption-Code">Use A Regular Expression to Locate The Decryption Code </a></li>
<li class="toc-entry toc-h2"><a href="#Convert-The-Extracted-Key-Information">Convert The Extracted Key Information </a></li>
<li class="toc-entry toc-h2"><a href="#Use-The-Key-Information-To-Extract-The-Key-Data">Use The Key Information To Extract The Key Data </a></li>
<li class="toc-entry toc-h2"><a href="#Hash-The-Key-Data-To-Create-The-Key">Hash The Key Data To Create The Key </a></li>
<li class="toc-entry toc-h2"><a href="#RC4-Decryption">RC4 Decryption </a></li>
<li class="toc-entry toc-h2"><a href="#Parsing-The-Config">Parsing The Config </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-10-04-hancitor.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p>Notes from our live stream where we reverse engineered the Hancitor DLL and built a static config extractor for it.

</p>
<center class="youtube-iframe-wrapper">
    <iframe width="730" height="315" src="https://www.youtube.com/embed/watch?v=OQuRwpUTBpQ" frameborder="0" allowfullscreen=""></iframe>
</center>

<h2 id="Malware-Sample">
<a class="anchor" href="#Malware-Sample" aria-hidden="true"><span class="octicon octicon-link"></span></a>Malware Sample<a class="anchor-link" href="#Malware-Sample"> </a>
</h2>
<ul>
<li><a href="https://www.malware-traffic-analysis.net/2021/09/02/index.html">Malware Traffic Analysis Sample 1</a></li>
<li><a href="https://malshare.com/sample.php?action=detail&amp;hash=39ae285d4a7436eec52ee4da032da13132cdf259768de8a0e396ad20245fe330">Unpacked Sample (malshare)</a></li>
</ul>
<h2 id="References">
<a class="anchor" href="#References" aria-hidden="true"><span class="octicon octicon-link"></span></a>References<a class="anchor-link" href="#References"> </a>
</h2>
<p><a href="https://thedfirreport.com/2021/06/28/hancitor-continues-to-push-cobalt-strike/">DFIR Report Hancitor</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup-Imports">
<a class="anchor" href="#Setup-Imports" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup Imports<a class="anchor-link" href="#Setup-Imports"> </a>
</h2>
<p>We are going to need some libraries to get our config extractor working.</p>
<ul>
<li>
<strong>pefile</strong> - Parse data into a PE format. <a href="https://github.com/erocarrera/pefile">Read the docs.</a>
</li>
<li>
<strong>re</strong> - Use a regular expression to locate our config data. <a href="https://docs.python.org/3/library/re.html">Read the docs.</a>
</li>
<li>
<strong>struct</strong> - Convert binary data into numeric values. <a href="https://docs.python.org/3/library/struct.html">Read the docs.</a>
</li>
<li>
<strong>hashlib</strong> - Generate a SHA1 hash. <a href="https://docs.python.org/3/library/hashlib.html">Read the docs.</a>
</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pefile</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Load-The-Malware">
<a class="anchor" href="#Load-The-Malware" aria-hidden="true"><span class="octicon octicon-link"></span></a>Load The Malware<a class="anchor-link" href="#Load-The-Malware"> </a>
</h2>
<p>We need to read in the malware binary, remember to replace the path with a path the file on your own host. We also want to parse the data as a PE file so we can easily access the PE structure in our code.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">file_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'/tmp/hancitor.bin'</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="o">.</span><span class="n">PE</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Use-A-Regular-Expression-to-Locate-The-Decryption-Code">
<a class="anchor" href="#Use-A-Regular-Expression-to-Locate-The-Decryption-Code" aria-hidden="true"><span class="octicon octicon-link"></span></a>Use A Regular Expression to Locate The Decryption Code<a class="anchor-link" href="#Use-A-Regular-Expression-to-Locate-The-Decryption-Code"> </a>
</h2>
<p>We can use a regulare expression to find the code that is used to setup the arguments for the config decryption function. The key is to assume that the config length will say the same 0x2000 so we can use this as a marker in the code.</p>
<p><img src="https://i.imgur.com/YxoCA7b.png" alt=""></p>
<p>The <code>(.)</code> in our regular expression are a wildcard -- match any bytes -- in a capture group. The capture group can then be used to extract the data that was matched by the wildcard. In this case we use a capture group to pull the size of the key and the address of the key.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">key</span> <span class="o">=</span> <span class="sa">rb</span><span class="s1">'\x6a(.)\x68(....)\x68\x00\x20\x00\x00'</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="k">if</span> <span class="n">m</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"key length: </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"key address: </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>key length: b'\x08'
key address: b'\x10PV\x00'
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Convert-The-Extracted-Key-Information">
<a class="anchor" href="#Convert-The-Extracted-Key-Information" aria-hidden="true"><span class="octicon octicon-link"></span></a>Convert The Extracted Key Information<a class="anchor-link" href="#Convert-The-Extracted-Key-Information"> </a>
</h2>
<p>The key information extracted in our capture groups is binary so it must be converted into a data type to be used in our scipt. WE can use the <code>struct</code> library to do this. The <code>'b'</code> signifies that we are converting a byte and the <code>'&lt;I'</code> signifies that we are converting an unsigned integer (DWORD) stored in little-endian format.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'b'</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>8</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">hex</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'0x565010'</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Use-The-Key-Information-To-Extract-The-Key-Data">
<a class="anchor" href="#Use-The-Key-Information-To-Extract-The-Key-Data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Use The Key Information To Extract The Key Data<a class="anchor-link" href="#Use-The-Key-Information-To-Extract-The-Key-Data"> </a>
</h2>
<p>Now that we have the key length and key address we can use this information to extract the key data, and the config data (which directly follows the key in the binary). The key address needs to be converted into a <strong>file offset</strong> so we can locate that data in our file.</p>
<p>To convert from an address in the PE file to a file offset we must first convert the address into a <strong>relative virtual address (RVA)</strong> then we can use the build in pefile function <code>get_offset_from_rva</code> to convert the RVA to a file offset.</p>
<p>Once we have the file offset of the key data we can extract the key and the config from our file.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">key_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'b'</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">key_address</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">key_rva</span> <span class="o">=</span> <span class="n">key_address</span> <span class="o">-</span> <span class="n">pe</span><span class="o">.</span><span class="n">OPTIONAL_HEADER</span><span class="o">.</span><span class="n">ImageBase</span>
<span class="n">key_offset</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_offset_from_rva</span><span class="p">(</span><span class="n">key_rva</span><span class="p">)</span>
<span class="n">key_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key_offset</span><span class="p">:</span><span class="n">key_offset</span><span class="o">+</span><span class="n">key_len</span><span class="p">]</span>
<span class="n">config_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key_offset</span><span class="o">+</span><span class="n">key_len</span><span class="p">:</span><span class="n">key_offset</span><span class="o">+</span><span class="n">key_len</span><span class="o">+</span><span class="mh">0x2000</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Hash-The-Key-Data-To-Create-The-Key">
<a class="anchor" href="#Hash-The-Key-Data-To-Create-The-Key" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hash The Key Data To Create The Key<a class="anchor-link" href="#Hash-The-Key-Data-To-Create-The-Key"> </a>
</h2>
<p>The config decryption key is the first 5 bytes of a <strong>sha1</strong> hash of the key data. We can use the hashlib library to create the key hash.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">key_data</span><span class="p">)</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">digest</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="RC4-Decryption">
<a class="anchor" href="#RC4-Decryption" aria-hidden="true"><span class="octicon octicon-link"></span></a>RC4 Decryption<a class="anchor-link" href="#RC4-Decryption"> </a>
</h2>
<p>The actual decryption algorithm is RC4. If you want to learn more about RC4 you can check out our <a href="https://www.youtube.com/watch?v=CiJocXXMXK4">RC4 Tutorial</a>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">rc4crypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="c1">#If the input is a string convert to byte arrays</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">box</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">box</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)])</span> <span class="o">%</span> <span class="mi">256</span>
        <span class="n">box</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">box</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span>
        <span class="n">box</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span> <span class="o">^</span> <span class="n">box</span><span class="p">[(</span><span class="n">box</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">box</span><span class="p">[</span><span class="n">y</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Parsing-The-Config">
<a class="anchor" href="#Parsing-The-Config" aria-hidden="true"><span class="octicon octicon-link"></span></a>Parsing The Config<a class="anchor-link" href="#Parsing-The-Config"> </a>
</h2>
<p>Once we have the config decrypted we can parse out the BUILD and the C2 list.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">rc4crypt</span><span class="p">(</span><span class="n">config_data</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="n">build_id</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">c2_string</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">''</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">''</span><span class="p">:</span>
        <span class="n">c2_string</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">break</span>
<span class="n">c2_list</span> <span class="o">=</span> <span class="n">c2_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">'|'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"BUILD: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">build_id</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">c2_list</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">c2</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">''</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"C2: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">c2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>BUILD: b'0109_iqwnm'
C2: b'http://asinvotheir.com/8/forum.php'
C2: b'http://ditrismale.ru/8/forum.php'
C2: b'http://clatrommon.ru/8/forum.php'
</pre>
</div>
</div>

</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/hancitor/malware/config/2021/10/04/hancitor.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
