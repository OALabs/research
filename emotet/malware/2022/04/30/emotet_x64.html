<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Emotet 64-bit</h1><p class="page-description">Initial Triage of new Emotet 64-bit sample</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-04-30T00:00:00-05:00" itemprop="datePublished">
        Apr 30, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      5 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#emotet">emotet</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#malware">malware</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2022-04-30-emotet_x64.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Samples">Samples </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Initial-Triage">Initial Triage </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Payload-Binary-Overview">Payload Binary Overview </a></li>
<li class="toc-entry toc-h3"><a href="#Code">Code </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Helper-Functions">Helper Functions </a></li>
<li class="toc-entry toc-h2"><a href="#String-Decryption">String Decryption </a></li>
<li class="toc-entry toc-h2"><a href="#C2-Table">C2 Table </a></li>
<li class="toc-entry toc-h2"><a href="#Binary-Exploration-with-Dumpulator">Binary Exploration with Dumpulator </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Using-Dumpultor">Using Dumpultor </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Generate-a-Yara-Rule">Generate a Yara Rule </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Hunting-Traints">Hunting Traints </a></li>
<li class="toc-entry toc-h3"><a href="#Robust-Rule-Traits">Robust Rule Traits </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-04-30-emotet_x64.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p>We are going to take a look at the new Emotet 64-bit samples and see if we can generate a Yara rule and a config extractor.</p>
<h3 id="Samples">
<a class="anchor" href="#Samples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Samples<a class="anchor-link" href="#Samples"> </a>
</h3>
<ul>
<li>
<a href="https://malshare.com/sample.php?action=detail&amp;hash=b481ac05ea9a59eedf6233166327057279babef26c913a8e89536472b192e86c">Packed</a> (<code>b481ac05ea9a59eedf6233166327057279babef26c913a8e89536472b192e86c</code>)</li>
<li>
<a href="https://malshare.com/sample.php?action=detail&amp;hash=ed2640be5ed0a4486ecf7ac97b125e26b9d263624251eae1c9a42e9998ca1e68">Unpacked</a> (<code>ed2640be5ed0a4486ecf7ac97b125e26b9d263624251eae1c9a42e9998ca1e68</code>)

<center>
    <div class="jekyll-twitter-plugin">
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">The PS1 has zero detections on VT ðŸ‘€<br><br>Distro compromised URL:<br>hxxp://ciencias-exactas[.]com[.]ar/old/w/<a href="https://twitter.com/hashtag/Emotet?src=hash&amp;ref_src=twsrc%5Etfw">#Emotet</a> DLL payload, MD5: 71675a9a8abbce8ba524f8f6ef3735ed <a href="https://t.co/95Na6SzguN">pic.twitter.com/95Na6SzguN</a></p>â€” Max_Malyutin (@Max_Mal_) <a href="https://twitter.com/Max_Mal_/status/1519797858681208832?ref_src=twsrc%5Etfw">April 28, 2022</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
</center>

<center>
    <div class="jekyll-twitter-plugin">
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">ðŸš¨<a href="https://twitter.com/hashtag/Emotet?src=hash&amp;ref_src=twsrc%5Etfw">#Emotet</a> UpdateðŸš¨ - Looks like Ivan laid an egg for easter and has been busy. As of about 14:00UTC today 2022/04/18 - Emotet on Epoch 4 has switched over to using 64-bit loaders and stealer modules. Previously everything was 32-bit except for occasional loader shenanigans. 1/x</p>â€” Cryptolaemus (@Cryptolaemus1) <a href="https://twitter.com/Cryptolaemus1/status/1516261512372965383?ref_src=twsrc%5Etfw">April 19, 2022</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
</center>

### References</li>
<li><a href="https://github.com/hyuunnn/Hyara">Yara rule plugin for IDA/Binja/Cutter</a></li>
<li><a href="https://twitter.com/Max_Mal_/status/1519797858681208832?s=20&amp;t=43oICS94STQrYPhbogF6yQ">@Max<em>Mal</em> emotet delivery analysis</a></li>
<li><a href="https://www.bleepingcomputer.com/news/security/emotet-botnet-switches-to-64-bit-modules-increases-activity/">Emotet botnet switches to 64-bit modules, increases activity</a></li>
<li><a href="https://www.bleepingcomputer.com/news/security/emocheck-now-detects-new-64-bit-versions-of-emotet-malware/">EmoCheck now detects new 64-bit versions of Emotet malware</a></li>
<li><a href="https://www.proofpoint.com/us/blog/threat-insight/emotet-tests-new-delivery-techniques">Emotet Tests New Delivery Techniques</a></li>
<li><a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.emotet">Malpedia Emotet Info (Yara)</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Initial-Triage">
<a class="anchor" href="#Initial-Triage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Initial Triage<a class="anchor-link" href="#Initial-Triage"> </a>
</h2>
<h3 id="Payload-Binary-Overview">
<a class="anchor" href="#Payload-Binary-Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Payload Binary Overview<a class="anchor-link" href="#Payload-Binary-Overview"> </a>
</h3>
<ul>
<li>DLL with <code>DllRegisterServer</code> export (ord 1)</li>
<li>compiler is <strong>MASM</strong>
</li>
<li>internal name <code>Y.dll</code>
</li>
</ul>
<h3 id="Code">
<a class="anchor" href="#Code" aria-hidden="true"><span class="octicon octicon-link"></span></a>Code<a class="anchor-link" href="#Code"> </a>
</h3>
<ul>
<li>using the same llvm control flow flattening obfuscator as the 32-bit versions</li>
<li>obscuring function calls by passing constants that are not used</li>
<li>we have some encrypted strings in the <code>.text</code> section</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Helper-Functions">
<a class="anchor" href="#Helper-Functions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Helper Functions<a class="anchor-link" href="#Helper-Functions"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">unhex</span><span class="p">(</span><span class="n">hex_string</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">binascii</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">hex_string</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">hex_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">hex_string</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">tohex</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">binascii</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="String-Decryption">
<a class="anchor" href="#String-Decryption" aria-hidden="true"><span class="octicon octicon-link"></span></a>String Decryption<a class="anchor-link" href="#String-Decryption"> </a>
</h2>
<p>The string decrypion works the same way as 32-bit emotet where the first DWORD is the key, the second DWORD is the encrypted string lenght, and the encrypted string follows. We can use the same code.</p>
<p>The strings table starts at the beginning of the <code>.text</code> section.</p>
<p>We can reuse our <a href="https://research.openanalysis.net/emotet/malware/config/2021/11/18/emotet.html">32-bit string decryptor</a> with some slight modificaitons.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">pefile</span>

<span class="n">EMOTET_FILE</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'/tmp/work/emotet_b481_unpacked.bin'</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">EMOTET_FILE</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="o">.</span><span class="n">PE</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">)</span>

<span class="n">txt_data</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pe</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
    <span class="k">if</span> <span class="sa">b</span><span class="s1">'.text'</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">Name</span><span class="p">:</span>
        <span class="n">txt_data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

<span class="c1"># Make sure we got the text section</span>
<span class="k">assert</span> <span class="n">txt_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="c1"># Strings are xor encrypted</span>
<span class="k">def</span> <span class="nf">xor_decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="k">len</span>(key)])
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_ascii</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">128</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">)</span>


<span class="n">strings_table</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ECS1_string</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">ECK1_string</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Check for the strings in the first 0x1000 bytes of the text section</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">candidate_1</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">txt_data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> 
    <span class="n">candidate_2</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">txt_data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> 
    <span class="k">if</span> <span class="p">(</span><span class="n">candidate_1</span>  <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">candidate_2</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># We have a match!</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">txt_data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">data_len</span> <span class="o">=</span> <span class="n">candidate_1</span> <span class="o">^</span> <span class="n">candidate_2</span>
        <span class="n">enc_data</span> <span class="o">=</span> <span class="n">txt_data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="n">data_len</span><span class="p">]</span>
        <span class="n">ptxt_data</span> <span class="o">=</span> <span class="n">xor_decrypt</span><span class="p">(</span><span class="n">enc_data</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_ascii</span><span class="p">(</span><span class="n">ptxt_data</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ptxt_data</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">''</span><span class="p">:</span>
                <span class="n">strings_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ptxt_data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'latin1'</span><span class="p">))</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s1">'ECS1'</span> <span class="o">==</span> <span class="n">ptxt_data</span><span class="p">[:</span><span class="mi">4</span><span class="p">]:</span>
            <span class="n">ECS1_string</span> <span class="o">=</span> <span class="n">ptxt_data</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s1">'ECK1'</span> <span class="o">==</span> <span class="n">ptxt_data</span><span class="p">[:</span><span class="mi">4</span><span class="p">]:</span>
            <span class="n">ECK1_string</span> <span class="o">=</span> <span class="n">ptxt_data</span>

<span class="c1"># Print our strings</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ECS1_string</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ECK1_string</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">strings_table</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>b'ECS1 \x00\x00\x00@_t\xb6\xc4\xd8\xdc\x0c=\x1f\x06z7\xdc\xb9\xf9\xb7\xbd^\x8a/\xa6\xa1\xf2\x0f\xa1y\r\x14\xe5\xf51\xe8\xb0\n\x1e&lt;\x8b?{\x90\x1d&amp;&amp;1\x86e|\x1a\xad\xd9\xc3\\\xacH\xf0`\x87\x18\xd9t&lt;X\xf9'
b'ECK1 \x00\x00\x00\xf3\xa35\xb5\x0e.+\xf45V\xcd\nL)&gt;|\xf1\x10\xdd\xcb\xb0O \xb3\xfa\x02 \xceL\xb6\x0c\x1eD\x96\xbe\xb4\x0e\xe6\xc9[\x9a\xbdN\xbd\x9d\x8f\xcf\xe0\x10[4L\x82\x04&amp;\x02\xd3\xba\xac\xf1\xfb\x9f,v'
%s%s.exe
%s%s.dll
%s\regsvr32.exe "%s" %s
shlwapi.dll
advapi32.dll
wininet.dll
crypt32.dll
userenv.dll
wtsapi32.dll
bcrypt.dll
urlmon.dll
shell32.dll
SHA256
Microsoft Primitive Provider
ECCPUBLICBLOB
HASH
ObjectLength
KeyDataBlob
AES
ECDH_P256
ECDSA_P256
RNG
POST
%u.%u.%u.%u

--%S--
Cookie: %s=%s

Content-Type: multipart/form-data; boundary=%s


--%S
Content-Disposition: form-data; name="%S"; filename="%S"
Content-Type: application/octet-stream


%s_%08X
nltest /dclist:
systeminfo
ipconfig /all
%s\%s
%s\regsvr32.exe "%s\%s"
SOFTWARE\Microsoft\Windows\CurrentVersion\Run
%s\%s%x
%s\regsvr32.exe "%s\%s" %s
WinSta0\Default
%s\%s
%s\*
%s:Zone.Identifier
%s\%s.exe
   
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="C2-Table">
<a class="anchor" href="#C2-Table" aria-hidden="true"><span class="octicon octicon-link"></span></a>C2 Table<a class="anchor-link" href="#C2-Table"> </a>
</h2>
<p>The c2 list is stored in the <code>.data</code> section in the exact same format as the 32-bit sample. We were able to re-use our <a href="https://research.openanalysis.net/emotet/malware/config/2021/11/18/emotet.html">32-bit c2 extractor</a> code.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data_data</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pe</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
    <span class="k">if</span> <span class="sa">b</span><span class="s1">'.data'</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">Name</span><span class="p">:</span>
        <span class="n">data_data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_data</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">data_data</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
<span class="n">data_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">data_data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">data_data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">enc_data</span> <span class="o">=</span> <span class="n">data_data</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="o">+</span><span class="n">data_len</span><span class="p">]</span>
<span class="n">ptxt_data</span> <span class="o">=</span> <span class="n">xor_decrypt</span><span class="p">(</span><span class="n">enc_data</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tohex</span><span class="p">(</span><span class="n">ptxt_data</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">== C2 List== "</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ptxt_data</span><span class="p">),</span><span class="mi">8</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">:</span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">ptxt_data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">],</span><span class="n">ptxt_data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">ptxt_data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span><span class="n">ptxt_data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&gt;H'</span><span class="p">,</span><span class="n">ptxt_data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">])[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>b"8\xfd\xb9\x1e\xc0\xfc\xb9\x1e\x88\xe2\xf0D9F\xb9\x1f\x15\xb1&amp;\xc8'm\xb9\x1f\xb28*{9F\xb9\x1fPU#Q'm\xb9\x1f\xad\xc5:\x02'm\xb9\x1f=\xf4\xcd\xe8'm\xb9\x1fu\xacN\x8e'm\xb9\x1f\x94\x95B\x84'm\xb9\x1f\n\xe3\x91\xda'm\xb9\x1f\x95)x\xe7'm\xb9\x1f\x0b\xa6\xf5G'm\xb9\x1f\xfd\x0f/\xea"
b'b01f495a01bb00012d4c9fd61f9000018ac5936501bb000168a89a4f1f9000019538831c1f900001050974f61f9000014d51f7901f900001ac68fb9a1f900001321e28c41f900001add4c1f91f900001335b4c591f900001c5f296f41f900001674bc90201bb000133fe8cee1ba800014f8923c61f900001480fc90f1f9000011b36593a1f900001bd7e6fc81ba80001c4da1e5301bb000152a5987f1f900001a44463031f900001b76fe3891f900001a7acfda21f900001997e92191ba8000181e8bc5d01bb0001976a70c41f900001bc2c141901bb0001a76373231f900001867a42c11f900001b90487a51f900001d41862631f900001335b07051f900001923be22d01bb0001836418e700500001d4ed11631f900001c95ea6a201bb00012db0e87c01bb00019f41580a1f900001a0108e381f900001d89ee2ce01bb0001cb726d7c01bb0001672b2eb601bb00012e37de0b01bb0001d17e62ce1f9000015bcf1c211f90000101ea02e81f9000012d7673631f900001cebd1cc71f9000015e172d56102f00019e45de6501bb000167461c661f9000016532005b1f9000013ae32aec0050000177c17c291ba800016bb6e18e1f900001b99d52d31f9000012deb081e1f9000016784f21a1f90000101ea15491ba800016ee875ba1f900001d161a3d601bb0001b908d4821ba80001d1faf6ce01bb0001'

== C2 List== 
176.31.73.90:443
45.76.159.214:8080
138.197.147.101:443
104.168.154.79:8080
149.56.131.28:8080
5.9.116.246:8080
77.81.247.144:8080
172.104.251.154:8080
50.30.40.196:8080
173.212.193.249:8080
51.91.76.89:8080
197.242.150.244:8080
103.75.201.2:443
51.254.140.238:7080
79.137.35.198:8080
72.15.201.15:8080
27.54.89.58:8080
189.126.111.200:7080
196.218.30.83:443
82.165.152.127:8080
164.68.99.3:8080
183.111.227.137:8080
167.172.253.162:8080
153.126.146.25:7080
129.232.188.93:443
151.106.112.196:8080
188.44.20.25:443
167.99.115.35:8080
134.122.66.193:8080
185.4.135.165:8080
212.24.98.99:8080
51.91.7.5:8080
146.59.226.45:443
131.100.24.231:80
212.237.17.99:8080
201.94.166.162:443
45.176.232.124:443
159.65.88.10:8080
160.16.142.56:8080
216.158.226.206:443
203.114.109.124:443
103.43.46.182:443
46.55.222.11:443
209.126.98.206:8080
91.207.28.33:8080
1.234.2.232:8080
45.118.115.99:8080
206.189.28.199:8080
94.23.45.86:4143
158.69.222.101:443
103.70.28.102:8080
101.50.0.91:8080
58.227.42.236:80
119.193.124.41:7080
107.182.225.142:8080
185.157.82.211:8080
45.235.8.30:8080
103.132.242.26:8080
1.234.21.73:7080
110.232.117.186:8080
209.97.163.214:443
185.8.212.130:7080
209.250.246.206:443
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Binary-Exploration-with-Dumpulator">
<a class="anchor" href="#Binary-Exploration-with-Dumpulator" aria-hidden="true"><span class="octicon octicon-link"></span></a>Binary Exploration with Dumpulator<a class="anchor-link" href="#Binary-Exploration-with-Dumpulator"> </a>
</h2>
<h3 id="Using-Dumpultor">
<a class="anchor" href="#Using-Dumpultor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using Dumpultor<a class="anchor-link" href="#Using-Dumpultor"> </a>
</h3>
<ul>
<li>First we load the sample in <a href="https://x64dbg.com/">x64dbg</a>
</li>
<li>Install <a href="https://github.com/mrexodia/MiniDumpPlugin/releases">mindump plugin</a>
</li>
<li>Then run to entrypoint of the DLL </li>
<li>Run mindump from the x64dbg command bar <code>MiniDump &lt;output_file.dmp&gt;</code>
</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">dumpulator</span> <span class="kn">import</span> <span class="n">Dumpulator</span>

<span class="n">DUMP_FILE</span> <span class="o">=</span> <span class="s1">'/tmp/work/emotet_b481.dmp'</span>

<span class="n">dp</span> <span class="o">=</span> <span class="n">Dumpulator</span><span class="p">(</span><span class="n">DUMP_FILE</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>    
<span class="k">def</span> <span class="nf">decrypt_string</span><span class="p">(</span><span class="n">string_address</span><span class="p">):</span>
    <span class="n">fn_decrypt</span> <span class="o">=</span> <span class="mh">0x07FFEA424B924</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">fn_decrypt</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x9695E</span><span class="p">,</span> <span class="n">string_address</span><span class="p">,</span> <span class="mh">0xD71EB</span><span class="p">])</span>
    <span class="n">ptxt_string</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">ptxt_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00\x00</span><span class="s1">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">,</span><span class="sa">b</span><span class="s1">''</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>

<span class="n">blob_1</span> <span class="o">=</span> <span class="mh">0x007FFEA4231000</span>
<span class="n">ptxt_string</span> <span class="o">=</span> <span class="n">decrypt_string</span><span class="p">(</span><span class="n">blob_1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ptxt_string</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>%s%s.exe
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Generate-a-Yara-Rule">
<a class="anchor" href="#Generate-a-Yara-Rule" aria-hidden="true"><span class="octicon octicon-link"></span></a>Generate a Yara Rule<a class="anchor-link" href="#Generate-a-Yara-Rule"> </a>
</h2>
<h3 id="Hunting-Traints">
<a class="anchor" href="#Hunting-Traints" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hunting Traints<a class="anchor-link" href="#Hunting-Traints"> </a>
</h3>
<p>These are data that might be useful for hunting related samples, but not great for non-fp identification of Emotet</p>
<ul>
<li>internal name <code>Y.dll</code>
</li>
<li>export <code>DllRegisterServer</code>
</li>
</ul>
<p>String decryption loop</p>

<pre><code>.text:00007FFEA424BAB9 C1 E9 10                                shr     ecx, 10h
.text:00007FFEA424BABC 66 C1 E8 08                             shr     ax, 8</code></pre>
<h3 id="Robust-Rule-Traits">
<a class="anchor" href="#Robust-Rule-Traits" aria-hidden="true"><span class="octicon octicon-link"></span></a>Robust Rule Traits<a class="anchor-link" href="#Robust-Rule-Traits"> </a>
</h3>
<p>We know that the <code>.text</code> and <code>.data</code> sections start with encrypted data that is in a set format: <code>&lt;DWORD:key&gt;&lt;DWORD:encrypted len&gt;</code>. We also know that that encrypted length is XOR encrypted with the key. We can exploit this info combined with the fact that the encrypted data length is not going to be more than 255 for the strings in <code>.text</code> or 65536 for the c2 table in <code>.data</code>. This tells us that most significant 2-bytes or 3-bytes will be equal for the key and the encrypted length.</p>
<p>Our yara rule will just compare these bytes and also make sure that they are no null bytes.</p>
<p>This might be good, but we don't know??? Some considerations:</p>
<ul>
<li>if there are common PE files that have repeating bytes at the start of both section this could cause a lot of FPs we should test</li>
</ul>

<pre><code>yara

import "pe"

rule Emotetx64
{


    condition:

        pe.is_64bit()
        and uint16(pe.sections[pe.section_index(".data")].raw_data_offset + 2) == uint16(pe.sections[pe.section_index(".data")].raw_data_offset + 6)
        and uint16(pe.sections[pe.section_index(".data")].raw_data_offset + 2) != 0
        and uint8(pe.sections[pe.section_index(".data")].raw_data_offset) != uint8(pe.sections[pe.section_index(".data")].raw_data_offset + 4)
        and uint8(pe.sections[pe.section_index(".text")].raw_data_offset + 1) == uint8(pe.sections[pe.section_index(".text")].raw_data_offset + 5)
        and uint8(pe.sections[pe.section_index(".text")].raw_data_offset + 1) != 0 
        and uint8(pe.sections[pe.section_index(".text")].raw_data_offset + 2) == uint8(pe.sections[pe.section_index(".text")].raw_data_offset + 6) 
        and uint8(pe.sections[pe.section_index(".text")].raw_data_offset + 2) != 0
        and uint8(pe.sections[pe.section_index(".text")].raw_data_offset + 3) == uint8(pe.sections[pe.section_index(".text")].raw_data_offset + 7)  
        and uint8(pe.sections[pe.section_index(".text")].raw_data_offset + 3) != 0
        and uint8(pe.sections[pe.section_index(".text")].raw_data_offset) != uint8(pe.sections[pe.section_index(".text")].raw_data_offset + 4)



}</code></pre>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\xAA\x8B\xDA\x35\xA2\x8B\xDA\x35\x8F\xF8\xFF\x46\x84\xEE\xA2\x50\x67\x9B\x33\xDD\xF6\xE0</span><span class="s1">'</span>

<span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\xAA\x8B\xDA\x35</span><span class="s1">'</span>

<span class="n">data_len</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\xA2\x8B\xDA\x35</span><span class="s1">'</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/emotet/malware/2022/04/30/emotet_x64.html" hidden></a>
</article>
