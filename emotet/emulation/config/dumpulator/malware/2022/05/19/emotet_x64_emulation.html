<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Emotet x64 Stack Strings Config Emulation</h1><p class="page-description">Taking a look at the new Emotet stack strings config</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-05-19T00:00:00-05:00" itemprop="datePublished">
        May 19, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      3 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#emotet">emotet</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#emulation">emulation</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#config">config</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#dumpulator">dumpulator</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#malware">malware</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2022-05-19-emotet_x64_emulation.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Samples">Samples </a></li>
<li class="toc-entry toc-h3"><a href="#Tools">Tools </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Using-Dumpulator-Emulation">Using Dumpulator Emulation </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Automated-Function-Identification">Automated Function Identification </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-05-19-emotet_x64_emulation.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p>The week of May 9th, 2022 Emotet released an update to their x64 malware that used "stack strings" and an obfuscator to protect the strings, keys, and c2s. This was a change from the enrypted strings and c2 tables that were usually stored at the beginning of the <code>.text</code> and <code>.data</code> sections. Our new approach for config extraction will be to identify the functions used to supply the strings and c2s and emulate them.</p>
<h3 id="Samples">
<a class="anchor" href="#Samples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Samples<a class="anchor-link" href="#Samples"> </a>
</h3>
<ul>
<li>
<a href="https://malshare.com/sample.php?action=detail&amp;hash=92033dc85730f7dc5dbd85369ea1db8806ce7581c1e9b4764a82abfc54e3146e">packed</a>: <code>92033dc85730f7dc5dbd85369ea1db8806ce7581c1e9b4764a82abfc54e3146e</code>
</li>
<li>
<a href="https://malshare.com/sample.php?action=detail&amp;hash=c688e079a16b3345c83a285ac2ae8dd48680298085421c225680f26ceae73eb7">unpacked</a>: <code>c688e079a16b3345c83a285ac2ae8dd48680298085421c225680f26ceae73eb7</code>
</li>
</ul>
<h3 id="Tools">
<a class="anchor" href="#Tools" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tools<a class="anchor-link" href="#Tools"> </a>
</h3>
<ul>
<li>Dumpulator minidump emulation <a href="https://github.com/mrexodia/dumpulator">github</a>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Using-Dumpulator-Emulation">
<a class="anchor" href="#Using-Dumpulator-Emulation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using Dumpulator Emulation<a class="anchor-link" href="#Using-Dumpulator-Emulation"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">dumpulator</span> <span class="kn">import</span> <span class="n">Dumpulator</span>

<span class="n">dp</span> <span class="o">=</span> <span class="n">Dumpulator</span><span class="p">(</span><span class="s2">"/tmp/emo2.dmp"</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fn_addr_list</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x07FFA3BA235D0</span><span class="p">,</span> <span class="mh">0x7FFA3BA213C4</span><span class="p">,</span><span class="mh">0x7FFA3BA21AAC</span><span class="p">,</span><span class="mh">0x7FFA3BA2400C</span><span class="p">,</span><span class="mh">0x7FFA3BA282D8</span><span class="p">,</span><span class="mh">0x7FFA3BA2A36C</span><span class="p">,</span><span class="mh">0x7FFA3BA2D370</span><span class="p">,</span><span class="mh">0x7FFA3BA2DD3C</span><span class="p">,</span><span class="mh">0x7FFA3BA2E468</span><span class="p">,</span><span class="mh">0x7FFA3BA30C28</span><span class="p">,</span><span class="mh">0x7FFA3BA31960</span><span class="p">,</span><span class="mh">0x7FFA3BA33F28</span><span class="p">,</span><span class="mh">0x7FFA3BA35980</span><span class="p">,</span><span class="mh">0x7FFA3BA35B04</span><span class="p">,</span><span class="mh">0x7FFA3BA3AFB0</span><span class="p">,</span><span class="mh">0x7FFA3BA3F9A8</span><span class="p">,</span><span class="mh">0x7FFA3BA3FEE8</span><span class="p">,</span><span class="mh">0x7FFA3BA4012C</span><span class="p">,</span><span class="mh">0x7FFA3BA41124</span><span class="p">,</span><span class="mh">0x7FFA3BA412A4</span><span class="p">,</span><span class="mh">0x7FFA3BA415A0</span><span class="p">,</span><span class="mh">0x7FFA3BA42224</span><span class="p">,</span><span class="mh">0x7FFA3BA43224</span><span class="p">,</span><span class="mh">0x7FFA3BA44AEC</span><span class="p">,</span><span class="mh">0x7FFA3BA465F0</span><span class="p">,</span><span class="mh">0x7FFA3BA46744</span><span class="p">,</span><span class="mh">0x7FFA3BA47140</span><span class="p">,</span><span class="mh">0x7FFA3BA472A8</span><span class="p">,</span><span class="mh">0x7FFA3BA490F8</span><span class="p">,</span><span class="mh">0x7FFA3BA49850</span><span class="p">,</span><span class="mh">0x7FFA3BA49A58</span><span class="p">,</span><span class="mh">0x7FFA3BA49D04</span><span class="p">,</span><span class="mh">0x7FFA3BA49FB4</span><span class="p">,</span><span class="mh">0x7FFA3BA4BCB4</span><span class="p">,</span><span class="mh">0x7FFA3BA4C168</span><span class="p">]</span> 

<span class="k">for</span> <span class="n">fn_addr</span> <span class="ow">in</span> <span class="n">fn_addr_list</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">fn_addr</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">ptxt_str</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">read_str</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-16'</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">fn_addr</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ptxt_str</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
    
    
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0x7ffa3ba235d0: %s%s.dll
0x7ffa3ba213c4: ObjectLength
0x7ffa3ba21aac: SOFTWARE\Microsoft\Windows\CurrentVersion\Run
0x7ffa3ba2400c: WinSta0\Default
0x7ffa3ba282d8: RNG
0x7ffa3ba2a36c: AES
0x7ffa3ba2d370: %s\%s
0x7ffa3ba2dd3c: %s\*
0x7ffa3ba2e468: SHA256
0x7ffa3ba30c28: %s\%s
0x7ffa3ba31960: urlmon.dll
0x7ffa3ba33f28: advapi32.dll
0x7ffa3ba35980: %s:Zone.Identifier
0x7ffa3ba35b04: %s%s.exe
0x7ffa3ba3afb0: %s\regsvr32.exe "%s\%s" %s
0x7ffa3ba3f9a8: HASH
0x7ffa3ba3fee8: Microsoft Primitive Provider
0x7ffa3ba4012c: bcrypt.dll
0x7ffa3ba41124: ECDH_P256
0x7ffa3ba412a4: Cookie: %s=%s

0x7ffa3ba415a0: shlwapi.dll
0x7ffa3ba42224: shell32.dll
0x7ffa3ba43224: ECCPUBLICBLOB
0x7ffa3ba44aec: Content-Type: multipart/form-data; boundary=%s

0x7ffa3ba465f0: wininet.dll
0x7ffa3ba46744: ECDSA_P256
0x7ffa3ba47140: %s\%s%x
0x7ffa3ba472a8: wtsapi32.dll
0x7ffa3ba490f8: POST
0x7ffa3ba49850: %s\regsvr32.exe "%s" %s
0x7ffa3ba49a58: %s\regsvr32.exe "%s\%s"
0x7ffa3ba49d04: userenv.dll
0x7ffa3ba49fb4: %u.%u.%u.%u
0x7ffa3ba4bcb4: crypt32.dll
0x7ffa3ba4c168: KeyDataBlob
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dp</span><span class="o">.</span><span class="n">read_str</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-16'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'%s%s.dll'</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">struct</span> 
<span class="n">key_decrypt_functions</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x7FFA3BA33B90</span><span class="p">,</span> <span class="mh">0x7FFA3BA22048</span><span class="p">]</span>

<span class="k">for</span> <span class="n">key_decrypt_function</span> <span class="ow">in</span> <span class="n">key_decrypt_functions</span><span class="p">:</span>
    <span class="n">tmp_arg</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">key_decrypt_function</span><span class="p">,</span> <span class="p">[</span><span class="n">tmp_arg</span><span class="p">,</span><span class="n">tmp_arg</span><span class="p">,</span> <span class="n">tmp_arg</span><span class="p">,</span> <span class="n">tmp_arg</span><span class="p">])</span>
    <span class="n">key_header</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">key_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">key_header</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">full_key_len</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">key_len</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">full_key_len</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>b'ECK1 \x00\x00\x00\xf3\xa35\xb5\x0e.+\xf45V\xcd\nL)&gt;|\xf1\x10\xdd\xcb\xb0O \xb3\xfa\x02 \xceL\xb6\x0c\x1eD\x96\xbe\xb4\x0e\xe6\xc9[\x9a\xbdN\xbd\x9d\x8f\xcf\xe0\x10[4L\x82\x04&amp;\x02\xd3\xba\xac\xf1\xfb\x9f,v'
b'ECS1 \x00\x00\x00@_t\xb6\xc4\xd8\xdc\x0c=\x1f\x06z7\xdc\xb9\xf9\xb7\xbd^\x8a/\xa6\xa1\xf2\x0f\xa1y\r\x14\xe5\xf51\xe8\xb0\n\x1e&lt;\x8b?{\x90\x1d&amp;&amp;1\x86e|\x1a\xad\xd9\xc3\\\xacH\xf0`\x87\x18\xd9t&lt;X\xf9'
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">c2_fns</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x07FFA3BA2E70C</span><span class="p">,</span> <span class="mh">0x7FFA3BA30D88</span><span class="p">,</span><span class="mh">0x7FFA3BA4B054</span><span class="p">,</span><span class="mh">0x7FFA3BA21528</span><span class="p">,</span><span class="mh">0x7FFA3BA4A4CC</span><span class="p">,</span><span class="mh">0x7FFA3BA4C2B8</span><span class="p">,</span><span class="mh">0x7FFA3BA4BF80</span><span class="p">,</span><span class="mh">0x7FFA3BA4AA74</span><span class="p">,</span><span class="mh">0x7FFA3BA2DAB0</span><span class="p">,</span><span class="mh">0x7FFA3BA43584</span><span class="p">,</span><span class="mh">0x7FFA3BA34644</span><span class="p">,</span><span class="mh">0x7FFA3BA2FD58</span><span class="p">,</span><span class="mh">0x7FFA3BA35690</span><span class="p">,</span><span class="mh">0x7FFA3BA3975C</span><span class="p">,</span><span class="mh">0x7FFA3BA23BD0</span><span class="p">,</span><span class="mh">0x7FFA3BA3519C</span><span class="p">,</span><span class="mh">0x7FFA3BA2B610</span><span class="p">,</span><span class="mh">0x7FFA3BA4C8B0</span><span class="p">,</span><span class="mh">0x7FFA3BA3C9F8</span><span class="p">,</span><span class="mh">0x7FFA3BA36A10</span><span class="p">,</span><span class="mh">0x7FFA3BA4339C</span><span class="p">,</span><span class="mh">0x7FFA3BA21F58</span><span class="p">,</span><span class="mh">0x7FFA3BA4557C</span><span class="p">,</span><span class="mh">0x7FFA3BA28BC8</span><span class="p">,</span><span class="mh">0x7FFA3BA3C5B4</span><span class="p">,</span><span class="mh">0x7FFA3BA45498</span><span class="p">,</span><span class="mh">0x7FFA3BA21000</span><span class="p">,</span><span class="mh">0x7FFA3BA24E50</span><span class="p">,</span><span class="mh">0x7FFA3BA2FBC4</span><span class="p">,</span><span class="mh">0x7FFA3BA33278</span><span class="p">,</span><span class="mh">0x7FFA3BA468C0</span><span class="p">,</span><span class="mh">0x7FFA3BA464FC</span><span class="p">,</span><span class="mh">0x7FFA3BA28EE0</span><span class="p">,</span><span class="mh">0x7FFA3BA274A0</span><span class="p">,</span><span class="mh">0x7FFA3BA3092C</span><span class="p">,</span><span class="mh">0x7FFA3BA24D58</span><span class="p">,</span><span class="mh">0x7FFA3BA3E274</span><span class="p">,</span><span class="mh">0x7FFA3BA2BCF8</span><span class="p">,</span><span class="mh">0x7FFA3BA4CAF8</span><span class="p">,</span><span class="mh">0x7FFA3BA4A340</span><span class="p">,</span><span class="mh">0x7FFA3BA29820</span><span class="p">,</span><span class="mh">0x7FFA3BA4A0F8</span><span class="p">,</span><span class="mh">0x7FFA3BA494D8</span><span class="p">,</span><span class="mh">0x7FFA3BA35C7C</span><span class="p">,</span><span class="mh">0x7FFA3BA3D5C8</span><span class="p">,</span><span class="mh">0x7FFA3BA21D48</span><span class="p">,</span><span class="mh">0x7FFA3BA4103C</span><span class="p">,</span><span class="mh">0x7FFA3BA28DCC</span><span class="p">,</span><span class="mh">0x7FFA3BA22F64</span><span class="p">,</span><span class="mh">0x7FFA3BA301BC</span><span class="p">,</span><span class="mh">0x7FFA3BA2F454</span><span class="p">,</span><span class="mh">0x7FFA3BA2B9E4</span><span class="p">,</span><span class="mh">0x7FFA3BA24C38</span><span class="p">,</span><span class="mh">0x7FFA3BA3CF80</span><span class="p">,</span><span class="mh">0x7FFA3BA3E360</span><span class="p">,</span><span class="mh">0x7FFA3BA45264</span><span class="p">,</span><span class="mh">0x7FFA3BA49C14</span><span class="p">,</span><span class="mh">0x7FFA3BA469D0</span><span class="p">,</span><span class="mh">0x7FFA3BA281E4</span><span class="p">,</span><span class="mh">0x7FFA3BA2DC28</span><span class="p">,</span><span class="mh">0x7FFA3BA26F38</span><span class="p">,</span><span class="mh">0x7FFA3BA45678</span><span class="p">,</span><span class="mh">0x7FFA3BA24868</span><span class="p">,</span><span class="mh">0x7FFA3BA35598</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_c2_from_fn</span><span class="p">(</span><span class="n">c2_fn</span><span class="p">):</span>
    <span class="n">c2_ip</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">c2_port</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">c2_fn</span><span class="p">,</span> <span class="p">[</span><span class="n">c2_ip</span><span class="p">,</span> <span class="n">c2_port</span><span class="p">])</span>
    <span class="n">c2_port_bytes</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">c2_port</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">c2_port</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;H'</span><span class="p">,</span><span class="n">c2_port_bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">c2_ip_bytes</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">c2_ip</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">c2_ip</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">c2_ip_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">c2_ip_bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">c2_ip_bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">c2_ip_bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">c2_ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">c2_port</span><span class="si">}</span><span class="s2">"</span>

<span class="k">for</span> <span class="n">c2_fn</span> <span class="ow">in</span> <span class="n">c2_fns</span><span class="p">:</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">get_c2_from_fn</span><span class="p">(</span><span class="n">c2_fn</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">c2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>172.104.251.154:8080
209.250.246.206:443
110.232.117.186:8080
164.68.99.3:8080
119.193.124.41:7080
212.237.17.99:8080
107.182.225.142:8080
185.8.212.130:7080
153.126.146.25:7080
77.81.247.144:8080
209.126.98.206:8080
201.94.166.162:443
131.100.24.231:80
45.235.8.30:8080
213.241.20.155:443
103.43.46.182:443
0.0.0.0:0
129.232.188.93:443
103.132.242.26:8080
151.106.112.196:8080
45.118.115.99:8080
185.4.135.165:8080
103.70.28.102:8080
51.91.7.5:8080
27.54.89.58:8080
196.218.30.83:443
206.189.28.199:8080
91.207.28.33:8080
79.137.35.198:8080
51.254.140.238:7080
173.212.193.249:8080
203.114.109.124:443
94.23.45.86:4143
63.142.250.212:443
189.126.111.200:7080
160.16.142.56:8080
102.222.215.74:443
5.9.116.246:8080
158.69.222.101:443
167.172.253.162:8080
82.165.152.127:8080
212.24.98.99:8080
197.242.150.244:8080
72.15.201.15:8080
101.50.0.91:8080
51.91.76.89:8080
183.111.227.137:8080
188.44.20.25:443
58.227.42.236:80
45.176.232.124:443
185.157.82.211:8080
163.44.196.120:8080
159.65.88.10:8080
146.59.226.45:443
1.234.2.232:8080
149.56.131.28:8080
209.97.163.214:443
46.55.222.11:443
150.95.66.124:8080
103.75.201.2:443
216.158.226.206:443
134.122.66.193:8080
1.234.21.73:7080
167.99.115.35:8080
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Automated-Function-Identification">
<a class="anchor" href="#Automated-Function-Identification" aria-hidden="true"><span class="octicon octicon-link"></span></a>Automated Function Identification<a class="anchor-link" href="#Automated-Function-Identification"> </a>
</h3>
<p>Now that we have a way to extract the data from the functions using emulation all we need to do is create some regexes to indetify the functions and complete our automation.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">pefile</span>

<span class="n">dump_image_base</span> <span class="o">=</span> <span class="mh">0x7FFA3BA20000</span>

<span class="n">FILE_PATH</span> <span class="o">=</span> <span class="s1">'/tmp/emo_unpacked_1020000.bin'</span>

<span class="n">file_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">FILE_PATH</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="o">.</span><span class="n">PE</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">file_data</span><span class="p">)</span>

<span class="n">egg</span> <span class="o">=</span> <span class="sa">rb</span><span class="s1">'\x48\x8D\x05(....)\x48\x89\x81..\x00\x00'</span>

<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">egg</span><span class="p">,</span> <span class="n">file_data</span><span class="p">):</span>
    <span class="n">fn_rel_offset</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">inst_offset</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> 
    <span class="n">fn_rva</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_rva_from_offset</span><span class="p">(</span><span class="n">inst_offset</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">fn_rel_offset</span>
    <span class="n">fn_addr</span> <span class="o">=</span> <span class="n">dump_image_base</span> <span class="o">+</span> <span class="n">fn_rva</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">get_c2_from_fn</span><span class="p">(</span><span class="n">fn_addr</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">fn_addr</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">c2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0x7ffa3ba30d88: 209.250.246.206:443
0x7ffa3ba4b054: 110.232.117.186:8080
0x7ffa3ba21528: 164.68.99.3:8080
0x7ffa3ba4a4cc: 119.193.124.41:7080
0x7ffa3ba4c2b8: 212.237.17.99:8080
0x7ffa3ba4aa74: 185.8.212.130:7080
0x7ffa3ba2dab0: 153.126.146.25:7080
0x7ffa3ba43584: 77.81.247.144:8080
0x7ffa3ba34644: 209.126.98.206:8080
0x7ffa3ba2fd58: 201.94.166.162:443
0x7ffa3ba35690: 131.100.24.231:80
0x7ffa3ba3975c: 45.235.8.30:8080
0x7ffa3ba23bd0: 213.241.20.155:443
0x7ffa3ba3519c: 103.43.46.182:443
0x7ffa3ba2b610: 0.0.0.0:0
0x7ffa3ba4c8b0: 129.232.188.93:443
0x7ffa3ba3c9f8: 103.132.242.26:8080
0x7ffa3ba36a10: 151.106.112.196:8080
0x7ffa3ba4339c: 45.118.115.99:8080
0x7ffa3ba21f58: 185.4.135.165:8080
0x7ffa3ba4557c: 103.70.28.102:8080
0x7ffa3ba28bc8: 51.91.7.5:8080
0x7ffa3ba3c5b4: 27.54.89.58:8080
0x7ffa3ba21000: 206.189.28.199:8080
0x7ffa3ba2fbc4: 79.137.35.198:8080
0x7ffa3ba33278: 51.254.140.238:7080
0x7ffa3ba468c0: 173.212.193.249:8080
0x7ffa3ba464fc: 203.114.109.124:443
0x7ffa3ba28ee0: 94.23.45.86:4143
0x7ffa3ba3092c: 189.126.111.200:7080
0x7ffa3ba24d58: 160.16.142.56:8080
0x7ffa3ba3e274: 102.222.215.74:443
0x7ffa3ba2bcf8: 5.9.116.246:8080
0x7ffa3ba4a340: 167.172.253.162:8080
0x7ffa3ba29820: 82.165.152.127:8080
0x7ffa3ba494d8: 197.242.150.244:8080
0x7ffa3ba35c7c: 72.15.201.15:8080
0x7ffa3ba3d5c8: 101.50.0.91:8080
0x7ffa3ba21d48: 51.91.76.89:8080
0x7ffa3ba4103c: 183.111.227.137:8080
0x7ffa3ba28dcc: 188.44.20.25:443
0x7ffa3ba22f64: 58.227.42.236:80
0x7ffa3ba301bc: 45.176.232.124:443
0x7ffa3ba2b9e4: 163.44.196.120:8080
0x7ffa3ba24c38: 159.65.88.10:8080
0x7ffa3ba3cf80: 146.59.226.45:443
0x7ffa3ba3e360: 1.234.2.232:8080
0x7ffa3ba49c14: 209.97.163.214:443
0x7ffa3ba469d0: 46.55.222.11:443
0x7ffa3ba2dc28: 103.75.201.2:443
0x7ffa3ba26f38: 216.158.226.206:443
0x7ffa3ba45678: 134.122.66.193:8080
0x7ffa3ba24868: 1.234.21.73:7080
0x7ffa3ba35598: 167.99.115.35:8080
</pre>
</div>
</div>

</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/emotet/emulation/config/dumpulator/malware/2022/05/19/emotet_x64_emulation.html" hidden></a>
</article>
