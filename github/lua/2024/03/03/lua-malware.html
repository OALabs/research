<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>GitHub Bug Used to Infect Game Hackers With Lua Malware | OALABS Research</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="GitHub Bug Used to Infect Game Hackers With Lua Malware" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Triaging this elaborate infection chain" />
<meta property="og:description" content="Triaging this elaborate infection chain" />
<link rel="canonical" href="https://research.openanalysis.net/github/lua/2024/03/03/lua-malware.html" />
<meta property="og:url" content="https://research.openanalysis.net/github/lua/2024/03/03/lua-malware.html" />
<meta property="og:site_name" content="OALABS Research" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-03-03T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="GitHub Bug Used to Infect Game Hackers With Lua Malware" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-03-03T00:00:00-06:00","datePublished":"2024-03-03T00:00:00-06:00","description":"Triaging this elaborate infection chain","headline":"GitHub Bug Used to Infect Game Hackers With Lua Malware","mainEntityOfPage":{"@type":"WebPage","@id":"https://research.openanalysis.net/github/lua/2024/03/03/lua-malware.html"},"url":"https://research.openanalysis.net/github/lua/2024/03/03/lua-malware.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://research.openanalysis.net/feed.xml" title="OALABS Research" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">OALABS Research</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">GitHub Bug Used to Infect Game Hackers With Lua Malware</h1><p class="page-description">Triaging this elaborate infection chain</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2024-03-03T00:00:00-06:00" itemprop="datePublished">
        Mar 3, 2024
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      7 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#github">github</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#lua">lua</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2024-03-03-lua-malware.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Special-Thanks">Special Thanks </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Delivery">Delivery </a></li>
<li class="toc-entry toc-h2"><a href="#GitHub-Bug">GitHub Bug </a></li>
<li class="toc-entry toc-h2"><a href="#Malicous-GitHub-Cloning">Malicous GitHub Cloning </a></li>
<li class="toc-entry toc-h2"><a href="#Lua-Malware-Analysis">Lua Malware Analysis </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Sample">Sample </a></li>
<li class="toc-entry toc-h3"><a href="#Analysis">Analysis </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Lua-Environment-Instrumentation">Lua Environment Instrumentation </a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#Lua-Garbage---Dumping-Encrypted-Strings">Lua Garbage - Dumping Encrypted Strings </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Hook-lj_str_free">Hook lj_str_free </a></li>
</ul>
</li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2024-03-03-lua-malware.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p>Malware operators are using a cloned game cheat website, SEO poisoning, and a bug in GitHub to trick would-be-game-hackers into running Lua malware. Our notes are divided into two sections, the first part is focuses on the GitHub bug the enables the malware delivery and the second part covers our attempt to analyze the Lua JIT malware.</p>
<h3 id="Special-Thanks">
<a class="anchor" href="#Special-Thanks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Special Thanks<a class="anchor-link" href="#Special-Thanks"> </a>
</h3>
<ul>
<li><a href="https://twitter.com/JustasMasiulis">@JustasMasiulis</a></li>
<li><a href="https://github.com/0avx">0AVX</a></li>
<li><a href="https://github.com/fish-sticks">Fish-Sticks</a></li>
<li><a href="https://github.com/Jollycistaken">Jollyc</a></li>
<li><a href="https://github.com/xusheng6">@xusheng6</a></li>
<li>
<em>Themida</em> for the sample ðŸ˜‰</li>
</ul>
<h2 id="Delivery">
<a class="anchor" href="#Delivery" aria-hidden="true"><span class="octicon octicon-link"></span></a>Delivery<a class="anchor-link" href="#Delivery"> </a>
</h2>
<p>The game cheat that has been targeted is an open source aim bot called AIMMY which is maintained in the following GitHub repository <a href="https://github.com/Babyhamsta/Aimmy">Babyhamsta/Aimmy</a> with the website <a href="https://aimmy.dev/">aimmy.dev</a>.</p>
<p>The malware operators have made a clone of the GitHub repository here <code>https[:]//github[.]com/nehuenbohm/Aimmy</code> and setup a malicious website <code>https[:]//aimmy[.]app</code> which links to the cloned GitHub repository. The website also has a modified download link which <strong>links to malware</strong> hosted at <code>https[:]//github[.]com/Babyhamsta/Aimmy/files/14475029/Aimmy.zip</code>. Note that this download link is for a ZIP file that is <strong>hosted on the original benign GitHub repository</strong>.</p>
<p>The malicious website has a high Google rank (likely due to SEO poisoning) and is ranked above the legitimate aim bot website. Users searching for the aim bot are likely to be tricked into visiting the malicious site and downloading the malware.</p>
<h2 id="GitHub-Bug">
<a class="anchor" href="#GitHub-Bug" aria-hidden="true"><span class="octicon octicon-link"></span></a>GitHub Bug<a class="anchor-link" href="#GitHub-Bug"> </a>
</h2>
<p><img src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcTVmNDdzdzQ3b2d3anh0M3J5ZjdhZHRxZTJud2ZreW9qd3JsZmZhcCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/aL3Rc4sVTnTWjRPj2O/giphy.gif" alt=""></p>
<p>A key element in the attack involves hosting that malware payload on the original benign repository. This both distances the operators from the payload host and also may enable the download URL to blend in with normal traffic. Using this trick makes it difficult for the victim to identify that they are clicking a malicious link. But how are the operators able to host their malware on another GitHub repository? This had us stumped until <a href="https://twitter.com/JustasMasiulis">@JustasMasiulis</a> discovered the bug â€¦ feature?</p>
<p>When opening an issue on a repository <strong>any file uploaded to the issue is stored under the GitHub repository where the issue when opened</strong>. These files persist even if the issue is never saved. This means that anyone can upload a file to any git repository on GitHub an not leave any trace that the file exists except for the direct link.</p>
<ul>
<li>Cick <code>New Issue</code> on the target GitHub repository</li>
<li>Drag and drop malware into issue description</li>
<li>Copy generated link for malware from description </li>
<li>Close issue without submitting/saving</li>
<li>The link to the uploaded malware remains active even though the issue was never saved</li>
</ul>
<p>@JustasMasiulis posted a <a href="https://twitter.com/JustasMasiulis/status/1764171634469122165">POC</a> of this to X last night.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">Seems like there is malware abusing GitHub attachments to create file links in legitimate repositories. Here's a funny example <a href="https://t.co/s32mD3vQJQ">https://t.co/s32mD3vQJQ</a> nothing special, but just seemed neat.</p>â€” Justas Masiulis (@JustasMasiulis) <a href="https://twitter.com/JustasMasiulis/status/1764171634469122165?ref_src=twsrc%5Etfw">March 3, 2024</a>
</blockquote> <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Malicous-GitHub-Cloning">
<a class="anchor" href="#Malicous-GitHub-Cloning" aria-hidden="true"><span class="octicon octicon-link"></span></a>Malicous GitHub Cloning<a class="anchor-link" href="#Malicous-GitHub-Cloning"> </a>
</h2>
<p><img src="https://i.imgur.com/amc7uya.png" alt=""></p>
<p>The malware operators also used a clever technique to obscure the fact that they have cloned the original GitHub repository. ArsTechnica recently detailed similar <a href="https://arstechnica.com/security/2024/02/github-besieged-by-millions-of-malicious-repositories-in-ongoing-attack/">malicious cloning attacks</a> but in this case we were able to observe the attack in real time, and can report some additional details.</p>
<ul>
<li>The target repository is downloaded then uploaded to a new account, it is not forked.</li>
<li>Though the git commit history is maintained in the newly uploaded repository it does not display as a fork of the original repository.</li>
<li>The operator then makes <strong>thousands of empty commits</strong> to the repository, likely scripted, making it appear as though they are main contributor to the project. In the case of the aim bot the operator made over seven thousand commits in a 24h hour period. </li>
<li>The final commit is made to the project README changing the project download links to the malware URL. This commit is made as a GitHub verified user as the user is verified for the repo. </li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Lua-Malware-Analysis">
<a class="anchor" href="#Lua-Malware-Analysis" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lua Malware Analysis<a class="anchor-link" href="#Lua-Malware-Analysis"> </a>
</h2>
<p>The malware itself is very unique.  It consists of a Lua JIT file, a compiled <a href="https://luajit.org/">LuaJIT</a> executable used to interpret the JIT file, and a batch script used to elevate permissions and run the JIT in the interpreter.</p>
<h3 id="Sample">
<a class="anchor" href="#Sample" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sample<a class="anchor-link" href="#Sample"> </a>
</h3>
<p>The malware is delivered in a ZIP file <a href="https://malshare.com/sample.php?action=detail&amp;hash=b4bf68ffb1fca012298c8943a55246abf92a4328a47e370e6c4a8a3e804f2620">malshare</a></p>
<ul>
<li>c912762952152c40646a61d7cc80a74f61ddd7aad292a1812f66e76b405f9660 <code>Aimmy.bat</code><ul>
<li>Batch script used to run the lua code in the interpreter </li>
</ul>
</li>
<li>1cf20b8449ea84c684822a5e8ab3672213072db8267061537d1ce4ec2c30c42a <code>AimmyLauncher.exe</code><ul>
<li>LuaJIT intepreter</li>
</ul>
</li>
<li>d6d3c8ea51a025b3abeb70c9c8a17ac46cf82e5a46a259e9aaa9d245212d9e17 <code>README.txt</code>
</li>
<li>fa3224ec83c69883519941c0e010697bcdc0518a3d9e2c081cd54f5e9458b253 <code>data</code><ul>
<li>Malicious compiled Lua JIT code, magic bytes <code>1B 4C 4A</code>
</li>
</ul>
</li>
<li>ff976f6e965e3793e278fa9bf5e80b9b226a0b3932b9da764bffc8e41e6cdb60 <code>lua51.dll</code>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Analysis">
<a class="anchor" href="#Analysis" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analysis<a class="anchor-link" href="#Analysis"> </a>
</h3>
<p>Using the <a href="https://github.com/marsinator358/luajit-decompiler-v2">LuaJIT Decompiler v2</a> we were able to decompile the JIT and recover the Lua code only find that it had been heavily obfuscated.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">var_0_19</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">var_0_17</span><span class="p">[</span><span class="n">var_0_18</span><span class="p">(</span><span class="s2">"</span><span class="se">\xA7</span><span class="s2">Z$</span><span class="se">\\</span><span class="s2">oÓˆ."</span><span class="p">,</span> <span class="mi">8170536974433</span><span class="p">)],</span>
    <span class="n">var_0_17</span><span class="p">[</span><span class="n">var_0_18</span><span class="p">(</span><span class="s2">"</span><span class="se">\x83\xEB\xC1\xEC\xAE</span><span class="s2">R</span><span class="se">\x0E\xCB</span><span class="s2">"</span><span class="p">,</span> <span class="mi">32340223605166</span><span class="p">)],</span>
    <span class="n">var_0_17</span><span class="p">[</span><span class="n">var_0_18</span><span class="p">(</span><span class="s2">"</span><span class="se">\x98</span><span class="s2">E</span><span class="se">\r\f</span><span class="s2">"</span><span class="p">,</span> <span class="mi">18847752807337</span><span class="p">)],</span>
    <span class="n">var_0_17</span><span class="p">[</span><span class="n">var_0_18</span><span class="p">(</span><span class="s2">"Z</span><span class="se">\x16</span><span class="s2">g</span><span class="se">\xD2</span><span class="s2">"</span><span class="p">,</span> <span class="mi">17704612011450</span><span class="p">)],</span>
    <span class="n">var_0_17</span><span class="p">[</span><span class="n">var_0_18</span><span class="p">(</span><span class="s2">"KÛ½^</span><span class="se">\xAE\xF8</span><span class="s2">_</span><span class="se">\xFF</span><span class="s2">"</span><span class="p">,</span> <span class="mi">2538651564100</span><span class="p">)],</span>
    <span class="n">var_0_17</span><span class="p">[</span><span class="n">var_0_18</span><span class="p">(</span><span class="s2">"</span><span class="se">\x1B</span><span class="s2">do</span><span class="se">\xF6</span><span class="s2">B</span><span class="se">\xF3\x92\xC0\x84</span><span class="s2">^zg</span><span class="se">\x8B\xB1\x95\xC3</span><span class="s2">"</span><span class="p">,</span> <span class="mi">17854945091482</span><span class="p">)],</span>
    <span class="n">var_0_17</span><span class="p">[</span><span class="n">var_0_18</span><span class="p">(</span><span class="s2">"</span><span class="se">\xFF</span><span class="s2">Yk</span><span class="se">\xF5\xAB</span><span class="s2">37</span><span class="se">\x83</span><span class="s2">"</span><span class="p">,</span> <span class="mi">21489022010759</span><span class="p">)],</span>
    <span class="n">var_0_17</span><span class="p">[</span><span class="n">var_0_18</span><span class="p">(</span><span class="s2">"</span><span class="se">\x8E</span><span class="s2">q</span><span class="se">\x85\x93</span><span class="s2">yJ.</span><span class="se">\xD8</span><span class="s2">"</span><span class="p">,</span> <span class="mi">17231694304248</span><span class="p">)],</span>
    <span class="n">var_0_17</span><span class="p">[</span><span class="n">var_0_18</span><span class="p">(</span><span class="s2">"</span><span class="se">\xDD</span><span class="s2">,G</span><span class="se">\x17\xEB</span><span class="s2">g#h"</span><span class="p">,</span> <span class="mi">1115184245546</span><span class="p">)],</span>
    <span class="n">var_0_17</span><span class="p">[</span><span class="n">var_0_18</span><span class="p">(</span><span class="s2">"DE</span><span class="se">\x10</span><span class="s2">D"</span><span class="p">,</span> <span class="mi">12159446557750</span><span class="p">)],</span>
    <span class="n">var_0_17</span><span class="p">[</span><span class="n">var_0_18</span><span class="p">(</span><span class="s2">"(</span><span class="se">\x92\xE7\xB9</span><span class="s2">X</span><span class="se">\xEE</span><span class="s2">8CÞµ</span><span class="se">\x19</span><span class="s2">Z</span><span class="se">\xBE\x8F</span><span class="s2">q</span><span class="se">\xBF</span><span class="s2">"</span><span class="p">,</span> <span class="mi">24217461828912</span><span class="p">)],</span>
    <span class="n">var_0_17</span><span class="p">[</span><span class="n">var_0_18</span><span class="p">(</span><span class="s2">"</span><span class="se">\xF8</span><span class="s2">cQsU</span><span class="se">\xAF\x9C\x9C</span><span class="s2">"</span><span class="p">,</span> <span class="mi">12518619714798</span><span class="p">)],</span>
    <span class="n">var_0_17</span><span class="p">[</span><span class="n">var_0_18</span><span class="p">(</span><span class="s2">"o</span><span class="se">\x01\xC1\xC7\xE7</span><span class="s2">$(</span><span class="se">\x84</span><span class="s2">"</span><span class="p">,</span> <span class="mi">29604450893836</span><span class="p">)],</span>

 <span class="p">.</span> <span class="p">.</span> <span class="p">.</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The obfuscation was matched to an open source Lua obfuscator called <a href="https://levno-710.gitbook.io/prometheus/">Prometheus</a>. This obfuscator bot encrypts strings, and employs a virtual machine to protect the Lua code.</p>
<p><img src="https://cdn.discordapp.com/attachments/885652495421030431/1214000233562771487/image.png?ex=65f784d2&amp;is=65e50fd2&amp;hm=3dc880375e918ac3990c16ba0b665e259cf2305d6ccbc3f1cefefbf0bd5f1039&amp;" alt=""></p>
<h4 id="Lua-Environment-Instrumentation">
<a class="anchor" href="#Lua-Environment-Instrumentation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lua Environment Instrumentation<a class="anchor-link" href="#Lua-Environment-Instrumentation"> </a>
</h4>
<p>Rather than attempting to break the VM directly we attempted to trace the Lua code dynamically. Because the malicious Lua code is passed as an argument to the LuaJIT interpreter we first attempted to instrument the Lua environment by loading tracing code prior to running the JIT, a concept based on the ideas outlined in Nickâ€™s blog <a href="https://nickcano.com/hooking-luajit/">Hooking LuaJIT</a>. Using the following script passed with the <code>-e</code> argument to the interpreter.</p>

<pre><code>AimmyLauncher.exe -e &lt;script&gt; data</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span><span class="n">jit</span><span class="p">.</span><span class="n">off</span><span class="p">()</span>

<span class="n">FILE_PATH</span> <span class="o">=</span> <span class="s2">"C:</span><span class="se">\\</span><span class="s2">LuaJitHookLogs</span><span class="se">\\</span><span class="s2">"</span>
<span class="n">STARTING_TIME</span> <span class="o">=</span> <span class="nb">os.clock</span><span class="p">()</span>
<span class="n">GDUMPED</span> <span class="o">=</span> <span class="kc">false</span>

<span class="kr">function</span> <span class="nc">table</span><span class="p">.</span><span class="nf">show</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="kd">local</span> <span class="kr">function</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">str</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="kd">local</span> <span class="n">indent</span> <span class="o">=</span> <span class="nb">string.rep</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="n">level</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

        <span class="kr">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="kr">do</span>
            <span class="kr">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"table"</span> <span class="kr">then</span>
                <span class="n">str</span> <span class="o">=</span> <span class="n">str</span> <span class="o">..</span> <span class="n">indent</span> <span class="o">..</span> <span class="n">i</span> <span class="o">..</span> <span class="s2">":</span><span class="se">\n</span><span class="s2">"</span> <span class="o">..</span> <span class="n">serialize</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">level</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="kr">else</span>
                <span class="n">str</span> <span class="o">=</span> <span class="n">str</span> <span class="o">..</span> <span class="n">indent</span> <span class="o">..</span> <span class="n">i</span> <span class="o">..</span> <span class="s2">": "</span> <span class="o">..</span> <span class="nb">tostring</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">..</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
            <span class="kr">end</span>
        <span class="kr">end</span>

        <span class="kr">return</span> <span class="n">str</span>
    <span class="kr">end</span>

    <span class="kr">return</span> <span class="n">serialize</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">dumpGlobals</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">FILE_PATH</span> <span class="o">..</span> <span class="s2">"globals_"</span> <span class="o">..</span> <span class="n">STARTING_TIME</span> <span class="o">..</span> <span class="s2">".txt"</span>
    <span class="kd">local</span> <span class="n">globalsFile</span> <span class="o">=</span> <span class="nb">io.open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span>
    <span class="n">globalsFile</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="n">table</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="nb">_G</span><span class="p">,</span> <span class="s2">"_G"</span><span class="p">))</span>
    <span class="n">globalsFile</span><span class="p">:</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">globalsFile</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">trace</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">info</span> <span class="o">=</span> <span class="nb">debug.getinfo</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="kr">if</span> <span class="ow">not</span> <span class="n">info</span> <span class="kr">then</span> <span class="kr">return</span> <span class="kr">end</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">info</span><span class="p">.</span><span class="n">name</span> <span class="kr">then</span> <span class="kr">return</span> <span class="kr">end</span>
    <span class="kr">if</span> <span class="nb">string.len</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="kr">then</span> <span class="kr">return</span> <span class="kr">end</span>

    <span class="kr">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">GDUMPED</span><span class="p">)</span> <span class="kr">then</span>
        <span class="n">dumpGlobals</span><span class="p">()</span>
        <span class="n">GDUMPED</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="kr">end</span>

    <span class="kd">local</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">FILE_PATH</span> <span class="o">..</span> <span class="s2">"trace_"</span> <span class="o">..</span> <span class="n">STARTING_TIME</span> <span class="o">..</span> <span class="s2">".txt"</span>
    <span class="kd">local</span> <span class="n">traceFile</span> <span class="o">=</span> <span class="nb">io.open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">)</span>
    <span class="n">traceFile</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span> <span class="o">..</span> <span class="s2">"()</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

    <span class="kd">local</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="kr">while</span> <span class="kc">true</span> <span class="kr">do</span>
        <span class="kd">local</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">debug.getlocal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="kr">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="kr">then</span> <span class="kr">break</span> <span class="kr">end</span>
        <span class="kr">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="kr">then</span> <span class="kr">break</span> <span class="kr">end</span>
        <span class="n">traceFile</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="nb">tostring</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">..</span> <span class="s2">": "</span> <span class="o">..</span> <span class="nb">tostring</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">..</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="kr">end</span>

    <span class="n">traceFile</span><span class="p">:</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">traceFile</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
<span class="kr">end</span>
<span class="nb">debug.sethook</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="s2">"c"</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This had some limited success, there is an anti-tamper feature in the VM (which was eventually bypassed by Jollyc) but I ran into some issues... mainly I donâ€™t know anything about Lua and troubleshooting the errors was time consuming.</p>
<h3 id="Lua-Garbage---Dumping-Encrypted-Strings">
<a class="anchor" href="#Lua-Garbage---Dumping-Encrypted-Strings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lua Garbage - Dumping Encrypted Strings<a class="anchor-link" href="#Lua-Garbage---Dumping-Encrypted-Strings"> </a>
</h3>
<p>This idea belongs to <strong>Jolyc</strong>, <strong>Fishy-Sticks</strong>, and <strong>0AVX</strong>. As Fishy-Sticks put it...</p>
<blockquote>
<p>Lua is a managed language which has a garbage collector, me and AVX are looking for where they collect strings so we can dump all string info before it gets collected thus holding decrypted strings
:) LuaJIT is a little bit diff from normal Lua so it takes us a bit to find
All that was needed was to clone the <a href="https://luajit.org/download.html">LuaJIT repository</a>, locate the garbage collector for the strings in the LuaJIT code, and add our own hook to dump them before they were freed. We could then compile our custom version of LuaJIT and use this to run the malicious Lua code and dump the strings.</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Hook-lj_str_free">
<a class="anchor" href="#Hook-lj_str_free" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hook lj_str_free<a class="anchor-link" href="#Hook-lj_str_free"> </a>
</h4>
<p>The <code>lj_str_free</code> function in <code>lj_str.c</code> is responsible for freeing the string memory. By adding some simple log code here and recompiling</p>
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">LJ_FASTCALL</span> <span class="n">lj_str_free</span><span class="p">(</span><span class="n">global_State</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="n">GCstr</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">myStr</span> <span class="o">=</span> <span class="n">strdata</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">myStr</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"STRING: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">myStr</span><span class="p">);</span>
        <span class="kt">FILE</span><span class="o">*</span> <span class="n">newfile</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"log.txt"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">newfile</span><span class="p">,</span> <span class="s">"STRING: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">myStr</span><span class="p">);</span>
        <span class="n">fclose</span><span class="p">(</span><span class="n">newfile</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">g</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">.</span><span class="n">num</span><span class="o">--</span><span class="p">;</span>
  <span class="n">lj_mem_free</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">lj_str_size</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
<p>Additional hooks can be added in <code>lib_os.c</code> on the os functions to dump interactions between the Lua and the host.</p>
<div class="highlight"><pre><span></span><span class="n">LJLIB_CF</span><span class="p">(</span><span class="n">os_execute</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cmd2</span> <span class="o">=</span> <span class="n">luaL_optstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmd2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"OS_EXECUTE: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cmd2</span><span class="p">);</span>
        <span class="kt">FILE</span><span class="o">*</span> <span class="n">newfile</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"log.txt"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">newfile</span><span class="p">,</span> <span class="s">"OS_EXECUTE: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cmd2</span><span class="p">);</span>
        <span class="n">fclose</span><span class="p">(</span><span class="n">newfile</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Because many string operators result in partial strings being allocated to memory there is a lot of noise in the dump but we were able to recover full structs, function definition, as well as strings used for the C2 communication and persistence of the malware.</p>
<p>TODO - this approach could be combined with more classic API tracing to provide an more holistic view of the malware.</p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/github/lua/2024/03/03/lua-malware.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
