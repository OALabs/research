<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Emotet Deobfuscation Generic Solution</h1><p class="page-description">Removing obfsucation from Emotet with a generic solution</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-04-20T00:00:00-05:00" itemprop="datePublished">
        Apr 20, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      50 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#angr">angr</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#symbolic execution">symbolic execution</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#deobfuscation">deobfuscation</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#research">research</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#emotet">emotet</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2022-04-20-emotet_deobfuscation_generic.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a></li>
<li class="toc-entry toc-h2"><a href="#References">References </a></li>
<li class="toc-entry toc-h2"><a href="#IDA-Script---Label-The-Basic-Blocks">IDA Script - Label The Basic Blocks </a></li>
<li class="toc-entry toc-h2"><a href="#Obtain-STATE-and-NEXT-STATE-Information-For-Each-Basic-Block">Obtain STATE and NEXT-STATE Information For Each Basic Block </a></li>
<li class="toc-entry toc-h2"><a href="#Patching-Ideas">Patching Ideas </a></li>
<li class="toc-entry toc-h2"><a href="#Failures-and-Next-Steps">Failures and Next Steps </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Hack-#1">Hack #1 </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-04-20-emotet_deobfuscation_generic.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p>We have updated our algorithm to hadle the CFG normalization and to handle branching within a state (no part of the dispatcher).</p>
<h2 id="References">
<a class="anchor" href="#References" aria-hidden="true"><span class="octicon octicon-link"></span></a>References<a class="anchor-link" href="#References"> </a>
</h2>
<ul>
<li><a href="https://github.com/ElvisBlue/emotet-deobfuscator">IDA IL-only Emotet Deobfuscation Tool</a></li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">angr</span><span class="o">,</span> <span class="nn">claripy</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">'angr'</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">'ERROR'</span><span class="p">)</span>

<span class="c1"># maintain a state counter</span>
<span class="n">state_count</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># maintain a list of entry bb for states</span>
<span class="n">entry_bb_list</span> <span class="o">=</span> <span class="p">[]</span> 
<span class="c1"># bb_tree[bb_address] = {states[], end, children=[] }</span>
<span class="n">bb_tree</span> <span class="o">=</span> <span class="p">{}</span>


<span class="c1"># Use a queue for BFS </span>
<span class="c1"># The queue contains state_info = {'state_value':0, 'sim_state':initial_state}</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>


<span class="c1"># Function information</span>
<span class="n">BINARY_PATH</span> <span class="o">=</span> <span class="s1">'/tmp/emotet.bin'</span>
<span class="n">fn_start</span> <span class="o">=</span> <span class="mh">0x10008784</span>
<span class="n">fn_end</span> <span class="o">=</span> <span class="mh">0x100099D2</span> 
<span class="n">state_register</span> <span class="o">=</span> <span class="s1">'ebx'</span>

<span class="c1"># Start angr project</span>
<span class="n">project</span> <span class="o">=</span> <span class="n">angr</span><span class="o">.</span><span class="n">Project</span><span class="p">(</span><span class="n">BINARY_PATH</span><span class="p">,</span> <span class="n">load_options</span><span class="o">=</span><span class="p">{</span><span class="s1">'auto_load_libs'</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>


<span class="c1"># Setup function initial state on queue</span>
<span class="n">initial_state</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">call_state</span><span class="p">(</span><span class="n">addr</span><span class="o">=</span><span class="n">fn_start</span><span class="p">)</span>

<span class="c1"># Use this setting to skip calls instead of a hook</span>
<span class="n">initial_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">angr</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">CALLLESS</span><span class="p">)</span>
<span class="n">state_count</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">state_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'state_value'</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'sim_state'</span><span class="p">:</span><span class="n">initial_state</span><span class="p">}</span>
<span class="n">entry_bb_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn_start</span><span class="p">)</span>
<span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">state_info</span><span class="p">)</span>




<span class="c1"># Walk the queue</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
    <span class="n">state_info</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">state_value</span> <span class="o">=</span> <span class="n">state_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'state_value'</span><span class="p">)</span>
    <span class="n">sim_state</span> <span class="o">=</span> <span class="n">state_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'sim_state'</span><span class="p">)</span>
    <span class="n">bb_address</span> <span class="o">=</span> <span class="n">sim_state</span><span class="o">.</span><span class="n">block</span><span class="p">()</span><span class="o">.</span><span class="n">addr</span>
    <span class="n">bb_end_address</span> <span class="o">=</span> <span class="n">bb_address</span> <span class="o">+</span> <span class="n">sim_state</span><span class="o">.</span><span class="n">block</span><span class="p">()</span><span class="o">.</span><span class="n">size</span>
    
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">==============================</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"BB: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">bb_address</span><span class="p">)</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">bb_end_address</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2"> State Value: </span><span class="si">{</span><span class="n">state_value</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
    
    <span class="c1"># If we have already processed this bb for the same state disregard it</span>
    <span class="k">if</span> <span class="n">bb_address</span> <span class="ow">in</span> <span class="n">bb_tree</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">state_value</span> <span class="ow">in</span> <span class="n">bb_tree</span><span class="p">[</span><span class="n">bb_address</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'states'</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2"> !! Already processed for this state - END !!"</span><span class="p">)</span>
            <span class="k">continue</span>
    
    <span class="c1"># Get successors </span>
    <span class="n">successors</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">sim_state</span><span class="p">)</span>
    <span class="c1"># Get children</span>
    <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">addr</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">successors</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2"> Children:"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    
    <span class="c1"># Add info to bb tree</span>
    <span class="k">if</span> <span class="n">bb_address</span> <span class="ow">in</span> <span class="n">bb_tree</span><span class="p">:</span>
        <span class="n">bb_tree</span><span class="p">[</span><span class="n">bb_address</span><span class="p">][</span><span class="s1">'states'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span>
        <span class="n">bb_tree</span><span class="p">[</span><span class="n">bb_address</span><span class="p">][</span><span class="s1">'children'</span><span class="p">]</span> <span class="o">+=</span> <span class="n">children</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bb_tree</span><span class="p">[</span><span class="n">bb_address</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'states'</span><span class="p">:[</span><span class="n">state_value</span><span class="p">],</span> <span class="s1">'end'</span><span class="p">:</span><span class="n">bb_end_address</span><span class="p">,</span> <span class="s1">'children'</span><span class="p">:</span><span class="n">children</span> <span class="p">}</span>
    
    <span class="c1"># Generate the successors and push them onto the queue</span>
    <span class="k">for</span> <span class="n">successor</span> <span class="ow">in</span> <span class="n">successors</span><span class="p">:</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n\t</span><span class="s2"> Successor: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">successor</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">successor</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state_register</span><span class="p">)</span><span class="o">.</span><span class="n">uninitialized</span><span class="p">:</span>
            <span class="c1"># If STATE is set reset the sim_state </span>
            <span class="c1"># Set clean sim_state</span>
            <span class="n">new_sim_state</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">blank_state</span><span class="p">(</span><span class="n">addr</span><span class="o">=</span><span class="n">successor</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span>
            <span class="n">new_sim_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">angr</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">CALLLESS</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">reg_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'eax'</span><span class="p">,</span><span class="s1">'ecx'</span><span class="p">,</span><span class="s1">'edx'</span><span class="p">,</span><span class="s1">'ebx'</span><span class="p">,</span><span class="s1">'esp'</span><span class="p">,</span><span class="s1">'ebp'</span><span class="p">,</span><span class="s1">'esi'</span><span class="p">,</span><span class="s1">'edi'</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">reg_name</span> <span class="o">!=</span> <span class="n">state_register</span><span class="p">:</span>
                    <span class="n">new_sim_state</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">new_sim_state</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reg_name</span><span class="p">),</span> <span class="n">successor</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reg_name</span><span class="p">))</span>
            <span class="c1"># Add to queue</span>
            <span class="n">state_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'state_value'</span><span class="p">:</span><span class="n">state_value</span><span class="p">,</span> <span class="s1">'sim_state'</span><span class="p">:</span><span class="n">new_sim_state</span><span class="p">}</span>
            <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">state_info</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t\t</span><span class="s2"> STATE registers set - reset sim state"</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t\t</span><span class="s2"> Added to queue -&gt;"</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If constraints for successor include == STATE </span>
            <span class="c1"># check if we have already seen the successor in entry_bb_list if we have don't push it else add it</span>
            <span class="n">flag_queue_successor</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">state_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'state_value'</span><span class="p">:</span><span class="n">state_value</span><span class="p">,</span> <span class="s1">'sim_state'</span><span class="p">:</span><span class="n">successor</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">successor</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">constraint_variable</span> <span class="ow">in</span> <span class="n">constraint</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">'reg_'</span><span class="o">+</span> <span class="n">state_register</span> <span class="ow">in</span> <span class="n">constraint_variable</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">constraint</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">'__eq__'</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t\t</span><span class="s2"> State entry bb found!"</span><span class="p">)</span>
                            <span class="c1"># This is a state entry bb</span>
                            <span class="k">if</span> <span class="n">successor</span><span class="o">.</span><span class="n">addr</span> <span class="ow">in</span> <span class="n">entry_bb_list</span><span class="p">:</span>
                                <span class="c1"># if it is already in entry_bb_list then don't add it to the queue</span>
                                <span class="n">flag_queue_successor</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t\t\t</span><span class="s2"> Already processed this state - END!"</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Setup new entry state for queue </span>
                                <span class="n">new_state_value</span> <span class="o">=</span> <span class="n">state_count</span>
                                <span class="n">state_count</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="c1"># Set clean sim_state</span>
                                <span class="n">new_sim_state</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">blank_state</span><span class="p">(</span><span class="n">addr</span><span class="o">=</span><span class="n">successor</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span>
                                <span class="n">new_sim_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">angr</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">CALLLESS</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">reg_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'eax'</span><span class="p">,</span><span class="s1">'ecx'</span><span class="p">,</span><span class="s1">'edx'</span><span class="p">,</span><span class="s1">'ebx'</span><span class="p">,</span><span class="s1">'esp'</span><span class="p">,</span><span class="s1">'ebp'</span><span class="p">,</span><span class="s1">'esi'</span><span class="p">,</span><span class="s1">'edi'</span><span class="p">]:</span>
                                    <span class="k">if</span> <span class="n">reg_name</span> <span class="o">!=</span> <span class="n">state_register</span><span class="p">:</span>
                                        <span class="n">new_sim_state</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">new_sim_state</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reg_name</span><span class="p">),</span> <span class="n">successor</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reg_name</span><span class="p">))</span>
                                <span class="n">state_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'state_value'</span><span class="p">:</span><span class="n">new_state_value</span><span class="p">,</span> <span class="s1">'sim_state'</span><span class="p">:</span><span class="n">new_sim_state</span><span class="p">}</span>
                                <span class="n">entry_bb_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">successor</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t\t\t</span><span class="s2"> New state: </span><span class="si">{</span><span class="n">new_state_value</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flag_queue_successor</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t\t</span><span class="s2"> Added to queue -&gt;"</span><span class="p">)</span>
                <span class="c1"># If we are ok to add the successor to the queue add it now</span>
                <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">state_info</span><span class="p">)</span>

                      
            
<span class="nb">print</span><span class="p">(</span><span class="s2">"** Completed initial analysis **"</span><span class="p">)</span>            

<span class="c1"># Normalize bb_tree and combine states for overlapping blocks</span>
<span class="c1"># Basic block normalization </span>
<span class="c1"># If there is a jmp to the middle of a bb angr doesn't split it into two bb, this causes issues where a "single" bb</span>
<span class="c1"># in the view of anger is actually two different types of bb </span>
<span class="c1"># To normalize these what we need to do is split the bottom parts off the any non-normalized bb and set the type of</span>
<span class="c1"># the top part of the block to be the same as the previous block</span>

<span class="c1"># bb_tree[bb_address] = {states[], end, children=[] }</span>

<span class="c1"># Sort the bb by address</span>
<span class="n">bb_tree_sorted</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">bb_tree</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">bb_tree</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>

<span class="c1"># For each bb search for bb that end after it and truncate them</span>
<span class="c1"># Also update their type to match the previous type</span>
<span class="k">for</span> <span class="n">bb_address</span> <span class="ow">in</span> <span class="n">bb_tree_sorted</span><span class="p">:</span>
    <span class="n">bb_tree_sorted</span><span class="p">[</span><span class="n">bb_address</span><span class="p">][</span><span class="s1">'children'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bb_tree_sorted</span><span class="p">[</span><span class="n">bb_address</span><span class="p">][</span><span class="s1">'children'</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">ptr</span> <span class="ow">in</span> <span class="n">bb_tree_sorted</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ptr</span> <span class="o">&gt;=</span> <span class="n">bb_address</span><span class="p">:</span>
            <span class="c1"># We have passed our bb, not more potential unnormalized bb for this address</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">bb_address</span> <span class="o">&lt;</span> <span class="n">bb_tree_sorted</span><span class="p">[</span><span class="n">ptr</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'end'</span><span class="p">):</span>
            <span class="c1"># Truncate the block</span>
            <span class="n">bb_tree_sorted</span><span class="p">[</span><span class="n">ptr</span><span class="p">][</span><span class="s1">'end'</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb_address</span>
            <span class="c1"># Update the truncated block children with only next block</span>
            <span class="n">bb_tree_sorted</span><span class="p">[</span><span class="n">ptr</span><span class="p">][</span><span class="s1">'children'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">bb_address</span><span class="p">]</span>
            <span class="c1"># Update the overlapped block states by combining both state lists</span>
            <span class="n">bb_tree_sorted</span><span class="p">[</span><span class="n">bb_address</span><span class="p">][</span><span class="s1">'states'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bb_tree_sorted</span><span class="p">[</span><span class="n">bb_address</span><span class="p">][</span><span class="s1">'states'</span><span class="p">]</span> <span class="o">+</span> <span class="n">bb_tree_sorted</span><span class="p">[</span><span class="n">ptr</span><span class="p">][</span><span class="s1">'states'</span><span class="p">]))</span>

<span class="c1"># Print sorted bb_tree </span>
<span class="k">for</span> <span class="n">bb_address</span> <span class="ow">in</span> <span class="n">bb_tree_sorted</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">bb_address</span><span class="p">)</span><span class="si">}</span><span class="s2"> - States: </span><span class="si">{</span><span class="n">bb_tree_sorted</span><span class="p">[</span><span class="n">bb_address</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'states'</span><span class="p">)</span><span class="si">}</span><span class="s2"> Children: </span><span class="si">{</span><span class="p">[</span><span class="nb">hex</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">bb_tree_sorted</span><span class="p">[</span><span class="n">bb_address</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'children'</span><span class="p">))]</span><span class="si">}</span><span class="s2"> "</span><span class="p">)</span>
            


<span class="c1"># Walk bb_tree and group bb by state, identify state end blocks</span>
<span class="c1"># bb_state_map[addr] = {'is_obb': True, 'end': 268470548}</span>
<span class="n">bb_state_map</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">bb_address</span> <span class="ow">in</span> <span class="n">bb_tree_sorted</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bb_tree_sorted</span><span class="p">[</span><span class="n">bb_address</span><span class="p">][</span><span class="s1">'children'</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># This is an end block mark it as obb</span>
        <span class="n">bb_state_map</span><span class="p">[</span><span class="n">bb_address</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="n">bb_tree_sorted</span><span class="p">[</span><span class="n">bb_address</span><span class="p">][</span><span class="s1">'end'</span><span class="p">]}</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">bb_tree_sorted</span><span class="p">[</span><span class="n">bb_address</span><span class="p">][</span><span class="s1">'states'</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># This is an obb</span>
        <span class="n">bb_state_map</span><span class="p">[</span><span class="n">bb_address</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="n">bb_tree_sorted</span><span class="p">[</span><span class="n">bb_address</span><span class="p">][</span><span class="s1">'end'</span><span class="p">]}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bb_state_map</span><span class="p">[</span><span class="n">bb_address</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="n">bb_tree_sorted</span><span class="p">[</span><span class="n">bb_address</span><span class="p">][</span><span class="s1">'end'</span><span class="p">]}</span>
    
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
==============================

BB: 0x10008784 - 0x10008914
	 State Value: 0
	 Children:
		 0x10008914

	 Successor: 0x10008914
		 STATE registers set - reset sim state
		 Added to queue -&gt;

==============================

BB: 0x10008914 - 0x10008aa1
	 State Value: 0
	 Children:
		 0x10008aa1

	 Successor: 0x10008aa1
		 Added to queue -&gt;

==============================

BB: 0x10008aa1 - 0x10008c31
	 State Value: 0
	 Children:
		 0x10008c31

	 Successor: 0x10008c31
		 Added to queue -&gt;

==============================

BB: 0x10008c31 - 0x10008dbb
	 State Value: 0
	 Children:
		 0x10008dbb

	 Successor: 0x10008dbb
		 Added to queue -&gt;

==============================

BB: 0x10008dbb - 0x10008f47
	 State Value: 0
	 Children:
		 0x10008f47

	 Successor: 0x10008f47
		 Added to queue -&gt;

==============================

BB: 0x10008f47 - 0x100090d0
	 State Value: 0
	 Children:
		 0x100090d0

	 Successor: 0x100090d0
		 Added to queue -&gt;

==============================

BB: 0x100090d0 - 0x1000925d
	 State Value: 0
	 Children:
		 0x1000925d

	 Successor: 0x1000925d
		 Added to queue -&gt;

==============================

BB: 0x1000925d - 0x100093e6
	 State Value: 0
	 Children:
		 0x100093e6

	 Successor: 0x100093e6
		 Added to queue -&gt;

==============================

BB: 0x100093e6 - 0x10009555
	 State Value: 0
	 Children:
		 0x10009555
		 0x10009894

	 Successor: 0x10009555
		 Added to queue -&gt;

	 Successor: 0x10009894
		 Added to queue -&gt;

==============================

BB: 0x10009555 - 0x1000955b
	 State Value: 0
	 Children:
		 0x10009863
		 0x1000955b

	 Successor: 0x10009863
		 State entry bb found!
			 New state: 1
		 Added to queue -&gt;

	 Successor: 0x1000955b
		 Added to queue -&gt;

==============================

BB: 0x10009894 - 0x100098a0
	 State Value: 0
	 Children:
		 0x100099c1
		 0x100098a0

	 Successor: 0x100099c1
		 State entry bb found!
			 New state: 2
		 Added to queue -&gt;

	 Successor: 0x100098a0
		 Added to queue -&gt;

==============================

BB: 0x10009863 - 0x1000988a
	 State Value: 1
	 Children:
		 0x1000988a

	 Successor: 0x1000988a
		 Added to queue -&gt;

==============================

BB: 0x1000955b - 0x10009563
	 State Value: 0
	 Children:
		 0x100097cd
		 0x10009563

	 Successor: 0x100097cd
		 State entry bb found!
			 New state: 3
		 Added to queue -&gt;

	 Successor: 0x10009563
		 Added to queue -&gt;

==============================

BB: 0x100099c1 - 0x100099d2
	 State Value: 2
	 Children:
		 0x10009549

	 Successor: 0x10009549
		 STATE registers set - reset sim state
		 Added to queue -&gt;

==============================

BB: 0x100098a0 - 0x100098a4
	 State Value: 0
	 Children:
		 0x100098e8
		 0x100098a4

	 Successor: 0x100098e8
		 State entry bb found!
			 New state: 4
		 Added to queue -&gt;

	 Successor: 0x100098a4
		 Added to queue -&gt;

==============================

BB: 0x1000988a - 0x10009894
	 State Value: 1
	 Children:
		 0x1000953a

	 Successor: 0x1000953a
		 Added to queue -&gt;

==============================

BB: 0x100097cd - 0x100097e6
	 State Value: 3
	 Children:
		 0x100097e6

	 Successor: 0x100097e6
		 Added to queue -&gt;

==============================

BB: 0x10009563 - 0x1000956f
	 State Value: 0
	 Children:
		 0x10009713
		 0x1000956f

	 Successor: 0x10009713
		 State entry bb found!
			 New state: 5
		 Added to queue -&gt;

	 Successor: 0x1000956f
		 Added to queue -&gt;

==============================

BB: 0x10009549 - 0x10009555
	 State Value: 2
	 Children:
		 0x10009555
		 0x10009894

	 Successor: 0x10009555
		 Added to queue -&gt;

	 Successor: 0x10009894
		 Added to queue -&gt;

==============================

BB: 0x100098e8 - 0x10009904
	 State Value: 4
	 Children:
		 0x10009904

	 Successor: 0x10009904
		 Added to queue -&gt;

==============================

BB: 0x100098a4 - 0x100098ac
	 State Value: 0
	 Children:
		 0x100098ac
		 0x100099c6

	 Successor: 0x100098ac
		 State entry bb found!
			 New state: 6
		 Added to queue -&gt;

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x1000953a - 0x10009555
	 State Value: 1
	 Children:
		 0x10009555

	 Successor: 0x10009555
		 Added to queue -&gt;

==============================

BB: 0x100097e6 - 0x10009830
	 State Value: 3
	 Children:
		 0x10009830

	 Successor: 0x10009830
		 Added to queue -&gt;

==============================

BB: 0x10009713 - 0x10009732
	 State Value: 5
	 Children:
		 0x10009732

	 Successor: 0x10009732
		 Added to queue -&gt;

==============================

BB: 0x1000956f - 0x10009573
	 State Value: 0
	 Children:
		 0x100095a9
		 0x10009573

	 Successor: 0x100095a9
		 State entry bb found!
			 New state: 7
		 Added to queue -&gt;

	 Successor: 0x10009573
		 Added to queue -&gt;

==============================

BB: 0x10009555 - 0x1000955b
	 State Value: 2
	 Children:
		 0x10009863
		 0x1000955b

	 Successor: 0x10009863
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x1000955b
		 Added to queue -&gt;

==============================

BB: 0x10009894 - 0x100098a0
	 State Value: 2
	 Children:
		 0x100099c1
		 0x100098a0

	 Successor: 0x100099c1
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100098a0
		 Added to queue -&gt;

==============================

BB: 0x10009904 - 0x1000998c
	 State Value: 4
	 Children:
		 0x1000998c

	 Successor: 0x1000998c
		 Added to queue -&gt;

==============================

BB: 0x100098ac - 0x100098d8
	 State Value: 6
	 Children:
		 0x100098d8

	 Successor: 0x100098d8
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 0
	 Children:
		 0x100099d2
		 0x10009549

	 Successor: 0x100099d2
		 State entry bb found!
			 New state: 8
		 Added to queue -&gt;

	 Successor: 0x10009549
		 Added to queue -&gt;

==============================

BB: 0x10009555 - 0x1000955b
	 State Value: 1
	 Children:
		 0x1000955b

	 Successor: 0x1000955b
		 Added to queue -&gt;

==============================

BB: 0x10009830 - 0x1000985b
	 State Value: 3
	 Children:
		 0x1000985b

	 Successor: 0x1000985b
		 STATE registers set - reset sim state
		 Added to queue -&gt;

==============================

BB: 0x10009732 - 0x10009750
	 State Value: 5
	 Children:
		 0x10009750

	 Successor: 0x10009750
		 Added to queue -&gt;

==============================

BB: 0x100095a9 - 0x100095c2
	 State Value: 7
	 Children:
		 0x100095c2

	 Successor: 0x100095c2
		 Added to queue -&gt;

==============================

BB: 0x10009573 - 0x1000957b
	 State Value: 0
	 Children:
		 0x1000957b
		 0x100099c6

	 Successor: 0x1000957b
		 State entry bb found!
			 New state: 9
		 Added to queue -&gt;

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x1000955b - 0x10009563
	 State Value: 2
	 Children:
		 0x100097cd
		 0x10009563

	 Successor: 0x100097cd
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009563
		 Added to queue -&gt;

==============================

BB: 0x100098a0 - 0x100098a4
	 State Value: 2
	 Children:
		 0x100098a4

	 Successor: 0x100098a4
		 Added to queue -&gt;

==============================

BB: 0x1000998c - 0x10009998
	 State Value: 4
	 Children:
		 0x10009998
		 0x1000999f

	 Successor: 0x10009998
		 Added to queue -&gt;

	 Successor: 0x1000999f
		 Added to queue -&gt;

==============================

BB: 0x100098d8 - 0x100098e8
	 State Value: 6
	 Children:

==============================

BB: 0x100099d2 - 0x100099d7
	 State Value: 8
	 Children:
		 0x100098db

	 Successor: 0x100098db
		 Added to queue -&gt;

==============================

BB: 0x10009549 - 0x10009555
	 State Value: 0
	 Children:
		 0x10009894

	 Successor: 0x10009894
		 Added to queue -&gt;

==============================

BB: 0x1000955b - 0x10009563
	 State Value: 1
	 Children:
		 0x10009563

	 Successor: 0x10009563
		 Added to queue -&gt;

==============================

BB: 0x1000985b - 0x10009863
	 State Value: 3
	 Children:
		 0x100096fa

	 Successor: 0x100096fa
		 Added to queue -&gt;

==============================

BB: 0x10009750 - 0x1000977e
	 State Value: 5
	 Children:
		 0x1000977e

	 Successor: 0x1000977e
		 Added to queue -&gt;

==============================

BB: 0x100095c2 - 0x100095e3
	 State Value: 7
	 Children:
		 0x100095e3

	 Successor: 0x100095e3
		 Added to queue -&gt;

==============================

BB: 0x1000957b - 0x10009595
	 State Value: 9
	 Children:
		 0x10009595

	 Successor: 0x10009595
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 0
	 !! Already processed for this state - END !!

==============================

BB: 0x10009563 - 0x1000956f
	 State Value: 2
	 Children:
		 0x10009713
		 0x1000956f

	 Successor: 0x10009713
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x1000956f
		 Added to queue -&gt;

==============================

BB: 0x100098a4 - 0x100098ac
	 State Value: 2
	 Children:
		 0x100099c6

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x10009998 - 0x1000999f
	 State Value: 4
	 Children:
		 0x100099a4

	 Successor: 0x100099a4
		 Added to queue -&gt;

==============================

BB: 0x1000999f - 0x100099ba
	 State Value: 4
	 Children:
		 0x100099ba

	 Successor: 0x100099ba
		 STATE registers set - reset sim state
		 Added to queue -&gt;

==============================

BB: 0x100098db - 0x100098e8
	 State Value: 8
	 Children:

==============================

BB: 0x10009894 - 0x100098a0
	 State Value: 0
	 !! Already processed for this state - END !!

==============================

BB: 0x10009563 - 0x1000956f
	 State Value: 1
	 Children:
		 0x1000956f

	 Successor: 0x1000956f
		 Added to queue -&gt;

==============================

BB: 0x100096fa - 0x10009713
	 State Value: 3
	 Children:
		 0x100099c6

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x1000977e - 0x100097af
	 State Value: 5
	 Children:
		 0x100097af

	 Successor: 0x100097af
		 STATE registers set - reset sim state
		 Added to queue -&gt;

==============================

BB: 0x100095e3 - 0x10009615
	 State Value: 7
	 Children:
		 0x10009615

	 Successor: 0x10009615
		 Added to queue -&gt;

==============================

BB: 0x10009595 - 0x100095a9
	 State Value: 9
	 Children:
		 0x1000953a

	 Successor: 0x1000953a
		 STATE registers set - reset sim state
		 Added to queue -&gt;

==============================

BB: 0x1000956f - 0x10009573
	 State Value: 2
	 Children:
		 0x10009573

	 Successor: 0x10009573
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 2
	 Children:
		 0x100099d2
		 0x10009549

	 Successor: 0x100099d2
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009549
		 Added to queue -&gt;

==============================

BB: 0x100099a4 - 0x100099ba
	 State Value: 4
	 Children:
		 0x100099ba

	 Successor: 0x100099ba
		 Added to queue -&gt;

==============================

BB: 0x100099ba - 0x100099c1
	 State Value: 4
	 Children:
		 0x100096fa

	 Successor: 0x100096fa
		 Added to queue -&gt;

==============================

BB: 0x1000956f - 0x10009573
	 State Value: 1
	 Children:
		 0x10009573

	 Successor: 0x10009573
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 3
	 Children:
		 0x100099d2
		 0x10009549

	 Successor: 0x100099d2
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009549
		 Added to queue -&gt;

==============================

BB: 0x100097af - 0x100097c5
	 State Value: 5
	 Children:
		 0x100097c5

	 Successor: 0x100097c5
		 Added to queue -&gt;

==============================

BB: 0x10009615 - 0x100096a2
	 State Value: 7
	 Children:
		 0x100096a2

	 Successor: 0x100096a2
		 Added to queue -&gt;

==============================

BB: 0x1000953a - 0x10009555
	 State Value: 9
	 Children:
		 0x10009555
		 0x10009894

	 Successor: 0x10009555
		 Added to queue -&gt;

	 Successor: 0x10009894
		 Added to queue -&gt;

==============================

BB: 0x10009573 - 0x1000957b
	 State Value: 2
	 Children:
		 0x100099c6

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x10009549 - 0x10009555
	 State Value: 2
	 !! Already processed for this state - END !!

==============================

BB: 0x100099ba - 0x100099c1
	 State Value: 4
	 !! Already processed for this state - END !!

==============================

BB: 0x100096fa - 0x10009713
	 State Value: 4
	 Children:
		 0x100099c6

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x10009573 - 0x1000957b
	 State Value: 1
	 Children:
		 0x100099c6

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x10009549 - 0x10009555
	 State Value: 3
	 Children:
		 0x10009555
		 0x10009894

	 Successor: 0x10009555
		 Added to queue -&gt;

	 Successor: 0x10009894
		 Added to queue -&gt;

==============================

BB: 0x100097c5 - 0x100097cd
	 State Value: 5
	 Children:
		 0x100096f5

	 Successor: 0x100096f5
		 Added to queue -&gt;

==============================

BB: 0x100096a2 - 0x100096d6
	 State Value: 7
	 Children:
		 0x100096d6

	 Successor: 0x100096d6
		 STATE registers set - reset sim state
		 Added to queue -&gt;

==============================

BB: 0x10009555 - 0x1000955b
	 State Value: 9
	 Children:
		 0x10009863
		 0x1000955b

	 Successor: 0x10009863
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x1000955b
		 Added to queue -&gt;

==============================

BB: 0x10009894 - 0x100098a0
	 State Value: 9
	 Children:
		 0x100099c1
		 0x100098a0

	 Successor: 0x100099c1
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100098a0
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 2
	 !! Already processed for this state - END !!

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 4
	 Children:
		 0x100099d2
		 0x10009549

	 Successor: 0x100099d2
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009549
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 1
	 Children:
		 0x10009549

	 Successor: 0x10009549
		 Added to queue -&gt;

==============================

BB: 0x10009555 - 0x1000955b
	 State Value: 3
	 Children:
		 0x10009863
		 0x1000955b

	 Successor: 0x10009863
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x1000955b
		 Added to queue -&gt;

==============================

BB: 0x10009894 - 0x100098a0
	 State Value: 3
	 Children:
		 0x100099c1
		 0x100098a0

	 Successor: 0x100099c1
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100098a0
		 Added to queue -&gt;

==============================

BB: 0x100096f5 - 0x10009713
	 State Value: 5
	 Children:
		 0x100099c6

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x100096d6 - 0x100096f2
	 State Value: 7
	 Children:
		 0x100096f2

	 Successor: 0x100096f2
		 Added to queue -&gt;

==============================

BB: 0x1000955b - 0x10009563
	 State Value: 9
	 Children:
		 0x100097cd
		 0x10009563

	 Successor: 0x100097cd
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009563
		 Added to queue -&gt;

==============================

BB: 0x100098a0 - 0x100098a4
	 State Value: 9
	 Children:
		 0x100098a4

	 Successor: 0x100098a4
		 Added to queue -&gt;

==============================

BB: 0x10009549 - 0x10009555
	 State Value: 4
	 Children:
		 0x10009555
		 0x10009894

	 Successor: 0x10009555
		 Added to queue -&gt;

	 Successor: 0x10009894
		 Added to queue -&gt;

==============================

BB: 0x10009549 - 0x10009555
	 State Value: 1
	 Children:
		 0x10009555

	 Successor: 0x10009555
		 Added to queue -&gt;

==============================

BB: 0x1000955b - 0x10009563
	 State Value: 3
	 Children:
		 0x100097cd
		 0x10009563

	 Successor: 0x100097cd
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009563
		 Added to queue -&gt;

==============================

BB: 0x100098a0 - 0x100098a4
	 State Value: 3
	 Children:
		 0x100098e8
		 0x100098a4

	 Successor: 0x100098e8
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100098a4
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 5
	 Children:
		 0x100099d2
		 0x10009549

	 Successor: 0x100099d2
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009549
		 Added to queue -&gt;

==============================

BB: 0x100096f2 - 0x10009713
	 State Value: 7
	 Children:
		 0x100099c6

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x10009563 - 0x1000956f
	 State Value: 9
	 Children:
		 0x10009713
		 0x1000956f

	 Successor: 0x10009713
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x1000956f
		 Added to queue -&gt;

==============================

BB: 0x100098a4 - 0x100098ac
	 State Value: 9
	 Children:
		 0x100099c6

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x10009555 - 0x1000955b
	 State Value: 4
	 Children:
		 0x10009863
		 0x1000955b

	 Successor: 0x10009863
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x1000955b
		 Added to queue -&gt;

==============================

BB: 0x10009894 - 0x100098a0
	 State Value: 4
	 Children:
		 0x100099c1
		 0x100098a0

	 Successor: 0x100099c1
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100098a0
		 Added to queue -&gt;

==============================

BB: 0x10009555 - 0x1000955b
	 State Value: 1
	 !! Already processed for this state - END !!

==============================

BB: 0x10009563 - 0x1000956f
	 State Value: 3
	 Children:
		 0x10009713
		 0x1000956f

	 Successor: 0x10009713
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x1000956f
		 Added to queue -&gt;

==============================

BB: 0x100098a4 - 0x100098ac
	 State Value: 3
	 Children:
		 0x100099c6

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x10009549 - 0x10009555
	 State Value: 5
	 Children:
		 0x10009555
		 0x10009894

	 Successor: 0x10009555
		 Added to queue -&gt;

	 Successor: 0x10009894
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 7
	 Children:
		 0x100099d2
		 0x10009549

	 Successor: 0x100099d2
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009549
		 Added to queue -&gt;

==============================

BB: 0x1000956f - 0x10009573
	 State Value: 9
	 Children:
		 0x100095a9
		 0x10009573

	 Successor: 0x100095a9
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009573
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 9
	 Children:
		 0x100099d2
		 0x10009549

	 Successor: 0x100099d2
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009549
		 Added to queue -&gt;

==============================

BB: 0x1000955b - 0x10009563
	 State Value: 4
	 Children:
		 0x100097cd
		 0x10009563

	 Successor: 0x100097cd
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009563
		 Added to queue -&gt;

==============================

BB: 0x100098a0 - 0x100098a4
	 State Value: 4
	 Children:
		 0x100098e8
		 0x100098a4

	 Successor: 0x100098e8
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100098a4
		 Added to queue -&gt;

==============================

BB: 0x1000956f - 0x10009573
	 State Value: 3
	 Children:
		 0x100095a9
		 0x10009573

	 Successor: 0x100095a9
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009573
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 3
	 !! Already processed for this state - END !!

==============================

BB: 0x10009555 - 0x1000955b
	 State Value: 5
	 Children:
		 0x10009863
		 0x1000955b

	 Successor: 0x10009863
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x1000955b
		 Added to queue -&gt;

==============================

BB: 0x10009894 - 0x100098a0
	 State Value: 5
	 Children:
		 0x100099c1
		 0x100098a0

	 Successor: 0x100099c1
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100098a0
		 Added to queue -&gt;

==============================

BB: 0x10009549 - 0x10009555
	 State Value: 7
	 Children:
		 0x10009555
		 0x10009894

	 Successor: 0x10009555
		 Added to queue -&gt;

	 Successor: 0x10009894
		 Added to queue -&gt;

==============================

BB: 0x10009573 - 0x1000957b
	 State Value: 9
	 Children:
		 0x1000957b
		 0x100099c6

	 Successor: 0x1000957b
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x10009549 - 0x10009555
	 State Value: 9
	 Children:
		 0x10009894

	 Successor: 0x10009894
		 Added to queue -&gt;

==============================

BB: 0x10009563 - 0x1000956f
	 State Value: 4
	 Children:
		 0x10009713
		 0x1000956f

	 Successor: 0x10009713
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x1000956f
		 Added to queue -&gt;

==============================

BB: 0x100098a4 - 0x100098ac
	 State Value: 4
	 Children:
		 0x100099c6

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x10009573 - 0x1000957b
	 State Value: 3
	 Children:
		 0x1000957b
		 0x100099c6

	 Successor: 0x1000957b
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x1000955b - 0x10009563
	 State Value: 5
	 Children:
		 0x100097cd
		 0x10009563

	 Successor: 0x100097cd
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009563
		 Added to queue -&gt;

==============================

BB: 0x100098a0 - 0x100098a4
	 State Value: 5
	 Children:
		 0x100098e8
		 0x100098a4

	 Successor: 0x100098e8
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100098a4
		 Added to queue -&gt;

==============================

BB: 0x10009555 - 0x1000955b
	 State Value: 7
	 Children:
		 0x10009863
		 0x1000955b

	 Successor: 0x10009863
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x1000955b
		 Added to queue -&gt;

==============================

BB: 0x10009894 - 0x100098a0
	 State Value: 7
	 Children:
		 0x100099c1
		 0x100098a0

	 Successor: 0x100099c1
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100098a0
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 9
	 !! Already processed for this state - END !!

==============================

BB: 0x10009894 - 0x100098a0
	 State Value: 9
	 !! Already processed for this state - END !!

==============================

BB: 0x1000956f - 0x10009573
	 State Value: 4
	 Children:
		 0x100095a9
		 0x10009573

	 Successor: 0x100095a9
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009573
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 4
	 !! Already processed for this state - END !!

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 3
	 !! Already processed for this state - END !!

==============================

BB: 0x10009563 - 0x1000956f
	 State Value: 5
	 Children:
		 0x10009713
		 0x1000956f

	 Successor: 0x10009713
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x1000956f
		 Added to queue -&gt;

==============================

BB: 0x100098a4 - 0x100098ac
	 State Value: 5
	 Children:
		 0x100098ac
		 0x100099c6

	 Successor: 0x100098ac
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x1000955b - 0x10009563
	 State Value: 7
	 Children:
		 0x100097cd
		 0x10009563

	 Successor: 0x100097cd
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009563
		 Added to queue -&gt;

==============================

BB: 0x100098a0 - 0x100098a4
	 State Value: 7
	 Children:
		 0x100098e8
		 0x100098a4

	 Successor: 0x100098e8
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100098a4
		 Added to queue -&gt;

==============================

BB: 0x10009573 - 0x1000957b
	 State Value: 4
	 Children:
		 0x1000957b
		 0x100099c6

	 Successor: 0x1000957b
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x1000956f - 0x10009573
	 State Value: 5
	 Children:
		 0x100095a9
		 0x10009573

	 Successor: 0x100095a9
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009573
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 5
	 !! Already processed for this state - END !!

==============================

BB: 0x10009563 - 0x1000956f
	 State Value: 7
	 Children:
		 0x10009713
		 0x1000956f

	 Successor: 0x10009713
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x1000956f
		 Added to queue -&gt;

==============================

BB: 0x100098a4 - 0x100098ac
	 State Value: 7
	 Children:
		 0x100098ac
		 0x100099c6

	 Successor: 0x100098ac
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 4
	 !! Already processed for this state - END !!

==============================

BB: 0x10009573 - 0x1000957b
	 State Value: 5
	 Children:
		 0x1000957b
		 0x100099c6

	 Successor: 0x1000957b
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x1000956f - 0x10009573
	 State Value: 7
	 Children:
		 0x100095a9
		 0x10009573

	 Successor: 0x100095a9
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x10009573
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 7
	 !! Already processed for this state - END !!

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 5
	 !! Already processed for this state - END !!

==============================

BB: 0x10009573 - 0x1000957b
	 State Value: 7
	 Children:
		 0x1000957b
		 0x100099c6

	 Successor: 0x1000957b
		 State entry bb found!
			 Already processed this state - END!

	 Successor: 0x100099c6
		 Added to queue -&gt;

==============================

BB: 0x100099c6 - 0x100099d2
	 State Value: 7
	 !! Already processed for this state - END !!
** Completed initial analysis **
0x10008784 - States: [0] Children: ['0x10008914'] 
0x10008914 - States: [0] Children: ['0x10008aa1'] 
0x10008aa1 - States: [0] Children: ['0x10008c31'] 
0x10008c31 - States: [0] Children: ['0x10008dbb'] 
0x10008dbb - States: [0] Children: ['0x10008f47'] 
0x10008f47 - States: [0] Children: ['0x100090d0'] 
0x100090d0 - States: [0] Children: ['0x1000925d'] 
0x1000925d - States: [0] Children: ['0x100093e6'] 
0x100093e6 - States: [0] Children: ['0x1000953a'] 
0x1000953a - States: [0, 1, 9] Children: ['0x10009549'] 
0x10009549 - States: [0, 1, 2, 3, 4, 5, 7, 9] Children: ['0x10009894', '0x10009555'] 
0x10009555 - States: [0, 2, 1, 9, 3, 4, 5, 7] Children: ['0x1000955b', '0x10009863'] 
0x1000955b - States: [0, 2, 1, 9, 3, 4, 5, 7] Children: ['0x10009563', '0x100097cd'] 
0x10009563 - States: [0, 2, 1, 9, 3, 4, 5, 7] Children: ['0x10009713', '0x1000956f'] 
0x1000956f - States: [0, 2, 1, 9, 3, 4, 5, 7] Children: ['0x100095a9', '0x10009573'] 
0x10009573 - States: [0, 2, 1, 9, 3, 4, 5, 7] Children: ['0x1000957b', '0x100099c6'] 
0x1000957b - States: [9] Children: ['0x10009595'] 
0x10009595 - States: [9] Children: ['0x1000953a'] 
0x100095a9 - States: [7] Children: ['0x100095c2'] 
0x100095c2 - States: [7] Children: ['0x100095e3'] 
0x100095e3 - States: [7] Children: ['0x10009615'] 
0x10009615 - States: [7] Children: ['0x100096a2'] 
0x100096a2 - States: [7] Children: ['0x100096d6'] 
0x100096d6 - States: [7] Children: ['0x100096f2'] 
0x100096f2 - States: [7] Children: ['0x100096f5'] 
0x100096f5 - States: [5, 7] Children: ['0x100096fa'] 
0x100096fa - States: [3, 4, 5, 7] Children: ['0x100099c6'] 
0x10009713 - States: [5] Children: ['0x10009732'] 
0x10009732 - States: [5] Children: ['0x10009750'] 
0x10009750 - States: [5] Children: ['0x1000977e'] 
0x1000977e - States: [5] Children: ['0x100097af'] 
0x100097af - States: [5] Children: ['0x100097c5'] 
0x100097c5 - States: [5] Children: ['0x100096f5'] 
0x100097cd - States: [3] Children: ['0x100097e6'] 
0x100097e6 - States: [3] Children: ['0x10009830'] 
0x10009830 - States: [3] Children: ['0x1000985b'] 
0x1000985b - States: [3] Children: ['0x100096fa'] 
0x10009863 - States: [1] Children: ['0x1000988a'] 
0x1000988a - States: [1] Children: ['0x1000953a'] 
0x10009894 - States: [0, 2, 9, 3, 4, 5, 7] Children: ['0x100098a0', '0x100099c1'] 
0x100098a0 - States: [0, 2, 9, 3, 4, 5, 7] Children: ['0x100098e8', '0x100098a4'] 
0x100098a4 - States: [0, 2, 9, 3, 4, 5, 7] Children: ['0x100098ac', '0x100099c6'] 
0x100098ac - States: [6] Children: ['0x100098d8'] 
0x100098d8 - States: [6] Children: ['0x100098db'] 
0x100098db - States: [8, 6] Children: [] 
0x100098e8 - States: [4] Children: ['0x10009904'] 
0x10009904 - States: [4] Children: ['0x1000998c'] 
0x1000998c - States: [4] Children: ['0x10009998', '0x1000999f'] 
0x10009998 - States: [4] Children: ['0x100099a4'] 
0x1000999f - States: [4] Children: ['0x100099a4'] 
0x100099a4 - States: [4] Children: ['0x100099ba'] 
0x100099ba - States: [4] Children: ['0x100096fa'] 
0x100099c1 - States: [2] Children: ['0x100099c6'] 
0x100099c6 - States: [0, 1, 2, 3, 4, 5, 7, 9] Children: ['0x10009549', '0x100099d2'] 
0x100099d2 - States: [8] Children: ['0x100098db'] 
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="IDA-Script---Label-The-Basic-Blocks">
<a class="anchor" href="#IDA-Script---Label-The-Basic-Blocks" aria-hidden="true"><span class="octicon octicon-link"></span></a>IDA Script - Label The Basic Blocks<a class="anchor-link" href="#IDA-Script---Label-The-Basic-Blocks"> </a>
</h2>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">idaapi</span>
<span class="kn">import</span> <span class="nn">idautils</span>
<span class="kn">import</span> <span class="nn">idc</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">import</span> <span class="nn">struct</span>


<span class="n">bb_states</span> <span class="o">=</span> <span class="p">{</span><span class="mi">268470148</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268470548</span><span class="p">},</span>
 <span class="mi">268470548</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268470945</span><span class="p">},</span>
 <span class="mi">268470945</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268471345</span><span class="p">},</span>
 <span class="mi">268471345</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268471739</span><span class="p">},</span>
 <span class="mi">268471739</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268472135</span><span class="p">},</span>
 <span class="mi">268472135</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268472528</span><span class="p">},</span>
 <span class="mi">268472528</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268472925</span><span class="p">},</span>
 <span class="mi">268472925</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473318</span><span class="p">},</span>
 <span class="mi">268473318</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473658</span><span class="p">},</span>
 <span class="mi">268473658</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473673</span><span class="p">},</span>
 <span class="mi">268473673</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473685</span><span class="p">},</span>
 <span class="mi">268473685</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473691</span><span class="p">},</span>
 <span class="mi">268473691</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473699</span><span class="p">},</span>
 <span class="mi">268473699</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473711</span><span class="p">},</span>
 <span class="mi">268473711</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473715</span><span class="p">},</span>
 <span class="mi">268473715</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473723</span><span class="p">},</span>
 <span class="mi">268473723</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473749</span><span class="p">},</span>
 <span class="mi">268473749</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473769</span><span class="p">},</span>
 <span class="mi">268473769</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473794</span><span class="p">},</span>
 <span class="mi">268473794</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473827</span><span class="p">},</span>
 <span class="mi">268473827</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473877</span><span class="p">},</span>
 <span class="mi">268473877</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474018</span><span class="p">},</span>
 <span class="mi">268474018</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474070</span><span class="p">},</span>
 <span class="mi">268474070</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474098</span><span class="p">},</span>
 <span class="mi">268474098</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474101</span><span class="p">},</span>
 <span class="mi">268474101</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474106</span><span class="p">},</span>
 <span class="mi">268474106</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474131</span><span class="p">},</span>
 <span class="mi">268474131</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474162</span><span class="p">},</span>
 <span class="mi">268474162</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474192</span><span class="p">},</span>
 <span class="mi">268474192</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474238</span><span class="p">},</span>
 <span class="mi">268474238</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474287</span><span class="p">},</span>
 <span class="mi">268474287</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474309</span><span class="p">},</span>
 <span class="mi">268474309</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474317</span><span class="p">},</span>
 <span class="mi">268474317</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474342</span><span class="p">},</span>
 <span class="mi">268474342</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474416</span><span class="p">},</span>
 <span class="mi">268474416</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474459</span><span class="p">},</span>
 <span class="mi">268474459</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474467</span><span class="p">},</span>
 <span class="mi">268474467</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474506</span><span class="p">},</span>
 <span class="mi">268474506</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474516</span><span class="p">},</span>
 <span class="mi">268474516</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474528</span><span class="p">},</span>
 <span class="mi">268474528</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474532</span><span class="p">},</span>
 <span class="mi">268474532</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474540</span><span class="p">},</span>
 <span class="mi">268474540</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474584</span><span class="p">},</span>
 <span class="mi">268474584</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474587</span><span class="p">},</span>
 <span class="mi">268474587</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474600</span><span class="p">},</span>
 <span class="mi">268474600</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474628</span><span class="p">},</span>
 <span class="mi">268474628</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474764</span><span class="p">},</span>
 <span class="mi">268474764</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474776</span><span class="p">},</span>
 <span class="mi">268474776</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474783</span><span class="p">},</span>
 <span class="mi">268474783</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474788</span><span class="p">},</span>
 <span class="mi">268474788</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474810</span><span class="p">},</span>
 <span class="mi">268474810</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474817</span><span class="p">},</span>
 <span class="mi">268474817</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474822</span><span class="p">},</span>
 <span class="mi">268474822</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474834</span><span class="p">},</span>
 <span class="mi">268474834</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474839</span><span class="p">}}</span>

<span class="k">def</span> <span class="nf">set_bb_color</span><span class="p">(</span><span class="n">ea_start</span><span class="p">,</span> <span class="n">ea_end</span><span class="p">,</span> <span class="n">color_value</span><span class="p">):</span>
    <span class="n">ea_end</span> <span class="o">=</span> <span class="n">prev_head</span><span class="p">(</span><span class="n">ea_end</span><span class="p">)</span>
    <span class="n">ptr</span> <span class="o">=</span> <span class="n">ea_start</span>
    <span class="k">while</span> <span class="n">ptr</span> <span class="o">&lt;=</span> <span class="n">ea_end</span> <span class="p">:</span>
        <span class="n">set_color</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">CIC_ITEM</span><span class="p">,</span> <span class="n">color_value</span><span class="p">)</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>


<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bb_states</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">bb_states</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'end'</span><span class="p">))</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">bb_states</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'is_obb'</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bb_states</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'is_obb'</span><span class="p">):</span>
        <span class="n">set_bb_color</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">bb_states</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'end'</span><span class="p">),</span> <span class="mh">0x00ff00</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">set_bb_color</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">bb_states</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'end'</span><span class="p">),</span> <span class="mh">0x00A5ff</span><span class="p">)</span>
    <span class="c1"># Color the bb entry</span>
    <span class="n">set_color</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">CIC_ITEM</span><span class="p">,</span> <span class="mh">0xc0c0c0</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Obtain-STATE-and-NEXT-STATE-Information-For-Each-Basic-Block">
<a class="anchor" href="#Obtain-STATE-and-NEXT-STATE-Information-For-Each-Basic-Block" aria-hidden="true"><span class="octicon octicon-link"></span></a>Obtain STATE and NEXT-STATE Information For Each Basic Block<a class="anchor-link" href="#Obtain-STATE-and-NEXT-STATE-Information-For-Each-Basic-Block"> </a>
</h2>
<ul>
<li>loop through all bb</li>
<li>start with STATE = 0 in obb</li>
<li>from obb run until you hit a cf bb - push branches onto queue<ul>
<li>note the STATE register VALUE - this is the NEXT STATE VALUE </li>
<li>use the STATE register value to derive the FLAGS constraints (this will be used for patching)</li>
<li>note the STATE end bb</li>
</ul>
</li>
<li>from cf run until you hit an obb <ul>
<li>assign the NEXT STATE VALUE to this obb and note the STATE entry bb</li>
</ul>
</li>
<li>end at obb you have alreay seen</li>
<li>end at end block</li>
</ul>
<div class="highlight"><pre><span></span><span class="n">state_map</span><span class="p">[</span><span class="s1">'state_value'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'state_value'</span><span class="p">:</span> <span class="kc">None</span>
                            <span class="s1">'entry_bb'</span><span class="p">:</span> <span class="kc">None</span>
                            <span class="s1">'exit_bb'</span><span class="p">:</span> <span class="kc">None</span>
                            <span class="s1">'next_states'</span><span class="p">:</span> <span class="p">[</span> <span class="p">{</span><span class="s1">'state_value'</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">'flags'</span><span class="p">:</span> <span class="kc">None</span> <span class="p">},</span> <span class="p">]</span>

<span class="p">}</span>
</pre></div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># state_table[state_value] = {</span>
<span class="c1"># 'entry':&lt;entry_bb_address&gt;, </span>
<span class="c1"># 'exit':&lt;exit_bb_address&gt;, </span>
<span class="c1"># 'next_states':[{'state_value':&lt;&gt;, 'flags':&lt;constrait_flags&gt;},]</span>
<span class="c1"># }</span>
<span class="n">state_table</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">## Build list of cf and obb blocks </span>

<span class="n">cf_bb_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">obb_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">bb_address</span> <span class="ow">in</span> <span class="n">bb_state_map</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">bb_state_map</span><span class="p">[</span><span class="n">bb_address</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'is_obb'</span><span class="p">):</span>
        <span class="n">obb_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bb_address</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cf_bb_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bb_address</span><span class="p">)</span>


<span class="c1"># Use a queue for BFS </span>
<span class="c1"># The queue contains state_info = {</span>
                <span class="c1"># 'state_value':0, </span>
                <span class="c1"># 'sim_state':initial_state, </span>
                <span class="c1"># 'entry':true/false, </span>
                <span class="c1"># 'condition':&lt;none / jz / etc.&gt;</span>
                <span class="c1"># }</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>


<span class="c1"># Function information</span>
<span class="n">BINARY_PATH</span> <span class="o">=</span> <span class="s1">'/tmp/emotet.bin'</span>
<span class="n">fn_start</span> <span class="o">=</span> <span class="mh">0x10008784</span>
<span class="n">fn_end</span> <span class="o">=</span> <span class="mh">0x100099D2</span> 
<span class="n">state_register</span> <span class="o">=</span> <span class="s1">'ebx'</span>

<span class="c1"># Start angr project</span>
<span class="n">project</span> <span class="o">=</span> <span class="n">angr</span><span class="o">.</span><span class="n">Project</span><span class="p">(</span><span class="n">BINARY_PATH</span><span class="p">,</span> <span class="n">load_options</span><span class="o">=</span><span class="p">{</span><span class="s1">'auto_load_libs'</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>


<span class="c1"># Setup function initial state on queue</span>
<span class="n">initial_state</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">call_state</span><span class="p">(</span><span class="n">addr</span><span class="o">=</span><span class="n">fn_start</span><span class="p">)</span>

<span class="c1"># Use this setting to skip calls instead of a hook</span>
<span class="n">initial_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">angr</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">CALLLESS</span><span class="p">)</span>

<span class="c1"># Add first state to state table (call it state 0)</span>
<span class="n">state_table</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'entry'</span><span class="p">:</span><span class="n">fn_start</span><span class="p">,</span> <span class="s1">'exit'</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">'next_states'</span><span class="p">:[]}</span>

<span class="c1"># Push state info for first state onto queue</span>
<span class="n">state_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'state_value'</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'sim_state'</span><span class="p">:</span><span class="n">initial_state</span><span class="p">,</span> <span class="s1">'entry'</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span><span class="kc">None</span> <span class="p">}</span>
<span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">state_info</span><span class="p">)</span>




<span class="c1"># Walk the queue</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
    <span class="n">state_info</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">state_value</span> <span class="o">=</span> <span class="n">state_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'state_value'</span><span class="p">)</span>
    <span class="n">state_entry</span> <span class="o">=</span> <span class="n">state_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'entry'</span><span class="p">)</span>
    <span class="n">old_sim_state</span> <span class="o">=</span> <span class="n">state_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'sim_state'</span><span class="p">)</span>
    
    <span class="c1"># Flag to control end of state and error end</span>
    <span class="n">state_end</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">error_end</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="n">sim_state</span> <span class="o">=</span> <span class="n">old_sim_state</span>
    <span class="c1"># # Setup blank state but carry regsiters</span>
    <span class="c1"># # Set clean sim_state</span>
    <span class="c1"># if not state_entry:</span>
    <span class="c1">#     sim_state = old_sim_state</span>
    <span class="c1"># else:</span>
    <span class="c1">#     sim_state = project.factory.blank_state(addr=old_sim_state.addr)</span>
    <span class="c1">#     sim_state.options.add(angr.options.CALLLESS)</span>
    <span class="c1">#     for reg_name in ['eax','ecx','edx','ebx','esp','ebp','esi','edi']:</span>
    <span class="c1">#         if reg_name != state_register:</span>
    <span class="c1">#             sim_state.memory.store(sim_state.regs.get(reg_name), old_sim_state.regs.get(reg_name))</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n\n\n</span><span class="s2">========================</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Walking obbs for state </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> - Entry: </span><span class="si">{</span><span class="n">state_entry</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="c1"># Walk until cf or branch or dead</span>
    <span class="n">loop_limit_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">loop_limit_count</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">loop_limit_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"obb walk: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">sim_state</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="c1">#print(f"STATE:{sim_state.regs.ebx} - FLAGS: {sim_state.regs.flags.variables}")</span>
        <span class="n">successors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">sim_state</span><span class="p">))</span>
        <span class="c1"># print(f"Successors:")</span>
        <span class="c1"># for s in successors:</span>
        <span class="c1">#     print(f"\t{hex(s.addr)} - STATE:{s.regs.get(state_register)}")</span>
        
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">successors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># dead - mark this bb as exit - continue next in queue</span>
            <span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'exit'</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_state</span><span class="o">.</span><span class="n">addr</span>
            <span class="n">state_end</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"State </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> exit at bb: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">sim_state</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">break</span>
            
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">successors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Check each one to see if it is a cf</span>
            <span class="c1"># Assumption: there should never be a branch from an obb into the dispatcher</span>
            <span class="k">if</span> <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span> <span class="ow">in</span> <span class="n">cf_bb_list</span> <span class="ow">and</span> <span class="n">successors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span> <span class="ow">in</span> <span class="n">cf_bb_list</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ERROR bb: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">sim_state</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2"> - obb branch both successors are cf"</span><span class="p">)</span>
                <span class="n">error_end</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span> <span class="ow">in</span> <span class="n">cf_bb_list</span> <span class="ow">and</span> <span class="n">successors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cf_bb_list</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ERROR bb: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">sim_state</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2"> - obb branch successor[0] are cf"</span><span class="p">)</span>
                <span class="n">error_end</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cf_bb_list</span> <span class="ow">and</span> <span class="n">successors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span> <span class="ow">in</span> <span class="n">cf_bb_list</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ERROR bb: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">sim_state</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2"> - obb branch successor[1] are cf"</span><span class="p">)</span>
                <span class="n">error_end</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>            
                <span class="c1"># branch - push second on queue and continue walking</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"Branch found!"</span><span class="p">)</span>
                <span class="c1"># if the condition is an == we can save it in the hope that it might be useful</span>
                <span class="c1"># when determining a state later -- this is a hack and we don't propogate conditions for </span>
                <span class="c1"># multiple obb branches -- there should be a better way to do this???</span>
                <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>
                <span class="n">successors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>
                <span class="n">constraints_0</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">constraints_1</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cc</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                        <span class="n">constraints_0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">successors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cc</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                        <span class="n">constraints_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
                    
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraints_0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraints_1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">constraints_0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">'__eq__'</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2"> is __eq__ pushing to queue"</span><span class="p">)</span>
                        <span class="n">sim_state</span> <span class="o">=</span> <span class="n">successors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">queue_state</span> <span class="o">=</span> <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">branch_condition</span> <span class="o">=</span> <span class="s1">'jz'</span>
                        
                    <span class="k">elif</span> <span class="n">constraints_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">'__eq__'</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">successors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2"> is __eq__ pushing to queue"</span><span class="p">)</span>
                        <span class="n">sim_state</span> <span class="o">=</span> <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">queue_state</span> <span class="o">=</span> <span class="n">successors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">branch_condition</span> <span class="o">=</span> <span class="s1">'jz'</span>
                        
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Constraint is not __eq__ not propogating condition"</span><span class="p">)</span>
                        <span class="n">sim_state</span> <span class="o">=</span> <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">queue_state</span> <span class="o">=</span> <span class="n">successors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">branch_condition</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"More than one constraint not propogating condition"</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">constraints_0</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">constraints_1</span><span class="p">)</span>
                    <span class="n">sim_state</span> <span class="o">=</span> <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">queue_state</span> <span class="o">=</span> <span class="n">successors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">branch_condition</span> <span class="o">=</span> <span class="kc">None</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Add bb: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">queue_state</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2"> to queue - continue with bb: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">sim_state</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">branch_state_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'state_value'</span><span class="p">:</span><span class="n">state_value</span><span class="p">,</span> <span class="s1">'sim_state'</span><span class="p">:</span><span class="n">queue_state</span><span class="p">,</span> <span class="s1">'entry'</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span><span class="n">branch_condition</span><span class="p">}</span>
                <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">branch_state_info</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check if the sccessor is outside of the function, this is some crazy angr thing with </span>
            <span class="c1"># following ret instructions instead of dying</span>
            <span class="k">if</span>  <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">fn_start</span> <span class="ow">or</span> <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span> <span class="o">&gt;</span> <span class="n">fn_end</span><span class="p">:</span>
                <span class="c1"># This is an end state - mark this bb as exit - continue next in queue</span>
                <span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'exit'</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_state</span><span class="o">.</span><span class="n">addr</span>
                <span class="n">state_end</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"State </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> return at bb: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">sim_state</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span> <span class="ow">in</span> <span class="n">cf_bb_list</span><span class="p">:</span>
                <span class="n">successor</span> <span class="o">=</span> <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># cf - get state value (next state)</span>
                <span class="c1"># - get flags and add to state table next states</span>
                <span class="n">next_state_values</span> <span class="o">=</span> <span class="n">successor</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">eval_upto</span><span class="p">(</span><span class="n">successor</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state_register</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">successor</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state_register</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="c1">######### DEBUG Constrain Next State #########</span>
                <span class="n">conditions_map</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># Looking for ast in the form IF (foo __eq__ bar) then STATE1 else STATE2 </span>
                <span class="n">state_reg_ast</span> <span class="o">=</span> <span class="n">successor</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state_register</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">state_reg_ast</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">state_reg_ast</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">'If'</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">state_reg_ast</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">symbolic</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">state_reg_ast</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">symbolic</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">state_reg_ast</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">'__eq__'</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">successor</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">state_reg_ast</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="si">}</span><span class="s2"> constrained by jz"</span><span class="p">)</span>
                            <span class="n">conditions_map</span><span class="p">[</span><span class="n">successor</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">state_reg_ast</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="s1">'jz'</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">successor</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">state_reg_ast</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="si">}</span><span class="s2"> unconstrained"</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"!!!! If condition </span><span class="si">{</span><span class="n">state_reg_ast</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">op</span><span class="si">}</span><span class="s2"> not handled"</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">"!!!! Top level condition to complex to handle"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If this is concrete test if it has a prior condition</span>
                    <span class="k">if</span> <span class="n">state_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'condition'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">" * Concrete * "</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" * Queue condtion </span><span class="si">{</span><span class="n">state_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'condition'</span><span class="p">)</span><span class="si">}</span><span class="s2"> * "</span><span class="p">)</span>
                        <span class="n">conditions_map</span><span class="p">[</span><span class="n">next_state_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">'jz'</span>

                <span class="c1">##########################################</span>
                <span class="c1"># Save info to state table</span>
                <span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'exit'</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_state</span><span class="o">.</span><span class="n">addr</span>
                <span class="k">for</span> <span class="n">next_state_value</span> <span class="ow">in</span> <span class="n">next_state_values</span><span class="p">:</span>
                    <span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'next_states'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">'state_value'</span><span class="p">:</span><span class="n">next_state_value</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span><span class="n">conditions_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">next_state_value</span><span class="p">,</span><span class="kc">None</span><span class="p">)})</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"State: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> -&gt; Next States </span><span class="si">{</span><span class="p">[</span><span class="nb">hex</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">next_state_values</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>   
                <span class="n">sim_state</span> <span class="o">=</span> <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sim_state</span> <span class="o">=</span> <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                
                

    <span class="c1"># Check state end flag</span>
    <span class="k">if</span> <span class="n">state_end</span><span class="p">:</span>
        <span class="k">continue</span> 
    <span class="k">if</span> <span class="n">error_end</span><span class="p">:</span>
        <span class="k">break</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">------------------</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">frozen_sim_state</span> <span class="o">=</span> <span class="n">sim_state</span>
    <span class="c1"># For each state match with obb and push onto queue</span>
    <span class="c1"># - if seen - continue next in queue</span>
    <span class="c1"># - if not seen walk to obb</span>
    <span class="k">for</span> <span class="n">next_state_value</span> <span class="ow">in</span> <span class="n">next_state_values</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Walking dispatcher for state </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">next_state_value</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">state_entry</span> <span class="ow">and</span> <span class="n">next_state_value</span> <span class="ow">in</span> <span class="n">state_table</span><span class="p">:</span>
            <span class="c1"># We have already processed this skip</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Already processed </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">next_state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> - skip!"</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Setup sim_state with concrete state_value</span>
        <span class="n">sim_state</span> <span class="o">=</span> <span class="n">frozen_sim_state</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sim_state</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">state_register</span><span class="p">,</span> <span class="n">next_state_value</span><span class="p">)</span>
        <span class="c1"># Walk until obb</span>
        <span class="n">loop_limit_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">loop_limit_count</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">loop_limit_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"cf walk: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">sim_state</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">successors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">sim_state</span><span class="p">))</span>
            <span class="c1"># print(f"\t Successors: {[hex(s.addr) for s in successors]}")</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">successors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># dead - error! no path for state through dispatcher</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ERROR no path through dispatcher for state </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">next_state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> - end bb: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">sim_state</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">error_end</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
                
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">successors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># branch - error! duplicate dispatcher paths</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ERROR duplicate paths through dispatcher for state </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">next_state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> - branch bb: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">sim_state</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">successors</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">error_end</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span> <span class="ow">in</span> <span class="n">obb_list</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Found matching obb: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                    <span class="c1"># obb - add state and entry to state_table</span>
                    <span class="n">state_table</span><span class="p">[</span><span class="n">next_state_value</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'entry'</span><span class="p">:</span><span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="s1">'exit'</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">'next_states'</span><span class="p">:[]}</span>
                    <span class="c1"># - push to queue - continue next in queue</span>
                    <span class="n">new_state_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'state_value'</span><span class="p">:</span><span class="n">next_state_value</span><span class="p">,</span> <span class="s1">'sim_state'</span><span class="p">:</span><span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="s1">'entry'</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">new_state_info</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sim_state</span> <span class="o">=</span> <span class="n">successors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    
        <span class="k">if</span> <span class="n">error_end</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">error_end</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>


========================

Walking obbs for state 0x0 - Entry: True
obb walk: 0x10008784
obb walk: 0x10008914
obb walk: 0x10008aa1
obb walk: 0x10008c31
obb walk: 0x10008dbb
obb walk: 0x10008f47
obb walk: 0x100090d0
obb walk: 0x1000925d
obb walk: 0x100093e6
&lt;BV32 0x9a37631&gt;
 * Concrete * 
State: 0x0 -&gt; Next States ['0x9a37631']

------------------

Walking dispatcher for state 0x9a37631
cf walk: 0x10009894
Found matching obb: 0x100099c1



========================

Walking obbs for state 0x9a37631 - Entry: True
obb walk: 0x100099c1
&lt;BV32 0x3fd6f7a&gt;
 * Concrete * 
State: 0x9a37631 -&gt; Next States ['0x3fd6f7a']

------------------

Walking dispatcher for state 0x3fd6f7a
cf walk: 0x10009549
cf walk: 0x10009555
cf walk: 0x1000955b
cf walk: 0x10009563
Found matching obb: 0x10009713



========================

Walking obbs for state 0x3fd6f7a - Entry: True
obb walk: 0x10009713
obb walk: 0x10009732
obb walk: 0x10009750
obb walk: 0x1000977e
obb walk: 0x100097af
obb walk: 0x100097c5
&lt;BV32 if fake_ret_value_278_32{UNINITIALIZED} == 0x0 then 0x8d4442d else 0xd886856&gt;
0x8d4442d constrained by jz
0xd886856 unconstrained
State: 0x3fd6f7a -&gt; Next States ['0xd886856', '0x8d4442d']

------------------

Walking dispatcher for state 0xd886856
cf walk: 0x100096f5
cf walk: 0x100099c6
Found matching obb: 0x100099d2
Walking dispatcher for state 0x8d4442d
cf walk: 0x100096f5
cf walk: 0x100099c6
cf walk: 0x10009549
cf walk: 0x10009555
cf walk: 0x1000955b
cf walk: 0x10009563
cf walk: 0x1000956f
Found matching obb: 0x100095a9



========================

Walking obbs for state 0xd886856 - Entry: True
obb walk: 0x100099d2
obb walk: 0x100098db
State 0xd886856 return at bb: 0x100098db



========================

Walking obbs for state 0x8d4442d - Entry: True
obb walk: 0x100095a9
obb walk: 0x100095c2
obb walk: 0x100095e3
obb walk: 0x10009615
obb walk: 0x100096a2
obb walk: 0x100096d6
obb walk: 0x100096f2
&lt;BV32 if fake_ret_value_284_32{UNINITIALIZED} == 0x0 then 0x3db060f else 0xe571e86&gt;
0x3db060f constrained by jz
0xe571e86 unconstrained
State: 0x8d4442d -&gt; Next States ['0x3db060f', '0xe571e86']

------------------

Walking dispatcher for state 0x3db060f
cf walk: 0x100099c6
cf walk: 0x10009549
cf walk: 0x10009555
cf walk: 0x1000955b
Found matching obb: 0x100097cd
Walking dispatcher for state 0xe571e86
cf walk: 0x100099c6
cf walk: 0x10009549
cf walk: 0x10009894
cf walk: 0x100098a0
cf walk: 0x100098a4
Found matching obb: 0x100098ac



========================

Walking obbs for state 0x3db060f - Entry: True
obb walk: 0x100097cd
obb walk: 0x100097e6
obb walk: 0x10009830
obb walk: 0x1000985b
&lt;BV32 if fake_ret_value_289_32{UNINITIALIZED} == 0x0 then 0x9005e79 else 0xe571e86&gt;
0x9005e79 constrained by jz
0xe571e86 unconstrained
State: 0x3db060f -&gt; Next States ['0x9005e79', '0xe571e86']

------------------

Walking dispatcher for state 0x9005e79
cf walk: 0x100096fa
cf walk: 0x100099c6
cf walk: 0x10009549
cf walk: 0x10009555
cf walk: 0x1000955b
cf walk: 0x10009563
cf walk: 0x1000956f
cf walk: 0x10009573
Found matching obb: 0x1000957b
Walking dispatcher for state 0xe571e86
Already processed 0xe571e86 - skip!



========================

Walking obbs for state 0xe571e86 - Entry: True
obb walk: 0x100098ac
obb walk: 0x100098d8
State 0xe571e86 return at bb: 0x100098d8



========================

Walking obbs for state 0x9005e79 - Entry: True
obb walk: 0x1000957b
obb walk: 0x10009595
&lt;BV32 if fake_ret_value_294_32{UNINITIALIZED} == 0x0 then 0xe571e86 else 0xabd1e15&gt;
0xe571e86 constrained by jz
0xabd1e15 unconstrained
State: 0x9005e79 -&gt; Next States ['0xe571e86', '0xabd1e15']

------------------

Walking dispatcher for state 0xe571e86
Already processed 0xe571e86 - skip!
Walking dispatcher for state 0xabd1e15
cf walk: 0x1000953a
cf walk: 0x10009894
cf walk: 0x100098a0
Found matching obb: 0x100098e8



========================

Walking obbs for state 0xabd1e15 - Entry: True
obb walk: 0x100098e8
obb walk: 0x10009904
obb walk: 0x1000998c
Branch found!
0x10009998 is __eq__ pushing to queue
Add bb: 0x10009998 to queue - continue with bb: 0x1000999f
obb walk: 0x1000999f
obb walk: 0x100099ba
&lt;BV32 0x94ee303&gt;
 * Concrete * 
State: 0xabd1e15 -&gt; Next States ['0x94ee303']

------------------

Walking dispatcher for state 0x94ee303
cf walk: 0x100096fa
cf walk: 0x100099c6
cf walk: 0x10009549
cf walk: 0x10009555
Found matching obb: 0x10009863



========================

Walking obbs for state 0xabd1e15 - Entry: False
obb walk: 0x10009998
obb walk: 0x100099a4
obb walk: 0x100099ba
&lt;BV32 0xe571e86&gt;
 * Queue condtion jz * 
State: 0xabd1e15 -&gt; Next States ['0xe571e86']

------------------

Walking dispatcher for state 0xe571e86
cf walk: 0x100096fa
cf walk: 0x100099c6
cf walk: 0x10009549
cf walk: 0x10009894
cf walk: 0x100098a0
cf walk: 0x100098a4
Found matching obb: 0x100098ac



========================

Walking obbs for state 0x94ee303 - Entry: True
obb walk: 0x10009863
obb walk: 0x1000988a
&lt;BV32 0xe571e86&gt;
 * Concrete * 
State: 0x94ee303 -&gt; Next States ['0xe571e86']

------------------

Walking dispatcher for state 0xe571e86
Already processed 0xe571e86 - skip!



========================

Walking obbs for state 0xe571e86 - Entry: True
obb walk: 0x100098ac
obb walk: 0x100098d8
State 0xe571e86 return at bb: 0x100098d8
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">state_table</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="se">\t</span><span class="s2">Entry:</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_table</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="s1">'entry'</span><span class="p">])</span><span class="si">}</span><span class="s2"> Exit:</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_table</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="s1">'exit'</span><span class="p">])</span><span class="si">}</span><span class="s2">  -&gt; "</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">next_state</span> <span class="ow">in</span> <span class="n">state_table</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="s1">'next_states'</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t\t\t\t\t\t\t</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">next_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'state_value'</span><span class="p">))</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">next_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'condition'</span><span class="p">)</span><span class="si">}</span><span class="s2"> "</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0x0 	Entry:0x10008784 Exit:0x100093e6  -&gt; 
							0x9a37631: None 
0x9a37631 	Entry:0x100099c1 Exit:0x100099c1  -&gt; 
							0x3fd6f7a: None 
0x3fd6f7a 	Entry:0x10009713 Exit:0x100097c5  -&gt; 
							0xd886856: None 
							0x8d4442d: jz 
0xd886856 	Entry:0x100099d2 Exit:0x100098db  -&gt; 
0x8d4442d 	Entry:0x100095a9 Exit:0x100096f2  -&gt; 
							0x3db060f: jz 
							0xe571e86: None 
0x3db060f 	Entry:0x100097cd Exit:0x1000985b  -&gt; 
							0x9005e79: jz 
							0xe571e86: None 
0xe571e86 	Entry:0x100098ac Exit:0x100098d8  -&gt; 
0x9005e79 	Entry:0x1000957b Exit:0x10009595  -&gt; 
							0xe571e86: jz 
							0xabd1e15: None 
0xabd1e15 	Entry:0x100098e8 Exit:0x100099ba  -&gt; 
							0x94ee303: None 
							0xe571e86: jz 
0x94ee303 	Entry:0x10009863 Exit:0x1000988a  -&gt; 
							0xe571e86: None 
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">bb_state_map</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'=============='</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">state_table</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{268470148: {'is_obb': True, 'end': 268470548}, 268470548: {'is_obb': True, 'end': 268470945}, 268470945: {'is_obb': True, 'end': 268471345}, 268471345: {'is_obb': True, 'end': 268471739}, 268471739: {'is_obb': True, 'end': 268472135}, 268472135: {'is_obb': True, 'end': 268472528}, 268472528: {'is_obb': True, 'end': 268472925}, 268472925: {'is_obb': True, 'end': 268473318}, 268473318: {'is_obb': True, 'end': 268473658}, 268473658: {'is_obb': False, 'end': 268473673}, 268473673: {'is_obb': False, 'end': 268473685}, 268473685: {'is_obb': False, 'end': 268473691}, 268473691: {'is_obb': False, 'end': 268473699}, 268473699: {'is_obb': False, 'end': 268473711}, 268473711: {'is_obb': False, 'end': 268473715}, 268473715: {'is_obb': False, 'end': 268473723}, 268473723: {'is_obb': True, 'end': 268473749}, 268473749: {'is_obb': True, 'end': 268473769}, 268473769: {'is_obb': True, 'end': 268473794}, 268473794: {'is_obb': True, 'end': 268473827}, 268473827: {'is_obb': True, 'end': 268473877}, 268473877: {'is_obb': True, 'end': 268474018}, 268474018: {'is_obb': True, 'end': 268474070}, 268474070: {'is_obb': True, 'end': 268474098}, 268474098: {'is_obb': True, 'end': 268474101}, 268474101: {'is_obb': False, 'end': 268474106}, 268474106: {'is_obb': False, 'end': 268474131}, 268474131: {'is_obb': True, 'end': 268474162}, 268474162: {'is_obb': True, 'end': 268474192}, 268474192: {'is_obb': True, 'end': 268474238}, 268474238: {'is_obb': True, 'end': 268474287}, 268474287: {'is_obb': True, 'end': 268474309}, 268474309: {'is_obb': True, 'end': 268474317}, 268474317: {'is_obb': True, 'end': 268474342}, 268474342: {'is_obb': True, 'end': 268474416}, 268474416: {'is_obb': True, 'end': 268474459}, 268474459: {'is_obb': True, 'end': 268474467}, 268474467: {'is_obb': True, 'end': 268474506}, 268474506: {'is_obb': True, 'end': 268474516}, 268474516: {'is_obb': False, 'end': 268474528}, 268474528: {'is_obb': False, 'end': 268474532}, 268474532: {'is_obb': False, 'end': 268474540}, 268474540: {'is_obb': True, 'end': 268474584}, 268474584: {'is_obb': True, 'end': 268474587}, 268474587: {'is_obb': True, 'end': 268474600}, 268474600: {'is_obb': True, 'end': 268474628}, 268474628: {'is_obb': True, 'end': 268474764}, 268474764: {'is_obb': True, 'end': 268474776}, 268474776: {'is_obb': True, 'end': 268474783}, 268474783: {'is_obb': True, 'end': 268474788}, 268474788: {'is_obb': True, 'end': 268474810}, 268474810: {'is_obb': True, 'end': 268474817}, 268474817: {'is_obb': True, 'end': 268474822}, 268474822: {'is_obb': False, 'end': 268474834}, 268474834: {'is_obb': True, 'end': 268474839}}
==============
{0: {'entry': 268470148, 'exit': 268473318, 'next_states': [{'state_value': 161707569, 'condition': None}]}, 161707569: {'entry': 268474817, 'exit': 268474817, 'next_states': [{'state_value': 66940794, 'condition': None}]}, 66940794: {'entry': 268474131, 'exit': 268474309, 'next_states': [{'state_value': 227043414, 'condition': None}, {'state_value': 148128813, 'condition': 'jz'}]}, 227043414: {'entry': 268474834, 'exit': 268474587, 'next_states': []}, 148128813: {'entry': 268473769, 'exit': 268474098, 'next_states': [{'state_value': 64685583, 'condition': 'jz'}, {'state_value': 240590470, 'condition': None}]}, 64685583: {'entry': 268474317, 'exit': 268474459, 'next_states': [{'state_value': 151019129, 'condition': 'jz'}, {'state_value': 240590470, 'condition': None}]}, 240590470: {'entry': 268474540, 'exit': 268474584, 'next_states': []}, 151019129: {'entry': 268473723, 'exit': 268473749, 'next_states': [{'state_value': 240590470, 'condition': 'jz'}, {'state_value': 180166165, 'condition': None}]}, 180166165: {'entry': 268474600, 'exit': 268474810, 'next_states': [{'state_value': 156164867, 'condition': None}, {'state_value': 240590470, 'condition': 'jz'}]}, 156164867: {'entry': 268474467, 'exit': 268474506, 'next_states': [{'state_value': 240590470, 'condition': None}]}}
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Patching-Ideas">
<a class="anchor" href="#Patching-Ideas" aria-hidden="true"><span class="octicon octicon-link"></span></a>Patching Ideas<a class="anchor-link" href="#Patching-Ideas"> </a>
</h2>
<p>Assumptions:</p>
<ol>
<li>There is enough code cave space (dispatcher code) that we can implement our jump table</li>
<li>Any short jumps from an obb remain in the state (no patch needed) or jump to a code cave </li>
</ol>
<p>** Note we may need to first process states that have an exit_bb that doesn't have a jmp as the final instruction so we can check for code caves at the next address</p>
<p>** We might want to proactivly patch out all cf blocks with nops to make the process easier to identify unused caves</p>
<p>For each state in the state map.</p>
<ul>
<li>if there is only one next-state <ul>
<li>lookup next-state entry_bb if it immediate follows state exit_bb do nothing</li>
<li>if it does not immediatly follow check if state exit_bb has a jmp as the final instruction<ul>
<li>if it does then simply alter the address to point to the next-state entry_bb</li>
<li>if it doesn't then find the next available code cave - if it doesn't immediatly follow the bb we are f-ed!!</li>
</ul>
</li>
</ul>
</li>
<li>if there is more than one next-state again check for a jmp as the final state instruction or a code cave following the bb<ul>
<li>if there is enough space to add a conditional jmp and an unconditiona jmp add them in directly </li>
<li>if not then add ajmp to a larger code cave</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">idaapi</span>
<span class="kn">import</span> <span class="nn">idautils</span>
<span class="kn">import</span> <span class="nn">idc</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="c1"># Function information</span>
<span class="n">BINARY_PATH</span> <span class="o">=</span> <span class="s1">'/tmp/emotet.bin'</span>
<span class="n">fn_start</span> <span class="o">=</span> <span class="mh">0x10008784</span>
<span class="n">fn_end</span> <span class="o">=</span> <span class="mh">0x100099D2</span> 

<span class="c1"># Map of all the bb and their type (obb / cf)</span>
<span class="c1"># bb_state_map[addr] = {'is_obb': True, 'end': 268470548}</span>

<span class="n">bb_state_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">268470148</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268470548</span><span class="p">},</span> <span class="mi">268470548</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268470945</span><span class="p">},</span> <span class="mi">268470945</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268471345</span><span class="p">},</span> <span class="mi">268471345</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268471739</span><span class="p">},</span> <span class="mi">268471739</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268472135</span><span class="p">},</span> <span class="mi">268472135</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268472528</span><span class="p">},</span> <span class="mi">268472528</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268472925</span><span class="p">},</span> <span class="mi">268472925</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473318</span><span class="p">},</span> <span class="mi">268473318</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473658</span><span class="p">},</span> <span class="mi">268473658</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473673</span><span class="p">},</span> <span class="mi">268473673</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473685</span><span class="p">},</span> <span class="mi">268473685</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473691</span><span class="p">},</span> <span class="mi">268473691</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473699</span><span class="p">},</span> <span class="mi">268473699</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473711</span><span class="p">},</span> <span class="mi">268473711</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473715</span><span class="p">},</span> <span class="mi">268473715</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473723</span><span class="p">},</span> <span class="mi">268473723</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473749</span><span class="p">},</span> <span class="mi">268473749</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473769</span><span class="p">},</span> <span class="mi">268473769</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473794</span><span class="p">},</span> <span class="mi">268473794</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473827</span><span class="p">},</span> <span class="mi">268473827</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268473877</span><span class="p">},</span> <span class="mi">268473877</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474018</span><span class="p">},</span> <span class="mi">268474018</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474070</span><span class="p">},</span> <span class="mi">268474070</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474098</span><span class="p">},</span> <span class="mi">268474098</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474101</span><span class="p">},</span> <span class="mi">268474101</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474106</span><span class="p">},</span> <span class="mi">268474106</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474131</span><span class="p">},</span> <span class="mi">268474131</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474162</span><span class="p">},</span> <span class="mi">268474162</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474192</span><span class="p">},</span> <span class="mi">268474192</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474238</span><span class="p">},</span> <span class="mi">268474238</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474287</span><span class="p">},</span> <span class="mi">268474287</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474309</span><span class="p">},</span> <span class="mi">268474309</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474317</span><span class="p">},</span> <span class="mi">268474317</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474342</span><span class="p">},</span> <span class="mi">268474342</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474416</span><span class="p">},</span> <span class="mi">268474416</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474459</span><span class="p">},</span> <span class="mi">268474459</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474467</span><span class="p">},</span> <span class="mi">268474467</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474506</span><span class="p">},</span> <span class="mi">268474506</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474516</span><span class="p">},</span> <span class="mi">268474516</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474528</span><span class="p">},</span> <span class="mi">268474528</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474532</span><span class="p">},</span> <span class="mi">268474532</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474540</span><span class="p">},</span> <span class="mi">268474540</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474584</span><span class="p">},</span> <span class="mi">268474584</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474587</span><span class="p">},</span> <span class="mi">268474587</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474600</span><span class="p">},</span> <span class="mi">268474600</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474628</span><span class="p">},</span> <span class="mi">268474628</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474764</span><span class="p">},</span> <span class="mi">268474764</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474776</span><span class="p">},</span> <span class="mi">268474776</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474783</span><span class="p">},</span> <span class="mi">268474783</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474788</span><span class="p">},</span> <span class="mi">268474788</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474810</span><span class="p">},</span> <span class="mi">268474810</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474817</span><span class="p">},</span> <span class="mi">268474817</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474822</span><span class="p">},</span> <span class="mi">268474822</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474834</span><span class="p">},</span> <span class="mi">268474834</span><span class="p">:</span> <span class="p">{</span><span class="s1">'is_obb'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">:</span> <span class="mi">268474839</span><span class="p">}}</span>


<span class="c1"># Map of the states their entry and exit and the next states</span>
<span class="c1"># state_table['state_value'] = {</span>
<span class="c1">#                             'entry': None</span>
<span class="c1">#                             'exit': None</span>
<span class="c1">#                             'next_states': [ {'state_value':None, 'condition': None }, ]</span>
<span class="n">state_table</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="s1">'entry'</span><span class="p">:</span> <span class="mi">268470148</span><span class="p">,</span> <span class="s1">'exit'</span><span class="p">:</span> <span class="mi">268473318</span><span class="p">,</span> <span class="s1">'next_states'</span><span class="p">:</span> <span class="p">[{</span><span class="s1">'state_value'</span><span class="p">:</span> <span class="mi">161707569</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span> <span class="kc">None</span><span class="p">}]},</span> <span class="mi">161707569</span><span class="p">:</span> <span class="p">{</span><span class="s1">'entry'</span><span class="p">:</span> <span class="mi">268474817</span><span class="p">,</span> <span class="s1">'exit'</span><span class="p">:</span> <span class="mi">268474817</span><span class="p">,</span> <span class="s1">'next_states'</span><span class="p">:</span> <span class="p">[{</span><span class="s1">'state_value'</span><span class="p">:</span> <span class="mi">66940794</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span> <span class="kc">None</span><span class="p">}]},</span> <span class="mi">66940794</span><span class="p">:</span> <span class="p">{</span><span class="s1">'entry'</span><span class="p">:</span> <span class="mi">268474131</span><span class="p">,</span> <span class="s1">'exit'</span><span class="p">:</span> <span class="mi">268474309</span><span class="p">,</span> <span class="s1">'next_states'</span><span class="p">:</span> <span class="p">[{</span><span class="s1">'state_value'</span><span class="p">:</span> <span class="mi">227043414</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span> <span class="p">{</span><span class="s1">'state_value'</span><span class="p">:</span> <span class="mi">148128813</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span> <span class="s1">'jz'</span><span class="p">}]},</span> <span class="mi">227043414</span><span class="p">:</span> <span class="p">{</span><span class="s1">'entry'</span><span class="p">:</span> <span class="mi">268474834</span><span class="p">,</span> <span class="s1">'exit'</span><span class="p">:</span> <span class="mi">268474587</span><span class="p">,</span> <span class="s1">'next_states'</span><span class="p">:</span> <span class="p">[]},</span> <span class="mi">148128813</span><span class="p">:</span> <span class="p">{</span><span class="s1">'entry'</span><span class="p">:</span> <span class="mi">268473769</span><span class="p">,</span> <span class="s1">'exit'</span><span class="p">:</span> <span class="mi">268474098</span><span class="p">,</span> <span class="s1">'next_states'</span><span class="p">:</span> <span class="p">[{</span><span class="s1">'state_value'</span><span class="p">:</span> <span class="mi">64685583</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span> <span class="s1">'jz'</span><span class="p">},</span> <span class="p">{</span><span class="s1">'state_value'</span><span class="p">:</span> <span class="mi">240590470</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span> <span class="kc">None</span><span class="p">}]},</span> <span class="mi">64685583</span><span class="p">:</span> <span class="p">{</span><span class="s1">'entry'</span><span class="p">:</span> <span class="mi">268474317</span><span class="p">,</span> <span class="s1">'exit'</span><span class="p">:</span> <span class="mi">268474459</span><span class="p">,</span> <span class="s1">'next_states'</span><span class="p">:</span> <span class="p">[{</span><span class="s1">'state_value'</span><span class="p">:</span> <span class="mi">151019129</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span> <span class="s1">'jz'</span><span class="p">},</span> <span class="p">{</span><span class="s1">'state_value'</span><span class="p">:</span> <span class="mi">240590470</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span> <span class="kc">None</span><span class="p">}]},</span> <span class="mi">240590470</span><span class="p">:</span> <span class="p">{</span><span class="s1">'entry'</span><span class="p">:</span> <span class="mi">268474540</span><span class="p">,</span> <span class="s1">'exit'</span><span class="p">:</span> <span class="mi">268474584</span><span class="p">,</span> <span class="s1">'next_states'</span><span class="p">:</span> <span class="p">[]},</span> <span class="mi">151019129</span><span class="p">:</span> <span class="p">{</span><span class="s1">'entry'</span><span class="p">:</span> <span class="mi">268473723</span><span class="p">,</span> <span class="s1">'exit'</span><span class="p">:</span> <span class="mi">268473749</span><span class="p">,</span> <span class="s1">'next_states'</span><span class="p">:</span> <span class="p">[{</span><span class="s1">'state_value'</span><span class="p">:</span> <span class="mi">240590470</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span> <span class="s1">'jz'</span><span class="p">},</span> <span class="p">{</span><span class="s1">'state_value'</span><span class="p">:</span> <span class="mi">180166165</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span> <span class="kc">None</span><span class="p">}]},</span> <span class="mi">180166165</span><span class="p">:</span> <span class="p">{</span><span class="s1">'entry'</span><span class="p">:</span> <span class="mi">268474600</span><span class="p">,</span> <span class="s1">'exit'</span><span class="p">:</span> <span class="mi">268474810</span><span class="p">,</span> <span class="s1">'next_states'</span><span class="p">:</span> <span class="p">[{</span><span class="s1">'state_value'</span><span class="p">:</span> <span class="mi">156164867</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span> <span class="p">{</span><span class="s1">'state_value'</span><span class="p">:</span> <span class="mi">240590470</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span> <span class="s1">'jz'</span><span class="p">}]},</span> <span class="mi">156164867</span><span class="p">:</span> <span class="p">{</span><span class="s1">'entry'</span><span class="p">:</span> <span class="mi">268474467</span><span class="p">,</span> <span class="s1">'exit'</span><span class="p">:</span> <span class="mi">268474506</span><span class="p">,</span> <span class="s1">'next_states'</span><span class="p">:</span> <span class="p">[{</span><span class="s1">'state_value'</span><span class="p">:</span> <span class="mi">240590470</span><span class="p">,</span> <span class="s1">'condition'</span><span class="p">:</span> <span class="kc">None</span><span class="p">}]}}</span>


<span class="c1"># Track states that have been patched</span>
<span class="n">patched_states</span> <span class="o">=</span> <span class="p">[]</span>


<span class="c1"># Nop all of the cf blocks - create our code caves</span>
<span class="k">for</span> <span class="n">bb_addr</span> <span class="ow">in</span> <span class="n">bb_state_map</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bb_state_map</span><span class="p">[</span><span class="n">bb_addr</span><span class="p">][</span><span class="s1">'is_obb'</span><span class="p">]:</span>
        <span class="c1"># Patch it</span>
        <span class="n">idaapi</span><span class="o">.</span><span class="n">patch_bytes</span><span class="p">(</span><span class="n">bb_addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x90</span><span class="s1">'</span><span class="o">*</span><span class="p">(</span><span class="n">bb_state_map</span><span class="p">[</span><span class="n">bb_addr</span><span class="p">][</span><span class="s1">'end'</span><span class="p">]</span> <span class="o">-</span> <span class="n">bb_addr</span><span class="p">))</span>


<span class="c1"># TODO: when we patch we should check to make sure there are enough nops to actually patch</span>


<span class="c1"># Find all state exit bb that don't end with a patchable (jmp) instruction and add control flow in the following code cave</span>
<span class="c1"># - if there is no following code cave !!! ERROR we can't proceed this is not patchable in-place</span>
<span class="k">for</span> <span class="n">state_value</span> <span class="ow">in</span> <span class="n">state_table</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'next_states'</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># This is an end state skip it</span>
        <span class="k">continue</span>
    <span class="c1">#print(f"STATE: {hex(state_value)}")</span>
    <span class="n">exit_bb_start</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'exit'</span><span class="p">]</span>
    <span class="n">entry_bb_start</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'entry'</span><span class="p">]</span>
    <span class="c1">#print(f"entry_bb_start: {hex(entry_bb_start)}")</span>
    <span class="c1">#print(f"exit_bb_start: {hex(exit_bb_start)}")</span>
    <span class="c1"># Check the final instruction of the exit bb</span>
    <span class="n">exit_bb_end</span> <span class="o">=</span> <span class="n">bb_state_map</span><span class="p">[</span><span class="n">exit_bb_start</span><span class="p">][</span><span class="s1">'end'</span><span class="p">]</span>
    <span class="n">exit_bb_end_head</span> <span class="o">=</span> <span class="n">prev_head</span><span class="p">(</span><span class="n">exit_bb_end</span><span class="p">)</span>
    <span class="n">exit_bb_final_mnemonic</span> <span class="o">=</span> <span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">exit_bb_end_head</span><span class="p">)</span>
    <span class="c1">## Assume you can't have conditional jumps from the state into the dispatcher</span>
    <span class="k">if</span> <span class="n">exit_bb_final_mnemonic</span> <span class="o">!=</span> <span class="s1">'jmp'</span> <span class="ow">and</span> <span class="s1">'ret'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exit_bb_final_mnemonic</span>  <span class="p">:</span>
        <span class="c1"># Check if there is only one next state and it is contiguous</span>
        <span class="n">next_states</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'next_states'</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># This is an end block who cares</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"STATE: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> Entry: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">entry_bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> - No need to patch this it's an end block"</span><span class="p">)</span>
            <span class="n">patched_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Check if the state is contiguous</span>
            <span class="n">next_state_value</span> <span class="o">=</span> <span class="n">next_states</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'state_value'</span><span class="p">]</span>
            <span class="n">next_state_entry</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">next_state_value</span><span class="p">][</span><span class="s1">'entry'</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">next_state_entry</span> <span class="o">==</span> <span class="n">exit_bb_end</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"STATE: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> Entry: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">entry_bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> - No need to patch this it's contiguous"</span><span class="p">)</span>
                <span class="n">patched_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="c1"># If we are here we need a code cave following our bb</span>
        <span class="c1"># Check is there space for a code cave</span>
        <span class="k">if</span> <span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">exit_bb_end</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'nop'</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"This bb needs to eat the code cave!!! - </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">exit_bb_end_head</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">patched_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span>
            <span class="c1"># Directly add the jmps</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Directly patch one jmp</span>
                <span class="n">patch_address</span> <span class="o">=</span> <span class="n">exit_bb_end</span>
                <span class="n">next_state_value</span> <span class="o">=</span> <span class="n">next_states</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'state_value'</span><span class="p">]</span>
                <span class="n">next_state_entry</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">next_state_value</span><span class="p">][</span><span class="s1">'entry'</span><span class="p">]</span>
                <span class="n">jmp_rel</span> <span class="o">=</span>  <span class="n">next_state_entry</span> <span class="o">-</span> <span class="p">(</span><span class="n">patch_address</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">patch_jmp</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\xe9</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel</span><span class="p">)</span>
                <span class="n">idaapi</span><span class="o">.</span><span class="n">patch_bytes</span><span class="p">(</span><span class="n">patch_address</span><span class="p">,</span> <span class="n">patch_jmp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Find the condition and patch first then patch other</span>
                <span class="n">jmp_condition</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">conditional_address</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">unconditional_address</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">for</span> <span class="n">next_state</span> <span class="ow">in</span> <span class="n">next_states</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">next_state</span><span class="p">[</span><span class="s1">'condition'</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">unconditional_address</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">next_state</span><span class="p">[</span><span class="s1">'state_value'</span><span class="p">]][</span><span class="s1">'entry'</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">conditional_address</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">next_state</span><span class="p">[</span><span class="s1">'state_value'</span><span class="p">]][</span><span class="s1">'entry'</span><span class="p">]</span>
                        <span class="n">jmp_condition</span> <span class="o">=</span> <span class="n">next_state</span><span class="p">[</span><span class="s1">'condition'</span><span class="p">]</span>
                <span class="c1"># Set up the patch jumps</span>
                <span class="c1"># TODO: For now we will hard code the codition as a jz</span>
                <span class="n">patch_jmp_cond_start</span> <span class="o">=</span> <span class="n">exit_bb_end</span>
                <span class="n">jmp_rel_statisfied</span> <span class="o">=</span>  <span class="n">conditional_address</span> <span class="o">-</span> <span class="p">(</span><span class="n">patch_jmp_cond_start</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
                <span class="n">patch_jmp_start</span> <span class="o">=</span> <span class="n">patch_jmp_cond_start</span> <span class="o">+</span> <span class="mi">6</span>
                <span class="n">jmp_rel</span> <span class="o">=</span>  <span class="n">unconditional_address</span> <span class="o">-</span> <span class="p">(</span><span class="n">patch_jmp_start</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">patch_jmp_condition</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x0f\x84</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel_statisfied</span><span class="p">)</span>
                <span class="n">patch_jmp</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\xe9</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel</span><span class="p">)</span>
                <span class="n">patch_bytes</span> <span class="o">=</span> <span class="n">patch_jmp_condition</span> <span class="o">+</span> <span class="n">patch_jmp</span>
                <span class="n">idaapi</span><span class="o">.</span><span class="n">patch_bytes</span><span class="p">(</span><span class="n">exit_bb_end</span><span class="p">,</span> <span class="n">patch_bytes</span><span class="p">)</span>     
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># NO? Abort! This won't work</span>
            <span class="c1"># If this is the case then it doesn't need to be patched</span>
            <span class="c1"># Else check for code cave</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ABORT!! STATE: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> Entry: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">entry_bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">abort_flag</span> <span class="o">=</span> <span class="kc">False</span>            
<span class="c1"># Find all state exit bb that end with a short jmp - these need to be patched first they depend on the code cave proximity</span>
<span class="k">for</span> <span class="n">state_value</span> <span class="ow">in</span> <span class="n">state_table</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'next_states'</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># This is an end state skip it</span>
        <span class="k">continue</span>
    <span class="k">if</span> <span class="n">abort_flag</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">if</span> <span class="n">state_value</span> <span class="ow">in</span> <span class="n">patched_states</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">exit_bb_start</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'exit'</span><span class="p">]</span>
    <span class="n">entry_bb_start</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'entry'</span><span class="p">]</span>
    <span class="c1"># Check the final instruction of the exit bb</span>
    <span class="n">exit_bb_end</span> <span class="o">=</span> <span class="n">bb_state_map</span><span class="p">[</span><span class="n">exit_bb_start</span><span class="p">][</span><span class="s1">'end'</span><span class="p">]</span>
    <span class="n">exit_bb_end_head</span> <span class="o">=</span> <span class="n">prev_head</span><span class="p">(</span><span class="n">exit_bb_end</span><span class="p">)</span>
    <span class="n">exit_bb_final_mnemonic</span> <span class="o">=</span> <span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">exit_bb_end_head</span><span class="p">)</span>
    <span class="c1">## Assume you can't have conditional jumps from the state into the dispatcher</span>
    <span class="k">if</span> <span class="n">exit_bb_final_mnemonic</span> <span class="o">==</span> <span class="s1">'jmp'</span><span class="p">:</span>
        <span class="c1"># Check the number of bytes</span>
        <span class="n">next_instruction_ea</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">exit_bb_end_head</span><span class="p">)</span>
        <span class="n">instruction_count</span> <span class="o">=</span> <span class="n">next_instruction_ea</span> <span class="o">-</span> <span class="n">exit_bb_end_head</span>
        <span class="k">if</span> <span class="n">instruction_count</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># This is a short jump</span>
            <span class="c1"># Follow the jump this will be our patch area</span>
            <span class="n">short_jmp_address</span> <span class="o">=</span> <span class="n">get_operand_value</span><span class="p">(</span><span class="n">exit_bb_end_head</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Check if this a single jump to another state so we don't need to patch</span>
            <span class="n">next_states</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'next_states'</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_states</span><span class="p">)</span> <span class="o">==</span>  <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Check if the state is at the jump address</span>
                <span class="n">next_state_address</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">next_states</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'state_value'</span><span class="p">]][</span><span class="s1">'entry'</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">next_state_address</span> <span class="o">==</span> <span class="n">short_jmp_address</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"STATE: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> Entry: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">entry_bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> - Short jump to next state no patch"</span><span class="p">)</span>
                    <span class="n">patched_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="c1"># If we got here we need to add a patch</span>
            <span class="c1"># Check if this address is available as a code cave if not adjust it</span>
            <span class="n">patched_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span>
            <span class="n">ptr_short_jmp_address</span> <span class="o">=</span> <span class="n">short_jmp_address</span>
            <span class="k">while</span> <span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ptr_short_jmp_address</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">'nop'</span><span class="p">:</span>
                <span class="c1"># We need to adjust the jmp to the nearest code cave</span>
                <span class="c1"># Loop until we hit the next section of nops</span>
                <span class="n">ptr_short_jmp_address</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">ptr_short_jmp_address</span><span class="p">)</span>
                <span class="c1"># Error if we run out of space in the function</span>
                <span class="k">if</span> <span class="n">ptr_short_jmp_address</span> <span class="o">&gt;=</span> <span class="n">fn_end</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ABORT - STATE: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> Entry: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">entry_bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> - short jmp nop finder hit end of function with no suitable code cave found!"</span><span class="p">)</span>
                    <span class="n">abort_flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="c1"># Check to see if we need to update the jmp diplacement</span>
            <span class="k">if</span> <span class="n">ptr_short_jmp_address</span> <span class="o">!=</span> <span class="n">short_jmp_address</span><span class="p">:</span>
                <span class="n">original_displacement</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'b'</span><span class="p">,</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">exit_bb_end_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">original_displacement</span> <span class="o">+=</span> <span class="n">ptr_short_jmp_address</span> <span class="o">-</span> <span class="n">short_jmp_address</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">idaapi</span><span class="o">.</span><span class="n">patch_bytes</span><span class="p">(</span><span class="n">exit_bb_end_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'b'</span><span class="p">,</span><span class="n">original_displacement</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"STATE: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> Entry: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">entry_bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> - Short jump updated jump to code cave: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">ptr_short_jmp_address</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ABORT - STATE: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> Entry: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">entry_bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> - short jmp code cave adjustment is too far!"</span><span class="p">)</span>
                    <span class="n">abort_flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

            <span class="c1"># If we get here we can assume we are ready to patch at the ptr_short_jmp_address</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Directly patch one jmp</span>
                <span class="n">patch_address</span> <span class="o">=</span> <span class="n">ptr_short_jmp_address</span>
                <span class="n">next_state_value</span> <span class="o">=</span> <span class="n">next_states</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'state_value'</span><span class="p">]</span>
                <span class="n">next_state_entry</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">next_state_value</span><span class="p">][</span><span class="s1">'entry'</span><span class="p">]</span>
                <span class="n">jmp_rel</span> <span class="o">=</span>  <span class="n">next_state_entry</span> <span class="o">-</span> <span class="p">(</span><span class="n">patch_address</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">patch_jmp</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\xe9</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel</span><span class="p">)</span>
                <span class="n">idaapi</span><span class="o">.</span><span class="n">patch_bytes</span><span class="p">(</span><span class="n">patch_address</span><span class="p">,</span> <span class="n">patch_jmp</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"STATE: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> Entry: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">entry_bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> - Short jump patched with one state at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">patch_address</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Find the condition and patch first then patch other</span>
                <span class="n">jmp_condition</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">conditional_address</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">unconditional_address</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">for</span> <span class="n">next_state</span> <span class="ow">in</span> <span class="n">next_states</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">next_state</span><span class="p">[</span><span class="s1">'condition'</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">unconditional_address</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">next_state</span><span class="p">[</span><span class="s1">'state_value'</span><span class="p">]][</span><span class="s1">'entry'</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">conditional_address</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">next_state</span><span class="p">[</span><span class="s1">'state_value'</span><span class="p">]][</span><span class="s1">'entry'</span><span class="p">]</span>
                        <span class="n">jmp_condition</span> <span class="o">=</span> <span class="n">next_state</span><span class="p">[</span><span class="s1">'condition'</span><span class="p">]</span>
                <span class="c1"># Set up the patch jumps</span>
                <span class="c1"># TODO: For now we will hard code the codition as a jz</span>
                <span class="n">patch_jmp_cond_start</span> <span class="o">=</span> <span class="n">ptr_short_jmp_address</span>
                <span class="n">jmp_rel_statisfied</span> <span class="o">=</span>  <span class="n">conditional_address</span> <span class="o">-</span> <span class="p">(</span><span class="n">patch_jmp_cond_start</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
                <span class="n">patch_jmp_start</span> <span class="o">=</span> <span class="n">patch_jmp_cond_start</span> <span class="o">+</span> <span class="mi">6</span>
                <span class="n">jmp_rel</span> <span class="o">=</span>  <span class="n">unconditional_address</span> <span class="o">-</span> <span class="p">(</span><span class="n">patch_jmp_start</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">patch_jmp_condition</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x0f\x84</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel_statisfied</span><span class="p">)</span>
                <span class="n">patch_jmp</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\xe9</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel</span><span class="p">)</span>
                <span class="n">patch_bytes</span> <span class="o">=</span> <span class="n">patch_jmp_condition</span> <span class="o">+</span> <span class="n">patch_jmp</span>
                <span class="n">idaapi</span><span class="o">.</span><span class="n">patch_bytes</span><span class="p">(</span><span class="n">ptr_short_jmp_address</span><span class="p">,</span> <span class="n">patch_bytes</span><span class="p">)</span> 
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"STATE: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> Entry: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">entry_bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> - Short jump patched with one two states at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">ptr_short_jmp_address</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>



<span class="c1"># Patch all remaining state exits</span>
<span class="k">for</span> <span class="n">state_value</span> <span class="ow">in</span> <span class="n">state_table</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'next_states'</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># This is an end state skip it</span>
        <span class="k">continue</span>
    <span class="k">if</span> <span class="n">abort_flag</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">if</span> <span class="n">state_value</span> <span class="ow">in</span> <span class="n">patched_states</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">exit_bb_start</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'exit'</span><span class="p">]</span>
    <span class="n">entry_bb_start</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'entry'</span><span class="p">]</span>
    <span class="c1"># Get address of final instruction</span>
    <span class="n">exit_bb_end</span> <span class="o">=</span> <span class="n">bb_state_map</span><span class="p">[</span><span class="n">exit_bb_start</span><span class="p">][</span><span class="s1">'end'</span><span class="p">]</span>
    <span class="n">exit_bb_end_head</span> <span class="o">=</span> <span class="n">prev_head</span><span class="p">(</span><span class="n">exit_bb_end</span><span class="p">)</span>
    <span class="n">next_states</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">state_value</span><span class="p">][</span><span class="s1">'next_states'</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Directly patch one jmp</span>
        <span class="n">patch_address</span> <span class="o">=</span> <span class="n">exit_bb_end_head</span>
        <span class="n">next_state_value</span> <span class="o">=</span> <span class="n">next_states</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'state_value'</span><span class="p">]</span>
        <span class="n">next_state_entry</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">next_state_value</span><span class="p">][</span><span class="s1">'entry'</span><span class="p">]</span>
        <span class="n">jmp_rel</span> <span class="o">=</span>  <span class="n">next_state_entry</span> <span class="o">-</span> <span class="p">(</span><span class="n">patch_address</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">patch_jmp</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\xe9</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel</span><span class="p">)</span>
        <span class="n">idaapi</span><span class="o">.</span><span class="n">patch_bytes</span><span class="p">(</span><span class="n">patch_address</span><span class="p">,</span> <span class="n">patch_jmp</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"STATE: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> Entry: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">entry_bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> - patched with one state at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">patch_address</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Find the condition and patch first then patch other</span>
        <span class="n">jmp_condition</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">conditional_address</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">unconditional_address</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">next_state</span> <span class="ow">in</span> <span class="n">next_states</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">next_state</span><span class="p">[</span><span class="s1">'condition'</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">unconditional_address</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">next_state</span><span class="p">[</span><span class="s1">'state_value'</span><span class="p">]][</span><span class="s1">'entry'</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">conditional_address</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">next_state</span><span class="p">[</span><span class="s1">'state_value'</span><span class="p">]][</span><span class="s1">'entry'</span><span class="p">]</span>
                <span class="n">jmp_condition</span> <span class="o">=</span> <span class="n">next_state</span><span class="p">[</span><span class="s1">'condition'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">unconditional_address</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">conditional_address</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"conditions error!! </span><span class="si">{</span><span class="n">next_states</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">abort_flag</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Set up the patch jumps</span>
        <span class="c1"># TODO: For now we will hard code the codition as a jz</span>
        <span class="c1"># Find a code cave to insert our jumps - search from the fn start to end</span>
        <span class="n">code_cave_ptr</span> <span class="o">=</span> <span class="n">fn_start</span>
        <span class="k">while</span> <span class="n">code_cave_ptr</span> <span class="o">&lt;=</span> <span class="n">fn_end</span><span class="p">:</span>
            <span class="c1"># Find a code cave with enough nops</span>
            <span class="k">if</span> <span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">code_cave_ptr</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'nop'</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">get_bytes</span><span class="p">(</span><span class="n">code_cave_ptr</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x90</span><span class="s1">'</span><span class="o">*</span><span class="mi">11</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="c1"># Find next head</span>
            <span class="n">code_cave_ptr</span> <span class="o">=</span> <span class="n">next_head</span><span class="p">(</span><span class="n">code_cave_ptr</span><span class="p">)</span>

        <span class="c1"># Check to make sure we didn't run out of room in the function</span>
        <span class="k">if</span> <span class="n">code_cave_ptr</span> <span class="o">&gt;=</span> <span class="n">fn_end</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ABORT - STATE: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> Entry: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">entry_bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> - no code cave found!"</span><span class="p">)</span>
            <span class="n">abort_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>

        <span class="c1"># Patch the jump to point to our new code cave</span>
        <span class="n">patch_address</span> <span class="o">=</span> <span class="n">exit_bb_end_head</span>
        <span class="n">new_jmp_address</span> <span class="o">=</span> <span class="n">code_cave_ptr</span>
        <span class="n">jmp_rel</span> <span class="o">=</span>  <span class="n">new_jmp_address</span> <span class="o">-</span> <span class="p">(</span><span class="n">patch_address</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">patch_jmp</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\xe9</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel</span><span class="p">)</span>
        <span class="n">idaapi</span><span class="o">.</span><span class="n">patch_bytes</span><span class="p">(</span><span class="n">patch_address</span><span class="p">,</span> <span class="n">patch_jmp</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"STATE: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> Entry: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">entry_bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> - moved our jump to point to a code cave: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">code_cave_ptr</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


        <span class="n">patch_jmp_cond_start</span> <span class="o">=</span> <span class="n">code_cave_ptr</span>
        <span class="n">jmp_rel_statisfied</span> <span class="o">=</span>  <span class="n">conditional_address</span> <span class="o">-</span> <span class="p">(</span><span class="n">patch_jmp_cond_start</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">patch_jmp_start</span> <span class="o">=</span> <span class="n">patch_jmp_cond_start</span> <span class="o">+</span> <span class="mi">6</span>
        <span class="n">jmp_rel</span> <span class="o">=</span>  <span class="n">unconditional_address</span> <span class="o">-</span> <span class="p">(</span><span class="n">patch_jmp_start</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">patch_jmp_condition</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x0f\x84</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel_statisfied</span><span class="p">)</span>
        <span class="n">patch_jmp</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\xe9</span><span class="s1">'</span> <span class="o">+</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;i'</span><span class="p">,</span><span class="n">jmp_rel</span><span class="p">)</span>
        <span class="n">patch_bytes</span> <span class="o">=</span> <span class="n">patch_jmp_condition</span> <span class="o">+</span> <span class="n">patch_jmp</span>
        <span class="n">idaapi</span><span class="o">.</span><span class="n">patch_bytes</span><span class="p">(</span><span class="n">code_cave_ptr</span><span class="p">,</span> <span class="n">patch_bytes</span><span class="p">)</span> 
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"STATE: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">state_value</span><span class="p">)</span><span class="si">}</span><span class="s2"> Entry: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">entry_bb_start</span><span class="p">)</span><span class="si">}</span><span class="s2"> - patched multiple states at code cave: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">code_cave_ptr</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Failures-and-Next-Steps">
<a class="anchor" href="#Failures-and-Next-Steps" aria-hidden="true"><span class="octicon octicon-link"></span></a>Failures and Next Steps<a class="anchor-link" href="#Failures-and-Next-Steps"> </a>
</h2>
<p>We made a bad assumption when we derived conditional next states. Our assumption was that we could rely on the FLAGS that were used to set the state to still be intact by the time the state exited so all we would need to do is add a conditional jmp based on the FLAGS. This turned out to not be the case for all states so our conditional jumps were incorrectly influenced by other code in the state.</p>
<h3 id="Hack-#1">
<a class="anchor" href="#Hack-#1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hack #1<a class="anchor-link" href="#Hack-#1"> </a>
</h3>
<p>One hack that we tried was to iterate through all insructions in the state and whenever the STATE register was invovled we replaced the instruction with an instruction to save the FLAGS in the STATE register. The assumption was that the last move into the STATE register would be the conditional one since it would overwrite the unconditional STATE.</p>

<pre><code>9c -&gt; push flags
5b -&gt; pop ebx (store FLAGS in state register)</code></pre>
<p>Then before we added our conditional jump we moved the flags back into the FLAGS register. The idea was that now our conditional jump would be based on the same FLAGS that were used to set the STATE earlier in the state basedic blocks.</p>

<pre><code>53 -&gt; push ebx (state register withe stored FLAGS)
9d -&gt; pop flags</code></pre>
<p>This does work except <strong>IDA is unable to simplify this logic</strong> so the end result is some random looking conditions that the analyst must investigate manually to recover the control flow. Not good!</p>
<p><img src="https://i.imgur.com/JnsSwnP.png" alt=""></p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/angr/symbolic%20execution/deobfuscation/research/emotet/2022/04/20/emotet_deobfuscation_generic.html" hidden></a>
</article>
