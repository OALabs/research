<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Malware Downloader Triage Notes</h1><p class="page-description">Researching malware downloaders, detection and triage</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-06-12T00:00:00-05:00" itemprop="datePublished">
        Jun 12, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      3 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#downloader">downloader</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#research">research</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#detection_engineering">detection_engineering</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#yara">yara</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#triage">triage</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2022-06-12-downloader-triage.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Samples">Samples </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Triage-of-9211...">Triage of 9211... </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Possible-IOCs">Possible IOCs </a></li>
<li class="toc-entry toc-h3"><a href="#Yara-rule">Yara rule </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Yara-Rule-Revisions">Yara Rule Revisions </a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Triage-of-1a10e...">Triage of 1a10e... </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Possible-IOCs">Possible IOCs </a></li>
<li class="toc-entry toc-h3"><a href="#Yara-Rule">Yara Rule </a></li>
<li class="toc-entry toc-h3"><a href="#Yara-Results">Yara Results </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-06-12-downloader-triage.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p>We are going to take a look at two different downloaders, which are so simple they don't have great static detection or information extraction in UnpacMe yet! Our goal is to generate some Yara rules, or maybe some code to identify and extract the relevant info (download URL) in a generic static way.</p>
<h3 id="Samples">
<a class="anchor" href="#Samples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Samples<a class="anchor-link" href="#Samples"> </a>
</h3>
<ul>
<li><a href="https://malshare.com/sample.php?action=detail&amp;hash=1a10e2940151982f2ab4f1e62be6e4f53074a2ffb90c7977e16d6a183db98695">1a10e2940151982f2ab4f1e62be6e4f53074a2ffb90c7977e16d6a183db98695</a></li>
<li><a href="https://malshare.com/sample.php?action=detail&amp;hash=9211ebf25c3cd3641451c95c50c1d3b7b2a4c53c36fa36564f3c1a177a0cda3d">9211ebf25c3cd3641451c95c50c1d3b7b2a4c53c36fa36564f3c1a177a0cda3d</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Triage-of-9211...">
<a class="anchor" href="#Triage-of-9211..." aria-hidden="true"><span class="octicon octicon-link"></span></a>Triage of <code>9211...</code><a class="anchor-link" href="#Triage-of-9211..."> </a>
</h2>
<p>The samples has a plaintext URL and the download functionality is not obfuscated/packed and can be identifed using <a href="https://github.com/mandiant/capa">CAPA</a> as seen in <a href="https://www.unpac.me/results/9b085f2f-9a1e-43ea-b7ae-814e85e90ddc/#/">UnpacMe</a>.</p>
<p>The hardcoded URL is: <code>http://apuservis.pe/ocultar/fw%d.exe</code>.</p>
<p>There are 2 loops used to generate ULRs from 1 - 7 calling the URLs:</p>
<ul>
<li><code>http://apuservis.pe/ocultar/fw1.exe</code></li>
<li><code>http://apuservis.pe/ocultar/fw2.exe</code></li>
<li><code>http://apuservis.pe/ocultar/fw3.exe</code></li>
<li><code>http://apuservis.pe/ocultar/fw4.exe</code></li>
<li><code>http://apuservis.pe/ocultar/fw5.exe</code></li>
<li><code>http://apuservis.pe/ocultar/fw6.exe</code></li>
</ul>
<p>The file is writtent to <code>%APPDATA%</code> with a random file name using a random number <code>"%08x.exe</code>.</p>
<p>To execute the file the API <code>ShellExecuteW</code> is resolved dynamically using a CRC32 hash then it is called with the <code>open</code> command.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">HASHDB_HUNT_URL</span> <span class="o">=</span> <span class="s1">'https://hashdb.openanalysis.net/hunt'</span>
<span class="n">HASHDB_HASH_URL</span> <span class="o">=</span> <span class="s1">'https://hashdb.openanalysis.net/hash'</span>

<span class="n">api_hash</span> <span class="o">=</span> <span class="mh">0x1FA8A1D4</span> <span class="o">+</span> <span class="mi">5</span>
<span class="n">hunt_request</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"hashes"</span><span class="p">:</span> <span class="p">[</span><span class="n">api_hash</span><span class="p">]}</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">HASHDB_HUNT_URL</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">hunt_request</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{'hits': [{'algorithm': 'crc32', 'count': 1, 'hitrate': 1.0}]}
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">HASHDB_HASH_URL</span> <span class="o">+</span> <span class="s1">'/crc32/'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">api_hash</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{'hashes': [{'hash': 531145177, 'string': {'string': 'ShellExecuteW', 'is_api': True, 'permutation': 'api', 'api': 'ShellExecuteW', 'modules': ['shell32']}}]}
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Possible-IOCs">
<a class="anchor" href="#Possible-IOCs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Possible IOCs<a class="anchor-link" href="#Possible-IOCs"> </a>
</h3>
<ul>
<li>
<p>There is self-delete functionatlity using the batch script:
<code>/c ping 127.0.0.1 &amp;&amp; del \"%s\" &gt;&gt; NUL</code></p>
</li>
<li>
<p>They use <code>GetEnvironmentVariableW(L"ComSpec", Filename, 0x104u)</code> to get the <code>cmd.exe</code> path.</p>
</li>
<li>
<p>They have a hardcoded URL <code>http://apuservis.pe/ocultar/fw%d.exe</code></p>
</li>
<li>
<p>They have a hardcoded HTTP header <code>GET %S HTTP/1.1</code></p>
</li>
<li>
<p>They have a CRC32 hash algo used for the dynamic API resolving</p>
</li>
</ul>
<h3 id="Yara-rule">
<a class="anchor" href="#Yara-rule" aria-hidden="true"><span class="octicon octicon-link"></span></a>Yara rule<a class="anchor-link" href="#Yara-rule"> </a>
</h3>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">rule download_hunt {</span>

    <span class="l l-Scalar l-Scalar-Plain">meta</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">description = "Hunt for simple downloaders"</span>

   <span class="l l-Scalar l-Scalar-Plain">strings</span><span class="p p-Indicator">:</span>
<span class=" -Error">       </span><span class="l l-Scalar l-Scalar-Plain">$s1 = "/c ping 127.0.0.1 &amp;&amp; del \"%s\" &gt;&gt; NUL" wide ascii nocase</span>
       <span class="l l-Scalar l-Scalar-Plain">$s2 = "http://" wide ascii</span>
       <span class="l l-Scalar l-Scalar-Plain">$s3 = "GET %S HTTP/1.1" wide ascii nocase</span>
       <span class="l l-Scalar l-Scalar-Plain">$x1 = { 35 20 83 B8 ED }</span>
       <span class="l l-Scalar l-Scalar-Plain">$x2 = { 81 F? 20 83 B8 ED }</span>

   <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span>
       <span class="l l-Scalar l-Scalar-Plain">all of ($s*) and 1 of ($x*)</span>

<span class="err">}</span>
</pre></div>
<p>** let's also check file size</p>
<p>** these are small binaries with very few functions, one ID trick might be to try and identify how many functions and only trigger an bins with a few functions... for this we could maybe used CFG count... from @psifertex</p>
<blockquote>
<p>You can see the function table from a CFG binary with dumpbin /loadconfig test.exe</p>
</blockquote>
<h4 id="Yara-Rule-Revisions">
<a class="anchor" href="#Yara-Rule-Revisions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Yara Rule Revisions<a class="anchor-link" href="#Yara-Rule-Revisions"> </a>
</h4>
<p>We ran a scan with the above rule over the <a href="https://riskmitigation.ch/yara-scan/index.html">MalwareBazaar</a> corpus and the results only gave us <a href="https://riskmitigation.ch/yara-scan/results/536840a0d04a2bbc3b63dd1e8cf36c008b1a242d23428c101d7e75157508958b/">one match</a> (the sample we were originally looking at). This is a <strong>bad</strong> rule. 
We are going to loosen the rule to see if we can catch more samples.</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">rule download_hunt_2 {</span>

    <span class="l l-Scalar l-Scalar-Plain">meta</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">description = "Hunt for simple downloaders"</span>

   <span class="l l-Scalar l-Scalar-Plain">strings</span><span class="p p-Indicator">:</span>
<span class=" -Error">       </span><span class="l l-Scalar l-Scalar-Plain">$s1 = "/c ping 127.0.0.1 &amp;&amp; del" wide ascii xor</span> 
       <span class="l l-Scalar l-Scalar-Plain">$s2 = "http://" wide ascii xor</span> 


   <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span>
       <span class="l l-Scalar l-Scalar-Plain">all of ($s*)</span> 

<span class="err">}</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://h0e4a0r1t.github.io/intro/post-bg.jpg" alt=""></p>
<h2 id="Triage-of-1a10e...">
<a class="anchor" href="#Triage-of-1a10e..." aria-hidden="true"><span class="octicon octicon-link"></span></a>Triage of <code>1a10e...</code><a class="anchor-link" href="#Triage-of-1a10e..."> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>
</p>
<center>
    <div class="jekyll-twitter-plugin">
<blockquote class="twitter-tweet">
<p lang="zh" dir="ltr">"企划营销岗位_徐浩阳_硕士.exe": 1a10e2940151982f2ab4f1e62be6e4f53074a2ffb90c7977e16d6a183db98695<br>139.9.138[.]190 <a href="https://t.co/pquwEW1ZW0">pic.twitter.com/pquwEW1ZW0</a></p>— MalwareHunterTeam (@malwrhunterteam) <a href="https://twitter.com/malwrhunterteam/status/1535745376766115840?ref_src=twsrc%5Etfw">June 11, 2022</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
</center>

<p>There is a PDB path in the binary <code>C:\Users\H0e4a0r1t\Documents\Visual Studio 2015\Projects\worddy\x64\Release\worddy.pdb</code>. Based on the username <code>H0e4a0r1t</code> we found a possible GitHub <a href="https://github.com/h0e4a0r1t">https://github.com/h0e4a0r1t</a> and this looks like maybe a "redteam" tools developer??</p>
<h3 id="Possible-IOCs">
<a class="anchor" href="#Possible-IOCs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Possible IOCs<a class="anchor-link" href="#Possible-IOCs"> </a>
</h3>
<ul>
<li>
<p>There is an embeded blob that is encrypted with a singl-byte XOR <code>0x99</code></p>
</li>
<li>
<p>Once decrypted the blob is a standard Cobalt Strike loader with the following "header" strings.</p>
</li>
</ul>

<pre><code>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Referer: http://code.jquery.com/
Accept-Encoding: gzip, deflate
User-Agent: Mozilla/5.0 (Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko</code></pre>
<ul>
<li>
<p>The C2 IP is <code>139.9.138.190</code></p>
</li>
<li>
<p>To load and launch the decrypted shellcode they use the following APIs</p>
<ul>
<li>VirtualAlloc</li>
<li>WriteProcessMemory</li>
<li>QueueUserAPC</li>
</ul>
</li>
</ul>
<h3 id="Yara-Rule">
<a class="anchor" href="#Yara-Rule" aria-hidden="true"><span class="octicon octicon-link"></span></a>Yara Rule<a class="anchor-link" href="#Yara-Rule"> </a>
</h3>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">rule cs_downloader {</span>

    <span class="l l-Scalar l-Scalar-Plain">meta</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">description = "Hunt for Cobalt Strike downloader"</span>

   <span class="l l-Scalar l-Scalar-Plain">strings</span><span class="p p-Indicator">:</span>
<span class=" -Error">       </span><span class="l l-Scalar l-Scalar-Plain">$s1 = "Accept-Language:" xor(0x01-0xff)</span>
       <span class="l l-Scalar l-Scalar-Plain">$s2 = "Referer</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://code.jquery.com/" xor(0x01-0xff)</span>
       <span class="l l-Scalar l-Scalar-Plain">$s3 = "Accept-Encoding</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gzip, deflate" xor(0x01-0xff)</span>
       <span class="l l-Scalar l-Scalar-Plain">$s4 = "User-Agent:" xor(0x01-0xff)</span>


<span class=" -Error">   </span><span class="nt">condition</span><span class="p">:</span>
       <span class="l l-Scalar l-Scalar-Plain">all of ($s*) and uint32(@s1) == uint32(@s3)</span> 

<span class="err">}</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Yara-Results">
<a class="anchor" href="#Yara-Results" aria-hidden="true"><span class="octicon octicon-link"></span></a>Yara Results<a class="anchor-link" href="#Yara-Results"> </a>
</h3>
<p>We only got 2 hits, this rule also sucks, lol!</p>

<pre><code>[
  {
    "rule": "cs_downloader",
    "malware": "CobaltStrike",
    "sha256": "e54514b1164508c049733c7dafc97f24ae66d42b8146b0e1a1271f9af7c94d48",
    "mime_type": "application/x-msdownload",
    "virustotal_link": "https://www.virustotal.com/gui/file/e54514b1164508c049733c7dafc97f24ae66d42b8146b0e1a1271f9af7c94d48/detection",
    "malwarebazaar_link": "https://bazaar.abuse.ch/sample/e54514b1164508c049733c7dafc97f24ae66d42b8146b0e1a1271f9af7c94d48/",
    "tags": []
  },
  {
    "rule": "cs_downloader",
    "malware": "CobaltStrike",
    "sha256": "6220127ada00d84b58d718152748cd2c62007b1de92201701dc2968d2b00e31f",
    "mime_type": "application/x-msdownload",
    "virustotal_link": "https://www.virustotal.com/gui/file/6220127ada00d84b58d718152748cd2c62007b1de92201701dc2968d2b00e31f/detection",
    "malwarebazaar_link": "https://bazaar.abuse.ch/sample/6220127ada00d84b58d718152748cd2c62007b1de92201701dc2968d2b00e31f/",
    "tags": []
  }
]</code></pre>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/downloader/research/detection_engineering/yara/triage/2022/06/12/downloader-triage.html" hidden></a>
</article>
