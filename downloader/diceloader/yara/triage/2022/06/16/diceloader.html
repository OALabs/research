<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Diceloader Triage Notes | OALABS Research</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Diceloader Triage Notes" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Researching malware downloaders, detection and triage" />
<meta property="og:description" content="Researching malware downloaders, detection and triage" />
<link rel="canonical" href="https://research.openanalysis.net/downloader/diceloader/yara/triage/2022/06/16/diceloader.html" />
<meta property="og:url" content="https://research.openanalysis.net/downloader/diceloader/yara/triage/2022/06/16/diceloader.html" />
<meta property="og:site_name" content="OALABS Research" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-06-16T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Diceloader Triage Notes" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-06-16T00:00:00-05:00","datePublished":"2022-06-16T00:00:00-05:00","description":"Researching malware downloaders, detection and triage","headline":"Diceloader Triage Notes","mainEntityOfPage":{"@type":"WebPage","@id":"https://research.openanalysis.net/downloader/diceloader/yara/triage/2022/06/16/diceloader.html"},"url":"https://research.openanalysis.net/downloader/diceloader/yara/triage/2022/06/16/diceloader.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://research.openanalysis.net/feed.xml" title="OALABS Research" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">OALABS Research</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Diceloader Triage Notes</h1><p class="page-description">Researching malware downloaders, detection and triage</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-06-16T00:00:00-05:00" itemprop="datePublished">
        Jun 16, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#downloader">downloader</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#diceloader">diceloader</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#yara">yara</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#triage">triage</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2022-06-16-diceloader.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a>
<ul>
<li class="toc-entry toc-h3"><a href="#References">References </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Triage-Notes">Triage Notes </a></li>
<li class="toc-entry toc-h2"><a href="#Yara">Yara </a></li>
<li class="toc-entry toc-h2"><a href="#Config-Extraction">Config Extraction </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-06-16-diceloader.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p>According to Mandiant..</p>
<blockquote>
<p>the DiceLoader framework, a known toolkit that helps attackers gain a foothold in infected systems and perform reconnaissance</p>
</blockquote>
<p>According to Twitter...</p>
<blockquote>
<p>twitter:<a href="https://twitter.com/c3rb3ru5d3d53c/status/1348667319665487874">https://twitter.com/c3rb3ru5d3d53c/status/1348667319665487874</a>
and ... 

</p>
<center>
    <div class="jekyll-twitter-plugin">
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr"><a href="https://twitter.com/hashtag/FIN7?src=hash&amp;ref_src=twsrc%5Etfw">#FIN7</a><br>As reported by <a href="https://twitter.com/KorbenD_Intel?ref_src=twsrc%5Etfw">@KorbenD_Intel</a>, the initial powershell script use DeflateStream method for uncompress the zip in memory and extract it. This execute the second layer that heavily obfuscated. More 70 functions are used for reorder the data for sensible strings and the implant <a href="https://t.co/f8CTvtaf2m">pic.twitter.com/f8CTvtaf2m</a></p>— Arkbird (@Arkbird_SOLG) <a href="https://twitter.com/Arkbird_SOLG/status/1310966874352635907?ref_src=twsrc%5Etfw">September 29, 2020</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
</center>

and ...

<center>
    <div class="jekyll-twitter-plugin">
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">For those tracking <a href="https://twitter.com/hashtag/FIN7?src=hash&amp;ref_src=twsrc%5Etfw">#FIN7</a> - <a href="https://twitter.com/hashtag/TAKEOUT?src=hash&amp;ref_src=twsrc%5Etfw">#TAKEOUT</a> is the powershell memory dropper that has been seen dropping <a href="https://twitter.com/hashtag/CARBANAK?src=hash&amp;ref_src=twsrc%5Etfw">#CARBANAK</a> OR <a href="https://twitter.com/hashtag/DICELOADER?src=hash&amp;ref_src=twsrc%5Etfw">#DICELOADER</a> - there's some confusion going on..<br><br>ClearTemp.ps1 files == TAKEOUT<br>Payloads embedded == CARBANAK || DICELOADER</p>— Dan Perez (@MrDanPerez) <a href="https://twitter.com/MrDanPerez/status/1347185968500109313?ref_src=twsrc%5Etfw">January 7, 2021</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
</center>

</blockquote>
<p>According to Dan Perez at Mandiant...</p>
<blockquote>
<p>For those tracking #FIN7 - #TAKEOUT is the powershell memory dropper that has been seen dropping #CARBANAK OR #DICELOADER - there's some confusion going on..
ClearTemp.ps1 files == TAKEOUT
Payloads embedded == CARBANAK || DICELOADER</p>
</blockquote>
<h3 id="References">
<a class="anchor" href="#References" aria-hidden="true"><span class="octicon octicon-link"></span></a>References<a class="anchor-link" href="#References"> </a>
</h3>
<ul>
<li>
<a href="https://bazaar.abuse.ch/browse.php?search=tag%3Adiceloader">MalwareBazaar "diceloader" tag</a>- <a href="https://www.secureworks.com/research/threat-profiles/gold-niagara">Attributed to GOLD NIAGARA (carbon spider)</a>
</li>
<li><a href="https://duo.com/decipher/fin7-evolves-with-novel-malware-initial-access-tactics">Attributed to FIN7</a></li>
<li><a href="https://bi-zone.medium.com/from-pentest-to-apt-attack-cybercriminal-group-fin7-disguises-its-malware-as-an-ethical-hackers-c23c9a75e319">Possible that Lizar is an earlier version of Diceloader</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Triage-Notes">
<a class="anchor" href="#Triage-Notes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Triage Notes<a class="anchor-link" href="#Triage-Notes"> </a>
</h2>
<p><strong>Sample:</strong> <code>2d88767c424d05330839e568b32f9f52962df56b1d3021f69930167fe623efd1</code></p>
<p><strong>Creation Time:</strong>  2021-07-15 15:46:07 UTC</p>
<p><strong>First Submission:</strong> 2022-03-20 23:22:32 UTC</p>
<ul>
<li>The sample is an x64 DLL with two exports</li>
<li>One of the exports is a reflective PE loader (possibly copy-paste from metasploit)</li>
<li>There is a mutex string <code>Global\\%08x</code> that is built as a stack string</li>
</ul>

<pre><code>.text:0000000180001749 C7 44 24 30 47 6C 6F 62                 mov     dword ptr [rsp+228h+var_mutex], 626F6C47h
.text:0000000180001751 C7 44 24 34 61 6C 5C 25                 mov     dword ptr [rsp+228h+var_mutex+4], 255C6C61h
.text:0000000180001759 C7 44 24 38 30 38 78 00                 mov     dword ptr [rsp+228h+var_mutex+8], 783830h</code></pre>
<ul>
<li>The <code>.data</code> section containst two encrypted blobs with a 32-byte key sandwitched between them. </li>
<li>The first encrypted blob seems to contain a port number</li>
</ul>

<pre><code>01 bb 01 11 bb 01 00 00 00 90 f1</code></pre>
<ul>
<li>The second encrypted blob contains C2 IP addresses separated with a <code>|</code>
</li>
</ul>

<pre><code>46.17.107.7|185.250.151.33\x00</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Yara">
<a class="anchor" href="#Yara" aria-hidden="true"><span class="octicon octicon-link"></span></a>Yara<a class="anchor-link" href="#Yara"> </a>
</h2>
<pre><code>import "pe"

rule diceloader {
    meta:
        description = "Identifies diceloader"

   strings:

       // gobal stack string
       // C7 44 24 30 47 6C 6F 62                 mov     dword ptr [rsp+228h+var_mutex], 626F6C47h
       // C7 44 24 34 61 6C 5C 25                 mov     dword ptr [rsp+228h+var_mutex+4], 255C6C61h
       // C7 44 24 38 30 38 78 00                 mov     dword ptr [rsp+228h+var_mutex+8], 783830h
       $x1 = { C7 ?? ?? ?? 47 6C 6F 62 C7 ?? ?? ?? 61 6C 5C 25 C7 ?? ?? ?? 30 38 78 00 }

       // fnv1
       // 48 FF C1                                inc     rcx
       // 33 C2                                   xor     eax, edx
       // 69 C0 93 01 00 01                       imul    eax, 1000193h
       $x2 = { 48 FF C1 33 C2 69 C0 93 01 00 01 }

       // sleep(1000)
       // B9 10 27 00 00                          mov     ecx, 2710h      ; dwMilliseconds
       // FF 15 B3 13 00 00                       call    cs:Sleep
       $x3 = {B9 10 27 00 00 ff}

       // hash for NtFlushInstructionCache
       // 81 F9 B8 0A 4C 53                       cmp     ecx, 534C0AB8h
       // 75 16                                   jnz     short loc_7FFA3BA4121E
       $x4 = { 81 F9 B8 0A 4C 53 75 }

   condition:
       pe.is_64bit() and 
       all of ($x*)

}</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Config-Extraction">
<a class="anchor" href="#Config-Extraction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Config Extraction<a class="anchor-link" href="#Config-Extraction"> </a>
</h2>
<p>We want to pull out the C2 IP addresses.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">unhex</span><span class="p">(</span><span class="n">hex_string</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">binascii</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">hex_string</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">hex_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">hex_string</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">tohex</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">binascii</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pefile</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">re</span>


<span class="n">FILE_PATH</span> <span class="o">=</span> <span class="s1">'/tmp/diceloader/2d88767c424d05330839e568b32f9f52962df56b1d3021f69930167fe623efd1.exe'</span>
<span class="n">file_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">FILE_PATH</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">xor_decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="k">len</span>(key)])
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="o">.</span><span class="n">PE</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">file_data</span><span class="p">)</span>


<span class="n">data_section_offset</span><span class="o">=</span> <span class="kc">None</span>
<span class="n">data_section_end_offset</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pe</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
    <span class="k">if</span> <span class="sa">b</span><span class="s1">'.data</span><span class="se">\x00</span><span class="s1">'</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">Name</span><span class="p">:</span>
        <span class="n">data_section_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">PointerToRawData</span>
        <span class="n">data_section_end_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">PointerToRawData</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">SizeOfRawData</span>
        <span class="k">break</span>


<span class="c1"># Find the key based on it being passed as an arg</span>
<span class="c1">#</span>
<span class="c1"># BD 1F 00 00 00                          mov     ebp, 1Fh</span>
<span class="c1"># 4C 8D 05 68 1E 00 00                    lea     r8, key</span>
<span class="c1"># 44 8B CD                                mov     r9d, ebp</span>
<span class="c1"># 49 8B CE                                mov     rcx, r14</span>
<span class="c1"># 8D 75 F7                                lea     esi, [rbp-9]</span>
<span class="c1"># 8B D6                                   mov     edx, esi</span>
<span class="c1"># E8 50 FE FF FF                          call    sub_7FFA3BA420B8</span>
<span class="n">egg</span> <span class="o">=</span> <span class="sa">rb</span><span class="s1">'\xBD\x1F\x00\x00\x00\x4C\x8D\x05(....)'</span>

<span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">egg</span><span class="p">,</span> <span class="n">file_data</span><span class="p">):</span>
    <span class="n">rel_offset</span>  <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> 
    <span class="c1"># Remember to add 7 for the 7 bytes in the instruction</span>
    <span class="n">rel_offset</span> <span class="o">+=</span> <span class="mi">7</span> 
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"rel offset: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">rel_offset</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="c1"># Remember that this is in the .text section which is loaded before the .data </span>
    <span class="c1"># so the relative will be postive displacement</span>
    <span class="n">match_offset</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">+</span> <span class="mi">5</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"match offset: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">match_offset</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">match_rva</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_rva_from_offset</span><span class="p">(</span><span class="n">match_offset</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"match rva: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">match_rva</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">key_rva</span> <span class="o">=</span> <span class="n">match_rva</span> <span class="o">+</span> <span class="n">rel_offset</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"key rva: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">key_rva</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">key_offset</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_offset_from_rva</span><span class="p">(</span><span class="n">key_rva</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"key offset: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">key_offset</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">key_offset</span><span class="p">:</span><span class="n">key_offset</span><span class="o">+</span><span class="mi">31</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tohex</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

<span class="c1"># Use the key position to locate the other two data blobs</span>

<span class="n">blob1</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">data_section_offset</span><span class="p">:</span><span class="n">key_offset</span><span class="p">]</span>
<span class="n">blob2</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="n">key_offset</span><span class="o">+</span><span class="mi">31</span><span class="p">:</span><span class="n">data_section_end_offset</span><span class="p">]</span>


<span class="n">out_blob1</span> <span class="o">=</span> <span class="n">xor_decrypt</span><span class="p">(</span><span class="n">blob1</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="n">port</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'&gt;H'</span><span class="p">,</span><span class="n">out_blob1</span><span class="p">[:</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Port: </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">out_blob2</span> <span class="o">=</span> <span class="n">xor_decrypt</span><span class="p">(</span><span class="n">blob2</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">),</span> <span class="n">key</span><span class="p">)</span>

<span class="n">c2_ips</span>  <span class="o">=</span> <span class="n">out_blob2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">'|'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">c2_ips</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"c2: </span><span class="si">{</span><span class="n">c2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>rel offset: 0x1e6f
match offset: 0x1651
match rva: 0x2251
key rva: 0x40c0
key offset: 0x2ec0
b'b2f3a1eaabea5757c9d7411c0df59d4ea951440911ec7d6603253e7d10660a'
Port: 443
c2: b'46.17.107.7'
c2: b'185.250.151.33'
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/downloader/diceloader/yara/triage/2022/06/16/diceloader.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
