<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>DbatLoader Triage | OALABS Research</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="DbatLoader Triage" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Config Extractor for DBatLoader" />
<meta property="og:description" content="Config Extractor for DBatLoader" />
<link rel="canonical" href="https://research.openanalysis.net/dbatloader/delphi/loader/config/triage/2022/09/04/dbatloader.html" />
<meta property="og:url" content="https://research.openanalysis.net/dbatloader/delphi/loader/config/triage/2022/09/04/dbatloader.html" />
<meta property="og:site_name" content="OALABS Research" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-04T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="DbatLoader Triage" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-04T00:00:00-05:00","datePublished":"2022-09-04T00:00:00-05:00","description":"Config Extractor for DBatLoader","headline":"DbatLoader Triage","mainEntityOfPage":{"@type":"WebPage","@id":"https://research.openanalysis.net/dbatloader/delphi/loader/config/triage/2022/09/04/dbatloader.html"},"url":"https://research.openanalysis.net/dbatloader/delphi/loader/config/triage/2022/09/04/dbatloader.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://research.openanalysis.net/feed.xml" title="OALABS Research" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">OALABS Research</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">DbatLoader Triage</h1><p class="page-description">Config Extractor for DBatLoader</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-09-04T00:00:00-05:00" itemprop="datePublished">
        Sep 4, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#dbatloader">dbatloader</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#delphi">delphi</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#loader">loader</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#config">config</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#triage">triage</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2022-09-04-dbatloader.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Samples">Samples </a></li>
<li class="toc-entry toc-h3"><a href="#References">References </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Analysis">Analysis </a>
<ul>
<li class="toc-entry toc-h3"><a href="#C2-Extraction">C2 Extraction </a></li>
<li class="toc-entry toc-h3"><a href="#Parsing-Downloaded-Data">Parsing Downloaded Data </a></li>
<li class="toc-entry toc-h3"><a href="#Stage3-Extraction">Stage3 Extraction </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-09-04-dbatloader.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p>Dbatloader is a simple loader that is used to download and execute a payload. It is very small and written in delphi. The sample we are looking at is the second? stage, likely the first stages are some sort of document chain. From OSINT we expect that this stage is simply used to download a third stage which will contain the payload as a resource.</p>
<h3 id="Samples">
<a class="anchor" href="#Samples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Samples<a class="anchor-link" href="#Samples"> </a>
</h3>
<ul>
<li>Packed Parent <code>5be5708b720b520f2292ec10196f47ff3a687843a529540d75c0d7621fad247e</code> <a href="https://malshare.com/sample.php?action=detail&amp;hash=5be5708b720b520f2292ec10196f47ff3a687843a529540d75c0d7621fad247e">malshare</a>
</li>
<li>Unpacked payload <code>dc5ec82e7cb2590ae612a2dd7203ae3a81662707377f2be44c94378ef0b0d3b0</code> <a href="https://malshare.com/sample.php?action=detail&amp;hash=dc5ec82e7cb2590ae612a2dd7203ae3a81662707377f2be44c94378ef0b0d3b0">malshare</a>
</li>
</ul>
<h3 id="References">
<a class="anchor" href="#References" aria-hidden="true"><span class="octicon octicon-link"></span></a>References<a class="anchor-link" href="#References"> </a>
</h3>
<ul>
<li><a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.dbatloader">Malpedia Dbatloader Yara</a></li>
<li><a href="https://www.netskope.com/blog/dbatloader-abusing-discord-to-deliver-warzone-rat">DBatLoader: Abusing Discord to Deliver Warzone RAT</a></li>
<li><a href="https://malcat.fr/blog/exploit-steganography-and-delphi-unpacking-dbatloader/">Exploit, steganography and Delphi: unpacking DBatLoader</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Analysis">
<a class="anchor" href="#Analysis" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analysis<a class="anchor-link" href="#Analysis"> </a>
</h2>
<h3 id="C2-Extraction">
<a class="anchor" href="#C2-Extraction" aria-hidden="true"><span class="octicon octicon-link"></span></a>C2 Extraction<a class="anchor-link" href="#C2-Extraction"> </a>
</h3>
<p>The packed payload actually contains the C2s which are accessed by the unpacked payload. This is done via a hard-coded delimiter in the unpacked child. In our sample there are two identical C2 URLs using the delimters <code>^^Nc</code>, and <code>Ymo_^</code>. The child will open the parent and search for a string that is sandwiched between the delimiter. Once the string has been extracted it is decrypted using a simple add/mod algorithm with a hard coded number. In our sample the number is <code>217</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">unhex</span><span class="p">(</span><span class="n">hex_string</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">binascii</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">hex_string</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">hex_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">hex_string</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">c2_data</span> <span class="o">=</span> <span class="n">unhex</span><span class="p">(</span><span class="s1">'2F 3B 3B 37 3A 01 F6 F6 36 35 2C 2B 39 30 3D 2C F5 33 30 3D 2C F5 2A 36 34 F6 2B 36 3E 35 33 36 28 2B 06 2A 30 2B 04 0C 08 0C 00 F7 F7 00 F8 FB FA 0D FE 0A FB F9 F7 ED 39 2C 3A 30 2B 04 0C 08 0C 00 F7 F7 00 F8 FB FA 0D FE 0A FB F9 F7 EC F9 F8 F8 F9 FE ED 28 3C 3B 2F 32 2C 40 04 08 09 18 09 13 15 21 2D F7 FC 16 11 2F 41 2A E7 E7'</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span><span class="s1">''</span><span class="p">))</span>
<span class="n">delim</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'^^Nc'</span>


<span class="k">def</span> <span class="nf">addit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">c</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x112</span> <span class="o">%</span> <span class="n">key</span><span class="p">))</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<span class="n">addit</span><span class="p">(</span><span class="n">c2_data</span><span class="p">,</span><span class="mi">217</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>b'https://onedrive.live.com/download?cid=EAE9009143F7C420&amp;resid=EAE9009143F7C420%21127&amp;authkey=ABQBLNZf05OJhzc  '</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Parsing-Downloaded-Data">
<a class="anchor" href="#Parsing-Downloaded-Data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Parsing Downloaded Data<a class="anchor-link" href="#Parsing-Downloaded-Data"> </a>
</h3>
<p>The downloaded data is a complex encrypted structure that must be parsed before the Stage3 binary can be extracted. An ecrypted version of the data can be downloaded from Malshare here: <a href="https://malshare.com/sample.php?action=detail&amp;hash=7fac3d9c98127d11ce69c3130dbbd6a876e1ae37c80304516cc8dd675423b9f2">7fac3d9c98127d11ce69c3130dbbd6a876e1ae37c80304516cc8dd675423b9f2</a>.</p>
<p>The downloaded data is first decrypted ysing a simple add/sub algorithm using the same hard coded key as the C2 decryption routine. In our sample this key was <code>217</code>. Once decrypted the data is inverted and split using a hard coded delimiter. In our sample the delimiter is is a string starting with <code>*()%@5YT...</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/stage3.bin'</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">key</span> <span class="o">=</span> <span class="mi">217</span>

<span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">c</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">c</span> <span class="o">-</span> <span class="n">key</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>

<span class="n">out</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>



<span class="n">delim</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'*()%@5YT!@#G__T@#$%^&amp;*()__#@$#57$#!@'</span>

<span class="n">out_sections</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delim</span><span class="p">)</span>


<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">out_sections</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="mi">400</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\n\n\n\n</span><span class="s1">'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>b''





b'bqreumlsuncxfylyhjhzefggkpmxwfercbsgqwjfopnjderezbemywzcjzxkjjwfyuaukujqnpoepcjvkmzajzzxtisalfpgvjglattaveih'





b'Qfefstpinqstsrgjnrtjyjlfqaxhrds'





b'\xc9\xda\xd9\xce\xde\xc6\xc7\xd8\xde\xc5\xc8\xd3\xcd\xd2\xc7\xd2\xc3\xc1\xc3\xd1\xce\xcd\xcc\xcc\xc0\xdb\xc6\xd3\xdc\xcd\xce\xd9\xc8\xc9\xd8\xcc\xda\xdc\xc1\xcd\xc4\xdb\xc5\xc1\xcf\xce\xd9\xce\xd1\xc9\xce\xc6\xd2\xdc\xd1\xc8\xc1\xd1\xd3\xc0\xc1\xc1\xdc\xcd\xd2\xde\xca\xde\xc0\xde\xc1\xda\xc5\xdb\xc4\xce\xdb\xc8\xc1\xdd\xc0\xc6\xd1\xca\xc1\xd1\xd1\xd3\xdf\xc2\xd8\xca\xc7\xcd\xdb\xcc\xdd\xc1\xcc\xc7\xca\xdf\xdf\xca\xdd\xce\xc2\xc3\xc9\xda\xd9\xce\xde\xc6\xc7\xd8\xde\xc5\xc8\xd3\xcd\xd2\xc7\xd2\xc3\xc1\xc3\xd1\xce\xcd\xcc\xcc\xc0\xdb\xc6\xd3\xdc\xcd\xce\xd9\xc8\xc9\xd8\xcc\xda\xdc\xc1\xcd\xc4\xdb\xc5\xc1\xcf\xce\xd9\xce\xd1\xc9\xce\xc6\xd2\xdc\xd1\xc8\xc1\xd1\xd3\xc0\xc1\xc1\xdc\xcd\xd2\xde\xca\xde\xc0\xde\xc1\xda\xc5\xdb\xc4\xce\xdb\xc8\xc1\xdd\xc0\xc6\xd1\xca\xc1\xd1\xd1\xd3\xdf\xc2\xd8\xca\xc7\xcd\xdb\xcc\xdd\xc1\xcc\xc7\xca\xdf\xdf\xca\xdd\xce\xc2\xc3\xc9\xda\xd9\xce\xde\xc6\xc7\xd8\xde\xc5\xc8\xd3\xcd\xd2\xc7\xd2\xc3\xc1\xc3\xd1\xce\xcd\xcc\xcc\xc0\xdb\xc6\xd3\xdc\xcd\xce\xd9\xc8\xc9\xd8\xcc\xda\xdc\xc1\xcd\xc4\xdb\xc5\xc1\xcf\xce\xd9\xce\xd1\xc9\xce\xc6\xd2\xdc\xd1\xc8\xc1\xd1\xd3\xc0\xc1\xc1\xdc\xcd\xd2\xde\xca\xde\xc0\xde\xc1\xda\xc5\xdb\xc4\xce\xdb\xc8\xc1\xdd\xc0\xc6\xd1\xca\xc1\xd1\xd1\xd3\xdf\xc2\xd8\xca\xc7\xcd\xdb\xcc\xdd\xc1\xcc\xc7\xca\xdf\xdf\xca\xdd\xce\xc2\xc3\xc9\xda\xd9\xce\xde\xc6\xc7\xd8\xde\xc5\xc8\xd3\xcd\xd2\xc7\xd2\xc3\xc1\xc3\xd1\xce\xcd\xcc\xcc\xc0\xdb\xc6\xd3\xdc\xcd\xce\xd9\xc8\xc9\xd8\xcc\xda\xdc\xc1\xcd\xc4\xdb\xc5\xc1\xcf\xce\xd9\xce\xd1\xc9\xce\xc6\xd2\xdc\xd1\xc8\xc1\xd1\xd3\xc0\xc1\xc1\xdc\xcd\xd2\xde\xca\xde\xc0\xde\xc1\xda\xc5\xdb\xc4\xce'





b''





b'1'





b''





b'1'





b''





b'217'





</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Stage3-Extraction">
<a class="anchor" href="#Stage3-Extraction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stage3 Extraction<a class="anchor-link" href="#Stage3-Extraction"> </a>
</h3>
<p>Once the data has been split into sections the <strong>second</strong> section is used as a key to decrypt the <strong>forth</strong> section, which contains the Stage3 payload. In our sample there were 10 sections in total and the first section was skipped entirly and contained no data. The decryption routine is a simple xor with the key, and the key, and data lengths (unusual).</p>
<p>Once the Stage3 payload has been decrypted it is inverted, then decrypted a second time using the same add/mod algorithm that was used to decrypt the C2 URLs. The decryption key is located in the <strong>tenth</strong> section. In our sample this key matched the hard coded C2 key in Stage2 <code>217</code>.</p>
<p>The decrypted Stage3 payload is then inverted again and passed through a final decryption algorythm that was refered to as <code>decrypt_yak</code> in this <a href="https://malcat.fr/blog/exploit-steganography-and-delphi-unpacking-dbatloader/">blog post</a> and reproduced in Python (our graditute &lt;3).</p>
<p>A decrypted Stage3 payload can be downloaded from Malshare here: <a href="https://malshare.com/sample.php?action=detail&amp;hash=05962419fba7b3b2b2fee77365db12e71d33d2919db5e1c162f2211398b7c8d2">05962419fba7b3b2b2fee77365db12e71d33d2919db5e1c162f2211398b7c8d2</a></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">key</span> <span class="o">=</span> <span class="n">out_sections</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">key_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="n">payload_data</span> <span class="o">=</span> <span class="n">out_sections</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">payload_data_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload_data</span><span class="p">)</span>



<span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">key_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">payload_data_len</span><span class="p">):</span>
    <span class="n">tmp_byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">payload_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">payload_data_len</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">[</span><span class="n">key_count</span><span class="p">]</span>  <span class="o">^</span> <span class="n">key_len</span> <span class="o">^</span> <span class="n">tmp_byte</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
    <span class="n">key_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">key_len</span>

<span class="n">payload_out</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="n">payload_out_dec</span> <span class="o">=</span> <span class="n">addit</span><span class="p">(</span><span class="n">payload_out</span><span class="p">,</span> <span class="mi">217</span><span class="p">)</span>

<span class="n">payload_out_dec</span> <span class="o">=</span> <span class="n">payload_out_dec</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">decrypt_yak</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    implements the first decryption layer of function 0x416408</span>
<span class="sd">    """</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="mh">0x21</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="mh">0x7e</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((((</span><span class="n">c</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">)</span> <span class="o">%</span> <span class="mh">0x5e</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="n">final_payload</span> <span class="o">=</span> <span class="n">decrypt_yak</span><span class="p">(</span><span class="n">payload_out_dec</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="n">final_payload</span><span class="p">[:</span><span class="mi">400</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>b'MZP\x00\x02\x00\x00\x00\x04\x00\x0f\x00\xff\xff\x00\x00\xb8\x00\x00\x00\x00\x00\x00\x00@\x00\x1a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\xba\x10\x00\x0e\x1f\xb4\t\xcd!\xb8\x01L\xcd!\x90\x90This program must be run under Win32\r\n$7\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00PE\x00\x00L\x01\x02\x00\xc0\x1b\xc4+\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x00\x8f\x81\x0b\x01\x04 \x00$\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x17\x15\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x00S\x00\x00\x10\x00\x00\x00\x02\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00P\x02\x00\x00\x04\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x10\x00\x00\x00\x01\x00\x00\x00\x10\x00\x00\x00\x01\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00@\x02\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
</pre>
</div>
</div>

</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/dbatloader/delphi/loader/config/triage/2022/09/04/dbatloader.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
