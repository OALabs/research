<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Brute Ratel | OALABS Research</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Brute Ratel" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Some notes on this dual purpose RAT" />
<meta property="og:description" content="Some notes on this dual purpose RAT" />
<link rel="canonical" href="https://research.openanalysis.net/rat/brute%20ratel/redteam/python/research/boymoderre/2022/12/11/brute-ratel.html" />
<meta property="og:url" content="https://research.openanalysis.net/rat/brute%20ratel/redteam/python/research/boymoderre/2022/12/11/brute-ratel.html" />
<meta property="og:site_name" content="OALABS Research" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-12-11T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Brute Ratel" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-12-11T00:00:00-06:00","datePublished":"2022-12-11T00:00:00-06:00","description":"Some notes on this dual purpose RAT","headline":"Brute Ratel","mainEntityOfPage":{"@type":"WebPage","@id":"https://research.openanalysis.net/rat/brute%20ratel/redteam/python/research/boymoderre/2022/12/11/brute-ratel.html"},"url":"https://research.openanalysis.net/rat/brute%20ratel/redteam/python/research/boymoderre/2022/12/11/brute-ratel.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://research.openanalysis.net/feed.xml" title="OALABS Research" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">OALABS Research</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Brute Ratel</h1><p class="page-description">Some notes on this dual purpose RAT</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-12-11T00:00:00-06:00" itemprop="datePublished">
        Dec 11, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      7 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#rat">rat</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#brute ratel">brute ratel</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#redteam">redteam</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#python">python</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#research">research</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#boymoderre">boymoderre</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-left">
            <div class="px-2">
                <a href="https://www.youtube.com/c/OALabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-YouTube-FF0000" alt="Join us on YouTube">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.twitch.tv/oalabslive" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/twitch/status/oalabslive?style=social" alt="Join us on Twitch">
                </a>
            </div>
            <div class="px-2">
                <a href="https://discord.gg/cw4U3WHvpn" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-Join Our Discord-blueviolet" alt="Join Discord">
                </a>
            </div>
            <div class="px-2">
                <a href="https://www.patreon.com/oalabs" role="button" target="_blank">
                    <img class="notebook-badge-image" src="https://img.shields.io/badge/-OALABS Patreon-FF424D" alt="Support us on Patreon">
                </a>
            </div>
          <div class="px-2">

    <a href="https://github.com/OALabs/research/tree/master/_notebooks/2022-12-11-brute-ratel.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Collab-with-@BoymoderRE">Collab with @BoymoderRE </a></li>
<li class="toc-entry toc-h2"><a href="#Overview">Overview </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Sample">Sample </a></li>
<li class="toc-entry toc-h3"><a href="#References">References </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Analysis">Analysis </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Stage-1-Unpacker">Stage 1 Unpacker </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-12-11-brute-ratel.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Collab-with-@BoymoderRE">
<a class="anchor" href="#Collab-with-@BoymoderRE" aria-hidden="true"><span class="octicon octicon-link"></span></a>Collab with @BoymoderRE<a class="anchor-link" href="#Collab-with-@BoymoderRE"> </a>
</h2>
<p>This is part of an ongoing collaboration with <a href="https://twitter.com/boymoderre">BoymoderRE</a> she has been streaming her work over on her <a href="https://www.twitch.tv/boymoderre">twitch channel</a>, and we have been sharing IDBs using the free open source IDA collaboration tool <a href="https://github.com/fidgetingbits/IDArling">IDArling</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">
<a class="anchor" href="#Overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview<a class="anchor-link" href="#Overview"> </a>
</h2>
<p><a href="https://bruteratel.com/">Brute Ratel</a> is a pentesting framework what was recently leaked and has been showing up in the <a href="https://www.bleepingcomputer.com/news/security/ransomware-hacking-groups-move-from-cobalt-strike-to-brute-ratel/">hands of ransomware operators</a>. We are going to focus on the releases before 1.3 where many of the weaknesses in the implant were fixed. To date we have only seen the older versions used by ransomware operators.</p>
<p>Some of the weaknesses in the older version.</p>
<ul>
<li>Default Rc4 key used <code>bYXJm/3#M?:XyMBF</code>
</li>
<li>Using ror13 string hashes</li>
<li>Strings in the badger's memory</li>
<li>Config is base64 encoded in stage 1</li>
</ul>
<h3 id="Sample">
<a class="anchor" href="#Sample" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sample<a class="anchor-link" href="#Sample"> </a>
</h3>
<p>The sample we are analyzing in not public.</p>
<h3 id="References">
<a class="anchor" href="#References" aria-hidden="true"><span class="octicon octicon-link"></span></a>References<a class="anchor-link" href="#References"> </a>
</h3>
<ul>
<li><a href="https://unit42.paloaltonetworks.com/brute-ratel-c4-tool/">When Pentest Tools Go Brutal: Red-Teaming Tool Being Abused by Malicious Actors</a></li>
<li><a href="https://www.trendmicro.com/en_us/research/22/j/black-basta-infiltrates-networks-via-qakbot-brute-ratel-and-coba.html">Black Basta Ransomware Gang Infiltrates Networks via QAKBOT, Brute Ratel, and Cobalt Strike</a></li>
<li><a href="https://medium.com/walmartglobaltech/brute-ratel-config-decoding-update-7820455022cb">Brute Ratel Config Decoding update</a></li>
<li><a href="https://github.com/Immersive-Labs-Sec/BruteRatel-DetectionTools">Immersive-Labs-Sec/BruteRatel-DetectionTools (github)</a></li>
<li><a href="https://bruteratel.com/release_notes/releases.txt">Brute Ratel release notes</a></li>
<li><a href="https://github.com/OALabs/BlobRunner">Blobrunner shellcode debugging tool</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Analysis">
<a class="anchor" href="#Analysis" aria-hidden="true"><span class="octicon octicon-link"></span></a>Analysis<a class="anchor-link" href="#Analysis"> </a>
</h2>
<p>Our sample comes as a 64-bit shellcode blob, the first order of business is to unpack it!</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b64_data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">'42 53 4B 50 36 52 5A 38 61 66 62 4F 6E 48 47 38 4E 54 76 50 66 6B 59 42 51 35 67 42 42 67 67 68 43 6B 71 6E 2F 43 35 51 62 68 72 55 51 53 39 75 4B 4C 4C 37 33 57 50 31 4A 68 46 77 51 66 35 6E 55 39 38 50 4E 53 70 36 70 6D 2B 69 55 55 63 46 70 64 45 4C 58 79 38 79 64 6A 67 71 49 4C 4C 78 61 6F 55 4A 57 33 49 6D 49 6C 48 74 64 31 48 34 51 70 4F 37 6E 2B 56 4D 62 56 45 77 36 77 75 32 47 7A 68 6B 4B 68 51 77 72 4B 31 32 51 35 4F 78 61 6F 6A 57 31 30 2F 42 70 39 31 72 77 68 49 4B 4C 37 4E 51 73 62 38 75 57 66 34 46 62 52 42 69 70 6D 73 37 33 37 65 4E 41 71 47 4E 51 58 78 44 34 59 41 6E 51 41 65 68 47 71 49 47 39 6A 4A 36 2B 7A 4F 78 34 6F 6A 63 30 70 77 57 70 42 48 53 79 63 37 2F 57 73 46 53 46 69 77 37 36 43 53 6C 6D 38 43 43 6E 4D 45 6F 54 56 30 56 41 57 6E 6A 41 4F 31 33 75 72 79 43 6C 77 4E 38 77 4C 2F 73 63 45 62 5A 37 30 73 77 67 67 73 54 45 42 32 34 64 73 6B 78 6A 6F 41 55 55 6C 7A 70 6E 6F 31 5A 6F 57 57 4B 5A 67 4E 6E 7A 72 65 67 64 41 4E 2B 6B 49 53 71 31 4F 2F 48 43 44 70 47 62 54 42 42 43 67 58 34 36 48 34 4A 38 47 4F 59 42 70 43 55 53 66 66 56 58 6A 68 53 49 31 32 65 55 55 65 48 41 37 79 57 38 63 46 5A 00'</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span><span class="s1">''</span><span class="p">))</span>
<span class="n">b64_data</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>b'BSKP6RZ8afbOnHG8NTvPfkYBQ5gBBgghCkqn/C5QbhrUQS9uKLL73WP1JhFwQf5nU98PNSp6pm+iUUcFpdELXy8ydjgqILLxaoUJW3ImIlHtd1H4QpO7n+VMbVEw6wu2GzhkKhQwrK12Q5OxaojW10/Bp91rwhIKL7NQsb8uWf4FbRBipms737eNAqGNQXxD4YAnQAehGqIG9jJ6+zOx4ojc0pwWpBHSyc7/WsFSFiw76CSlm8CCnMEoTV0VAWnjAO13uryClwN8wL/scEbZ70swggsTEB24dskxjoAUUlzpno1ZoWWKZgNnzregdAN+kISq1O/HCDpGbTBBCgX46H4J8GOYBpCUSffVXjhSI12eUUeHA7yW8cFZ\x00'</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Stage-1-Unpacker">
<a class="anchor" href="#Stage-1-Unpacker" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stage 1 Unpacker<a class="anchor-link" href="#Stage-1-Unpacker"> </a>
</h3>
<ul>
<li>
<p>The shellcode payload contains an RC4 encrypted PE with the "badger" payload. The RC4 key is 8 bytes which is appended directly to the end of the encrypted payload.</p>
</li>
<li>
<p>This encrypted blob is moved on the the stack in blocks of 8 bytes. The stack blob and size are then copied on the heap.</p>
</li>
<li>
<p>The same approach is used for the (config?) but this is base64 encoded.</p>
</li>
<li>
<p>The heap allocations containing the encrypted payload, the base64 encoded config, and the lenght of both data allocations are passed to the initialization function in the shellcode.</p>
</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">rc4crypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="c1">#If the input is a string convert to byte arrays</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">box</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">box</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)])</span> <span class="o">%</span> <span class="mi">256</span>
        <span class="n">box</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">box</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span>
        <span class="n">box</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span> <span class="o">^</span> <span class="n">box</span><span class="p">[(</span><span class="n">box</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">box</span><span class="p">[</span><span class="n">y</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">payload_enc</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/brute_enc_shellcode.bin'</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">payload_key</span> <span class="o">=</span> <span class="n">payload_enc</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">rc4crypt</span><span class="p">(</span><span class="n">payload_enc</span><span class="p">[:</span><span class="o">-</span><span class="mi">8</span><span class="p">],</span><span class="n">payload_key</span><span class="p">)</span>
<span class="n">out</span><span class="p">[:</span><span class="mh">0x400</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x00\x00\x00\x0e\x1f\xba\x0e\x00\xb4\t\xcd!\xb8\x01L\xcd\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\r\r\n$\x00\x00\x00\x00\x00\x00\x00PE\x00\x00d\x86\t\x00\xd9\xb4\x03c\x00\x00\x00\x00\x00\x00\x00\x00\xf0\x00."\x0b\x02\x02"\x00\xb4\x02\x00\x00\xdc\x00\x00\x00\x1e\x00\x00\x00\x10\x00\x00\x00\x10\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x10\x00\x00\x00\x02\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x05\x00\x02\x00\x00\x00\x00\x00\x00\x10\x04\x00\x00\x04\x00\x00\xf0\xd3\x03\x00\x03\x00\x00\x00\x00\x00 \x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\xe0\x03\x006\x00\x00\x00\x00\xf0\x03\x00\x80\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x03\x00\x8c\x13\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00l\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00L\xf1\x03\x00\x10\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00.text\x00\x00\x00\xb0\xb3\x02\x00\x00\x10\x00\x00\x00\xb4\x02\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00 \x00P`.data\x00\x00\x000\x1b\x00\x00\x00\xd0\x02\x00\x00\x1c\x00\x00\x00\xb8\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00@\x00`\xc0.rdata\x00\x00P\x83\x00\x00\x00\xf0\x02\x00\x00\x84\x00\x00\x00\xd4\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00@\x00`@.pdata\x00\x00\x8c\x13\x00\x00\x00\x80\x03\x00\x00\x14\x00\x00\x00X\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00@\x000@.xdata\x00\x00h\x18\x00\x00\x00\xa0\x03\x00\x00\x1a\x00\x00\x00l\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00@\x000@.bss\x00\x00\x00\x00\xa6\x1d\x00\x00\x00\xc0\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x00`\xc0.edata\x00\x006\x00\x00\x00\x00\xe0\x03\x00\x00\x02\x00\x00\x00\x86\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00@\x000@.idata\x00\x00\x80\x04\x00\x00\x00\xf0\x03\x00\x00\x06\x00\x00\x00\x88\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00@\x000\xc0.reloc\x00\x00l\x04\x00\x00\x00\x00\x04\x00\x00\x06\x00\x00\x00\x8e\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00@\x000B\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">stage1_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/stage1.bin'</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">unicorn</span> <span class="k">as</span> <span class="nn">uc</span>

<span class="n">stage1_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/stage1.bin'</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">call_state</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">hook_call</span><span class="p">(</span><span class="n">uc_engine</span><span class="p">,</span> <span class="n">mem_type</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">call_state</span>
    <span class="n">ptr_data</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RCX</span><span class="p">)</span>
    <span class="n">data_size</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RDX</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Hook: blob ptr: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">ptr_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> size:</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">data_size</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">ptr_data</span><span class="p">,</span> <span class="n">data_size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">call_state</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Found first blob"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">buf</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">"first.bin"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Found second blob"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">buf</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">"second.bin"</span> 
    <span class="n">call_state</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">rip</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RIP</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"RIP: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">rip</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">rip</span> <span class="o">+=</span> <span class="mi">5</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RIP</span><span class="p">,</span> <span class="n">rip</span><span class="p">)</span>
    <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">'/tmp/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">call_state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"End emulation"</span><span class="p">)</span>
        <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RIP</span><span class="p">,</span> <span class="mh">0x99999999999</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
    <span class="n">uc_engine</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UC_ARCH_X86</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_MODE_64</span><span class="p">)</span>
    <span class="n">STACK_ADDR</span> <span class="o">=</span> <span class="mh">0x4400000</span>
    <span class="n">CODE_ADDR</span> <span class="o">=</span> <span class="mh">0x1400000</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="mh">0x100000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">STACK_ADDR</span> <span class="o">-</span> <span class="mh">0x100000</span><span class="p">,</span> <span class="mh">0x200000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RIP</span><span class="p">,</span> <span class="n">CODE_ADDR</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RSP</span><span class="p">,</span> <span class="n">STACK_ADDR</span><span class="p">)</span>
    <span class="n">hook1</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UC_HOOK_CODE</span><span class="p">,</span> <span class="n">hook_call</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">CODE_ADDR</span> <span class="o">+</span> <span class="mh">0x0536B1</span><span class="p">,</span> <span class="n">CODE_ADDR</span> <span class="o">+</span> <span class="mh">0x0536B2</span><span class="p">)</span>
    <span class="n">hook2</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UC_HOOK_CODE</span><span class="p">,</span> <span class="n">hook_call</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">CODE_ADDR</span> <span class="o">+</span> <span class="mh">0x536CB</span><span class="p">,</span> <span class="n">CODE_ADDR</span> <span class="o">+</span> <span class="mh">0x536CC</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">emu_start</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="n">CODE_ADDR</span> <span class="o">+</span> <span class="mh">0x10000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">out_rip</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RIP</span><span class="p">)</span>
    
<span class="n">main</span><span class="p">(</span><span class="n">stage1_data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Hook: blob ptr: 0x43c69f0 size:0x39410
Found first blob
bytearray(b';\xbc\xca\x9f\xfa\x95aX,\xb4\xdc\x98\xfb\x87\x13"\x88x\x05\xff2\xc4\xcc\xbd\xdc,\xb6\xa5$.\xe5\xe4\xf2r\xec\xea]/\xec6\xae\xc3\xd9\xc4\x91@A\x14\xf8\xbd\xa4t\x95\xb6\xa6[\xb6\x9a~\xaf&lt;\xf7\xc598\x0b\xd2\xa9\x8df\xaf\xa4\x00\xeb\xcc\xa4w\xb0\xa8i#u\x0b\xf0\xec\x89\xde\xf6\xe7e\x8a\xca\x06m\x1dl#\x9f\xd4a')
RIP: 0x14536b1
Hook: blob ptr: 0x43ffe00 size:0x178
Found second blob
bytearray(b'BSKP6RZ8afbOnHG8NTvPfkYBQ5gBBgghCkqn/C5QbhrUQS9uKLL73WP1JhFwQf5nU98PNSp6pm+iUUcFpdELXy8ydjgqILLxaoUJ')
RIP: 0x14536cb
End emulation
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">UcError</span>                                   Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-7-7940ea9dc380&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     45</span>     out_rip <span class="ansi-blue-fg">=</span> uc_engine<span class="ansi-blue-fg">.</span>reg_read<span class="ansi-blue-fg">(</span>uc<span class="ansi-blue-fg">.</span>x86_const<span class="ansi-blue-fg">.</span>UC_X86_REG_RIP<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     46</span> 
<span class="ansi-green-fg">---&gt; 47</span><span class="ansi-red-fg"> </span>main<span class="ansi-blue-fg">(</span>stage1_data<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">&lt;ipython-input-7-7940ea9dc380&gt;</span> in <span class="ansi-cyan-fg">main</span><span class="ansi-blue-fg">(buf)</span>
<span class="ansi-green-intense-fg ansi-bold">     42</span>     hook1 <span class="ansi-blue-fg">=</span> uc_engine<span class="ansi-blue-fg">.</span>hook_add<span class="ansi-blue-fg">(</span>uc<span class="ansi-blue-fg">.</span>UC_HOOK_CODE<span class="ansi-blue-fg">,</span> hook_call<span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> CODE_ADDR <span class="ansi-blue-fg">+</span> <span class="ansi-cyan-fg">0x0536B1</span><span class="ansi-blue-fg">,</span> CODE_ADDR <span class="ansi-blue-fg">+</span> <span class="ansi-cyan-fg">0x0536B2</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     43</span>     hook2 <span class="ansi-blue-fg">=</span> uc_engine<span class="ansi-blue-fg">.</span>hook_add<span class="ansi-blue-fg">(</span>uc<span class="ansi-blue-fg">.</span>UC_HOOK_CODE<span class="ansi-blue-fg">,</span> hook_call<span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> CODE_ADDR <span class="ansi-blue-fg">+</span> <span class="ansi-cyan-fg">0x536CB</span><span class="ansi-blue-fg">,</span> CODE_ADDR <span class="ansi-blue-fg">+</span> <span class="ansi-cyan-fg">0x536CC</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 44</span><span class="ansi-red-fg">     </span>uc_engine<span class="ansi-blue-fg">.</span>emu_start<span class="ansi-blue-fg">(</span>CODE_ADDR<span class="ansi-blue-fg">,</span> CODE_ADDR <span class="ansi-blue-fg">+</span> <span class="ansi-cyan-fg">0x10000</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     45</span>     out_rip <span class="ansi-blue-fg">=</span> uc_engine<span class="ansi-blue-fg">.</span>reg_read<span class="ansi-blue-fg">(</span>uc<span class="ansi-blue-fg">.</span>x86_const<span class="ansi-blue-fg">.</span>UC_X86_REG_RIP<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     46</span> 

<span class="ansi-green-fg">~/.pyenv/versions/3.9.5/lib/python3.9/site-packages/unicorn/unicorn.py</span> in <span class="ansi-cyan-fg">emu_start</span><span class="ansi-blue-fg">(self, begin, until, timeout, count)</span>
<span class="ansi-green-intense-fg ansi-bold">    339</span>         status <span class="ansi-blue-fg">=</span> _uc<span class="ansi-blue-fg">.</span>uc_emu_start<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_uch<span class="ansi-blue-fg">,</span> begin<span class="ansi-blue-fg">,</span> until<span class="ansi-blue-fg">,</span> timeout<span class="ansi-blue-fg">,</span> count<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    340</span>         <span class="ansi-green-fg">if</span> status <span class="ansi-blue-fg">!=</span> uc<span class="ansi-blue-fg">.</span>UC_ERR_OK<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 341</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">raise</span> UcError<span class="ansi-blue-fg">(</span>status<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    342</span> 
<span class="ansi-green-intense-fg ansi-bold">    343</span>         <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>_hook_exception <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span>

<span class="ansi-red-fg">UcError</span>: Invalid memory fetch (UC_ERR_FETCH_UNMAPPED)</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">unicorn</span> <span class="k">as</span> <span class="nn">uc</span>

<span class="n">stage1_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/stage1.bin'</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">call_state</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">hook_call</span><span class="p">(</span><span class="n">uc_engine</span><span class="p">,</span> <span class="n">mem_type</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">call_state</span>
    <span class="n">rip</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RIP</span><span class="p">)</span>
    <span class="n">rip_byte</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">rip</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rip_byte</span> <span class="o">==</span>  <span class="sa">b</span><span class="s1">'</span><span class="se">\xe8</span><span class="s1">'</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Call hook at RIP: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">rip</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">call_state</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">call_state</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">ptr_data</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RCX</span><span class="p">)</span>
        <span class="n">data_size</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RDX</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Hook: blob ptr: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">ptr_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> size:</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">data_size</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">ptr_data</span><span class="p">,</span> <span class="n">data_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">call_state</span>  <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Found first blob"</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">buf</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">"first.bin"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Found second blob"</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">buf</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">"second.bin"</span> 
        <span class="n">call_state</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">rip</span> <span class="o">+=</span> <span class="mi">5</span>
        <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RIP</span><span class="p">,</span> <span class="n">rip</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">'/tmp/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">call_state</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"End emulation"</span><span class="p">)</span>
            <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RIP</span><span class="p">,</span> <span class="mh">0x99999999999</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
    <span class="n">uc_engine</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UC_ARCH_X86</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_MODE_64</span><span class="p">)</span>
    <span class="n">STACK_ADDR</span> <span class="o">=</span> <span class="mh">0x4400000</span>
    <span class="n">CODE_ADDR</span> <span class="o">=</span> <span class="mh">0x1400000</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="mh">0x100000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">STACK_ADDR</span> <span class="o">-</span> <span class="mh">0x100000</span><span class="p">,</span> <span class="mh">0x200000</span><span class="p">,</span> <span class="n">uc</span><span class="o">.</span><span class="n">UC_PROT_ALL</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RIP</span><span class="p">,</span> <span class="n">CODE_ADDR</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RSP</span><span class="p">,</span> <span class="n">STACK_ADDR</span><span class="p">)</span>
    <span class="n">hook1</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">UC_HOOK_CODE</span><span class="p">,</span> <span class="n">hook_call</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">uc_engine</span><span class="o">.</span><span class="n">emu_start</span><span class="p">(</span><span class="n">CODE_ADDR</span><span class="p">,</span> <span class="n">CODE_ADDR</span> <span class="o">+</span> <span class="mh">0x10000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">out_rip</span> <span class="o">=</span> <span class="n">uc_engine</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">uc</span><span class="o">.</span><span class="n">x86_const</span><span class="o">.</span><span class="n">UC_X86_REG_RIP</span><span class="p">)</span>
    
<span class="n">main</span><span class="p">(</span><span class="n">stage1_data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Call hook at RIP: 0x1400000
Call hook at RIP: 0x14536b1
Hook: blob ptr: 0x43c69f0 size:0x39410
Found first blob
bytearray(b';\xbc\xca\x9f\xfa\x95aX,\xb4\xdc\x98\xfb\x87\x13"\x88x\x05\xff2\xc4\xcc\xbd\xdc,\xb6\xa5$.\xe5\xe4\xf2r\xec\xea]/\xec6\xae\xc3\xd9\xc4\x91@A\x14\xf8\xbd\xa4t\x95\xb6\xa6[\xb6\x9a~\xaf&lt;\xf7\xc598\x0b\xd2\xa9\x8df\xaf\xa4\x00\xeb\xcc\xa4w\xb0\xa8i#u\x0b\xf0\xec\x89\xde\xf6\xe7e\x8a\xca\x06m\x1dl#\x9f\xd4a')
Call hook at RIP: 0x14536cb
Hook: blob ptr: 0x43ffe00 size:0x178
Found second blob
bytearray(b'BSKP6RZ8afbOnHG8NTvPfkYBQ5gBBgghCkqn/C5QbhrUQS9uKLL73WP1JhFwQf5nU98PNSp6pm+iUUcFpdELXy8ydjgqILLxaoUJ')
End emulation
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">UcError</span>                                   Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-2-47735b0fbcb1&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     49</span>     out_rip <span class="ansi-blue-fg">=</span> uc_engine<span class="ansi-blue-fg">.</span>reg_read<span class="ansi-blue-fg">(</span>uc<span class="ansi-blue-fg">.</span>x86_const<span class="ansi-blue-fg">.</span>UC_X86_REG_RIP<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     50</span> 
<span class="ansi-green-fg">---&gt; 51</span><span class="ansi-red-fg"> </span>main<span class="ansi-blue-fg">(</span>stage1_data<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">&lt;ipython-input-2-47735b0fbcb1&gt;</span> in <span class="ansi-cyan-fg">main</span><span class="ansi-blue-fg">(buf)</span>
<span class="ansi-green-intense-fg ansi-bold">     46</span>     uc_engine<span class="ansi-blue-fg">.</span>reg_write<span class="ansi-blue-fg">(</span>uc<span class="ansi-blue-fg">.</span>x86_const<span class="ansi-blue-fg">.</span>UC_X86_REG_RSP<span class="ansi-blue-fg">,</span> STACK_ADDR<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     47</span>     hook1 <span class="ansi-blue-fg">=</span> uc_engine<span class="ansi-blue-fg">.</span>hook_add<span class="ansi-blue-fg">(</span>uc<span class="ansi-blue-fg">.</span>UC_HOOK_CODE<span class="ansi-blue-fg">,</span> hook_call<span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 48</span><span class="ansi-red-fg">     </span>uc_engine<span class="ansi-blue-fg">.</span>emu_start<span class="ansi-blue-fg">(</span>CODE_ADDR<span class="ansi-blue-fg">,</span> CODE_ADDR <span class="ansi-blue-fg">+</span> <span class="ansi-cyan-fg">0x10000</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     49</span>     out_rip <span class="ansi-blue-fg">=</span> uc_engine<span class="ansi-blue-fg">.</span>reg_read<span class="ansi-blue-fg">(</span>uc<span class="ansi-blue-fg">.</span>x86_const<span class="ansi-blue-fg">.</span>UC_X86_REG_RIP<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     50</span> 

<span class="ansi-green-fg">~/.pyenv/versions/3.9.5/lib/python3.9/site-packages/unicorn/unicorn.py</span> in <span class="ansi-cyan-fg">emu_start</span><span class="ansi-blue-fg">(self, begin, until, timeout, count)</span>
<span class="ansi-green-intense-fg ansi-bold">    339</span>         status <span class="ansi-blue-fg">=</span> _uc<span class="ansi-blue-fg">.</span>uc_emu_start<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_uch<span class="ansi-blue-fg">,</span> begin<span class="ansi-blue-fg">,</span> until<span class="ansi-blue-fg">,</span> timeout<span class="ansi-blue-fg">,</span> count<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    340</span>         <span class="ansi-green-fg">if</span> status <span class="ansi-blue-fg">!=</span> uc<span class="ansi-blue-fg">.</span>UC_ERR_OK<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 341</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">raise</span> UcError<span class="ansi-blue-fg">(</span>status<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    342</span> 
<span class="ansi-green-intense-fg ansi-bold">    343</span>         <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>_hook_exception <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span>

<span class="ansi-red-fg">UcError</span>: Invalid memory fetch (UC_ERR_FETCH_UNMAPPED)</pre>
</div>
</div>

</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/rat/brute%20ratel/redteam/python/research/boymoderre/2022/12/11/brute-ratel.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="https://research.openanalysis.net/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
